@page "/invoices"
@inject IMobileInvoiceService InvoiceSvc
@inject IMobileCustomerService CustomerService
@inject IMobileJobService JobService
@inject IMobileSiteService SiteService
@inject IMobileAuthService AuthService
@inject IMobilePdfService PdfService
@inject NavigationManager Nav

@if (_loading)
{
    <div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>
}
else if (_mode == "detail" && _detail != null)
{
    <!-- Detail View -->
    <div class="d-flex align-items-center mb-2">
        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="BackToList"><i class="bi bi-arrow-left"></i></button>
        <span style="font-size:0.95rem; font-weight:700;">@_detail.InvoiceNumber</span>
        <span class="badge ms-auto @GetStatusBadge(_detail.Status)" style="font-size:0.7rem;">@_detail.Status</span>
    </div>

    @if (_detail.NeedsReview)
    {
        <div class="alert alert-warning py-2 px-3 mb-2 d-flex align-items-center" style="font-size:0.8rem; border-radius:10px;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span>Created on mobile — add line items, tax, and pricing details on the web app.</span>
        </div>
    }

    <!-- Amount Card -->
    <div class="mobile-card mb-2" style="border-left:3px solid @(_detail.BalanceDue > 0 ? "#dc3545" : "#198754");">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <span style="font-size:0.8rem; font-weight:600;">Total</span>
            <span style="font-size:1.2rem; font-weight:700; color:var(--primary);">@_detail.Total.ToString("C")</span>
        </div>
        <div class="d-flex justify-content-between" style="font-size:0.78rem;">
            <span class="text-muted">Subtotal</span><span>@_detail.Subtotal.ToString("C")</span>
        </div>
        @if (_detail.TaxAmount > 0)
        {
            <div class="d-flex justify-content-between" style="font-size:0.78rem;">
                <span class="text-muted">Tax (@(_detail.TaxRate)%)</span><span>@_detail.TaxAmount.ToString("C")</span>
            </div>
        }
        @if (_detail.MarkupAmount > 0)
        {
            <div class="d-flex justify-content-between" style="font-size:0.78rem;">
                <span class="text-muted">Markup</span><span>@_detail.MarkupAmount.ToString("C")</span>
            </div>
        }
        @if (_detail.DiscountAmount.HasValue && _detail.DiscountAmount > 0)
        {
            <div class="d-flex justify-content-between" style="font-size:0.78rem;">
                <span class="text-muted">Discount</span><span>-@_detail.DiscountAmount.Value.ToString("C")</span>
            </div>
        }
        <hr style="margin:0.3rem 0;" />
        <div class="d-flex justify-content-between" style="font-size:0.78rem;">
            <span class="text-muted">Paid</span><span class="text-success">@_detail.AmountPaid.ToString("C")</span>
        </div>
        <div class="d-flex justify-content-between fw-bold" style="font-size:0.9rem;">
            <span>Balance Due</span>
            <span class="@(_detail.BalanceDue > 0 ? "text-danger" : "text-success")">@_detail.BalanceDue.ToString("C")</span>
        </div>
    </div>

    <!-- Invoice Info -->
    <div class="mobile-card mb-2">
        <div style="font-size:0.8rem; font-weight:600; margin-bottom:0.3rem;">Invoice Info</div>
        <div class="d-flex flex-wrap gap-3" style="font-size:0.78rem;">
            @if (_detail.InvoiceDate.HasValue)
            {
                <div><span class="text-muted">Date:</span> @_detail.InvoiceDate.Value.ToString("MMM dd, yyyy")</div>
            }
            @if (_detail.DueDate.HasValue)
            {
                <div><span class="text-muted">Due:</span> @_detail.DueDate.Value.ToString("MMM dd, yyyy")</div>
            }
            @if (!string.IsNullOrWhiteSpace(_detail.PaymentTerms))
            {
                <div><span class="text-muted">Terms:</span> @_detail.PaymentTerms</div>
            }
            @if (!string.IsNullOrWhiteSpace(_detail.PricingType))
            {
                <div><span class="text-muted">Pricing:</span> @_detail.PricingType</div>
            }
        </div>
    </div>

    <!-- Customer / Job / Site -->
    @if (_detail.CustomerName != null || _detail.JobNumber != null || _detail.SiteName != null)
    {
        <div class="mobile-card mb-2">
            <div style="font-size:0.8rem; font-weight:600; margin-bottom:0.3rem;">Linked Info</div>
            @if (_detail.CustomerName != null)
            {
                <div class="d-flex align-items-center gap-2 mb-1" style="font-size:0.78rem;">
                    <i class="bi bi-person text-muted"></i>
                    <span>@_detail.CustomerName</span>
                    @if (!string.IsNullOrWhiteSpace(_detail.CustomerPhone))
                    {
                        <a href="tel:@_detail.CustomerPhone" class="ms-auto" style="font-size:0.75rem;"><i class="bi bi-telephone"></i></a>
                    }
                </div>
            }
            @if (_detail.JobNumber != null)
            {
                <div class="d-flex align-items-center gap-2 mb-1" style="font-size:0.78rem; cursor:pointer;" @onclick='() => Nav.NavigateTo("/jobs/" + _detail.JobId)'>
                    <i class="bi bi-briefcase text-muted"></i>
                    <span class="text-primary">@_detail.JobNumber@(!string.IsNullOrWhiteSpace(_detail.JobTitle) ? $" — {_detail.JobTitle}" : "")</span>
                </div>
            }
            @if (_detail.SiteName != null)
            {
                <div class="d-flex align-items-center gap-2 mb-1" style="font-size:0.78rem;">
                    <i class="bi bi-geo-alt text-muted"></i>
                    <span>@_detail.SiteName@(!string.IsNullOrWhiteSpace(_detail.SiteAddress) ? $" — {_detail.SiteAddress}" : "")</span>
                </div>
            }
        </div>
    }

    <!-- Line Items -->
    @if (_detail.Lines.Any())
    {
        <div class="mobile-card mb-2">
            <div style="font-size:0.8rem; font-weight:600; margin-bottom:0.3rem;">Line Items (@_detail.Lines.Count)</div>
            @foreach (var l in _detail.Lines)
            {
                <div class="d-flex justify-content-between align-items-start py-1" style="border-bottom:1px solid #f0f0f0;">
                    <div style="min-width:0; flex:1;">
                        <div style="font-size:0.8rem; font-weight:500;">@l.Description</div>
                        <div style="font-size:0.7rem;" class="text-muted">
                            @l.Quantity x @l.UnitPrice.ToString("C")
                            @if (!string.IsNullOrWhiteSpace(l.LineType)) { <span>� @l.LineType</span> }
                        </div>
                    </div>
                    <span style="font-size:0.8rem; font-weight:600;">@l.LineTotal.ToString("C")</span>
                </div>
            }
        </div>
    }

    <!-- Payments -->
    @if (_detail.Payments.Any())
    {
        <div class="mobile-card mb-2">
            <div style="font-size:0.8rem; font-weight:600; margin-bottom:0.3rem;">
                <i class="bi bi-cash-stack me-1"></i>Payments (@_detail.Payments.Count)
            </div>
            @foreach (var p in _detail.Payments)
            {
                <div class="d-flex justify-content-between align-items-center py-1" style="border-bottom:1px solid #f0f0f0;">
                    <div>
                        <div style="font-size:0.8rem; font-weight:500;">@p.PaymentDate.ToString("MMM dd, yyyy")</div>
                        <div style="font-size:0.7rem;" class="text-muted">
                            @p.Method
                            @if (!string.IsNullOrWhiteSpace(p.Reference)) { <span>� Ref: @p.Reference</span> }
                        </div>
                    </div>
                    <span style="font-size:0.85rem; font-weight:600; color:#198754;">@p.Amount.ToString("C")</span>
                </div>
            }
        </div>
    }

    <!-- Notes / Terms -->
    @if (!string.IsNullOrWhiteSpace(_detail.Notes) || !string.IsNullOrWhiteSpace(_detail.Terms))
    {
        <div class="mobile-card mb-2">
            @if (!string.IsNullOrWhiteSpace(_detail.Notes))
            {
                <div style="font-size:0.78rem; margin-bottom:0.25rem;"><strong>Notes:</strong> @_detail.Notes</div>
            }
            @if (!string.IsNullOrWhiteSpace(_detail.Terms))
            {
                <div style="font-size:0.78rem;"><strong>Terms:</strong> @_detail.Terms</div>
            }
        </div>
    }

    <!-- Status Actions -->
    @if (_isElevatedRole)
    {
        <div class="mobile-card mb-2">
            <div style="font-size:0.8rem; font-weight:600; margin-bottom:0.3rem;">Actions</div>
            @if (!string.IsNullOrEmpty(_statusMessage))
            {
                <div class="alert @(_statusSuccess ? "alert-success" : "alert-danger") py-1 mb-2" style="font-size:0.8rem; border-radius:8px;">
                    <i class="bi @(_statusSuccess ? "bi-check-circle-fill" : "bi-x-circle-fill") me-1"></i>@_statusMessage
                </div>
            }
            <div class="d-flex flex-wrap gap-2">
                @if (_detail.Status == InvoiceStatus.Draft)
                {
                    <button class="btn btn-outline-primary flex-fill" style="font-size:0.8rem;" disabled="@_updatingStatus"
                            @onclick="() => ChangeInvoiceStatus(InvoiceStatus.Sent)">
                        <i class="bi bi-send me-1"></i>Mark as Sent
                    </button>
                }
                @if (_detail.Status == InvoiceStatus.Draft || _detail.Status == InvoiceStatus.Sent)
                {
                    <button class="btn btn-primary flex-fill" style="font-size:0.8rem;" disabled="@_updatingStatus"
                            @onclick="() => ChangeInvoiceStatus(InvoiceStatus.Invoiced)">
                        @if (_updatingStatus) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        <i class="bi bi-receipt me-1"></i>Invoice
                    </button>
                }
                @if (_detail.Status is InvoiceStatus.Sent or InvoiceStatus.Invoiced or InvoiceStatus.Overdue)
                {
                    <button class="btn btn-success flex-fill" style="font-size:0.8rem;" disabled="@_updatingStatus"
                            @onclick="() => ChangeInvoiceStatus(InvoiceStatus.Paid)">
                        <i class="bi bi-check-circle me-1"></i>Mark Paid
                    </button>
                }
                @if (_detail.Status != InvoiceStatus.Void && _detail.Status != InvoiceStatus.Paid)
                {
                    <button class="btn btn-outline-danger flex-fill" style="font-size:0.8rem;" disabled="@_updatingStatus"
                            @onclick="() => ChangeInvoiceStatus(InvoiceStatus.Void)">
                        <i class="bi bi-x-circle me-1"></i>Void
                    </button>
                }
            </div>
            <hr class="my-2" />
            <button class="btn btn-outline-primary w-100" style="font-size:0.8rem;" disabled="@_sharingPdf"
                    @onclick="ShareInvoicePdf">
                @if (_sharingPdf) { <span class="spinner-border spinner-border-sm me-1"></span> }
                <i class="bi bi-file-earmark-pdf me-1"></i>Share as PDF
            </button>
        </div>
    }

    <div class="text-muted text-center" style="font-size:0.65rem;">Created @_detail.CreatedAt.ToString("MMM dd, yyyy h:mm tt") — Updated @_detail.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")</div>
}
else
{
    @if (_showCreate)
    {
        <div class="mobile-card" style="padding:0.75rem;">
            @if (_isElevatedRole)
            {
                <h6 class="fw-bold mb-2" style="font-size:0.85rem;"><i class="bi bi-receipt me-1"></i>New Invoice</h6>
                <div class="mb-1">
                    <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_fullInvoice.CustomerId">
                        <option value="">Customer *</option>
                        @foreach (var c in _custOpts) { <option value="@c.Id">@c.Name</option> }
                    </select>
                </div>
                <div class="mb-1">
                    <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_fullInvoice.JobId">
                        <option value="">Job (optional)</option>
                        @foreach (var j in _jobOpts) { <option value="@j.Id">@j.JobNumber — @(j.Title ?? "Untitled")</option> }
                    </select>
                </div>
                <div class="mb-1">
                    <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_fullInvoice.SiteId">
                        <option value="">Site (optional)</option>
                        @foreach (var s in _siteOpts) { <option value="@s.Id">@s.Name</option> }
                    </select>
                </div>
                <div class="row g-1 mb-1">
                    <div class="col-6">
                        <label style="font-size:0.75rem;" class="text-muted">Due Date</label>
                        <input type="date" class="form-control" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_fullInvoice.DueDate" />
                    </div>
                    <div class="col-6">
                        <label style="font-size:0.75rem;" class="text-muted">Payment Terms</label>
                        <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_fullInvoice.PaymentTerms">
                            <option value="Due on Receipt">Due on Receipt</option>
                            <option value="Net 15">Net 15</option>
                            <option value="Net 30">Net 30</option>
                            <option value="Net 45">Net 45</option>
                            <option value="Net 60">Net 60</option>
                        </select>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="d-flex justify-content-between align-items-center mt-2 mb-1">
                    <span style="font-size:0.8rem; font-weight:600;">Line Items (@_fullInvoice.Lines.Count)</span>
                    <button class="btn btn-sm btn-outline-primary" style="font-size:0.7rem; padding:2px 8px;" @onclick="AddInvoiceLine">
                        <i class="bi bi-plus me-1"></i>Add
                    </button>
                </div>
                @for (var idx = 0; idx < _fullInvoice.Lines.Count; idx++)
                {
                    var i = idx;
                    var line = _fullInvoice.Lines[i];
                    <div class="border rounded p-2 mb-1" style="background:#f8f9fa; font-size:0.85rem;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold" style="font-size:0.75rem;">Item @(i + 1)</span>
                            <button class="btn btn-sm btn-outline-danger" style="font-size:0.65rem; padding:1px 5px;" @onclick="() => RemoveInvoiceLine(i)">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <input type="text" class="form-control mb-1" style="min-height:34px; font-size:0.85rem; padding:4px 8px;" placeholder="Description *" @bind="line.Description" />
                        <div class="row g-1">
                            <div class="col-4">
                                <select class="form-select" style="min-height:34px; font-size:0.8rem; padding:4px 6px;" @bind="line.LineType">
                                    <option value="Labor">Labor</option>
                                    <option value="Material">Material</option>
                                    <option value="Equipment">Equipment</option>
                                    <option value="Fee">Fee</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control" style="min-height:34px; font-size:0.85rem; padding:4px 8px;" placeholder="Qty" @bind="line.Quantity" step="0.5" min="0.1" />
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control" style="min-height:34px; font-size:0.85rem; padding:4px 8px;" placeholder="Price" @bind="line.UnitPrice" step="0.01" min="0" />
                            </div>
                        </div>
                        <div class="text-end mt-1" style="font-size:0.75rem; color:var(--primary); font-weight:600;">
                            = @((line.Quantity * line.UnitPrice).ToString("C"))
                        </div>
                    </div>
                }

                <!-- Pricing -->
                <div class="row g-1 mb-1 mt-2">
                    <div class="col-6">
                        <label style="font-size:0.75rem;" class="text-muted">Tax %</label>
                        <input type="number" class="form-control" style="min-height:34px; font-size:0.85rem; padding:4px 8px;" @bind="_fullInvoice.TaxRate" step="0.1" min="0" />
                    </div>
                    <div class="col-6">
                        <label style="font-size:0.75rem;" class="text-muted">Markup %</label>
                        <input type="number" class="form-control" style="min-height:34px; font-size:0.85rem; padding:4px 8px;" @bind="_fullInvoice.MarkupPercent" step="1" min="0" />
                    </div>
                </div>

                <!-- Calculated Total Preview -->
                <div class="border rounded p-2 mb-1" style="background:#e8f5e9; font-size:0.8rem;">
                    <div class="d-flex justify-content-between"><span class="text-muted">Subtotal</span><span>@InvPreviewSubtotal.ToString("C")</span></div>
                    @if (_fullInvoice.MarkupPercent > 0)
                    {
                        <div class="d-flex justify-content-between"><span class="text-muted">Markup (@_fullInvoice.MarkupPercent%)</span><span>@InvPreviewMarkup.ToString("C")</span></div>
                    }
                    @if (_fullInvoice.TaxRate > 0)
                    {
                        <div class="d-flex justify-content-between"><span class="text-muted">Tax (@_fullInvoice.TaxRate%)</span><span>@InvPreviewTax.ToString("C")</span></div>
                    }
                    <hr class="my-1" />
                    <div class="d-flex justify-content-between fw-bold"><span>Total</span><span>@InvPreviewTotal.ToString("C")</span></div>
                </div>

                <div class="mb-1">
                    <textarea class="form-control" rows="2" style="min-height:auto; font-size:0.9rem; padding:6px 10px;" placeholder="Notes (optional)" @bind="_fullInvoice.Notes"></textarea>
                </div>
                <div class="mb-1">
                    <textarea class="form-control" rows="1" style="min-height:auto; font-size:0.9rem; padding:6px 10px;" placeholder="Payment Terms Text (optional)" @bind="_fullInvoice.Terms"></textarea>
                </div>
                <div class="d-flex gap-2 mt-1">
                    <button class="btn btn-primary flex-fill" style="min-height:40px;" @onclick="SaveInvoice" disabled="@(!_fullInvoice.CustomerId.HasValue)">
                        <i class="bi bi-check-lg me-1"></i>Create Invoice
                    </button>
                    <button class="btn btn-outline-secondary" style="min-height:40px;" @onclick="() => _showCreate = false">Cancel</button>
                </div>
            }
            else
            {
                <h6 class="fw-bold mb-2" style="font-size:0.85rem;"><i class="bi bi-receipt me-1"></i>Quick Draft Invoice</h6>
                <div class="mb-1">
                    <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_newInvoice.CustomerId">
                        <option value="">Customer *</option>
                        @foreach (var c in _custOpts) { <option value="@c.Id">@c.Name</option> }
                    </select>
                </div>
                <div class="mb-1">
                    <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_newInvoice.JobId">
                        <option value="">Job (optional)</option>
                        @foreach (var j in _jobOpts) { <option value="@j.Id">@j.JobNumber — @(j.Title ?? "Untitled")</option> }
                    </select>
                </div>
                <div class="mb-1">
                    <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_newInvoice.SiteId">
                        <option value="">Site (optional)</option>
                        @foreach (var s in _siteOpts) { <option value="@s.Id">@s.Name</option> }
                    </select>
                </div>
                <div class="mb-1">
                    <textarea class="form-control" rows="2" style="min-height:auto; font-size:0.9rem; padding:6px 10px;" placeholder="Notes (optional)" @bind="_newInvoice.Notes"></textarea>
                </div>
                <div class="alert alert-info py-1 px-2 mb-1" style="font-size:0.75rem;">
                    <i class="bi bi-info-circle me-1"></i>Creates a Draft invoice (Net 30). Add line items, tax, and pricing on the web app.
                </div>
                <div class="d-flex gap-2 mt-1">
                    <button class="btn btn-primary flex-fill" style="min-height:40px;" @onclick="SaveInvoice" disabled="@(!_newInvoice.CustomerId.HasValue)">
                        <i class="bi bi-check-lg me-1"></i>Create Draft
                    </button>
                    <button class="btn btn-outline-secondary" style="min-height:40px;" @onclick="() => _showCreate = false">Cancel</button>
                </div>
            }
            @if (_saveError != null)
            {
                <div class="alert alert-danger mt-2 py-1" style="font-size:0.8rem;">@_saveError</div>
            }
        </div>
    }

    <!-- List View -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span style="font-size:0.95rem; font-weight:700;"><i class="bi bi-receipt me-1"></i>Invoices</span>
    </div>

    <!-- Stats -->
    @if (_stats != null)
    {
        <div class="gap-grid mb-2">
            <div class="stat-card">
                <div class="stat-icon text-primary"><i class="bi bi-receipt"></i></div>
                <div class="stat-value">@_stats.TotalCount</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-secondary"><i class="bi bi-pencil-square"></i></div>
                <div class="stat-value">@_stats.DraftCount</div>
                <div class="stat-label">Drafts</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-danger"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="stat-value">@_stats.OverdueCount</div>
                <div class="stat-label">Overdue</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-warning"><i class="bi bi-cash-coin"></i></div>
                <div class="stat-value">@_stats.TotalOutstanding.ToString("C0")</div>
                <div class="stat-label">Outstanding</div>
            </div>
        </div>
    }

    <!-- Search -->
    <div class="mobile-card mb-2" style="padding:0.5rem 0.75rem;">
        <input type="text" class="form-control form-control-sm" placeholder="Search invoices..." @bind="_filter.Search" @bind:event="oninput" @bind:after="LoadInvoices" />
    </div>

    <!-- Status Filter -->
    <div class="d-flex gap-1 flex-wrap mb-2">
        <button class="btn btn-sm @(!_filter.Status.HasValue ? "btn-primary" : "btn-outline-secondary")" style="border-radius:20px; font-size:0.7rem; padding:2px 10px;" @onclick="() => FilterStatus(null)">All</button>
        @foreach (var s in Enum.GetValues<InvoiceStatus>())
        {
            <button class="btn btn-sm @(_filter.Status == s ? "btn-primary" : "btn-outline-secondary")" style="border-radius:20px; font-size:0.7rem; padding:2px 10px;" @onclick="() => FilterStatus(s)">@s</button>
        }
    </div>

    <!-- Invoice List -->
    @if (_invoices.Any())
    {
        @foreach (var inv in _invoices)
        {
            <div class="mobile-card mb-1" style="cursor:pointer;" @onclick="() => ViewDetail(inv.Id)">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="min-width:0; flex:1;">
                        <div class="d-flex align-items-center gap-1">
                            <span style="font-size:0.85rem; font-weight:700;">@inv.InvoiceNumber</span>
                            <span class="badge @GetStatusBadge(inv.Status)" style="font-size:0.58rem;">@inv.Status</span>
                        </div>
                        <div style="font-size:0.75rem;" class="text-muted mt-1">
                            @(inv.CustomerName ?? "—")
                            @if (!string.IsNullOrWhiteSpace(inv.JobNumber)) { <span>� @inv.JobNumber</span> }
                        </div>
                        @if (inv.DueDate.HasValue)
                        {
                            <div style="font-size:0.7rem;" class="text-muted">Due @inv.DueDate.Value.ToString("MMM dd")</div>
                        }
                    </div>
                    <div class="text-end">
                        <div style="font-size:0.9rem; font-weight:700;">@inv.Total.ToString("C")</div>
                        @if (inv.BalanceDue > 0)
                        {
                            <div style="font-size:0.7rem;" class="text-danger">Bal: @inv.BalanceDue.ToString("C")</div>
                        }
                        else if (inv.Status == InvoiceStatus.Paid)
                        {
                            <div style="font-size:0.7rem;" class="text-success">Paid</div>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-receipt d-block" style="font-size:2rem;"></i>
            <p>No invoices found</p>
        </div>
    }

    @if (!_showCreate)
    {
        <button class="fab" title="New Invoice" @onclick="ShowCreateInvoice">
            <i class="bi bi-plus-lg"></i>
        </button>
    }
}

@code {
    private string _mode = "list";
    private bool _loading = true;

    private MobileInvoiceStats? _stats;
    private List<MobileInvoiceCard> _invoices = [];
    private MobileInvoiceDetail? _detail;
    private MobileInvoiceFilter _filter = new();
    private bool _showCreate;
    private MobileInvoiceQuickCreate _newInvoice = new();
    private MobileInvoiceFullCreate _fullInvoice = new();
    private List<MobileCustomerCard> _custOpts = [];
    private List<MobileSiteCard> _siteOpts = [];
    private List<MobileJobCard> _jobOpts = [];
    private string? _saveError;
    private bool _isElevatedRole;
    private bool _updatingStatus;
    private string? _statusMessage;
    private bool _statusSuccess;
    private bool _sharingPdf;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthService.GetCurrentUserAsync();
        _isElevatedRole = session?.Role is "Owner" or "Admin" or "Manager";

        await LoadData();
        _loading = false;
    }

    private async Task LoadData()
    {
        _stats = await InvoiceSvc.GetStatsAsync();
        await LoadInvoices();
    }

    private async Task LoadInvoices()
    {
        _invoices = await InvoiceSvc.GetInvoicesAsync(_filter);
    }

    private async Task ViewDetail(int id)
    {
        _detail = await InvoiceSvc.GetInvoiceDetailAsync(id);
        if (_detail != null) _mode = "detail";
    }

    private async Task BackToList()
    {
        _mode = "list";
        _detail = null;
        _statusMessage = null;
        await LoadData();
    }

    private async Task FilterStatus(InvoiceStatus? status)
    {
        _filter.Status = status;
        await LoadInvoices();
    }

    private async Task ShowCreateInvoice()
    {
        _newInvoice = new();
        _fullInvoice = new();
        if (_isElevatedRole)
            _fullInvoice.Lines.Add(new MobileInvoiceLineCreate());
        _saveError = null;
        _custOpts = await CustomerService.GetCustomersAsync();
        _siteOpts = await SiteService.GetSitesAsync();
        _jobOpts = await JobService.GetAllJobCardsAsync();
        _showCreate = true;
    }

    private async Task SaveInvoice()
    {
        try
        {
            _saveError = null;
            if (_isElevatedRole)
            {
                if (!_fullInvoice.CustomerId.HasValue) { _saveError = "Customer is required."; return; }
                if (!_fullInvoice.Lines.Any(l => !string.IsNullOrWhiteSpace(l.Description))) { _saveError = "At least one line item is required."; return; }
                _fullInvoice.Lines.RemoveAll(l => string.IsNullOrWhiteSpace(l.Description));
                await InvoiceSvc.FullCreateAsync(_fullInvoice);
            }
            else
            {
                if (!_newInvoice.CustomerId.HasValue) { _saveError = "Customer is required."; return; }
                await InvoiceSvc.QuickCreateAsync(_newInvoice);
            }
            _showCreate = false;
            await LoadData();
        }
        catch (Exception ex) { _saveError = ex.Message; }
    }

    private void AddInvoiceLine() => _fullInvoice.Lines.Add(new MobileInvoiceLineCreate());
    private void RemoveInvoiceLine(int index) { if (_fullInvoice.Lines.Count > 1) _fullInvoice.Lines.RemoveAt(index); }

    private decimal InvPreviewSubtotal => _fullInvoice.Lines.Sum(l => l.Quantity * l.UnitPrice);
    private decimal InvPreviewMarkup => InvPreviewSubtotal * _fullInvoice.MarkupPercent / 100;
    private decimal InvPreviewTax => (InvPreviewSubtotal + InvPreviewMarkup) * _fullInvoice.TaxRate / 100;
    private decimal InvPreviewTotal => InvPreviewSubtotal + InvPreviewMarkup + InvPreviewTax;

    private async Task ChangeInvoiceStatus(InvoiceStatus newStatus)
    {
        if (_detail == null) return;
        _updatingStatus = true;
        _statusMessage = null;
        StateHasChanged();
        try
        {
            var success = await InvoiceSvc.UpdateStatusAsync(_detail.Id, newStatus);
            if (success)
            {
                _statusMessage = $"Status updated to {newStatus}.";
                _statusSuccess = true;
                await ViewDetail(_detail.Id);
            }
            else
            {
                _statusMessage = "Failed to update status.";
                _statusSuccess = false;
            }
        }
        catch (Exception ex)
        {
            _statusMessage = ex.Message;
            _statusSuccess = false;
        }
        _updatingStatus = false;
    }

    private async Task ShareInvoicePdf()
    {
        if (_detail is null) return;
        _sharingPdf = true;
        StateHasChanged();
        try
        {
            var filePath = await PdfService.GenerateInvoiceDocumentAsync(_detail.Id);
            if (filePath is not null)
                await PdfService.ShareDocumentAsync(filePath, $"Invoice {_detail.InvoiceNumber}");
        }
        finally
        {
            _sharingPdf = false;
            StateHasChanged();
        }
    }

    private static string GetStatusBadge(InvoiceStatus s) => s switch
    {
        InvoiceStatus.Draft => "bg-secondary",
        InvoiceStatus.Sent => "bg-info",
        InvoiceStatus.Invoiced => "bg-primary",
        InvoiceStatus.Paid => "bg-success",
        InvoiceStatus.Overdue => "bg-danger",
        InvoiceStatus.Void => "bg-dark",
        _ => "bg-secondary",
    };
}
