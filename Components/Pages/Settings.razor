@page "/settings"
@inject IMobileSettingsService SettingsService
@inject NavigationManager Nav
@inject IJSRuntime JS

@if (_loading)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    <!-- Back -->
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary" @onclick='() => Nav.NavigateTo("/profile")'>
            <i class="bi bi-arrow-left me-1"></i>Back to Profile
        </button>
    </div>

    <!-- Appearance -->
    <div class="section-header">Appearance</div>
    <div class="mobile-card">
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-palette me-2 text-primary"></i>Theme</span>
                <p class="card-subtitle mb-0">App color theme</p>
            </div>
            <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.Theme" @bind:after="OnThemeChanged">
                <option value="Light">Light</option>
                <option value="Dark">Dark</option>
            </select>
        </div>
    </div>

    <!-- Notifications -->
    <div class="section-header">Notifications</div>
    <div class="mobile-card">
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-bell me-2 text-primary"></i>Push Notifications</span>
                <p class="card-subtitle mb-0">Receive alerts on this device</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.NotificationsEnabled" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-briefcase me-2"></i>Job Alerts</span>
                <p class="card-subtitle mb-0">New assignments & status changes</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.JobAlerts"
                       disabled="@(!_settings.NotificationsEnabled)" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-box-seam me-2"></i>Inventory Alerts</span>
                <p class="card-subtitle mb-0">Low stock warnings</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.InventoryAlerts"
                       disabled="@(!_settings.NotificationsEnabled)" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-receipt me-2"></i>Estimate Alerts</span>
                <p class="card-subtitle mb-0">Expiring & approved estimates</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.EstimateAlerts"
                       disabled="@(!_settings.NotificationsEnabled)" />
            </div>
        </div>
    </div>

    <!-- Job Preferences -->
    <div class="section-header">Job Preferences</div>
    <div class="mobile-card">
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-clock-history me-2 text-primary"></i>Auto-Clock on En Route</span>
                <p class="card-subtitle mb-0">Start time tracking when you go en route</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.AutoClockOnEnRoute" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-eye me-2"></i>Show Completed Jobs</span>
                <p class="card-subtitle mb-0">Include completed jobs in lists</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.ShowCompletedJobs" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-filter me-2"></i>Default Job Filter</span>
                <p class="card-subtitle mb-0">Default view when opening Jobs</p>
            </div>
            <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.DefaultJobFilter">
                <option value="All">All</option>
                <option value="Today">Today</option>
                <option value="Open">Open Only</option>
            </select>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-calendar-week me-2"></i>Calendar Default</span>
                <p class="card-subtitle mb-0">Default calendar view</p>
            </div>
            <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.DefaultCalendarView">
                <option value="Day">Day</option>
                <option value="Week">Week</option>
            </select>
        </div>
    </div>

    <!-- Sync & Storage -->
    <div class="section-header">Sync & Storage</div>
    <div class="mobile-card">
        @if (_syncStatus != null)
        {
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-cloud-check me-2 text-success"></i>Status</span>
                <span class="badge bg-success-subtle text-success" style="font-size:0.75rem;">@_syncStatus.SyncState</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-clock me-2"></i>Last Sync</span>
                <span class="text-muted" style="font-size:0.85rem;">@_syncStatus.LastSyncTime.ToString("MMM dd, h:mm tt")</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-database me-2"></i>Cache Size</span>
                <span class="text-muted" style="font-size:0.85rem;">@FormatBytes(_syncStatus.CacheSizeBytes)</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-archive me-2"></i>Cached Data</span>
                <span class="text-muted" style="font-size:0.85rem;">
                    @_syncStatus.CachedJobs jobs, @_syncStatus.CachedCustomers customers, @_syncStatus.CachedAssets assets
                </span>
            </div>
        }
    </div>

    <!-- About -->
    <div class="section-header">About</div>
    <div class="mobile-card">
        @if (_appInfo != null)
        {
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-app-indicator me-2 text-primary"></i>Version</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.AppVersion (@_appInfo.BuildNumber)</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-code-slash me-2"></i>Framework</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.Framework</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-hdd me-2"></i>Database</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.DatabaseEngine</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-wifi me-2"></i>Connection</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.ApiEndpoint</span>
            </div>
        }
    </div>

    <!-- Save Button -->
    <div class="mt-3 mb-3">
        <button class="btn btn-primary w-100" @onclick="SaveSettings">
            <i class="bi bi-check-lg me-1"></i>Save Preferences
        </button>
    </div>

    @if (_saved)
    {
        <div class="alert alert-success d-flex align-items-center mb-3" role="alert"
             style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
            <i class="bi bi-check-circle-fill me-2"></i>
            Preferences saved successfully
        </div>
    }
}

@code {
    private MobileAppSettings _settings = new();
    private MobileSyncStatus? _syncStatus;
    private MobileAppInfo? _appInfo;
    private bool _loading = true;
    private bool _saved;

    protected override async Task OnInitializedAsync()
    {
        _settings = await SettingsService.GetSettingsAsync();
        _syncStatus = await SettingsService.GetSyncStatusAsync();
        _appInfo = await SettingsService.GetAppInfoAsync();
        await ApplyTheme(_settings.Theme);
        _loading = false;
    }

    private async Task SaveSettings()
    {
        await SettingsService.SaveSettingsAsync(_settings);
        await ApplyTheme(_settings.Theme);
        _saved = true;
        StateHasChanged();
        await Task.Delay(2000);
        _saved = false;
        StateHasChanged();
    }

    private async Task OnThemeChanged()
    {
        await ApplyTheme(_settings.Theme);
        await SettingsService.SaveSettingsAsync(_settings);
    }

    private async Task ApplyTheme(string theme)
    {
        var value = theme == "Dark" ? "dark" : "";
        await JS.InvokeVoidAsync("eval", "document.documentElement.setAttribute('data-theme', '" + value + "')");
    }

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024.0).ToString("0.#") + " KB";
        return (bytes / (1024.0 * 1024.0)).ToString("0.#") + " MB";
    }
}
