@page "/settings"
@inject IMobileSettingsService SettingsService
@inject IMobileAuthService AuthService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ApiClient ApiClient
@inject IServiceProvider SP
@implements IDisposable

@if (_loading)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    <!-- Back -->
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary" @onclick="GoBack">
            <i class="bi bi-arrow-left me-1"></i>Back
        </button>
    </div>

    <!-- Appearance -->
    <div class="section-header">Appearance</div>
    <div class="mobile-card">
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-palette me-2 text-primary"></i>Theme</span>
                <p class="card-subtitle mb-0">App color theme</p>
            </div>
            <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.Theme" @bind:after="OnThemeChanged">
                <option value="Light">Light</option>
                <option value="Dark">Dark</option>
            </select>
        </div>
    </div>

    <!-- Notifications -->
    <div class="section-header">Notifications</div>
    <div class="mobile-card">
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-bell me-2 text-primary"></i>Push Notifications</span>
                <p class="card-subtitle mb-0">Receive alerts on this device</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.NotificationsEnabled" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-briefcase me-2"></i>Job Alerts</span>
                <p class="card-subtitle mb-0">New assignments & status changes</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.JobAlerts"
                       disabled="@(!_settings.NotificationsEnabled)" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-box-seam me-2"></i>Inventory Alerts</span>
                <p class="card-subtitle mb-0">Low stock warnings</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.InventoryAlerts"
                       disabled="@(!_settings.NotificationsEnabled)" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-receipt me-2"></i>Estimate Alerts</span>
                <p class="card-subtitle mb-0">Expiring & approved estimates</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.EstimateAlerts"
                       disabled="@(!_settings.NotificationsEnabled)" />
            </div>
        </div>
    </div>

    <!-- Job Preferences -->
    <div class="section-header">Job Preferences</div>
    <div class="mobile-card">
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-clock-history me-2 text-primary"></i>Auto-Clock on En Route</span>
                <p class="card-subtitle mb-0">Start time tracking when you go en route</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.AutoClockOnEnRoute" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-eye me-2"></i>Show Completed Jobs</span>
                <p class="card-subtitle mb-0">Include completed jobs in lists</p>
            </div>
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" role="switch" @bind="_settings.ShowCompletedJobs" />
            </div>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-filter me-2"></i>Default Job Filter</span>
                <p class="card-subtitle mb-0">Default view when opening Jobs</p>
            </div>
            <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.DefaultJobFilter">
                <option value="All">All</option>
                <option value="Today">Today</option>
                <option value="Open">Open Only</option>
            </select>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <div>
                <span style="font-size:0.9rem;"><i class="bi bi-calendar-week me-2"></i>Calendar Default</span>
                <p class="card-subtitle mb-0">Default calendar view</p>
            </div>
            <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.DefaultCalendarView">
                <option value="Day">Day</option>
                <option value="Week">Week</option>
            </select>
        </div>
    </div>

    <!-- Sync & Storage -->
    <div class="section-header">Sync & Storage</div>
    <div class="mobile-card">
        @if (_syncStatus != null)
        {
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-cloud-check me-2 text-success"></i>Status</span>
                <span class="badge bg-success-subtle text-success" style="font-size:0.75rem;">@_syncStatus.SyncState</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-clock me-2"></i>Last Sync</span>
                <span class="text-muted" style="font-size:0.85rem;">@_syncStatus.LastSyncTime.ToString("MMM dd, h:mm tt")</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-database me-2"></i>Cache Size</span>
                <span class="text-muted" style="font-size:0.85rem;">@FormatBytes(_syncStatus.CacheSizeBytes)</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-archive me-2"></i>Cached Data</span>
                <span class="text-muted" style="font-size:0.85rem;">
                    @_syncStatus.CachedJobs jobs, @_syncStatus.CachedCustomers customers, @_syncStatus.CachedAssets assets
            </span>
        </div>
        }
    </div>

    <!-- Remote Sync Controls (only in remote mode) -->
    @if (_isRemoteMode)
    {
        <div class="section-header">Remote Sync</div>
        <div class="mobile-card">
            <!-- Sync Status -->
            <div class="d-flex justify-content-between align-items-center py-1">
                <div>
                    <span style="font-size:0.9rem;"><i class="bi bi-arrow-repeat me-2 text-primary"></i>Auto-Sync</span>
                    <p class="card-subtitle mb-0">Background sync interval</p>
                </div>
                <select class="form-select" style="width:auto; min-height:36px; font-size:0.85rem;" @bind="_settings.SyncIntervalMinutes" @bind:after="OnSyncIntervalChanged">
                    <option value="0">Off</option>
                    <option value="5">5 min</option>
                    <option value="15">15 min</option>
                    <option value="30">30 min</option>
                    <option value="60">1 hour</option>
                </select>
            </div>
            <hr class="my-2" />

            <!-- Last Remote Sync -->
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-cloud-arrow-down me-2"></i>Last Remote Sync</span>
                <span class="text-muted" style="font-size:0.85rem;">
                    @if (_syncService?.LastSyncTime != null)
                    {
                        @_syncService.LastSyncTime.Value.ToString("MMM dd, h:mm tt")
                    }
                    else
                    {
                        @:Never
                    }
                </span>
            </div>
            <hr class="my-2" />

            <!-- Background Sync Status -->
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-activity me-2"></i>Background Sync</span>
                <span class="badge @(_bgSync?.IsRunning == true ? "bg-success-subtle text-success" : "bg-secondary-subtle text-secondary")" style="font-size:0.75rem;">
                    @(_bgSync?.IsRunning == true ? "Running" : "Stopped")
                </span>
            </div>
            <hr class="my-2" />

            <!-- Manual Sync Button -->
            <button class="btn btn-outline-primary w-100" @onclick="ManualSync" disabled="@_isSyncing">
                @if (_isSyncing)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                    <span>@(_syncProgressText ?? "Syncing...")</span>
                }
                else
                {
                    <i class="bi bi-arrow-repeat me-1"></i>
                    <span>Sync Now</span>
                }
            </button>
            @if (_syncResultMessage != null)
            {
                <div class="alert @(_syncResultSuccess ? "alert-success" : "alert-danger") d-flex align-items-center mt-2 mb-0" style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
                    <i class="bi @(_syncResultSuccess ? "bi-check-circle-fill" : "bi-x-circle-fill") me-2"></i>@_syncResultMessage
                </div>
            }
        </div>

        <!-- Offline Queue -->
        <div class="section-header">Offline Queue</div>
        <div class="mobile-card">
            <div class="d-flex justify-content-between align-items-center py-1">
                <div>
                    <span style="font-size:0.9rem;"><i class="bi bi-hourglass-split me-2 @(_offlinePendingCount > 0 ? "text-warning" : "text-success")"></i>Pending Changes</span>
                    <p class="card-subtitle mb-0">Mutations waiting to be pushed to server</p>
                </div>
                <span class="badge @(_offlinePendingCount > 0 ? "bg-warning-subtle text-warning" : "bg-success-subtle text-success")" style="font-size:0.85rem;">
                    @_offlinePendingCount
                </span>
            </div>
            @if (_offlinePendingCount > 0)
            {
                <hr class="my-2" />
                @foreach (var item in _offlineItems.Take(5))
                {
                    <div class="d-flex align-items-center gap-2 py-1">
                        <i class="bi bi-arrow-up-circle text-muted" style="font-size:0.8rem;"></i>
                        <div style="flex:1; min-width:0;">
                            <p class="mb-0" style="font-size:0.8rem;">@item.Description</p>
                            <p class="mb-0 text-muted" style="font-size:0.65rem;">@item.QueuedAt.ToLocalTime().ToString("MMM dd, h:mm tt") · @item.HttpMethod @item.Endpoint</p>
                        </div>
                    </div>
                }
                @if (_offlinePendingCount > 5)
                {
                    <p class="text-muted mb-0 mt-1" style="font-size:0.75rem;">+ @(_offlinePendingCount - 5) more item(s)</p>
                }
                <hr class="my-2" />
                <button class="btn btn-sm btn-outline-warning w-100" @onclick="ProcessOfflineQueue" disabled="@_processingQueue">
                    @if (_processingQueue)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-cloud-upload me-1"></i>Push Pending Changes
                </button>
            }
        </div>
    }

    <!-- Testing & Demo -->
    <div class="section-header">Testing & Demo</div>
    <div class="mobile-card">
        <div class="py-1">
            <span style="font-size:0.9rem;"><i class="bi bi-database-gear me-2 text-warning"></i>Seed Demo Data</span>
            <p class="card-subtitle mb-0">Load sample HVAC data for testing (customers, jobs, assets, etc.)</p>
        </div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between align-items-center py-1">
            <span style="font-size:0.85rem;" class="@(_hasData ? "text-success" : "text-muted")">
                <i class="bi @(_hasData ? "bi-check-circle-fill" : "bi-x-circle") me-1"></i>
                @(_hasData ? "Database has data" : "Database is empty")
            </span>
        </div>
        <hr class="my-2" />
        @if (!_confirmSeed)
        {
            <button class="btn btn-warning w-100" @onclick="() => _confirmSeed = true" disabled="@(_seeding || _hasData)">
                <i class="bi bi-database-add me-1"></i>@(_hasData ? "Demo Data Already Loaded" : "Load Demo Data")
            </button>
        }
        else
        {
            <div class="alert alert-warning py-2 mb-2" style="font-size:0.85rem;">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>This will populate the database with sample HVAC data. Continue?
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-warning flex-fill" @onclick="SeedDemoData" disabled="@_seeding">
                    @if (_seeding)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Yes, Load Demo Data
                </button>
                <button class="btn btn-outline-secondary flex-fill" @onclick="() => _confirmSeed = false" disabled="@_seeding">Cancel</button>
            </div>
        }
        @if (_seedSuccess)
        {
            <div class="alert alert-success d-flex align-items-center mt-2 mb-0" style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
                <i class="bi bi-check-circle-fill me-2"></i>Demo data loaded successfully!
            </div>
        }
        @if (_seedError != null)
        {
            <div class="alert alert-danger d-flex align-items-center mt-2 mb-0" style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
                <i class="bi bi-x-circle-fill me-2"></i>@_seedError
            </div>
        }
    </div>

    <!-- About -->
    <div class="section-header">About</div>
    <div class="mobile-card">
        @if (_appInfo != null)
        {
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-app-indicator me-2 text-primary"></i>Version</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.AppVersion (@_appInfo.BuildNumber)</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-code-slash me-2"></i>Framework</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.Framework</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-hdd me-2"></i>Database</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.DatabaseEngine</span>
            </div>
            <hr class="my-2" />
            <div class="d-flex justify-content-between align-items-center py-1">
                <span style="font-size:0.9rem;"><i class="bi bi-wifi me-2"></i>Connection</span>
                <span class="text-muted" style="font-size:0.85rem;">@_appInfo.ApiEndpoint</span>
            </div>
        }
    </div>

    <!-- Database Connection -->
    <div class="section-header">Database Connection</div>
    <div class="mobile-card">
        <div class="py-1">
            <span style="font-size:0.9rem;"><i class="bi bi-hdd-network me-2 text-primary"></i>Connection Mode</span>
            <p class="card-subtitle mb-0">Switch between local and remote database</p>
        </div>
        <hr class="my-2" />
        <div class="d-flex gap-2 mb-2">
            <button class="btn btn-sm flex-fill @(_dbMode == "Local" ? "btn-primary" : "btn-outline-primary")" @onclick='() => _dbMode = "Local"'>
                <i class="bi bi-phone me-1"></i>Local
            </button>
            <button class="btn btn-sm flex-fill @(_dbMode == "Remote" ? "btn-primary" : "btn-outline-primary")" @onclick='() => _dbMode = "Remote"'>
                <i class="bi bi-cloud me-1"></i>Remote
            </button>
        </div>

        @if (_dbMode == "Remote")
        {
            <div class="mb-2">
                <label class="form-label small mb-1">Server URL</label>
                <input type="text" class="form-control form-control-sm" @bind="_serverUrl"
                       placeholder="http://192.168.1.100:6000" />
                <small class="text-muted d-block mt-1">
                    <i class="bi bi-info-circle me-1"></i>Use your server's LAN IP and exposed port (not localhost)
                </small>
            </div>
            <div class="mb-2">
                <label class="form-label small mb-1">Sync Username</label>
                <input type="text" class="form-control form-control-sm" @bind="_syncUsername"
                       placeholder="sync_user" />
            </div>
            <div class="mb-2">
                <label class="form-label small mb-1">Sync Password</label>
                <input type="password" class="form-control form-control-sm" @bind="_syncPassword"
                       placeholder="sync password" />
            </div>
        }
        else
        {
            <p class="small text-muted mb-0"><i class="bi bi-info-circle me-1"></i>Using local SQLite database on this device.</p>
        }

        <hr class="my-2" />
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-fill" @onclick="SaveDbConnection" disabled="@_savingDbConfig">
                @if (_savingDbConfig)
                {
                    <span class="spinner-border spinner-border-sm me-1"></span>
                }
                <i class="bi bi-check-lg me-1"></i>Save Connection
            </button>
            @if (_dbMode == "Remote")
            {
                <button class="btn btn-sm btn-outline-info flex-fill" @onclick="TestConnection" disabled="@_testingConnection">
                    @if (_testingConnection)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-wifi me-1"></i>Test
                </button>
            }
        </div>
        @if (_dbConfigSaved)
        {
            <div class="alert alert-success d-flex align-items-center mt-2 mb-0" style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
                <i class="bi bi-check-circle-fill me-2"></i>@_dbConfigMessage
            </div>
        }
        @if (!string.IsNullOrEmpty(_dbConfigError))
        {
            <div class="alert alert-danger d-flex align-items-center mt-2 mb-0" style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
                <i class="bi bi-x-circle-fill me-2"></i>@_dbConfigError
            </div>
        }
        @if (!string.IsNullOrEmpty(_testConnectionResult))
        {
            <div class="alert @(_testConnectionSuccess ? "alert-success" : "alert-danger") mt-2 mb-0" style="font-size:0.82rem; padding:10px 12px; border-radius:10px;">
                <div class="d-flex align-items-center mb-1">
                    <i class="bi @(_testConnectionSuccess ? "bi-check-circle-fill text-success" : "bi-x-circle-fill text-danger") me-2"></i>
                    <strong>@(_testConnectionSuccess ? "Connected" : "Connection Failed")</strong>
                </div>
                <div class="ps-4">
                    <div>@_testConnectionResult</div>
                    @if (!string.IsNullOrWhiteSpace(_serverUrl))
                    {
                        <div class="text-muted mt-1"><i class="bi bi-link-45deg me-1"></i>URL: @_serverUrl.Trim()/health</div>
                    }
                    @if (!_testConnectionSuccess)
                    {
                        <hr class="my-2" />
                        <div class="small text-muted">
                            <strong>Troubleshooting:</strong>
                            <ul class="mb-0 ps-3 mt-1">
                                <li>URL must start with <code>http://</code> or <code>https://</code></li>
                                <li>Use your server's LAN IP (not <code>localhost</code>)</li>
                                <li>Port must match Docker mapping (e.g., <code>6000</code> for test)</li>
                                <li>Ensure phone is on the same Wi-Fi network</li>
                                <li>Check server firewall allows the port</li>
                                <li>Verify Docker container is running</li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Save Button -->
    <div class="mt-3 mb-3">
        <button class="btn btn-primary w-100" @onclick="SaveSettings">
            <i class="bi bi-check-lg me-1"></i>Save Preferences
        </button>
    </div>

    @if (_saved)
    {
        <div class="alert alert-success d-flex align-items-center mb-3" role="alert"
             style="font-size:0.85rem; padding:8px 12px; border-radius:10px;">
            <i class="bi bi-check-circle-fill me-2"></i>
            Preferences saved successfully
        </div>
    }
}

@code {
private MobileAppSettings _settings = new();
private MobileSyncStatus? _syncStatus;
private MobileAppInfo? _appInfo;
private bool _loading = true;
private bool _saved;
private bool _hasData;
private bool _seeding;
private bool _confirmSeed;
private bool _seedSuccess;
private string? _seedError;

// Database connection state
private string _dbMode = "Local";
private string _serverUrl = "";
private string _syncUsername = "";
private string _syncPassword = "";
private bool _savingDbConfig;
private bool _dbConfigSaved;
private string? _dbConfigMessage;
private string? _dbConfigError;
private bool _testingConnection;
private string? _testConnectionResult;
private bool _testConnectionSuccess;

// Remote sync state
private bool _isRemoteMode;
private ISyncService? _syncService;
private BackgroundSyncService? _bgSync;
private IOfflineQueueService? _offlineQueue;
private bool _isSyncing;
private string? _syncProgressText;
private string? _syncResultMessage;
private bool _syncResultSuccess;
private int _offlinePendingCount;
private List<OfflineQueueItem> _offlineItems = [];
private bool _processingQueue;

protected override async Task OnInitializedAsync()
{
    _settings = await SettingsService.GetSettingsAsync();
    _syncStatus = await SettingsService.GetSyncStatusAsync();
    _appInfo = await SettingsService.GetAppInfoAsync();
    _hasData = await SettingsService.HasDataAsync();
    await ApplyTheme(_settings.Theme);

    // Load saved DB connection settings
    _dbMode = Preferences.Default.Get("db_mode", "Local");
    _isRemoteMode = _dbMode == "Remote";
    _serverUrl = Preferences.Default.Get("db_server_url", "");
    _syncUsername = Preferences.Default.Get("db_sync_username", "");
    try
    {
        _syncPassword = await SecureStorage.Default.GetAsync("db_sync_password") ?? "";
    }
    catch
    {
        _syncPassword = "";
    }

    // Resolve optional remote-mode services
    if (_isRemoteMode)
    {
        _syncService = SP.GetService<ISyncService>();
        _bgSync = SP.GetService<BackgroundSyncService>();
        _offlineQueue = SP.GetService<IOfflineQueueService>();
        RefreshOfflineQueueState();

        if (_syncService is not null)
            _syncService.OnSyncProgress += HandleSyncProgress;
    }

    _loading = false;
}

    private async Task SaveSettings()
    {
        await SettingsService.SaveSettingsAsync(_settings);
        await ApplyTheme(_settings.Theme);
        _saved = true;
        StateHasChanged();
        await Task.Delay(2000);
        _saved = false;
        StateHasChanged();
    }

    private async Task OnThemeChanged()
    {
        await ApplyTheme(_settings.Theme);
        await SettingsService.SaveSettingsAsync(_settings);
    }

    private async Task SeedDemoData()
    {
        _seeding = true;
        _seedSuccess = false;
        _seedError = null;
        StateHasChanged();
        try
        {
            var result = await SettingsService.SeedDemoDataAsync();
            if (result)
            {
                _seedSuccess = true;
                _hasData = true;
                _confirmSeed = false;
                _syncStatus = await SettingsService.GetSyncStatusAsync();
            }
            else
            {
                _seedError = "Database already contains data or seeding failed.";
            }
        }
        catch (Exception ex)
        {
            _seedError = $"Seeding failed: {ex.Message}";
        }
        finally
        {
            _seeding = false;
            StateHasChanged();
        }
    }

    private async Task ApplyTheme(string theme)
    {
        var value = theme == "Dark" ? "dark" : "";
        await JS.InvokeVoidAsync("eval", "document.documentElement.setAttribute('data-theme', '" + value + "')");
    }

    private string FormatBytes(long bytes)
    {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024.0).ToString("0.#") + " KB";
        return (bytes / (1024.0 * 1024.0)).ToString("0.#") + " MB";
    }

    private async Task TestConnection()
    {
        _testingConnection = true;
        _testConnectionResult = null;
        StateHasChanged();

        try
        {
            // Temporarily save the URL so ApiClient can read it
            var currentUrl = Preferences.Default.Get("db_server_url", "");
            Preferences.Default.Set("db_server_url", _serverUrl.Trim());

            var (reachable, message) = await ApiClient.TestConnectionAsync();
            _testConnectionSuccess = reachable;
            _testConnectionResult = message;

            // Restore previous URL if not saved yet
            Preferences.Default.Set("db_server_url", currentUrl);
        }
        catch (Exception ex)
        {
            _testConnectionSuccess = false;
            _testConnectionResult = $"Error: {ex.Message}";
        }
        finally
        {
            _testingConnection = false;
            StateHasChanged();
        }
    }

    private async Task SaveDbConnection()
    {
        _savingDbConfig = true;
        _dbConfigSaved = false;
        _dbConfigError = null;
        StateHasChanged();

        try
        {
            var previousMode = Preferences.Default.Get("db_mode", "Local");
            var modeChanged = previousMode != _dbMode;

            Preferences.Default.Set("db_mode", _dbMode);
            Preferences.Default.Set("db_server_url", _dbMode == "Remote" ? _serverUrl.Trim() : "");
            Preferences.Default.Set("db_sync_username", _dbMode == "Remote" ? _syncUsername.Trim() : "");

            if (_dbMode == "Remote" && !string.IsNullOrWhiteSpace(_syncPassword))
            {
                await SecureStorage.Default.SetAsync("db_sync_password", _syncPassword);
            }
            else
            {
                SecureStorage.Default.Remove("db_sync_password");
            }

            // Clear session when switching database modes
            if (modeChanged)
            {
                await AuthService.LogoutAsync();
                System.Diagnostics.Debug.WriteLine($"[SETTINGS] Database mode changed from {previousMode} to {_dbMode} - session cleared");
            }

            // Update app info display
            if (_appInfo is not null)
            {
                _appInfo.ApiEndpoint = _dbMode == "Remote" ? _serverUrl : "Local (Offline)";
            }

            _dbConfigSaved = true;
            _dbConfigMessage = modeChanged
                ? $"Switched to {_dbMode} database. You will be logged out. Please restart the app and log in again."
                : "Connection settings saved.";

            // If mode changed, redirect to login after 2 seconds
            if (modeChanged)
            {
                await Task.Delay(2000);
                Nav.NavigateTo("/login", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            _dbConfigError = $"Failed to save: {ex.Message}";
        }
        finally
        {
            _savingDbConfig = false;
            StateHasChanged();
        }
    }

    private void HandleSyncProgress(SyncProgressInfo info)
    {
        _isSyncing = info.IsRunning;
        _syncProgressText = info.StatusMessage;
        InvokeAsync(StateHasChanged);
    }

    private async Task ManualSync()
    {
        if (_syncService is null || _isSyncing) return;

        _syncResultMessage = null;
        _isSyncing = true;
        StateHasChanged();

        var result = await _syncService.SyncAllAsync();

        _isSyncing = false;
        _syncResultSuccess = result.Succeeded;
        _syncResultMessage = result.Succeeded
            ? $"Synced {result.EntitiesSynced} records successfully"
            : $"Sync failed: {result.ErrorMessage}";

        // Refresh local data after sync
        _syncStatus = await SettingsService.GetSyncStatusAsync();
        RefreshOfflineQueueState();
        StateHasChanged();

        if (result.Succeeded)
        {
            _ = ClearSyncResultMessage();
        }
    }

    private async Task ClearSyncResultMessage()
    {
        await Task.Delay(4000);
        _syncResultMessage = null;
        await InvokeAsync(StateHasChanged);
    }

    private void OnSyncIntervalChanged()
    {
        _bgSync?.SetInterval(_settings.SyncIntervalMinutes);
        if (_settings.SyncIntervalMinutes > 0 && _bgSync is not null && !_bgSync.IsRunning)
            _bgSync.Start();
    }

    private async Task ProcessOfflineQueue()
    {
        if (_offlineQueue is null) return;

        _processingQueue = true;
        StateHasChanged();

        try
        {
            var pushed = await _offlineQueue.ProcessQueueAsync();
            RefreshOfflineQueueState();

            _syncResultSuccess = true;
            _syncResultMessage = pushed > 0
                ? $"Pushed {pushed} offline change(s) to server"
                : "No items could be pushed (will retry on next sync)";
            _ = ClearSyncResultMessage();
        }
        catch (Exception ex)
        {
            _syncResultSuccess = false;
            _syncResultMessage = $"Queue processing failed: {ex.Message}";
        }
        finally
        {
            _processingQueue = false;
            StateHasChanged();
        }
    }

    private void RefreshOfflineQueueState()
    {
        if (_offlineQueue is null) return;
        _offlinePendingCount = _offlineQueue.PendingCount;
        _offlineItems = _offlineQueue.GetPending();
    }

    private async Task GoBack()
    {
        var went = await JS.InvokeAsync<bool>("goBack");
        if (!went) Nav.NavigateTo("/profile");
    }

    public void Dispose()
    {
        if (_syncService is not null)
            _syncService.OnSyncProgress -= HandleSyncProgress;
    }
}
