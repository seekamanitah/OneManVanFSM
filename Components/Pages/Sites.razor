@page "/sites"
@inject IMobileSiteService SiteService
@inject NavigationManager Nav

@if (_loading)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    <!-- Stats Row -->
    <div class="gap-grid mb-2">
        <div class="stat-card">
            <div class="stat-icon text-primary"><i class="bi bi-building"></i></div>
            <div class="stat-value">@_stats.TotalSites</div>
            <div class="stat-label">Total Sites</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon text-info"><i class="bi bi-house-door"></i></div>
            <div class="stat-value">@_stats.ResidentialCount</div>
            <div class="stat-label">Residential</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon text-warning"><i class="bi bi-shop"></i></div>
            <div class="stat-value">@_stats.CommercialCount</div>
            <div class="stat-label">Commercial</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon text-success"><i class="bi bi-cpu"></i></div>
            <div class="stat-value">@_stats.TotalAssets</div>
            <div class="stat-label">Assets</div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="d-flex gap-2 mb-3">
        <select class="form-select" style="max-width:150px;" @bind="_typeFilter" @bind:after="LoadSites">
            <option value="">All Types</option>
            @foreach (var t in Enum.GetValues<PropertyType>())
            {
                <option value="@t">@t</option>
            }
        </select>
        <input type="search" class="form-control" placeholder="Search sites…" @bind="_search"
               @bind:event="oninput" @bind:after="LoadSites" />
        <button class="btn btn-outline-secondary" style="min-width:38px; padding:4px 8px;" @onclick="LoadSites" title="Refresh">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>

    <!-- Count + Sort -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted" style="font-size:0.75rem;">@_sites.Count site@(_sites.Count != 1 ? "s" : "") found</span>
        <button class="btn btn-sm btn-outline-secondary" style="font-size:0.7rem; padding:2px 8px; border-radius:12px;" @onclick="ToggleSort">
            <i class="bi @(_sortMode == "recent" ? "bi-clock-history" : _sortMode == "assets" ? "bi-cpu" : "bi-sort-alpha-down") me-1"></i>@SortLabel()
        </button>
    </div>

    @if (_sites.Any())
    {
        @foreach (var site in SortedSites)
        {
            <div class="mobile-card" @onclick="() => GoToSite(site.Id)">
                <div class="mobile-card-header">
                    <div style="min-width:0;">
                        <span class="card-title">@site.Name</span>
                    </div>
                    <span class="badge bg-@TypeColor(site.PropertyType)" style="font-size:0.65rem; white-space:nowrap;">
                        @site.PropertyType
                    </span>
                </div>

                @if (site.Address != null)
                {
                    <p class="card-subtitle mb-1">
                        <i class="bi bi-geo-alt me-1"></i>@site.Address@(site.City != null ? $", {site.City}" : "")@(site.State != null ? $" {site.State}" : "")
                    </p>
                }
                @if (site.CustomerName != null)
                {
                    <p class="card-subtitle mb-0">
                        <i class="bi bi-person me-1"></i>@site.CustomerName
                    </p>
                }

                <div class="d-flex flex-wrap gap-1 mt-1">
                    @if (site.AssetCount > 0)
                    {
                        <span class="badge bg-light text-dark" style="font-size:0.6rem;">
                            <i class="bi bi-cpu me-1"></i>@site.AssetCount asset@(site.AssetCount != 1 ? "s" : "")
                        </span>
                    }
                    @if (site.JobCount > 0)
                    {
                        <span class="badge bg-light text-dark" style="font-size:0.6rem;">
                            <i class="bi bi-wrench me-1"></i>@site.JobCount job@(site.JobCount != 1 ? "s" : "")
                        </span>
                    }
                    @if (site.LastJobDate.HasValue)
                    {
                        <span class="badge bg-light text-dark" style="font-size:0.6rem;">
                            <i class="bi bi-calendar3 me-1"></i>Last: @site.LastJobDate.Value.ToString("MMM dd")
                        </span>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-building d-block"></i>
            <p>No sites found</p>
        </div>
    }
}

@code {
    private List<MobileSiteCard> _sites = [];
    private MobileSiteStats _stats = new();
    private bool _loading = true;
    private string _search = string.Empty;
    private string _typeFilter = string.Empty;
    private string _sortMode = "name";

    private IEnumerable<MobileSiteCard> SortedSites => _sortMode switch
    {
        "recent" => _sites.OrderByDescending(s => s.LastJobDate ?? DateTime.MinValue).ThenBy(s => s.Name),
        "assets" => _sites.OrderByDescending(s => s.AssetCount).ThenBy(s => s.Name),
        _ => _sites.OrderBy(s => s.Name)
    };

    private void ToggleSort()
    {
        _sortMode = _sortMode switch
        {
            "name" => "recent",
            "recent" => "assets",
            _ => "name"
        };
    }

    private string SortLabel() => _sortMode switch
    {
        "recent" => "Recent",
        "assets" => "Assets",
        _ => "Name"
    };

    protected override async Task OnInitializedAsync()
    {
        _stats = await SiteService.GetStatsAsync();
        await LoadSites();
    }

    private async Task LoadSites()
    {
        _loading = true;
        StateHasChanged();

        PropertyType? type = Enum.TryParse<PropertyType>(_typeFilter, out var parsed) ? parsed : null;

        var filter = new MobileSiteFilter
        {
            Search = string.IsNullOrWhiteSpace(_search) ? null : _search,
            PropertyType = type,
        };

        _sites = await SiteService.GetSitesAsync(filter);
        _loading = false;
    }

    private void GoToSite(int id) => Nav.NavigateTo($"/sites/{id}");

    private static string TypeColor(PropertyType type) => type switch
    {
        PropertyType.Residential => "info",
        PropertyType.Commercial => "warning",
        PropertyType.Industrial => "dark",
        _ => "secondary"
    };
}
