@page "/notifications"
@inject IMobileDashboardService DashboardService
@inject IMobileInventoryService InventoryService
@inject IMobileEstimateService EstimateService
@inject IMobileServiceAgreementService AgreementService
@inject IMobileAuthService AuthService
@inject NavigationManager Nav

<!-- Header Row -->
<div class="d-flex justify-content-between align-items-center mb-2">
    <span class="text-muted" style="font-size:0.75rem;">@_notifications.Count notification@(_notifications.Count != 1 ? "s" : "") · Updated @_lastUpdated.ToString("h:mm tt")</span>
    <button class="btn btn-sm btn-outline-secondary" style="font-size:0.75rem; padding:2px 10px;" @onclick="RefreshNotifications">
        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
    </button>
</div>

<!-- Filter Chips -->
<div class="d-flex gap-2 mb-3 flex-wrap">
    @foreach (var cat in _categories)
    {
        <button class="btn btn-sm @(cat == _filter ? "btn-primary" : "btn-outline-secondary")"
                style="border-radius:20px; font-size:0.75rem; padding:4px 12px;"
                @onclick="() => SetFilter(cat)">
            @cat
        </button>
    }
</div>

@if (!_loading && _notifications.Any(n => !n.IsRead))
{
    <div class="d-flex justify-content-end mb-2">
        <button class="btn btn-sm btn-outline-secondary" style="font-size:0.75rem;" @onclick="MarkAllRead">
            <i class="bi bi-check-all me-1"></i>Mark All Read
        </button>
    </div>
}

@if (_loading)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (FilteredNotifications.Any())
{
    @foreach (var group in FilteredNotifications.GroupBy(n => n.Timestamp.Date).OrderByDescending(g => g.Key))
    {
        <div class="section-header">
            @if (group.Key == DateTime.UtcNow.Date)
            {
                @:Today
            }
            else if (group.Key == DateTime.UtcNow.Date.AddDays(-1))
            {
                @:Yesterday
            }
            else
            {
                @group.Key.ToString("MMM dd, yyyy")
            }
        </div>
        @foreach (var notif in group.OrderByDescending(n => n.Timestamp))
        {
            <div class="mobile-card notification-item @(notif.IsRead ? "" : "unread")" @onclick="() => HandleTap(notif)">
                <div class="d-flex align-items-start gap-2">
                    <div class="notif-icon-wrap @notif.ColorClass">
                        <i class="bi @notif.Icon"></i>
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div class="d-flex justify-content-between align-items-start">
                            <p class="mb-0 fw-semibold" style="font-size:0.85rem;">@notif.Title</p>
                            @if (notif.Category != "All")
                            {
                                <span class="badge bg-light text-muted" style="font-size:0.55rem;">@notif.Category</span>
                            }
                        </div>
                        <p class="card-subtitle mb-0">@notif.Description</p>
                        <p class="mb-0 text-muted" style="font-size:0.7rem;">@notif.Timestamp.ToString("h:mm tt")</p>
                    </div>
                    @if (!notif.IsRead)
                    {
                        <span class="unread-dot"></span>
                    }
                </div>
            </div>
        }
    }
}
else
{
    <div class="empty-state">
        <i class="bi bi-bell-slash d-block"></i>
        <p>No notifications</p>
    </div>
}

@code {
private int _employeeId;
private List<NotificationItem> _notifications = [];
private bool _loading = true;
private string _filter = "All";
private DateTime _lastUpdated = DateTime.Now;
private readonly string[] _categories = ["All", "Jobs", "Inventory", "Estimates", "Notes", "Agreements"];

private IEnumerable<NotificationItem> FilteredNotifications =>
    _filter == "All"
        ? _notifications
        : _notifications.Where(n => n.Category == _filter);

protected override async Task OnInitializedAsync()
{
    _employeeId = await AuthService.GetEmployeeIdAsync() ?? 0;
    await LoadNotifications();
}

    private async Task RefreshNotifications()
    {
        await LoadNotifications();
    }

    private void SetFilter(string category)
    {
        _filter = category;
    }

    private async Task LoadNotifications()
    {
        _loading = true;
        var items = new List<NotificationItem>();

        var dashboard = await DashboardService.GetDashboardAsync(_employeeId);

        // Today's upcoming jobs
        foreach (var job in dashboard.TodayJobs)
        {
            items.Add(new NotificationItem
            {
                Title = job.Status == JobStatus.Scheduled ? "Upcoming Job" : "Job " + job.Status,
                Description = job.JobNumber + " - " + (job.Title ?? "Untitled") + " at " + (job.SiteAddress ?? "Unknown"),
                Icon = job.Priority == JobPriority.Emergency ? "bi-exclamation-triangle-fill" : "bi-wrench-adjustable",
                ColorClass = job.Priority == JobPriority.Emergency ? "bg-danger-subtle" : "bg-primary-subtle",
                Timestamp = DateTime.UtcNow.Date.Add(job.ScheduledTime ?? TimeSpan.Zero),
                NavigateTo = "/jobs/" + job.Id,
                IsRead = job.Status != JobStatus.Scheduled,
                Category = "Jobs",
            });
        }

        // Overdue jobs
        if (dashboard.OverdueJobCount > 0)
        {
            items.Add(new NotificationItem
            {
                Title = "Overdue Jobs",
                Description = dashboard.OverdueJobCount + " job(s) past scheduled date",
                Icon = "bi-exclamation-circle-fill",
                ColorClass = "bg-danger-subtle",
                Timestamp = DateTime.UtcNow,
                NavigateTo = "/jobs",
                IsRead = false,
                Category = "Jobs",
            });
        }

        // Upcoming jobs (next 3 days)
        foreach (var job in dashboard.UpcomingJobs)
        {
            items.Add(new NotificationItem
            {
                Title = "Upcoming: " + (job.Title ?? job.JobNumber),
                Description = (job.CustomerName ?? "Customer") + " - " + (job.ScheduledDate?.ToString("MMM dd") ?? "TBD"),
                Icon = "bi-calendar-event",
                ColorClass = "bg-info-subtle",
                Timestamp = job.ScheduledDate?.Date.Add(job.ScheduledTime ?? TimeSpan.Zero) ?? DateTime.UtcNow,
                NavigateTo = "/jobs/" + job.Id,
                IsRead = true,
                Category = "Jobs",
            });
        }

        // Recent activity
        foreach (var activity in dashboard.RecentActivity)
        {
            items.Add(new NotificationItem
            {
                Title = "Job Update",
                Description = activity.Description,
                Icon = activity.Icon.Contains("check") ? "bi-check-circle-fill" : "bi-info-circle",
                ColorClass = activity.Icon.Contains("check") ? "bg-success-subtle" : "bg-info-subtle",
                Timestamp = activity.Timestamp,
                IsRead = true,
                Category = "Jobs",
            });
        }

        // Urgent notes
        if (dashboard.PendingNoteCount > 0)
        {
            items.Add(new NotificationItem
            {
                Title = "Urgent Notes",
                Description = dashboard.PendingNoteCount + " urgent note(s) need attention",
                Icon = "bi-journal-text",
                ColorClass = "bg-warning-subtle",
                Timestamp = DateTime.UtcNow,
                NavigateTo = "/notes",
                IsRead = false,
                Category = "Notes",
            });
        }

        // Low stock items
        if (dashboard.LowStockCount > 0)
        {
            try
            {
                var inventory = await InventoryService.GetInventoryAsync(new MobileInventoryFilter { LowStockOnly = true });
                foreach (var item in inventory.Take(3))
                {
                    items.Add(new NotificationItem
                    {
                        Title = "Low Stock: " + item.Name,
                        Description = item.Quantity + " remaining (min " + item.MinThreshold + ") - " + item.Location,
                        Icon = "bi-box-seam",
                        ColorClass = "bg-warning-subtle",
                        Timestamp = DateTime.UtcNow.AddMinutes(-10),
                        NavigateTo = "/inventory",
                        IsRead = false,
                        Category = "Inventory",
                    });
                }
            }
            catch { }
        }

        // Expiring estimates
        try
        {
            var estimates = await EstimateService.GetEstimatesAsync(new MobileEstimateFilter { Status = EstimateStatus.Sent });
            foreach (var est in estimates.Where(e => e.ExpiryDate.HasValue && e.ExpiryDate.Value < DateTime.UtcNow.AddDays(7)).Take(3))
            {
                items.Add(new NotificationItem
                {
                    Title = "Estimate Expiring",
                    Description = est.EstimateNumber + " - " + (est.Title ?? "Untitled") + " exp " + (est.ExpiryDate?.ToString("MMM dd") ?? ""),
                    Icon = "bi-calculator",
                    ColorClass = "bg-warning-subtle",
                    Timestamp = est.ExpiryDate?.AddDays(-7) ?? DateTime.UtcNow,
                    NavigateTo = "/estimates/" + est.Id,
                    IsRead = false,
                    Category = "Estimates",
                });
            }
        }
        catch { }

        // Expiring agreements
        try
        {
            var agreements = await AgreementService.GetAgreementsAsync("Active");
            foreach (var sa in agreements.Where(a => a.EndDate <= DateTime.UtcNow.AddDays(30)).Take(5))
            {
                var daysLeft = (sa.EndDate - DateTime.UtcNow.Date).Days;
                items.Add(new NotificationItem
                {
                    Title = daysLeft <= 0 ? "Agreement Expired" : "Agreement Expiring Soon",
                    Description = sa.AgreementNumber + " - " + (sa.Title ?? "Untitled") + (daysLeft > 0 ? " expires in " + daysLeft + " days" : " has expired"),
                    Icon = daysLeft <= 0 ? "bi-file-earmark-x-fill" : "bi-file-earmark-lock",
                    ColorClass = daysLeft <= 0 ? "bg-danger-subtle" : "bg-warning-subtle",
                    Timestamp = sa.EndDate,
                    NavigateTo = "/agreements/" + sa.Id,
                    IsRead = daysLeft > 7,
                    Category = "Agreements",
                });
            }
        }
        catch { }

        // Expiring agreements with no visits remaining
        try
        {
            var agreements = await AgreementService.GetAgreementsAsync("Active");
            foreach (var sa in agreements.Where(a => a.VisitsRemaining == 0 && a.EndDate > DateTime.UtcNow).Take(3))
            {
                items.Add(new NotificationItem
                {
                    Title = "No Visits Remaining",
                    Description = sa.AgreementNumber + " - " + (sa.CustomerName ?? "Customer") + " has used all " + sa.VisitsIncluded + " visits",
                    Icon = "bi-calendar-x",
                    ColorClass = "bg-info-subtle",
                    Timestamp = DateTime.UtcNow.AddHours(-2),
                    NavigateTo = "/agreements/" + sa.Id,
                    IsRead = true,
                    Category = "Agreements",
                });
            }
        }
        catch { }
        _notifications = items;
        _lastUpdated = DateTime.Now;
        _loading = false;
    }

    private void HandleTap(NotificationItem notif)
    {
        notif.IsRead = true;
        if (!string.IsNullOrEmpty(notif.NavigateTo))
        {
            Nav.NavigateTo(notif.NavigateTo);
        }
    }

    private void MarkAllRead()
    {
        foreach (var notif in _notifications)
        {
            notif.IsRead = true;
        }
    }

    private class NotificationItem
    {
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Icon { get; set; } = "bi-bell";
        public string ColorClass { get; set; } = "bg-info-subtle";
        public DateTime Timestamp { get; set; }
        public string? NavigateTo { get; set; }
        public bool IsRead { get; set; }
        public string Category { get; set; } = "All";
    }
}
