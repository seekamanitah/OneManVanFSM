@page "/assets"
@inject IMobileAssetService AssetService
@inject IMobileCustomerService CustomerService
@inject IMobileSiteService SiteService
@inject NavigationManager Nav

@if (_loading)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    @if (_showCreate)
    {
        <div class="mobile-card" style="padding:0.75rem;">
            <h6 class="fw-bold mb-2" style="font-size:0.85rem;"><i class="bi bi-cpu-fill me-1"></i>Quick Add Asset</h6>
            <div class="mb-1">
                <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_newAsset.CustomerId">
                    <option value="">Customer (optional)</option>
                    @foreach (var c in _customerOpts) { <option value="@c.Id">@c.Name</option> }
                </select>
            </div>
            <div class="mb-1">
                <select class="form-select" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" @bind="_newAsset.SiteId">
                    <option value="">Site (optional)</option>
                    @foreach (var s in _siteOpts) { <option value="@s.Id">@s.Name</option> }
                </select>
            </div>
            <div class="mb-1">
                <input type="text" class="form-control" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" placeholder="Brand" @bind="_newAsset.Brand" />
            </div>
            <div class="mb-1">
                <input type="text" class="form-control" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" placeholder="Model" @bind="_newAsset.Model" />
            </div>
            <div class="mb-1">
                <input type="text" class="form-control" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" placeholder="Serial Number *" @bind="_newAsset.SerialNumber" />
            </div>
            <div class="mb-1">
                <input type="text" class="form-control" style="min-height:38px; font-size:0.9rem; padding:6px 10px;" placeholder="Equipment type (e.g., AC Unit, Furnace)" @bind="_newAsset.AssetType" />
            </div>
            <div class="alert alert-info py-1 px-2 mb-1" style="font-size:0.75rem;">
                <i class="bi bi-info-circle me-1"></i>Complete specs, warranty, and efficiency details on the web app.
            </div>
            <div class="d-flex gap-2 mt-1">
                <button class="btn btn-primary flex-fill" style="min-height:40px;" @onclick="SaveAsset" disabled="@string.IsNullOrWhiteSpace(_newAsset.SerialNumber)">
                    <i class="bi bi-check-lg me-1"></i>Save
                </button>
                <button class="btn btn-outline-secondary" style="min-height:40px;" @onclick="() => _showCreate = false">Cancel</button>
            </div>
            @if (_saveError != null)
            {
                <div class="alert alert-danger mt-2 py-1" style="font-size:0.8rem;">@_saveError</div>
            }
        </div>
    }

    <!-- Stats Row -->
    <div class="gap-grid mb-2">
        <div class="stat-card">
            <div class="stat-icon text-primary"><i class="bi bi-cpu"></i></div>
            <div class="stat-value">@_stats.TotalAssets</div>
            <div class="stat-label">Total Assets</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon text-success"><i class="bi bi-check-circle"></i></div>
            <div class="stat-value">@_stats.ActiveCount</div>
            <div class="stat-label">Active</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon text-warning"><i class="bi bi-tools"></i></div>
            <div class="stat-value">@_stats.MaintenanceNeededCount</div>
            <div class="stat-label">Needs Service</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon text-danger"><i class="bi bi-shield-exclamation"></i></div>
            <div class="stat-value">@_stats.ExpiringWarrantyCount</div>
            <div class="stat-label">Warranty Soon</div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="d-flex gap-2 mb-3">
        <select class="form-select" style="max-width:140px;" @bind="_statusFilter" @bind:after="LoadAssets">
            <option value="">All Status</option>
            @foreach (var s in Enum.GetValues<AssetStatus>())
            {
                <option value="@s">@s</option>
            }
        </select>
        <input type="search" class="form-control" placeholder="Search assets…" @bind="_search"
               @bind:event="oninput" @bind:after="LoadAssets" />
        <button class="btn btn-outline-secondary" style="min-width:38px; padding:4px 8px;" @onclick="LoadAssets" title="Refresh">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>

    <!-- Count -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="text-muted" style="font-size:0.75rem;">@_assets.Count asset@(_assets.Count != 1 ? "s" : "") found</span>
        <button class="btn btn-sm btn-outline-secondary" style="font-size:0.7rem; padding:2px 8px; border-radius:12px;" @onclick="ToggleSort">
            <i class="bi @(_sortMode == "status" ? "bi-check-circle" : _sortMode == "warranty" ? "bi-shield" : "bi-sort-alpha-down") me-1"></i>@SortLabel()
        </button>
    </div>

    @if (_assets.Any())
    {
        @foreach (var asset in SortedAssets)
        {
            <div class="mobile-card" @onclick="() => GoToAsset(asset.Id)">
                <div class="mobile-card-header">
                    <div style="min-width:0;">
                        <span class="card-title">@asset.Name</span>
                        @if (asset.AssetType != null)
                        {
                            <span class="text-muted ms-1" style="font-size:0.7rem;">(@asset.AssetType)</span>
                        }
                    </div>
                    <span class="badge bg-@StatusColor(asset.Status)" style="font-size:0.65rem; white-space:nowrap;">
                        @StatusLabel(asset.Status)
                    </span>
                </div>

                @if (asset.Brand != null || asset.Model != null)
                {
                    <p class="card-subtitle mb-1">
                        <i class="bi bi-tag me-1"></i>@(asset.Brand ?? "") @(asset.Model ?? "")
                    </p>
                }
                @if (asset.SerialNumber != null)
                {
                    <p class="card-subtitle mb-1">
                        <i class="bi bi-upc-scan me-1"></i>@asset.SerialNumber
                    </p>
                }
                <p class="card-subtitle mb-0">
                    <i class="bi bi-person me-1"></i>@(asset.CustomerName ?? "—")
                    @if (asset.SiteName != null)
                    {
                        <span class="text-muted"> · @asset.SiteName</span>
                    }
                </p>

                <!-- Badges Row -->
                <div class="d-flex flex-wrap gap-1 mt-1">
                    @if (asset.WarrantyExpiry.HasValue)
                    {
                        var daysLeft = (asset.WarrantyExpiry.Value - DateTime.UtcNow).Days;
                        @if (daysLeft < 0)
                        {
                            <span class="badge bg-secondary" style="font-size:0.6rem;">
                                <i class="bi bi-shield-x me-1"></i>Warranty Expired
                            </span>
                        }
                        else if (daysLeft < 90)
                        {
                            <span class="badge bg-warning text-dark" style="font-size:0.6rem;">
                                <i class="bi bi-shield-exclamation me-1"></i>Warranty @daysLeft d
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-success" style="font-size:0.6rem;">
                                <i class="bi bi-shield-check me-1"></i>Under Warranty
                            </span>
                        }
                    }
                    @if (asset.NextServiceDue.HasValue && asset.NextServiceDue.Value < DateTime.UtcNow.AddDays(30))
                    {
                        <span class="badge bg-info" style="font-size:0.6rem;">
                            <i class="bi bi-calendar-check me-1"></i>Service Due @asset.NextServiceDue.Value.ToString("MMM dd")
                        </span>
                    }
                    @if (asset.LastServiceDate.HasValue)
                    {
                        <span class="badge bg-light text-dark" style="font-size:0.6rem;">
                            <i class="bi bi-wrench me-1"></i>Last: @asset.LastServiceDate.Value.ToString("MMM dd")
                        </span>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-cpu d-block"></i>
            <p>No assets found</p>
        </div>
    }

    @if (!_showCreate)
    {
        <button class="fab" title="New Asset" @onclick="ShowCreateAsset">
            <i class="bi bi-plus-lg"></i>
        </button>
    }
}

@code {
    private List<MobileAssetCard> _assets = [];
    private MobileAssetStats _stats = new();
    private bool _loading = true;
    private string _search = string.Empty;
    private string _statusFilter = string.Empty;
    private string _sortMode = "name";
    private bool _showCreate;
    private MobileAssetQuickCreate _newAsset = new();
    private List<MobileCustomerCard> _customerOpts = [];
    private List<MobileSiteCard> _siteOpts = [];
    private string? _saveError;

    private IEnumerable<MobileAssetCard> SortedAssets => _sortMode switch
    {
        "status" => _assets.OrderBy(a => a.Status).ThenBy(a => a.Name),
        "warranty" => _assets.OrderBy(a => a.WarrantyExpiry ?? DateTime.MaxValue).ThenBy(a => a.Name),
        _ => _assets.OrderBy(a => a.Name)
    };

    private void ToggleSort()
    {
        _sortMode = _sortMode switch
        {
            "name" => "status",
            "status" => "warranty",
            _ => "name"
        };
    }

    private string SortLabel() => _sortMode switch
    {
        "status" => "Status",
        "warranty" => "Warranty",
        _ => "Name"
    };

    protected override async Task OnInitializedAsync()
    {
        _stats = await AssetService.GetStatsAsync();
        await LoadAssets();
    }

    private async Task LoadAssets()
    {
        _loading = true;
        StateHasChanged();

        AssetStatus? status = Enum.TryParse<AssetStatus>(_statusFilter, out var parsed) ? parsed : null;

        var filter = new MobileAssetFilter
        {
            Search = string.IsNullOrWhiteSpace(_search) ? null : _search,
            Status = status,
        };

        _assets = await AssetService.GetAssetsAsync(filter);
        _loading = false;
    }

    private async Task ShowCreateAsset()
    {
        _newAsset = new();
        _saveError = null;
        _customerOpts = await CustomerService.GetCustomersAsync();
        _siteOpts = await SiteService.GetSitesAsync();
        _showCreate = true;
    }

    private async Task SaveAsset()
    {
        if (string.IsNullOrWhiteSpace(_newAsset.SerialNumber)) { _saveError = "Serial number is required."; return; }
        try
        {
            _saveError = null;
            await AssetService.QuickCreateAsync(_newAsset);
            _showCreate = false;
            _stats = await AssetService.GetStatsAsync();
            await LoadAssets();
        }
        catch (Exception ex) { _saveError = ex.Message; }
    }

    private void GoToAsset(int id) => Nav.NavigateTo($"/assets/{id}");

    private static string StatusColor(AssetStatus status) => status switch
    {
        AssetStatus.Active => "success",
        AssetStatus.MaintenanceNeeded => "warning",
        AssetStatus.Retired => "secondary",
        AssetStatus.Decommissioned => "dark",
        _ => "secondary"
    };

    private static string StatusLabel(AssetStatus status) => status switch
    {
        AssetStatus.MaintenanceNeeded => "Needs Service",
        _ => status.ToString()
    };
}
