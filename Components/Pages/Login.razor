@page "/login"
@layout Components.Layout.MobileLayout
@inject IMobileAuthService AuthService
@inject IMobileSettingsService SettingsService
@inject NavigationManager Nav
@inject ApiClient Api

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <i class="bi bi-snow2" style="font-size:2.5rem; color:var(--primary);"></i>
            <h4 class="mt-2 mb-0 fw-bold">OneManVanFSM</h4>
            <p class="text-muted" style="font-size:0.85rem;">Field Service Management</p>
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-danger py-2" style="font-size:0.85rem;">@_error</div>
        }

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success py-2" style="font-size:0.85rem;">@_successMessage</div>
        }

        <div class="mb-3">
            <label class="form-label" style="font-size:0.85rem;">Username</label>
            <input type="text" class="form-control" @bind="_username" @bind:event="oninput" placeholder="Enter username" />
        </div>

        <div class="mb-3">
            <label class="form-label" style="font-size:0.85rem;">Password</label>
            <input type="password" class="form-control" @bind="_password" @bind:event="oninput" placeholder="Enter password" />
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="rememberMe" @bind="_rememberMe" />
                <label class="form-check-label" for="rememberMe" style="font-size:0.82rem;">Remember me</label>
            </div>
        </div>

        <button class="btn btn-primary w-100 fw-semibold" @onclick="HandleLogin" disabled="@_loggingIn">
            @if (_loggingIn)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Signing in...</span>
            }
            else
            {
                <i class="bi bi-box-arrow-in-right me-1"></i>
                <span>Sign In</span>
            }
        </button>

        @* Server Connection Toggle *@
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary w-100" @onclick="() => _showServerConfig = !_showServerConfig">
                <i class="bi bi-hdd-network me-1"></i>
                @(_showServerConfig ? "Hide Server Settings" : "Configure Remote Server")
            </button>
        </div>

        @if (_showServerConfig)
        {
            <div class="mt-2 p-3 border rounded bg-white" style="font-size:0.85rem;">
                <h6 class="mb-2"><i class="bi bi-cloud me-1 text-primary"></i>Database Connection</h6>

                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="dbMode" id="dbLocal" value="Local"
                               checked="@(_dbMode == "Local")" @onchange='() => _dbMode = "Local"' />
                        <label class="form-check-label" for="dbLocal">Local (Offline)</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="dbMode" id="dbRemote" value="Remote"
                               checked="@(_dbMode == "Remote")" @onchange='() => _dbMode = "Remote"' />
                        <label class="form-check-label" for="dbRemote">Remote Server</label>
                    </div>
                </div>

                @if (_dbMode == "Remote")
                {
                    <div class="mb-2">
                        <label class="form-label small mb-1">Server URL</label>
                        <input type="text" class="form-control form-control-sm" @bind="_serverUrl"
                               placeholder="http://192.168.1.100:8080" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Sync Username</label>
                        <input type="text" class="form-control form-control-sm" @bind="_syncUsername"
                               placeholder="sync user" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Sync Password</label>
                        <input type="password" class="form-control form-control-sm" @bind="_syncPassword"
                               placeholder="sync password" />
                    </div>

                    <button class="btn btn-sm btn-outline-info w-100 mb-2" @onclick="TestConnection" disabled="@_testingConnection">
                        @if (_testingConnection)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-wifi me-1"></i>Test Connection
                    </button>
                }

                <button class="btn btn-sm btn-outline-primary w-100" @onclick="SaveServerConfig" disabled="@_savingConfig">
                    @if (_savingConfig)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-check-lg me-1"></i>Save Connection
                </button>
            </div>
        }

        @* Diagnostic Log Panel *@
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-dark w-100" @onclick="() => _showDiagLog = !_showDiagLog">
                <i class="bi bi-terminal me-1"></i>
                @(_showDiagLog ? "Hide" : "Show") Connection Diagnostics
                @if (_diagLog.Count > 0)
                {
                    <span class="badge bg-secondary ms-1">@_diagLog.Count</span>
                }
            </button>
        </div>

        @if (_showDiagLog)
        {
            <div class="mt-2 p-2 border rounded bg-dark text-light" style="font-size:0.75rem; max-height:300px; overflow-y:auto; font-family:monospace;">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-info fw-bold">Connection Diagnostics</small>
                    <button class="btn btn-sm btn-outline-light py-0 px-1" @onclick="ClearDiagLog" style="font-size:0.7rem;">Clear</button>
                </div>
                @if (_diagLog.Count == 0)
                {
                    <div class="text-muted">No diagnostics yet. Try logging in or testing the connection.</div>
                }
                else
                {
                    @foreach (var entry in _diagLog)
                    {
                        <div class="@GetDiagCss(entry.Level) mb-1" style="word-break:break-all;">
                            <span class="text-secondary">[@entry.Timestamp.ToString("HH:mm:ss.fff")]</span>
                            <span class="@GetDiagLevelCss(entry.Level) fw-bold"> @entry.Level </span>
                            @entry.Message
                        </div>
                    }
                }
                <div class="mt-1 pt-1 border-top border-secondary">
                    <small class="text-muted">Mode: @_dbMode | URL: @(string.IsNullOrEmpty(_serverUrl) ? "(not set)" : _serverUrl) | App registered as: @(_isRemoteMode ? "REMOTE" : "LOCAL")</small>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string _username = string.Empty;
    private string _password = string.Empty;
    private string? _error;
    private string? _successMessage;
    private bool _rememberMe;
    private bool _loggingIn;

    // Server connection state
    private bool _showServerConfig;
    private string _dbMode = "Local";
    private string _serverUrl = "";
    private string _syncUsername = "";
    private string _syncPassword = "";
    private bool _savingConfig;
    private bool _testingConnection;

    // Diagnostics
    private bool _showDiagLog;
    private readonly List<DiagEntry> _diagLog = [];
    private bool _isRemoteMode;

    protected override async Task OnInitializedAsync()
    {
        // Restore saved connection settings
        _dbMode = Preferences.Default.Get("db_mode", "Local");
        _serverUrl = Preferences.Default.Get("db_server_url", "");
        _syncUsername = Preferences.Default.Get("db_sync_username", "");
        _isRemoteMode = _dbMode == "Remote" && !string.IsNullOrWhiteSpace(_serverUrl);

        try
        {
            _syncPassword = await SecureStorage.Default.GetAsync("db_sync_password") ?? "";
        }
        catch
        {
            _syncPassword = "";
        }

        LogDiag("INFO", $"Login page loaded. Mode={_dbMode}, ServerURL={(string.IsNullOrEmpty(_serverUrl) ? "(empty)" : _serverUrl)}");
        LogDiag("INFO", $"Auth service type: {AuthService.GetType().Name}");
        if (_isRemoteMode)
        {
            LogDiag("INFO", $"ApiClient BaseUrl: {(string.IsNullOrEmpty(Api.BaseUrl) ? "(empty)" : Api.BaseUrl)}");
            LogDiag("INFO", $"ApiClient IsAuthenticated: {Api.IsAuthenticated}");
        }
    }

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
        {
            _error = "Please enter username and password.";
            return;
        }

        _error = null;
        _loggingIn = true;
        StateHasChanged();

        LogDiag("INFO", $"Login attempt: user='{_username.Trim()}', mode={_dbMode}, rememberMe={_rememberMe}");

        if (_isRemoteMode)
        {
            LogDiag("INFO", $"Remote login - ApiClient BaseUrl='{Api.BaseUrl}'");
            LogDiag("INFO", "Testing server reachability before login...");
            StateHasChanged();

            try
            {
                var (reachable, msg) = await Api.TestConnectionAsync();
                LogDiag(reachable ? "OK" : "FAIL", $"Health check: {msg}");
                StateHasChanged();

                if (!reachable)
                {
                    LogDiag("FAIL", "Server is not reachable. Login will likely fail.");
                }
            }
            catch (Exception ex)
            {
                LogDiag("FAIL", $"Health check exception: {ex.GetType().Name}: {ex.Message}");
            }
            StateHasChanged();
        }

        try
        {
            var result = await AuthService.LoginAsync(_username.Trim(), _password, _rememberMe);

            if (result.Succeeded)
            {
                LogDiag("OK", $"Login succeeded! UserId={result.Session?.UserId}, Role={result.Session?.Role}");
                StateHasChanged();

                if (result.Session?.MustChangePassword == true)
                {
                    Nav.NavigateTo("/setup", forceLoad: false);
                }
                else
                {
                    Nav.NavigateTo("/", forceLoad: false);
                }
            }
            else
            {
                var errorMsg = result.ErrorMessage ?? "Login failed.";
                LogDiag("FAIL", $"Login failed: {errorMsg}");
                _error = errorMsg;
                _loggingIn = false;
            }
        }
        catch (HttpRequestException ex)
        {
            var detail = ex.InnerException?.Message ?? ex.Message;
            LogDiag("FAIL", $"HTTP error during login: {ex.GetType().Name}: {detail}");
            if (ex.StatusCode.HasValue)
                LogDiag("FAIL", $"HTTP status code: {(int)ex.StatusCode.Value} ({ex.StatusCode.Value})");
            _error = $"Cannot reach server: {detail}";
            _loggingIn = false;
        }
        catch (TaskCanceledException ex) when (!ex.CancellationToken.IsCancellationRequested)
        {
            LogDiag("FAIL", "Login request timed out. Server may be unreachable or slow.");
            _error = "Connection timed out. Check your server URL and network.";
            _loggingIn = false;
        }
        catch (Exception ex)
        {
            LogDiag("FAIL", $"Unexpected login error: {ex.GetType().Name}: {ex.Message}");
            if (ex.InnerException is not null)
                LogDiag("FAIL", $"  Inner: {ex.InnerException.GetType().Name}: {ex.InnerException.Message}");
            _error = $"Login error: {ex.Message}";
            _loggingIn = false;
        }

        StateHasChanged();
    }

    private async Task TestConnection()
    {
        _testingConnection = true;
        _error = null;
        _successMessage = null;
        StateHasChanged();

        LogDiag("INFO", $"Manual connection test - URL: '{_serverUrl}'");

        // Temporarily set the server URL in preferences so ApiClient picks it up
        var currentUrl = Preferences.Default.Get("db_server_url", "");
        Preferences.Default.Set("db_server_url", _serverUrl.Trim());

        try
        {
            LogDiag("INFO", $"ApiClient.BaseUrl resolves to: '{Api.BaseUrl}'");
            var (reachable, msg) = await Api.TestConnectionAsync();
            LogDiag(reachable ? "OK" : "FAIL", $"Connection test result: {msg}");

            if (reachable)
                _successMessage = $"Server reachable: {msg}";
            else
                _error = msg;
        }
        catch (Exception ex)
        {
            LogDiag("FAIL", $"Connection test exception: {ex.GetType().Name}: {ex.Message}");
            if (ex.InnerException is not null)
                LogDiag("FAIL", $"  Inner: {ex.InnerException.GetType().Name}: {ex.InnerException.Message}");
            _error = $"Test failed: {ex.Message}";
        }
        finally
        {
            // Restore original URL if not yet saved
            Preferences.Default.Set("db_server_url", currentUrl);
            _testingConnection = false;
            StateHasChanged();
        }
    }

    private async Task SaveServerConfig()
    {
        _savingConfig = true;
        _error = null;
        _successMessage = null;
        StateHasChanged();

        LogDiag("INFO", $"Saving server config: mode={_dbMode}, url={(_dbMode == "Remote" ? _serverUrl.Trim() : "(local)")}");

        try
        {
            Preferences.Default.Set("db_mode", _dbMode);
            Preferences.Default.Set("db_server_url", _dbMode == "Remote" ? _serverUrl.Trim() : "");
            Preferences.Default.Set("db_sync_username", _dbMode == "Remote" ? _syncUsername.Trim() : "");

            if (_dbMode == "Remote" && !string.IsNullOrWhiteSpace(_syncPassword))
            {
                await SecureStorage.Default.SetAsync("db_sync_password", _syncPassword);
            }
            else
            {
                SecureStorage.Default.Remove("db_sync_password");
            }

            _isRemoteMode = _dbMode == "Remote" && !string.IsNullOrWhiteSpace(_serverUrl);

            _successMessage = _dbMode == "Remote"
                ? "Remote server configured successfully. Please restart the app to connect."
                : "Local database mode selected. Please restart the app to apply changes.";
            _showServerConfig = false;

            LogDiag("OK", "Server config saved successfully.");
            LogDiag("WARN", "App must be restarted for DI service registrations to use the new mode.");
        }
        catch (Exception ex)
        {
            LogDiag("FAIL", $"Failed to save config: {ex.Message}");
            _error = $"Failed to save: {ex.Message}";
        }
        finally
        {
            _savingConfig = false;
            StateHasChanged();
        }
    }

    // --- Diagnostic log helpers ---

    private void LogDiag(string level, string message)
    {
        _diagLog.Add(new DiagEntry { Timestamp = DateTime.Now, Level = level, Message = message });
        if (_diagLog.Count > 100)
            _diagLog.RemoveAt(0);
    }

    private void ClearDiagLog() => _diagLog.Clear();

    private static string GetDiagCss(string level) => level switch
    {
        "FAIL" => "text-danger",
        "WARN" => "text-warning",
        "OK" => "text-success",
        _ => "text-light"
    };

    private static string GetDiagLevelCss(string level) => level switch
    {
        "FAIL" => "text-danger",
        "WARN" => "text-warning",
        "OK" => "text-success",
        _ => "text-info"
    };

    private record DiagEntry
    {
        public DateTime Timestamp { get; init; }
        public string Level { get; init; } = "INFO";
        public string Message { get; init; } = "";
    }
}
