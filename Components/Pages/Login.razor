@page "/login"
@layout Components.Layout.MobileLayout
@inject IMobileAuthService AuthService
@inject NavigationManager Nav

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <i class="bi bi-snow2" style="font-size:2.5rem; color:var(--primary);"></i>
            <h4 class="mt-2 mb-0 fw-bold">OneManVanFSM</h4>
            <p class="text-muted" style="font-size:0.85rem;">Field Service Management</p>
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-danger py-2" style="font-size:0.85rem;">@_error</div>
        }

        <div class="mb-3">
            <label class="form-label" style="font-size:0.85rem;">Username</label>
            <input type="text" class="form-control" @bind="_username" @bind:event="oninput" placeholder="Enter username" />
        </div>

        <div class="mb-3">
            <label class="form-label" style="font-size:0.85rem;">Password</label>
            <input type="password" class="form-control" @bind="_password" @bind:event="oninput" placeholder="Enter password" />
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="rememberMe" @bind="_rememberMe" />
                <label class="form-check-label" for="rememberMe" style="font-size:0.82rem;">Remember me</label>
            </div>
        </div>

        <button class="btn btn-primary w-100 fw-semibold" @onclick="HandleLogin" disabled="@_loggingIn">
            @if (_loggingIn)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Signing in…</span>
            }
            else
            {
                <i class="bi bi-box-arrow-in-right me-1"></i>
                <span>Sign In</span>
            }
        </button>

        <p class="text-center text-muted mt-3 mb-0" style="font-size:0.75rem;">
            Demo: admin / admin123
        </p>
    </div>
</div>

@code {
    private string _username = string.Empty;
    private string _password = string.Empty;
    private string? _error;
    private bool _rememberMe;
    private bool _loggingIn;

    private async Task HandleLogin()
    {
        System.Diagnostics.Debug.WriteLine($"[LOGIN] HandleLogin called — username='{_username}', password length={_password?.Length ?? -1}");

        if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
        {
            _error = "Please enter username and password.";
            System.Diagnostics.Debug.WriteLine("[LOGIN] Validation failed — empty username or password.");
            return;
        }

        _error = null;
        _loggingIn = true;
        StateHasChanged();

        var result = await AuthService.LoginAsync(_username.Trim(), _password, _rememberMe);

        if (result.Succeeded)
        {
            Nav.NavigateTo("/", forceLoad: false);
        }
        else
        {
            _error = result.ErrorMessage ?? "Login failed.";
            _loggingIn = false;
        }
    }
}
