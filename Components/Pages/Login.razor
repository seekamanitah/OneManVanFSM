@page "/login"
@layout Components.Layout.MobileLayout
@inject IMobileAuthService AuthService
@inject IMobileSettingsService SettingsService
@inject NavigationManager Nav

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <i class="bi bi-snow2" style="font-size:2.5rem; color:var(--primary);"></i>
            <h4 class="mt-2 mb-0 fw-bold">OneManVanFSM</h4>
            <p class="text-muted" style="font-size:0.85rem;">Field Service Management</p>
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-danger py-2" style="font-size:0.85rem;">@_error</div>
        }

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success py-2" style="font-size:0.85rem;">@_successMessage</div>
        }

        <div class="mb-3">
            <label class="form-label" style="font-size:0.85rem;">Username</label>
            <input type="text" class="form-control" @bind="_username" @bind:event="oninput" placeholder="Enter username" />
        </div>

        <div class="mb-3">
            <label class="form-label" style="font-size:0.85rem;">Password</label>
            <input type="password" class="form-control" @bind="_password" @bind:event="oninput" placeholder="Enter password" />
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="form-check mb-0">
                <input class="form-check-input" type="checkbox" id="rememberMe" @bind="_rememberMe" />
                <label class="form-check-label" for="rememberMe" style="font-size:0.82rem;">Remember me</label>
            </div>
        </div>

        <button class="btn btn-primary w-100 fw-semibold" @onclick="HandleLogin" disabled="@_loggingIn">
            @if (_loggingIn)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Signing in…</span>
            }
            else
            {
                <i class="bi bi-box-arrow-in-right me-1"></i>
                <span>Sign In</span>
            }
        </button>

        @* Server Connection Toggle *@
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary w-100" @onclick="() => _showServerConfig = !_showServerConfig">
                <i class="bi bi-hdd-network me-1"></i>
                @(_showServerConfig ? "Hide Server Settings" : "Configure Remote Server")
            </button>
        </div>

        @if (_showServerConfig)
        {
            <div class="mt-2 p-3 border rounded bg-white" style="font-size:0.85rem;">
                <h6 class="mb-2"><i class="bi bi-cloud me-1 text-primary"></i>Database Connection</h6>

                <div class="mb-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="dbMode" id="dbLocal" value="Local"
                               checked="@(_dbMode == "Local")" @onchange='() => _dbMode = "Local"' />
                        <label class="form-check-label" for="dbLocal">Local (Offline)</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="dbMode" id="dbRemote" value="Remote"
                               checked="@(_dbMode == "Remote")" @onchange='() => _dbMode = "Remote"' />
                        <label class="form-check-label" for="dbRemote">Remote Server</label>
                    </div>
                </div>

                @if (_dbMode == "Remote")
                {
                    <div class="mb-2">
                        <label class="form-label small mb-1">Server URL</label>
                        <input type="text" class="form-control form-control-sm" @bind="_serverUrl"
                               placeholder="http://192.168.1.100:8080" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Sync Username</label>
                        <input type="text" class="form-control form-control-sm" @bind="_syncUsername"
                               placeholder="sync user" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Sync Password</label>
                        <input type="password" class="form-control form-control-sm" @bind="_syncPassword"
                               placeholder="sync password" />
                    </div>
                }

                <button class="btn btn-sm btn-outline-primary w-100" @onclick="SaveServerConfig" disabled="@_savingConfig">
                    @if (_savingConfig)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-check-lg me-1"></i>Save Connection
                </button>
            </div>
        }
    </div>
</div>

@code {
    private string _username = string.Empty;
    private string _password = string.Empty;
    private string? _error;
    private string? _successMessage;
    private bool _rememberMe;
    private bool _loggingIn;

    // Server connection state
    private bool _showServerConfig;
    private string _dbMode = "Local";
    private string _serverUrl = "";
    private string _syncUsername = "";
    private string _syncPassword = "";
    private bool _savingConfig;

    protected override async Task OnInitializedAsync()
    {
        // Restore saved connection settings
        _dbMode = Preferences.Default.Get("db_mode", "Local");
        _serverUrl = Preferences.Default.Get("db_server_url", "");
        _syncUsername = Preferences.Default.Get("db_sync_username", "");

        try
        {
            _syncPassword = await SecureStorage.Default.GetAsync("db_sync_password") ?? "";
        }
        catch
        {
            _syncPassword = "";
        }
    }

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(_username) || string.IsNullOrWhiteSpace(_password))
        {
            _error = "Please enter username and password.";
            return;
        }

        _error = null;
        _loggingIn = true;
        StateHasChanged();

        var result = await AuthService.LoginAsync(_username.Trim(), _password, _rememberMe);

        if (result.Succeeded)
        {
            // Check if user must change password
            if (result.Session?.MustChangePassword == true)
            {
                Nav.NavigateTo("/setup", forceLoad: false);
            }
            else
            {
                Nav.NavigateTo("/", forceLoad: false);
            }
        }
        else
        {
            _error = result.ErrorMessage ?? "Login failed.";
            _loggingIn = false;
        }
    }

    private async Task SaveServerConfig()
    {
        _savingConfig = true;
        _error = null;
        _successMessage = null;
        StateHasChanged();

        try
        {
            Preferences.Default.Set("db_mode", _dbMode);
            Preferences.Default.Set("db_server_url", _dbMode == "Remote" ? _serverUrl.Trim() : "");
            Preferences.Default.Set("db_sync_username", _dbMode == "Remote" ? _syncUsername.Trim() : "");

            if (_dbMode == "Remote" && !string.IsNullOrWhiteSpace(_syncPassword))
            {
                await SecureStorage.Default.SetAsync("db_sync_password", _syncPassword);
            }
            else
            {
                SecureStorage.Default.Remove("db_sync_password");
            }

            _successMessage = _dbMode == "Remote"
                ? "Remote server configured. Restart the app to connect."
                : "Switched to local database. Restart the app to apply.";
        }
        catch (Exception ex)
        {
            _error = $"Failed to save: {ex.Message}";
        }
        finally
        {
            _savingConfig = false;
        }
    }
}
