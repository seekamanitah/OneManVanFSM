@page "/dropdowns"
@inject IMobileDropdownService DropdownSvc

@if (_loading)
{
    <div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></div>
}
else if (_selectedCategory != null)
{
    <!-- Category Detail View -->
    <div class="d-flex align-items-center mb-2">
        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="BackToCategories"><i class="bi bi-arrow-left"></i></button>
        <span style="font-size:0.95rem; font-weight:700;">@FormatCategoryName(_selectedCategory)</span>
        <span class="badge bg-primary ms-auto" style="font-size:0.7rem;">@_options.Count options</span>
    </div>

    <!-- Add New Option -->
    <div class="mobile-card mb-2" style="padding:0.5rem 0.75rem;">
        <div class="d-flex gap-2">
            <input type="text" class="form-control form-control-sm flex-fill" @bind="_newValue" @bind:event="oninput" placeholder="Add new option..." />
            <button class="btn btn-sm btn-primary" @onclick="AddOption" disabled="@(string.IsNullOrWhiteSpace(_newValue))">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="text-danger mt-1" style="font-size:0.7rem;">@_error</div>
        }
    </div>

    <!-- Options List -->
    @if (_options.Any())
    {
        @foreach (var opt in _options)
        {
            <div class="mobile-card mb-1">
                @if (_editingId == opt.Id)
                {
                    <!-- Inline Edit -->
                    <div class="d-flex gap-2 align-items-center">
                        <input type="text" class="form-control form-control-sm flex-fill" @bind="_editValue" />
                        <button class="btn btn-sm btn-success" style="padding:2px 6px;" @onclick="() => SaveEdit(opt)"><i class="bi bi-check-lg"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" style="padding:2px 6px;" @onclick="CancelEdit"><i class="bi bi-x-lg"></i></button>
                    </div>
                }
                else
                {
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="min-width:0; flex:1;">
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size:0.85rem; font-weight:500; @(opt.IsActive ? "" : "text-decoration:line-through; opacity:0.5;")">@opt.Value</span>
                                @if (!string.IsNullOrWhiteSpace(opt.Label) && opt.Label != opt.Value)
                                {
                                    <span class="text-muted" style="font-size:0.7rem;">(@opt.Label)</span>
                                }
                                @if (opt.IsSystem)
                                {
                                    <span class="badge bg-light text-muted" style="font-size:0.55rem;">System</span>
                                }
                                @if (!opt.IsActive)
                                {
                                    <span class="badge bg-secondary" style="font-size:0.55rem;">Inactive</span>
                                }
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-secondary" style="font-size:0.65rem; padding:1px 5px;" @onclick="() => StartEdit(opt)" title="Edit"><i class="bi bi-pencil"></i></button>
                            @if (!opt.IsActive)
                            {
                                <button class="btn btn-sm btn-outline-success" style="font-size:0.65rem; padding:1px 5px;" @onclick="() => ToggleActive(opt, true)" title="Activate"><i class="bi bi-eye"></i></button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-warning" style="font-size:0.65rem; padding:1px 5px;" @onclick="() => ToggleActive(opt, false)" title="Deactivate"><i class="bi bi-eye-slash"></i></button>
                            }
                            @if (!opt.IsSystem)
                            {
                                <button class="btn btn-sm btn-outline-danger" style="font-size:0.65rem; padding:1px 5px;" @onclick="() => DeleteOption(opt.Id)" title="Delete"><i class="bi bi-trash3"></i></button>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-sliders d-block" style="font-size:2rem;"></i>
            <p>No options configured</p>
        </div>
    }
}
else
{
    <!-- Categories List -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span style="font-size:0.95rem; font-weight:700;"><i class="bi bi-sliders me-1"></i>Custom Fields</span>
        <button class="btn btn-sm btn-outline-primary" @onclick="SeedDefaults" disabled="@_seeding">
            @if (_seeding) { <span class="spinner-border spinner-border-sm me-1"></span> }
            <i class="bi bi-arrow-repeat me-1"></i>Reset Defaults
        </button>
    </div>

    <div class="mobile-card mb-2" style="padding:0.5rem 0.75rem;">
        <input type="text" class="form-control form-control-sm" placeholder="Search categories..." @bind="_search" @bind:event="oninput" />
    </div>

    @if (FilteredCategories.Any())
    {
        @foreach (var cat in FilteredCategories)
        {
            <div class="mobile-card mb-1" style="cursor:pointer;" @onclick="() => SelectCategory(cat)">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div style="font-size:0.85rem; font-weight:600;">@FormatCategoryName(cat)</div>
                        <div class="text-muted" style="font-size:0.7rem;">@cat</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
            </div>
        }
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-sliders d-block" style="font-size:2rem;"></i>
            <p>No categories found</p>
        </div>
    }
}

@code {
    private bool _loading = true;
    private bool _seeding;
    private string? _error;
    private string _search = string.Empty;

    private List<string> _categories = [];
    private string? _selectedCategory;
    private List<DropdownOption> _options = [];

    private string _newValue = string.Empty;
    private int? _editingId;
    private string _editValue = string.Empty;

    private IEnumerable<string> FilteredCategories => string.IsNullOrWhiteSpace(_search)
        ? _categories
        : _categories.Where(c => c.Contains(_search, StringComparison.OrdinalIgnoreCase)
            || FormatCategoryName(c).Contains(_search, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        _categories = await DropdownSvc.GetCategoriesAsync();
        _loading = false;
    }

    private async Task SelectCategory(string category)
    {
        _selectedCategory = category;
        _options = await DropdownSvc.GetOptionsAsync(category);
        _newValue = string.Empty;
        _editingId = null;
        _error = null;
    }

    private async Task BackToCategories()
    {
        _selectedCategory = null;
        _categories = await DropdownSvc.GetCategoriesAsync();
    }

    private async Task AddOption()
    {
        if (string.IsNullOrWhiteSpace(_newValue) || _selectedCategory is null) return;
        if (_options.Any(o => o.Value.Equals(_newValue.Trim(), StringComparison.OrdinalIgnoreCase)))
        {
            _error = "This value already exists.";
            return;
        }
        _error = null;
        await DropdownSvc.AddOptionAsync(_selectedCategory, _newValue.Trim());
        _newValue = string.Empty;
        _options = await DropdownSvc.GetOptionsAsync(_selectedCategory);
    }

    private void StartEdit(DropdownOption opt)
    {
        _editingId = opt.Id;
        _editValue = opt.Value;
    }

    private void CancelEdit() => _editingId = null;

    private async Task SaveEdit(DropdownOption opt)
    {
        if (string.IsNullOrWhiteSpace(_editValue)) return;
        await DropdownSvc.UpdateOptionAsync(opt.Id, _editValue.Trim(), opt.Label, opt.IsActive);
        _editingId = null;
        if (_selectedCategory != null)
            _options = await DropdownSvc.GetOptionsAsync(_selectedCategory);
    }

    private async Task ToggleActive(DropdownOption opt, bool active)
    {
        await DropdownSvc.UpdateOptionAsync(opt.Id, opt.Value, opt.Label, active);
        if (_selectedCategory != null)
            _options = await DropdownSvc.GetOptionsAsync(_selectedCategory);
    }

    private async Task DeleteOption(int id)
    {
        await DropdownSvc.DeleteOptionAsync(id);
        if (_selectedCategory != null)
            _options = await DropdownSvc.GetOptionsAsync(_selectedCategory);
    }

    private async Task SeedDefaults()
    {
        _seeding = true;
        await DropdownSvc.SeedDefaultsAsync();
        _categories = await DropdownSvc.GetCategoriesAsync();
        _seeding = false;
    }

    private static string FormatCategoryName(string category)
    {
        // Convert PascalCase to spaced: "SystemType" â†’ "System Type"
        var result = System.Text.RegularExpressions.Regex.Replace(category, "([a-z])([A-Z])", "$1 $2");
        return result;
    }
}
