Financials for WebUi OneManVanFSM

### Financials Page - Exhaustive Description

**Routes**: `/financials` (main dashboard view for an integrated overview of invoices, expenses, and payments, with tabs or sections for navigation); `/financials/invoices` (dedicated invoices list/sub-page); `/financials/invoices/{id}` (invoice detail view); `/financials/invoices/new` or `/financials/invoices/{id}/edit` (invoice create/edit view); similarly for expenses (`/financials/expenses`, `/financials/expenses/{id}`, etc.) and payments (`/financials/payments`, `/financials/payments/{id}`, etc.). For contextual integration, embeddable as components or modals in related pages like Jobs (e.g., `/jobs/{jobId}/financials` to generate an invoice directly from a completed job) or Customers (e.g., `/customers/{customerId}/financials` to view only that customer's invoices/expenses/payments). This ensures seamless workflow—e.g., upon job completion, open an embedded invoice creator without leaving the job page, with data (e.g., materials/labor from the job) transferring automatically to prepopulate lines and totals, reducing steps for the contractor tracking cash flow after a busy day of repairs.

**Purpose & Business Context**:
- The Financials page is designed as the unified "money manager" for the app, consolidating invoices (billing for completed work), expenses (tracking costs like supplier purchases or tech reimbursements), and payments (recording inflows with partials/refunds) into a single, intuitive hub that provides quick oversight and actions for maintaining healthy finances. For a small HVAC contractor, it addresses the post-job reality: After installing a trunk system at a landlord's multi-rental site (with materials like flex duct boxes and labor hours logged), auto-generate an invoice from the job details, record expenses for any variances (e.g., extra mastic sealant), and track payments (e.g., partial from a company contact)—all while handling urgencies like overdue balances that could delay future work. Presentation emphasizes cash flow: Dashboard views show at-a-glance metrics (e.g., "A/R Aging: $5K Overdue"), while sub-pages offer detailed breakdowns with quick links to resolve issues (e.g., "Send Reminder" for an unpaid invoice).
- HVAC-specific: Incorporates elements like refrigerant reclaim fees (from pasted-text disposal section) in expenses, permit/inspection costs in invoices, and warranty-related refunds in payments—ensuring compliance (e.g., tax exemptions for certain materials). Generic foundation: Sections and calcs are modular for other trades without app rework—e.g., repurpose "Disposal Fees" for "Waste Removal" in plumbing (septic costs) or "Recycling Charges" in electrical (old wiring), using customizable categories to adjust while maintaining core financial tracking (totals/markups/taxes). This supports complex scenarios: A customer's multiple estates (e.g., batch invoices across sites with shared discounts) or a company's territorial payments (e.g., filter by contact for East County billing, ensuring the right approver gets reminders).
- Business value: Promotes user-friendly efficiency by automating shared data transfer—e.g., a completed job's materials/labor/site fees prepopulate an invoice (no re-entry), an expense from a material variance (e.g., extra "Zip Ties: Qty") links back to the job for reimbursement, and a payment updates customer balances real-time (flowing to reports for cash flow insights). Industry thinking: Contractors focus on getting paid quickly (e.g., mobile payment recording post-job); the page supports this with clean mobile views for techs (simple payment entry), prepopulated customizable dropdowns (e.g., "Payment Method: Cash/Card" editable in settings to add "Zelle"), and shared data (e.g., an invoice for a landlord's multi-rentals aggregates per site but bills as one, with territorial routing for company contacts). For small operations, it reduces admin burden: Auto-calcs (time-based labor from employee rates or flat from bids) tie to profitability, while A/R alerts prevent cash shortfalls. Overall robustness: Connectivity ensures financial integrity—e.g., an invoice pulls from jobs/material lists/inventory for costs, expenses deduct from budgets, payments reconcile with bank integrations, and all flow to customer summaries/reports for holistic views.

**Data Sources & Interconnections**:
- **Core Entities**: Invoices table (ID PK, JobID/EstimateID/CustomerID/CompanyID/SiteID/AssetID polymorphic FKs; Status enum: Draft/Sent/Invoiced/Paid/Overdue/Void – customizable; Total/Subtotal/Tax/Markup/Contingency/BalanceDue computed; Lines JSON/child table from material lists/jobs; Notes/PDFHistory); Expenses table (ID PK, JobID/InvoiceID/Category enum: Fuel/Tools/Disposal – customizable; Amount/IsBillable/Status: Pending/Approved/Reimbursed; ReceiptAttach); Payments table (ID PK, InvoiceID FK; Amount/Method enum: Cash/Check/Card – customizable; Status: Pending/Completed/Refunded; Reference/TransactionID).
- **Sources**: Prepopulates from Jobs/Estimates (completed details for invoice lines/totals – customizable pricing methods), Material Lists (sections to invoice/expense items), Inventory/Products (costs/markups for lines), Employees (labor rates for time-based calcs), Settings (default tax/markup/contingency %/methods – customizable per jurisdiction/trade).
- **Interconnections** (App-Wide Flow for Shared Financial Data):
  - **Jobs/Estimates**: One-to-One/Many (Invoice/Expense from JobID/EstimateID). Connectivity: Job completion → "Generate Invoice" transfers all (materials/labor/site fees/totals – data flow: List sections to invoice lines, variances to expenses); estimate approval previews financials (transfer to job on conversion). App flow: From job detail, embedded invoice creator (changes sync back); multi-jobs (e.g., batch for landlord sites) aggregate invoices.
  - **Sites/Customers/Companies**: Many-to-One (Financial CustomerID/CompanyID/SiteID FK). Connectivity: Invoice/expense/payment filters by site/customer (prepopulates address/contact for billing); multi-site financials (e.g., landlord rentals) batch per site (shared balances). App flow: Customer detail "Financial Summary" embeds filtered view (data transfer to new invoice); company territorial: Auto-route reminders to contact (e.g., overdue for West sites to Jill Dane).
  - **Assets**: Indirect via jobs (warranty claims as expenses/refunds). Connectivity: Asset repair job → Transfers to invoice (e.g., "Refrigerant Reclaim" fee); depreciation calcs in expenses. App flow: Asset detail "Bill for Repair" opens embedded invoice (data transfer to lines from asset specs/history).
  - **Material Lists/Inventory/Products**: Many-to-Many (Invoice/Expense Lines from MaterialListItems/ProductID). Connectivity: List sections transfer to invoice lines (with markup/tax); variances create expenses (e.g., extra "Mastic Sealant"); inventory deductions log as job expenses. App flow: Invoice embedded material preview (transfer updates from list); products provide cost bases for lines.
  - **Employees/ServiceAgreements**: Employees for labor lines in invoices (rates/hours from time entries); agreements auto-invoice recurring (pull from jobs). Connectivity: Time clock from jobs transfers to invoice labor (data flow to payroll); expenses reimburse techs (link to employee records).
  - **QuickNotes/Documents/Notifications**: Polymorphic notes/docs per financial record (import to invoice notes, e.g., "Disposal: From Note – Haul-Away Fee"); notifications from status (e.g., overdue alert). Connectivity: Quick note on job → Imports to invoice/expense (e.g., "Variance" category auto-creates expense).
  - **Shared Data Flow**: Job/estimate completion (transfer materials/labor/site fees) → Invoice create (prepopulate lines/totals, add expenses for variances) → Payment record (update balance, flow to customer summary) → Reports (e.g., "A/R Aging" from overdue). For multi-site: "Batch Invoice" aggregates (shared data like discounts). Robust views: "FinancialOverviewView" (joins for dashboards); "TerritorialAgingView" (filters by company contact).

**Layout & Sections** (Desktop Web Focus: Tabbed Dashboard with Grids, Responsive for Mobile Card-Stacking):
- **Main Dashboard View (/financials)**: Tabbed interface (Invoices/Expenses/Payments – with shared KPIs like "Outstanding A/R: $X, Y Overdue" at top); quick filters (by customer/site/status – prepopulated dropdowns customizable).
- **Invoices Sub-Page (/financials/invoices)**: Table (columns: Invoice #/Customer/Company/Site (clickable), Status Badge, Due Date/Amount/Balance, Lines Count – sortable/prepopulated like "Overdue Only" dropdown). Responsive cards with expand for lines.
  - **Detail View (/financials/invoices/{id})**: Invoice "statement" with sections (Header: Status/Due/Total; Lines Table from jobs/lists – editable preview; Payments History; Notes – quick note import; Footer: "Record Payment/Send Reminder/Void/Export PDF").
- **Expenses Sub-Page (/financials/expenses)**: Table (columns: Expense #/Category (dropdown filter – customizable), Job/Invoice Link, Amount/IsBillable/Status, Receipt Attach – sortable). Detail: Form with category dropdown (prepopulated like "Disposal"), billable toggle (links to invoice).
- **Payments Sub-Page (/financials/payments)**: Table (columns: Payment #/Invoice Link, Method (dropdown – customizable), Amount/Date/Status, Reference – sortable). Detail: Form with method dropdown, partial amount (updates invoice balance).
- **Create/Edit Views**: Forms with integrations (e.g., "Pull from Job" dropdown prepopulates – customizable sources).

**UX Interactions & Flows**:
- **Billing Flow**: From job, embedded invoice create → Prepopulate from job (lines from materials/labor/site) → Add expense (e.g., "Permit Cost") → Record payment (partial updates balance).
- **Connectivity Flow**: From detail, "Link Expense" → Opens expenses form with invoice prepopulated (data transfer to billable); payment "Apply to Invoice" updates status.
- **Main to Sub-Detail**: Filter "Overdue for Territorial Contacts" → Click invoice → Detail with payments history expanded; for multi-site companies, filter groups by site.
- **User Journey**: Office post-job (company with chain stores) → Generate batch invoice for multi-sites (prepopulate shared materials/labor) → Record partial payment (territorial filter) → Track expense (reclaim fee) → Customer summary updates balance.
- **Efficiency Features**: Prepopulated dropdowns (status/methods/categories – customizable add/edit/remove); auto-calcs (balances from partials); search integrates invoice # across app.

**Customizations & Configurability**:
- Admins: Add/edit/remove enums (e.g., Status: Add "Disputed"; Methods: Add "ACH"); customize calc rules (e.g., default tax per jurisdiction); toggle fields (e.g., add "Service Charge" for HVAC). Per-role: Techs record payments only (mobile); office voids/full edit.
- Quick Notes: Import to notes (e.g., "Adjustment" category auto-appends as line item).

**Edge Cases & Robustness**:
- Multi-Site Financials: Handle "One Invoice, Multiple Sites" (e.g., batch lines with shared totals – grouped views); "Territorial Payments" (contact-specific routing/edits).
- Partials/Overdues: Auto-prorate partials (update balance); overdue trigger reminders.
- Large Records: Pagination in tables/history; filter limits (e.g., "My Invoices Only").
- Permissions: Techs view linked invoices (pay only); approvers void. Hidden details for customers.
- Offline: Mobile caches draft invoices/expenses (record local, sync updates balances with merge).

**Integrations & Automation**:
- Triggers: Invoice sent → Notification (email to customer/contact); overdue → Alert/reminder; payment → Update job status/customer balance.
- External: QuickBooks sync (export invoices/payments/expenses); Stripe for card payments (embed form); PDF generation (full breakdown or totals-only).
- Workflow Ties: Quick links ensure progression (e.g., "From Invoice to Payment" → Prepopulates form with balance, transferring data). For companies: Territorial auto-remind (e.g., alert right contact for overdue).

**Mobile Considerations**:
- Dashboard tabs as swipeable views; lists as filterable cards (swipe to pay/record). Mobile payment: Clean form with scan for receipts/checks. Offline cache prioritizes tech's job-linked financials (record payment local, sync updates balances). Responsive layouts stack tabs to sections; embedded in jobs as bottom sheet for quick invoicing, ensuring techs can bill on-site without rework.