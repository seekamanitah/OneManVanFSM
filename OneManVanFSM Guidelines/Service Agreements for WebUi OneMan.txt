Service Agreements for WebUi OneManVanFSM

### Service Agreements Page - Exhaustive Description

**Routes**: `/serviceagreements` (list view for browsing, searching, and managing all agreements); `/serviceagreements/{id}` (detail view for a specific agreement, including visit history, renewals, and quick actions); `/serviceagreements/new` or `/serviceagreements/{id}/edit` (create/edit view for setting up or modifying agreements). For contextual integration, embeddable as a component or modal in related pages like Customers (e.g., `/customers/{customerId}/serviceagreements` to list only that customer's or company's agreements) or Assets (e.g., `/assets/{assetId}/serviceagreements` for linking maintenance to specific equipment). This ensures seamless workflow—e.g., while viewing a customer's detail with multi-sites and assets, create a new agreement without leaving, with data (e.g., sites/assets from the customer) transferring automatically to prepopulate covered items and visit schedules, reducing steps for the contractor building recurring revenue streams.

**Purpose & Business Context**:
- The Service Agreements page is designed as the "recurring revenue builder" for the app, enabling contractors to create, track, and automate long-term maintenance contracts that generate steady income while ensuring customer equipment longevity. For a small HVAC contractor, it captures the value of preventive care: E.g., a quarterly tune-up agreement for a landlord's multi-rental furnaces (covering specific sites/assets with scheduled visits, auto-generating jobs for filter changes or refrigerant checks), with built-in renewals (e.g., alert 30 days before expiry) and escalations (e.g., add-ons for emergency coverage). Presentation emphasizes sustainability: List views show renewal pipelines with health metrics (e.g., "Visits Used: 3/4, Renewal Due Soon"), while details provide a "contract file" with visit calendars, covered asset lists, and financial previews for upselling.
- HVAC-specific: Incorporates elements like seasonal visits (e.g., winter furnace checks, summer AC prep) based on asset types (tonnage/SEER from pasted-text), refrigerant monitoring for compliance, and bundled services (e.g., UV light/humidifier add-ons). Generic foundation: Adaptable for other trades without app changes—e.g., repurpose "Tune-Up Visits" for "Annual Boiler Inspection" in plumbing (water quality tests) or "Electrical Safety Check" in electrical (panel load reviews), using customizable visit types to adjust while maintaining core tracking (schedules/coverage/fees). This supports complex contracts: A customer's multiple estates (e.g., basic coverage for primary home, premium for vacation properties—batched visits) or a company's territorial sites (e.g., standard agreements per store, filtered by contact for East/West approvals).
- Business value: Promotes user-friendly efficiency by automating shared data transfer—e.g., link an agreement to a customer's sites/assets (prepopulate from history), auto-schedule jobs (carry over agreement details like covered materials/labor), and generate invoices on visit completion (flow to financials with deferred revenue recognition). Industry thinking: Contractors rely on agreements for predictable cash flow (e.g., monthly billing for multi-site landlords); the page supports this with mobile visit logging for techs (clean UI for check-ins), prepopulated customizable dropdowns (e.g., "Coverage Level: Basic/Premium" editable in settings to add "Extended Warranty"), and shared data (e.g., an agreement for a company's chain links to territorial contacts for notifications, with site-specific customizations like "High-Traffic Store: Extra Filter Changes"). For small operations, it reduces admin: Auto-reminders prevent lapses, and integration with calendar/jobs ensures no missed visits. Overall robustness: Connectivity ensures proactive service—e.g., agreement visits update asset repair history, pull from material lists for standard kits, and log expenses for add-ons, building customer loyalty through reliable tracking.

**Data Sources & Interconnections**:
- **Core Entity**: ServiceAgreements table (ID PK, CustomerID/CompanyID/SiteID/AssetID polymorphic FKs for coverage; Start/End Date, VisitsIncluded/Used (counter), CoverageLevel enum: Basic/Premium – customizable; Fee (monthly/annual – for deferred revenue), Notes/AddOns JSON (e.g., "UV Light: Yes"). One-to-Many with VisitSchedules (dates/jobs linked), Renewals (history/expirations).
- **Sources**: Prepopulates from Customers/Companies/Sites/Assets (ownership/covered items – customizable defaults like "Quarterly Visits"), Settings (default levels/fees/schedules – e.g., seasonal for HVAC).
- **Interconnections** (App-Wide Flow for Shared Recurring Data):
  - **Customers/Companies/Sites**: Many-to-One (Agreement CustomerID/CompanyID/SiteID FK). Connectivity: Agreements inherit customer/site data (e.g., multi-sites covered as list – batch visits); territorial companies route renewals to contacts. App flow: Customer detail "New Agreement" embeds agreements form (data transfer to sites/assets); company multi-contacts: Auto-filter agreements by territory (e.g., West for Jill Dane).
  - **Assets**: Many-to-Many (via AgreementAssets junction). Connectivity: Assets selected for coverage (prepopulates from customer/sites – e.g., "All Furnaces"); visits update asset history (e.g., "Tune-Up Completed"). App flow: Asset detail "Add to Agreement" links (data transfer to coverage level); multi-assets per agreement/site (e.g., zone-specific for multi-story).
  - **Jobs/Calendar/Estimates**: One-to-Many (Job from AgreementID for auto-generated). Connectivity: Agreement schedules create jobs (transfer sites/assets/coverage to job details/material lists); job completion decrements visits used. App flow: Calendar embeds agreement events (data to job scheduling); estimates for add-ons link back (transfer to agreement updates).
  - **Material Lists/Inventory/Products**: Indirect via jobs (recurring lists for visits). Connectivity: Agreement "Default Kit" FK to material list (prepopulates jobs with sections – data flow: Deduct inventory on visit); products suggest for coverage (e.g., "Humidifier Add-On"). App flow: From agreement detail, "Generate Visit List" embeds builder (transfer to job materials).
  - **Invoices/Expenses/Payments**: One-to-Many (Invoice/Expense from AgreementID/Visits). Connectivity: Visits auto-invoice (transfer fee/add-ons to lines, recognize deferred revenue); expenses for non-covered (e.g., extra "Fire-rated Caulk"). App flow: Financials detail embeds agreement billing (data to payments); multi-visits batch invoices.
  - **Employees/QuickNotes/Notifications**: Employees for visit assignments (by cert); quick notes import to agreement notes (e.g., "Renewal Discussion"). Connectivity: Notification for renewal/visit due (to customer/contact/tech); quick note on job → Imports if agreement-linked.
  - **Shared Data Flow**: Customer/site/asset select (transfer ownership/coverage) → Agreement create (prepopulate visits from asset history) → Auto-schedule jobs (transfer to calendar with sites/assets/lists) → Visit execution (update asset history, deduct inventory) → Auto-invoice (transfer to financials with fee recognition) → Renewal (alert with usage summary). For multi-site: "Batch Coverage" links multiple sites/assets (shared data like fees aggregate for discounts). Robust views: "AgreementRenewalView" (joins expirations/visits for alerts); "TerritorialCoverageView" (filters by company contact).

**Layout & Sections** (Desktop Web Focus: Contract-Centric with Calendars, Responsive for Mobile Card-Stacking):
- **List View (/serviceagreements)**: Table (columns: Agreement #/Customer/Company (clickable), Start/End Date/Renewal Status (badges: Active/Expiring/Expired), Visits Used/Included, Fee/Total Value, Covered Sites/Assets Count – sortable/prepopulated like "Premium Only" dropdown customizable). Groupable by customer/company for multi-agreement overviews. Responsive: Cards with renewal badges.
- **Detail View (/serviceagreements/{id})**: Agreement "contract" with tabs/accordions.
  - **Header**: Agreement #/Status (dropdown update), Coverage Level Badge, Quick Actions dropdown ("Renew/Schedule Visit/Add Add-On/Generate Invoice" – prepopulates job/invoice with agreement data).
  - **Core Info Section**: Linked Customer/Company/Contact (territorial dropdown if company), Start/End Date/Fee (editable for renewals), Visits Included/Used (counter with progress bar), Add-Ons (JSON editable as checkboxes – customizable like "UV Light").
  - **Covered Entities Accordion**: "Sites/Assets" (embedded summaries with multi-site/asset grouping – filterable by territory).
  - **Visit Schedule & History Accordion**: Calendar snippet (embedded from calendar, with auto-generated events); History Table (visits/jobs: Date/Tech/Notes – clickable to job detail).
  - **Financials Accordion**: Deferred Revenue (recognized per visit), Linked Invoices/Expenses (preview/generate).
  - **Notes & Documents Accordion**: Quick notes feed (import for renewal discussions), docs (e.g., signed PDF – upload/view).
  - **Footer**: "Export Contract PDF/CSV", related links (e.g., "View All Visits" filtered by agreement).
- **Edit/Create View**: Form mirroring detail, with coverage selector (multi-select sites/assets – customizable defaults).

**UX Interactions & Flows**:
- **Agreement Flow**: Create from customer/site (prepopulate all) → Select coverage (dropdown/multi-select sites/assets – customizable) → Set visits/fee (auto-calc from add-ons) → Save auto-schedules first visit (transfer to calendar/job).
- **Connectivity Flow**: From detail, "Schedule Visit" → Opens calendar with agreement prepopulated (data transfer to job); renewal "Extend" clones with updates (transfer to new agreement).
- **List to Detail**: Filter "Expiring for Territorial Contacts" → Click agreement → Detail with visit history expanded; for multi-site companies, filter groups by site.
- **User Journey**: Office from customer (company with chain stores) → New agreement for multi-sites (prepopulate shared assets) → Auto-schedule visits (territorial filter) → Tech mobile logs visit (transfer to invoice, decrement used) → Renewal alert (with usage summary).
- **Efficiency Features**: Prepopulated dropdowns (levels/add-ons – customizable add/edit/remove); auto-alerts (e.g., "Visits Low – Upsell?"); search agreements by customer # across app.

**Customizations & Configurability**:
- Admins: Add/edit/remove enums (e.g., Level: Add "Gold"; Add-On: Add "Air Cleaner" for HVAC); customize schedule rules (e.g., seasonal frequency); toggle fields (e.g., add "Escalation Clause" for trades). Per-role: Techs view visit schedules only (mobile); office renews/full edit.
- Quick Notes: Import to notes (e.g., "Renewal" category auto-appends as discussion log).

**Edge Cases & Robustness**:
- Multi-Site Coverage: Handle "One Agreement, Multiple Sites" (e.g., batch visits with shared used counter – grouped schedules); "Territorial Renewals" (contact-specific alerts/edits).
- Low Visits: Auto-upsell prompt on save (e.g., "Add More?").
- Large Agreements: Pagination in history/visits; collapse accordions.
- Permissions: Techs log visits (update used); managers renew. Hidden fees for techs.
- Offline: Mobile caches visit schedules (log local, sync decrements used with merge).

**Integrations & Automation**:
- Triggers: Visit due → Alert (SMS to tech/customer/contact); expiry near → Renewal draft (auto-email proposal).
- External: Calendar sync for visit events; Stripe for recurring fee payments (embed in detail).
- Workflow Ties: Quick links ensure progression (e.g., "From Agreement to Job" → Prepopulates scheduler with sites/assets/lists, transferring data). For companies: Territorial auto-alert (e.g., notify right contact for renewal).

**Mobile Considerations**:
- List as coverage-filtered cards (swipe to view detail/schedule visit); detail as vertical scroll with accordions (tap expand visit history). Mobile visit log: Clean check-in UI with voice notes, GPS for auto-start. Offline cache prioritizes tech's agreements (log visits local, sync updates used/history). Responsive layouts stack groups to lists; embedded in customers as bottom sheet for quick creation, ensuring techs can reference on-site without rework.

### Service History & Warranty Claims Page - Exhaustive Description (Separate Page as Requested)

**Routes**: `/servicehistory` (list view for browsing and searching all service records and warranty claims); `/servicehistory/{id}` (detail view for a specific record/claim, including resolution and quick actions); `/servicehistory/new` or `/servicehistory/{id}/edit` (create/edit view for logging new history or claims). For contextual integration, embeddable as a component or modal in related pages like Assets (e.g., `/assets/{assetId}/servicehistory` to list only that asset's records) or Customers (e.g., `/customers/{customerId}/servicehistory` to aggregate across sites/assets). This ensures seamless workflow—e.g., while viewing an asset's detail, log a new non-warranty repair without leaving, with data (e.g., asset specs/site from the customer) transferring automatically to prepopulate the form, reducing steps for the contractor tracking long-term equipment performance.

**Purpose & Business Context**:
- The Service History & Warranty Claims page is a dedicated, separate tool (as requested) for logging, tracking, and resolving all service events—both warranty (e.g., manufacturer-covered repairs) and non-warranty (e.g., routine or out-of-pocket fixes)—serving as the "maintenance logbook" that provides historical context for better decision-making. For a small HVAC contractor, it separates from agreements to focus on reactive/post-install tracking: E.g., a warranty claim for a leaking compressor at a company's territorial site (linked to asset/install date for eligibility), or non-warranty history for a landlord's multi-rental filters (tracking "Changed 3x This Year" across sites to suggest upgrades). Presentation emphasizes chronology: List views show timelines with status/resolution, while details provide a "service ticket" with evidence (photos/notes) for disputes or audits.
- HVAC-specific: Tracks warranty-specific details like refrigerant leaks (with claim forms for EPA compliance) or non-warranty wear (e.g., duct insulation degradation), with alerts for patterns (e.g., "Frequent Filter Claims – Suggest Better Model"). Generic foundation: Adaptable for other trades—e.g., repurpose "Refrigerant Claim" for "Pipe Leak Warranty" in plumbing (material defects) or "Circuit Breaker Failure" in electrical (load issues), using customizable claim types to adjust while maintaining core history (dates/techs/resolutions). This supports relationships: Claims tie to customers/sites/companies/assets for traceability (e.g., multi-site claims batch for a chain, filtered by territorial contact).
- Business value: Promotes user-friendly efficiency by automating shared data transfer—e.g., a job completion logs history automatically (prepopulate from job materials/tech), a warranty claim pulls asset install date/warranty expiry (flow to manufacturer submission), and non-warranty records update customer summaries for upselling agreements. Industry thinking: Contractors use history for warranties (e.g., avoid out-of-pocket costs) and patterns (e.g., recurring issues at a site signal bigger problems); the page supports this with mobile logging for techs (clean UI for photo evidence), prepopulated customizable dropdowns (e.g., "Claim Type: Defect/Leak" editable in settings to add "Overload"), and shared data (e.g., a claim for a company's store links to territorial contact for approval, with site-specific notes from quick notes). For multi-site customers/companies (e.g., landlords with rentals or chains with divisions), history enables "group analysis" (batch claims across sites, shared resolutions for similar assets), with territorial filtering to route claims correctly (e.g., submit to right vendor for East sites). Overall robustness: Separate page ensures focused tracking—e.g., history from jobs/assets feeds reports for trends, claims link to expenses/invoices for reimbursements, building a complete service narrative.

**Data Sources & Interconnections** (With Requested Relationships to Customers/Sites/Companies/Assets):
- **Core Entity**: ServiceHistory table (ID PK, Type enum: WarrantyClaim/NonWarrantyRepair – customizable; CustomerID/CompanyID/SiteID/AssetID polymorphic FKs for relationships; Date/Description/Resolution/Status enum: Open/Pending/Resolved/Denied – customizable; TechID FK; Evidence JSON (photos/notes/receipts); Cost/Reimbursement if applicable). One-to-Many with ClaimsDocs (attachments for warranties).
- **Sources**: Prepopulates from Jobs (completed details for history logs – customizable types like "Routine Check"), Assets (specs/install date for warranty eligibility), Sites/Customers/Companies (ownership/location/contacts – for relationships), Settings (default types/statuses – e.g., "Claim Submission Template" for HVAC vendors).
- **Interconnections** (App-Wide Flow for Shared History Data, Emphasizing Requested Relationships):
  - **Customers/Companies**: Many-to-One (History CustomerID/CompanyID FK). Connectivity: History aggregates by customer/company (e.g., "3 Claims This Year Across Sites"); territorial companies route claims to contacts. App flow: Customer detail "Service History" embeds filtered view (data transfer to new claim); company multi-contacts: Auto-filter history by territory (e.g., West for Jill Dane).
  - **Sites**: Many-to-One (History SiteID FK). Connectivity: Sites group history (e.g., multi-asset repairs at one location); site detail "History at This Site" pulls records (with multi-site batch for landlords). App flow: Site "Log New Repair" opens history form with site prepopulated (data transfer to location/notes); dispersed sites (e.g., estates) suggest patterns (e.g., "Similar Claims at Other Sites?").
  - **Assets**: Many-to-One (History AssetID FK). Connectivity: Assets append history (e.g., "Non-Warranty: Filter Change" updates asset log); warranty claims validate against asset install/expiry. App flow: Asset detail "Add History/Claim" embeds form (data transfer to type/description from asset specs); multi-assets per site (e.g., zone-specific claims group in views).
  - **Jobs/Estimates/Calendar**: One-to-Many (History from JobID). Connectivity: Job completion auto-logs history (transfer materials/tech/description – data flow to type/resolution); estimates for warranty work link back. App flow: Job detail "Log as History" transfers to form (prepopulate for non-warranty); calendar events from agreements append to history on close.
  - **Material Lists/Inventory/Products/Financials**: Indirect via jobs (materials used in history from lists). Connectivity: History "Parts Used" pulls from material lists (transfer to claims for reimbursement); inventory deductions log as history evidence. App flow: Invoice from job embeds history preview (data to expenses for non-warranty costs); payments reimburse claims (link to resolutions).
  - **QuickNotes/Notifications/Employees**: Quick notes import to description (e.g., "Repair" category); employees in logs (tech ID for accountability); notifications from status (e.g., claim denied alert).
  - **Shared Data Flow**: Job completion at site/asset (transfer details) → Auto-log history/claim (prepopulate type from warranty status) → Update asset/site/customer/company records (append to summaries) → Claim resolution (transfer to expenses/reimbursements) → Reports (e.g., "Claim Trends by Asset/Site"). For multi-site: "Batch Log" for landlord estates (shared data like resolutions aggregate for patterns). Robust views: "HistoryByAssetView" (joins for timelines); "TerritorialClaimsView" (filters by company contact).

**Layout & Sections** (Desktop Web Focus: Timeline-Centric with Filters, Responsive for Mobile Card-Stacking):
- **List View (/servicehistory)**: Table (columns: Record #/Type (Claim/Repair badge – filter dropdown customizable), Linked Customer/Company/Site/Asset (clickable), Date/Status (badges: Open/Resolved), Resolution Snippet, Tech – sortable/prepopulated like "Warranty Only" dropdown). Groupable by asset/site/customer for pattern spotting. Responsive: Cards with status badges.
- **Detail View (/servicehistory/{id})**: Record "ticket" with sections.
  - **Header**: Record #/Type, Status (dropdown update), Quick Actions dropdown ("Resolve Claim/Log Resolution/Add Evidence" – prepopulates forms with record data).
  - **Core Info Section**: Linked Customer/Company/Contact (territorial dropdown if company), Site/Link (address/map), Asset/Link (specs/history).
  - **Description & Evidence Accordion**: Text/Notes (quick note import), Attachments (photos/receipts/PDFs – upload/view).
  - **Resolution & History Accordion**: Status Timeline (changes/dates), Resolution Notes/Cost/Reimbursement.
  - **Connections Accordion**: "Related Records" (other history/claims for same asset/site – links); "Linked Job/Invoice" (from originating work).
  - **Footer**: "Export Claim PDF/CSV", related links (e.g., "View All for Asset" filtered).
- **Edit/Create View**: Form mirroring detail, with linker (multi-select customer/site/company/asset – customizable defaults).

**UX Interactions & Flows**:
- **Logging Flow**: Create from asset/job (prepopulate all) → Select type (dropdown customizable) → Add evidence (photo/voice) → Resolve (update status, transfer to reimbursement).
- **Connectivity Flow**: From detail, "Link to Asset/Site" → Dropdown pulls from customer (data transfer to relationships); resolution "Reimburse" creates expense (transfer to financials).
- **List to Detail**: Filter "Open Claims for Territorial Contacts" → Click record → Detail with evidence expanded; for multi-site companies, filter groups by site.
- **User Journey**: Tech from job (company with chain stores) → Log non-warranty repair (prepopulate from job/site/asset) → Office views history (territorial filter) → File warranty claim (transfer evidence) → Resolve (update asset, reimburse via payment).
- **Efficiency Features**: Prepopulated dropdowns (types/status – customizable add/edit/remove); auto-alerts (e.g., "Pattern Detected – Similar Claims on Other Assets?"); search records by asset serial across app.

**Customizations & Configurability**:
- Admins: Add/edit/remove enums (e.g., Type: Add "Recall"; Status: Add "In Progress"); customize evidence requirements (e.g., mandate photo for claims); toggle fields (e.g., add "Vendor Response" for HVAC manufacturers). Per-role: Techs log only (evidence/status); office resolves/full edit.
- Quick Notes: Import to description (e.g., "Claim" category auto-appends as evidence).

**Edge Cases & Robustness**:
- Multi-Relationships: Handle "One Record, Multiple Assets/Sites" (e.g., batch claims for landlord estates – grouped resolutions); "Territorial Claims" (contact-specific views/edits).
- No Evidence: Require for resolution (e.g., "Add Photo First?").
- Large Histories: Pagination in lists/history; filter limits (e.g., "By Asset Only").
- Permissions: Techs create logs (from jobs); managers resolve claims. Hidden resolutions for techs.
- Offline: Mobile caches draft records (log local, sync with merge – e.g., "Duplicate Claim – Resolve?").

**Integrations & Automation**:
- Triggers: New record from job → Alert (e.g., "Review for Warranty?"); expiry/resolution → Notify customer/contact/tech.
- External: Manufacturer API for claim submission (e.g., auto-fill from asset specs); PDF export for claim forms (with evidence).
- Workflow Ties: Quick links ensure progression (e.g., "From History to New Job" → Prepopulates scheduler with sites/assets/previous resolution, transferring data). For companies: Territorial auto-notify (e.g., alert right contact for claim updates).

**Mobile Considerations**:
- List as type-filtered cards (swipe to view detail/log new); detail as vertical scroll with accordions (tap expand evidence). Mobile logging: Clean form with camera for photos, voice for notes. Offline cache prioritizes tech's job-linked records (log local, sync appends to asset/site history). Responsive layouts stack groups to lists; embedded in assets as bottom sheet for quick logging, ensuring techs can record on-site without rework.