@page "/customers"
@page "/customers/new"
@page "/customers/{Id:int}"
@page "/customers/{Id:int}/edit"
@inject ICustomerService CustomerService
@inject ISiteService SiteService
@inject IDropdownService DropdownSvc
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>@(_pageTitle) - OneManVanFSM</PageTitle>

@if (_loading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Loading...</p>
    </div>
}
else if (_view == View.List)
{
    @* ===== LIST VIEW ===== *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-people-fill me-2"></i>Customers</h4>
        <div class="d-flex gap-2 align-items-center">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="showArchivedCustomers" checked="@_filter.ShowArchived" @onchange="ToggleShowArchived" />
                <label class="form-check-label small" for="showArchivedCustomers"><i class="bi bi-archive me-1"></i>Show Archived</label>
            </div>
            @if (!_filter.ShowArchived)
            {
                <a href="customers/new" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg me-1"></i>New Customer</a>
            }
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-center">
                <div class="col-md-5">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Search name, email, phone..."
                               @bind="_filter.Search" @bind:event="oninput" @bind:after="ReloadList" />
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="_filterType" @bind:after="OnTypeFilterChanged">
                        <option value="">All Types</option>
                        @foreach (var t in _customerTypeOptions) { <option value="@t">@t</option> }
                    </select>
                </div>
                <div class="col-md-4 text-end text-muted small">
                    @_customers.Count customer@(_customers.Count != 1 ? "s" : "")
                </div>
            </div>
        </div>
    </div>

    @if (_selectedIds.Count > 0)
    {
        <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
            <span><strong>@_selectedIds.Count</strong> customer(s) selected</span>
            <div class="d-flex gap-2">
                @if (_filter.ShowArchived)
                {
                    <button class="btn btn-success btn-sm" @onclick="BulkRestore"><i class="bi bi-arrow-counterclockwise me-1"></i>Restore</button>
                    @if (!_confirmBulkDelete) { <button class="btn btn-danger btn-sm" @onclick="() => _confirmBulkDelete = true"><i class="bi bi-trash3 me-1"></i>Delete Permanently</button> }
                    else { <button class="btn btn-danger btn-sm fw-semibold" @onclick="BulkDeletePermanently"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete Forever</button> <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmBulkDelete = false">Cancel</button> }
                }
                else
                {
                    <button class="btn btn-warning btn-sm" @onclick="BulkArchive"><i class="bi bi-archive me-1"></i>Archive</button>
                    @if (!_confirmBulkDelete) { <button class="btn btn-danger btn-sm" @onclick="() => _confirmBulkDelete = true"><i class="bi bi-trash3 me-1"></i>Delete Permanently</button> }
                    else { <button class="btn btn-danger btn-sm fw-semibold" @onclick="BulkDeletePermanently"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete Forever</button> <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmBulkDelete = false">Cancel</button> }
                }
                <button class="btn btn-outline-secondary btn-sm" @onclick="ClearSelection"><i class="bi bi-x-lg me-1"></i>Clear</button>
            </div>
        </div>
    }

    @if (_customers.Count == 0)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-people" style="font-size: 3rem;"></i>
                @if (_filter.ShowArchived)
                {
                    <p class="mt-2 mb-1">No archived customers to show.</p>
                }
                else
                {
                    <p class="mt-2 mb-1">No customers found.</p>
                    <a href="customers/new" class="btn btn-outline-primary btn-sm mt-2">Add Your First Customer</a>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width:40px;"><input type="checkbox" class="form-check-input" checked="@_allSelected" @onchange="ToggleSelectAll" title="Select all" /></th>
                            <th role="button" @onclick='() => ToggleSort("Name")'>
                                Name @SortIcon("Name")
                            </th>
                            <th role="button" @onclick='() => ToggleSort("Type")'>
                                Type @SortIcon("Type")
                            </th>
                            <th class="d-none d-md-table-cell" role="button" @onclick='() => ToggleSort("Contact")'>Contact @SortIcon("Contact")</th>
                            <th class="text-center d-none d-lg-table-cell" role="button" @onclick='() => ToggleSort("Sites")'>Sites @SortIcon("Sites")</th>
                            <th class="text-center d-none d-lg-table-cell" role="button" @onclick='() => ToggleSort("Assets")'>Assets @SortIcon("Assets")</th>
                            <th class="text-center d-none d-md-table-cell" role="button" @onclick='() => ToggleSort("OpenJobs")'>Open Jobs @SortIcon("OpenJobs")</th>
                            <th class="text-end d-none d-lg-table-cell" role="button" @onclick='() => ToggleSort("Balance")'>
                                Balance @SortIcon("Balance")
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in _customers)
                        {
                            <tr class="@(_selectedIds.Contains(c.Id) ? "table-active" : "")">
                                <td @onclick:stopPropagation="true"><input type="checkbox" class="form-check-input" checked="@_selectedIds.Contains(c.Id)" @onchange="() => ToggleRowSelection(c.Id)" /></td>
                                <td role="button" @onclick="() => GoToDetail(c.Id)">
                                    <span class="fw-semibold">@c.Name</span>
                                    @if (!string.IsNullOrEmpty(c.CompanyName))
                                    {
                                        <br /><small class="text-muted">@c.CompanyName</small>
                                    }
                                </td>
                                <td>
                                    <span class="badge @TypeBadgeClass(c.Type)">@c.Type</span>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    <small>
                                        @if (!string.IsNullOrEmpty(c.PrimaryPhone))
                                        {
                                            <span><i class="bi bi-telephone me-1"></i>@c.PrimaryPhone</span><br />
                                        }
                                        @if (!string.IsNullOrEmpty(c.PrimaryEmail))
                                        {
                                            <span><i class="bi bi-envelope me-1"></i>@c.PrimaryEmail</span>
                                        }
                                    </small>
                                </td>
                                <td class="text-center d-none d-lg-table-cell">@c.SiteCount</td>
                                <td class="text-center d-none d-lg-table-cell">@c.AssetCount</td>
                                <td class="text-center d-none d-md-table-cell">
                                    @if (c.OpenJobCount > 0)
                                    {
                                        <span class="badge bg-primary">@c.OpenJobCount</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">0</span>
                                    }
                                </td>
                                <td class="text-end d-none d-lg-table-cell">
                                    @if (c.OutstandingBalance > 0)
                                    {
                                        <span class="text-danger fw-semibold">@c.OutstandingBalance.ToString("C")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">$0.00</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    @if (!string.IsNullOrEmpty(_bulkMsg))
    {
        <div class="alert @(_bulkMsgIsError ? "alert-danger" : "alert-success") mt-2 mb-0 py-2"><i class="bi @(_bulkMsgIsError ? "bi-x-circle" : "bi-check-circle") me-1"></i>@_bulkMsg</div>
    }
}
else if (_view == View.Detail && _detail is not null)
{
    @* ===== DETAIL VIEW ===== *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-secondary" @onclick='() => Navigation.NavigateTo("/customers")'>
                <i class="bi bi-arrow-left"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="GoToPrevCustomer" disabled="@(GetAdjacentCustomerId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="GoToNextCustomer" disabled="@(GetAdjacentCustomerId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
            <h4 class="mb-0">
                <i class="bi bi-person-fill me-2"></i>@_detail.Name
                <span class="badge @TypeBadgeClass(_detail.Type) ms-2 fs-6">@_detail.Type</span>
            </h4>
        </div>
        <div class="dropdown">
            <button class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-plus-lg me-1"></i>Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="customers/@_detail.Id/edit"><i class="bi bi-pencil me-2"></i>Edit Customer</a></li>
                <li><a class="dropdown-item" href="sites/new?customerId=@_detail.Id"><i class="bi bi-geo-alt me-2"></i>New Site</a></li>
                <li><a class="dropdown-item" href="jobs/new?customerId=@_detail.Id"><i class="bi bi-wrench me-2"></i>New Job</a></li>
                <li><a class="dropdown-item" href="estimates/new?customerId=@_detail.Id"><i class="bi bi-calculator me-2"></i>New Estimate</a></li>
                @if (!string.IsNullOrEmpty(_detail.PrimaryEmail))
                {
                    <li><button class="dropdown-item" @onclick="EmailCustomer"><i class="bi bi-envelope me-2"></i>Email Customer</button></li>
                }
                <li><hr class="dropdown-divider" /></li>
                @if (!_confirmArchive)
                {
                    <li><button class="dropdown-item text-danger" @onclick="() => _confirmArchive = true"><i class="bi bi-archive me-2"></i>Archive</button></li>
                }
                else
                {
                    <li><button class="dropdown-item text-danger fw-semibold" @onclick="ArchiveCustomer"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Archive?</button></li>
                    <li><button class="dropdown-item" @onclick="() => _confirmArchive = false"><i class="bi bi-x-lg me-2"></i>Cancel</button></li>
                }
            </ul>
        </div>
    </div>

    @* Contact Info Card *@
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <h6 class="card-title text-muted"><i class="bi bi-person-lines-fill me-1"></i>Contact Information</h6>
            <div class="row">
                <div class="col-md-6">
                    @if (!string.IsNullOrEmpty(_detail.PrimaryPhone))
                    {
                        <div class="mb-1"><i class="bi bi-telephone me-2 text-muted"></i>@_detail.PrimaryPhone</div>
                    }
                    @if (!string.IsNullOrEmpty(_detail.SecondaryPhone))
                    {
                        <div class="mb-1"><i class="bi bi-telephone me-2 text-muted"></i>@_detail.SecondaryPhone <small class="text-muted">(secondary)</small></div>
                    }
                    @if (!string.IsNullOrEmpty(_detail.PrimaryEmail))
                    {
                        <div class="mb-1"><i class="bi bi-envelope me-2 text-muted"></i>@_detail.PrimaryEmail</div>
                    }
                    @if (!string.IsNullOrEmpty(_detail.PreferredContactMethod))
                    {
                        <div class="mb-1"><i class="bi bi-chat-dots me-2 text-muted"></i>Prefers: <span class="badge bg-light text-dark border">@_detail.PreferredContactMethod</span></div>
                    }
                    @if (!string.IsNullOrEmpty(_detail.CompanyName))
                    {
                        <div class="mb-1"><i class="bi bi-building me-2 text-muted"></i>@_detail.CompanyName</div>
                    }
                </div>
                <div class="col-md-6">
                    @{ var addr = FormatAddress(_detail); }
                    @if (!string.IsNullOrEmpty(addr))
                    {
                        <div class="mb-1"><i class="bi bi-geo-alt me-2 text-muted"></i>@addr</div>
                    }
                    <div class="mb-1"><i class="bi bi-calendar me-2 text-muted"></i>Customer since @_detail.SinceDate.ToString("MMM yyyy")</div>
                    @if (_detail.CreditLimit > 0)
                    {
                        <div class="mb-1"><i class="bi bi-credit-card me-2 text-muted"></i>Credit Limit: @_detail.CreditLimit.ToString("C")</div>
                    }
                    @if (_detail.BalanceOwed > 0)
                    {
                        <div class="mb-1"><i class="bi bi-cash me-2 text-danger"></i><strong>Balance Owed:</strong> <span class="text-danger">@_detail.BalanceOwed.ToString("C")</span></div>
                    }
                    @if (_detail.TaxExempt)
                    {
                        <div class="mb-1"><i class="bi bi-shield-check me-2 text-success"></i><span class="badge bg-success">Tax Exempt</span></div>
                    }
                    @if (!string.IsNullOrEmpty(_detail.ReferralSource))
                    {
                        <div class="mb-1"><i class="bi bi-megaphone me-2 text-muted"></i>Referral: @_detail.ReferralSource</div>
                    }
                </div>
            </div>
            @if (!string.IsNullOrEmpty(_detail.Notes))
            {
                <div class="mt-2 p-2 bg-light rounded small">@_detail.Notes</div>
            }
            @if (!string.IsNullOrEmpty(_detail.Tags))
            {
                <div class="mt-2">
                    @foreach (var tag in _detail.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                    {
                        <span class="badge bg-light text-dark border me-1"><i class="bi bi-tag me-1"></i>@tag</span>
                    }
                </div>
            }
            <hr class="my-2" />
            <div class="d-flex gap-3 text-muted small">
                <span><i class="bi bi-clock me-1"></i>Created @_detail.CreatedAt.ToString("MMM dd, yyyy")</span>
                <span><i class="bi bi-pencil-square me-1"></i>Updated @_detail.UpdatedAt.ToString("MMM dd, yyyy")</span>
            </div>
        </div>
    </div>

    @* Tabbed Sections *@
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "sites" ? "active" : "")" @onclick='() => _activeTab = "sites"'>
                Sites <span class="badge bg-secondary ms-1">@_detail.Sites.Count</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "assets" ? "active" : "")" @onclick='() => _activeTab = "assets"'>
                Assets <span class="badge bg-secondary ms-1">@_detail.Assets.Count</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "jobs" ? "active" : "")" @onclick='() => _activeTab = "jobs"'>
                Jobs <span class="badge bg-secondary ms-1">@(_detail.RecentJobs.Count + _detail.UpcomingJobs.Count)</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "financials" ? "active" : "")" @onclick='() => _activeTab = "financials"'>
                Financials <span class="badge bg-secondary ms-1">@(_detail.OutstandingInvoices.Count + _detail.ServiceAgreements.Count)</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(_activeTab == "notes" ? "active" : "")" @onclick='() => _activeTab = "notes"'>
                Notes <span class="badge bg-secondary ms-1">@_detail.RecentNotes.Count</span>
            </button>
        </li>
    </ul>

    @* Tab Content *@
    @if (_activeTab == "sites")
    {
        <div class="card border-0 shadow-sm">
            @if (_detail.Sites.Count == 0)
            {
                <div class="card-body text-center py-4 text-muted">
                    <i class="bi bi-geo-alt" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No sites yet. <a href="sites/new?customerId=@_detail.Id">Add one?</a></p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>Site</th><th>Address</th><th class="text-center">Assets</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var s in _detail.Sites)
                            {
                                <tr role="button" @onclick="() => GoToSite(s.Id)">
                                    <td class="fw-semibold">@s.Name</td>
                                    <td><small class="text-muted">@FormatSiteAddress(s)</small></td>
                                    <td class="text-center">@s.AssetCount</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else if (_activeTab == "assets")
    {
        <div class="card border-0 shadow-sm">
            @if (_detail.Assets.Count == 0)
            {
                <div class="card-body text-center py-4 text-muted">
                    <i class="bi bi-cpu" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No assets tracked for this customer.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>Asset</th><th>Type</th><th>Site</th><th>Installed</th><th>Warranty</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var a in _detail.Assets)
                            {
                                <tr role="button" @onclick="() => GoToAsset(a.Id)">
                                    <td class="fw-semibold">@a.Name</td>
                                    <td><small class="text-muted">@(a.AssetType ?? "—")</small></td>
                                    <td><small>@(a.SiteName ?? "—")</small></td>
                                    <td><small>@(a.InstallDate?.ToString("MMM yyyy") ?? "—")</small></td>
                                    <td>
                                        @if (a.WarrantyExpiry.HasValue)
                                        {
                                            var expired = a.WarrantyExpiry.Value < DateTime.UtcNow;
                                            <span class="badge @(expired ? "bg-danger" : "bg-success")">
                                                @(expired ? "Expired" : a.WarrantyExpiry.Value.ToString("MMM yyyy"))
                                            </span>
                                        }
                                        else
                                        {
                                            <small class="text-muted">—</small>
                                        }
                                    </td>
                                    <td><span class="badge @AssetStatusBadge(a.Status)">@a.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else if (_activeTab == "jobs")
    {
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-clock me-1"></i>Upcoming Jobs</h6>
            </div>
            @if (_detail.UpcomingJobs.Count == 0)
            {
                <div class="card-body text-center py-3 text-muted small">No upcoming jobs.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>Job #</th><th>Title</th><th>Site</th><th>Date</th><th>Tech</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var j in _detail.UpcomingJobs)
                            {
                                <tr role="button" @onclick="() => GoToJob(j.Id)">
                                    <td class="fw-semibold">@j.JobNumber</td>
                                    <td>@(j.Title ?? "—")</td>
                                    <td><small>@(j.SiteName ?? "—")</small></td>
                                    <td><small>@(j.ScheduledDate?.ToString("MMM dd") ?? "TBD")</small></td>
                                    <td><small>@(j.TechnicianName ?? "Unassigned")</small></td>
                                    <td><span class="badge @JobStatusBadge(j.Status)">@j.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-check-circle me-1"></i>Recent Jobs</h6>
            </div>
            @if (_detail.RecentJobs.Count == 0)
            {
                <div class="card-body text-center py-3 text-muted small">No past jobs.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>Job #</th><th>Title</th><th>Site</th><th>Date</th><th>Tech</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var j in _detail.RecentJobs)
                            {
                                <tr role="button" @onclick="() => GoToJob(j.Id)">
                                    <td class="fw-semibold">@j.JobNumber</td>
                                    <td>@(j.Title ?? "—")</td>
                                    <td><small>@(j.SiteName ?? "—")</small></td>
                                    <td><small>@(j.ScheduledDate?.ToString("MMM dd") ?? "—")</small></td>
                                    <td><small>@(j.TechnicianName ?? "—")</small></td>
                                    <td><span class="badge @JobStatusBadge(j.Status)">@j.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else if (_activeTab == "financials")
    {
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-receipt me-1"></i>Outstanding Invoices</h6>
            </div>
            @if (_detail.OutstandingInvoices.Count == 0)
            {
                <div class="card-body text-center py-3 text-muted small">No outstanding invoices.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>Invoice #</th><th>Status</th><th class="text-end">Total</th><th class="text-end">Balance Due</th><th>Due Date</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var inv in _detail.OutstandingInvoices)
                            {
                                <tr role="button" @onclick="() => GoToInvoice(inv.Id)">
                                    <td class="fw-semibold">@inv.InvoiceNumber</td>
                                    <td><span class="badge @InvoiceStatusBadge(inv.Status)">@inv.Status</span></td>
                                    <td class="text-end">@inv.Total.ToString("C")</td>
                                    <td class="text-end text-danger fw-semibold">@inv.BalanceDue.ToString("C")</td>
                                    <td><small>@(inv.DueDate?.ToString("MMM dd, yyyy") ?? "—")</small></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-file-earmark-check me-1"></i>Service Agreements</h6>
            </div>
            @if (_detail.ServiceAgreements.Count == 0)
            {
                <div class="card-body text-center py-3 text-muted small">No service agreements.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr><th>Agreement</th><th>Coverage</th><th>Period</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var sa in _detail.ServiceAgreements)
                            {
                                <tr role="button" @onclick="() => GoToAgreement(sa.Id)">
                                    <td class="fw-semibold">@sa.Title</td>
                                    <td><small>@(sa.AgreementType ?? "—")</small></td>
                                    <td><small>@(sa.StartDate?.ToString("MMM yyyy")) – @(sa.EndDate?.ToString("MMM yyyy"))</small></td>
                                    <td>
                                        <span class="badge @(sa.IsActive ? "bg-success" : "bg-secondary")">
                                            @(sa.IsActive ? "Active" : "Inactive")
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else if (_activeTab == "notes")
    {
        <div class="card border-0 shadow-sm">
            @if (_detail.RecentNotes.Count == 0)
            {
                <div class="card-body text-center py-4 text-muted">
                    <i class="bi bi-sticky" style="font-size: 2rem;"></i>
                    <p class="mt-2 mb-0">No notes yet. <a href="quicknotes/new?customerId=@_detail.Id">Add one?</a></p>
                </div>
            }
            else
            {
                <div class="list-group list-group-flush">
                    @foreach (var n in _detail.RecentNotes)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">@(n.Category ?? "General")</small>
                                <small class="text-muted">@n.CreatedAt.ToString("MMM dd, yyyy")</small>
                            </div>
                            <p class="mb-0 mt-1">@n.Content</p>
                        </div>
                    }
                </div>
            }
        </div>
    }
}
else if (_view == View.Form)
{
    @* ===== CREATE / EDIT FORM ===== *@
    <div class="d-flex align-items-center gap-2 mb-3">
        <button class="btn btn-sm btn-outline-secondary" @onclick="GoBack">
            <i class="bi bi-arrow-left"></i>
        </button>
        @if (Id.HasValue)
        {
            <button class="btn btn-sm btn-outline-secondary" @onclick="GoToPrevCustomerEdit" disabled="@(GetAdjacentCustomerEditId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="GoToNextCustomerEdit" disabled="@(GetAdjacentCustomerEditId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        }
        <h4 class="mb-0"><i class="bi bi-person-fill me-2"></i>@(Id.HasValue ? "Edit" : "New") Customer</h4>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="_editModel" OnValidSubmit="SaveCustomer">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger small" />

                @if (!string.IsNullOrEmpty(_formError))
                {
                    <div class="alert alert-danger py-2 small">@_formError</div>
                }

                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <InputText @bind-Value="_editModel.FirstName" class="form-control" placeholder="First name" />
                        <ValidationMessage For="() => _editModel.FirstName" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Last Name</label>
                        <InputText @bind-Value="_editModel.LastName" class="form-control" placeholder="Last name" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Type</label>
                        <select class="form-select" value="@_editModel.Type" @onchange="OnCustomerTypeChanged">
                            @foreach (var opt in _customerTypeOptions)
                            {
                                <option value="@opt">@opt</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" value="@_editModel.PrimaryPhone"
                               @oninput="e => _editModel.PrimaryPhone = FormatPhone(e.Value?.ToString())" placeholder="(555) 123-4567" />
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Email</label>
                        <InputText @bind-Value="_editModel.PrimaryEmail" class="form-control" placeholder="email@example.com" />
                        <ValidationMessage For="() => _editModel.PrimaryEmail" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Secondary Phone</label>
                        <input type="tel" class="form-control" value="@_editModel.SecondaryPhone"
                               @oninput="e => _editModel.SecondaryPhone = FormatPhone(e.Value?.ToString())" placeholder="(555) 987-6543" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Preferred Contact</label>
                        <InputSelect @bind-Value="_editModel.PreferredContactMethod" class="form-select">
                            <option value="">No Preference</option>
                            @foreach (var opt in _preferredContactOptions)
                            {
                                <option value="@opt">@opt</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Referral Source</label>
                        <InputSelect @bind-Value="_editModel.ReferralSource" class="form-select">
                            <option value="">— Select —</option>
                            @foreach (var opt in _referralSourceOptions)
                            {
                                <option value="@opt">@opt</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <hr class="my-2" />

                <div class="mb-2">
                    <label class="form-label">Address</label>
                    <InputText @bind-Value="_editModel.Address" class="form-control" placeholder="Street address" />
                </div>
                <div class="row">
                    <div class="col-md-5 mb-2">
                        <label class="form-label">City</label>
                        <InputText @bind-Value="_editModel.City" class="form-control" />
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">State</label>
                        <InputText @bind-Value="_editModel.State" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Zip</label>
                        <InputText @bind-Value="_editModel.Zip" class="form-control" />
                    </div>
                </div>

                <hr class="my-2" />

                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Credit Limit</label>
                        <InputNumber @bind-Value="_editModel.CreditLimit" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Company</label>
                        <InputSelect @bind-Value="_editModel.CompanyId" class="form-select">
                            <option value="">— No Company —</option>
                            @foreach (var co in _companies)
                            {
                                <option value="@co.Id">@co.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4 mb-2 d-flex align-items-end">
                        <div class="form-check mb-2">
                            <InputCheckbox @bind-Value="_editModel.TaxExempt" class="form-check-input" id="taxExemptCheck" />
                            <label class="form-check-label" for="taxExemptCheck">Tax Exempt</label>
                        </div>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">Tags</label>
                    <InputText @bind-Value="_editModel.Tags" class="form-control" placeholder="VIP, Warranty Customer, Propane (comma separated)" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Notes</label>
                    <InputTextArea @bind-Value="_editModel.Notes" class="form-control" rows="3" placeholder="Internal notes about this customer..." />
                </div>

                <div class="d-flex justify-content-end gap-2 align-items-center">
                    <button type="button" class="btn btn-outline-secondary" @onclick="GoBack">Cancel</button>
                    @if (!string.IsNullOrEmpty(_savedMsg)) { <span class="text-success small"><i class="bi bi-check-circle me-1"></i>@_savedMsg</span> }
                    <button type="submit" class="btn btn-outline-primary" disabled="@_saving" @onclick="() => _closeAfterSave = false">
                        @if (_saving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-floppy me-1"></i>Save
                    </button>
                    <button type="submit" class="btn btn-primary" disabled="@_saving" @onclick="() => _closeAfterSave = true">
                        @if (_saving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-circle me-1"></i>Save & Close
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    private enum View { List, Detail, Form }
    private View _view = View.List;
    private bool _loading = true;
    private string _pageTitle = "Customers";
    private string _activeTab = "sites";

    // List
    private List<CustomerListItem> _customers = [];
    private CustomerFilter _filter = new();
    private string _filterType = "";

    // Detail
    private CustomerDetail? _detail;

    // Form
    private CustomerEditModel _editModel = new();
    private List<CompanyOption> _companies = [];
    private string? _formError;
    private bool _saving;
    private bool _confirmArchive;

    // Save/Close state
    private bool _closeAfterSave = true;
    private string? _savedMsg;

    // Multi-select & bulk action state
    private HashSet<int> _selectedIds = [];
    private bool _confirmBulkDelete;
    private string? _bulkMsg;
    private bool _bulkMsgIsError;
    private bool _allSelected => _customers.Count > 0 && _customers.All(c => _selectedIds.Contains(c.Id));

    // Dropdown options from settings
    private List<string> _customerTypeOptions = ["Individual", "Company", "Landlord"];
    private List<string> _preferredContactOptions = ["Phone", "Email", "Text"];
    private List<string> _referralSourceOptions = [];

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await DetermineView();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DetermineView()
    {
        _loading = true;
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var path = uri.AbsolutePath.TrimEnd('/').ToLower();

        if (path.EndsWith("/new") || path.EndsWith("/edit"))
        {
            _view = View.Form;
            _pageTitle = Id.HasValue ? "Edit Customer" : "New Customer";
            _companies = await SiteService.GetCompaniesForDropdownAsync();
            await LoadFormDropdowns();
            if (Id.HasValue)
            {
                var detail = await CustomerService.GetCustomerAsync(Id.Value);
                if (detail is not null)
                {
                    _editModel = new CustomerEditModel
                    {
                        Name = detail.Name,
                        FirstName = detail.FirstName ?? detail.Name,
                        LastName = detail.LastName,
                        Type = detail.Type,
                        PrimaryPhone = detail.PrimaryPhone,
                        SecondaryPhone = detail.SecondaryPhone,
                        PrimaryEmail = detail.PrimaryEmail,
                        PreferredContactMethod = detail.PreferredContactMethod,
                        ReferralSource = detail.ReferralSource,
                        Address = detail.Address,
                        City = detail.City,
                        State = detail.State,
                        Zip = detail.Zip,
                        CreditLimit = detail.CreditLimit,
                        TaxExempt = detail.TaxExempt,
                        Tags = detail.Tags,
                        Notes = detail.Notes,
                        CompanyId = detail.CompanyId
                    };
                }
            }
            else
            {
                _editModel = new CustomerEditModel
                {
                    FirstName = string.Empty,
                    City = "Pikeville",
                    State = "TN",
                    Zip = "37367"
                };
            }
        }
        else if (Id.HasValue)
        {
            _view = View.Detail;
            _detail = await CustomerService.GetCustomerAsync(Id.Value);
            _pageTitle = _detail?.Name ?? "Customer";
            _activeTab = "sites";
        }
        else
        {
            _view = View.List;
            _pageTitle = "Customers";
            await ReloadList();
        }

        _loading = false;
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private async Task ReloadList()
    {
        _customers = await CustomerService.GetCustomersAsync(_filter);
    }

    private async Task OnTypeFilterChanged()
    {
        _filter.Type = string.IsNullOrEmpty(_filterType) ? null : Enum.Parse<CustomerType>(_filterType);
        await ReloadList();
    }

    private async Task ToggleSort(string column)
    {
        if (_filter.SortBy == column)
            _filter.SortDescending = !_filter.SortDescending;
        else
        {
            _filter.SortBy = column;
            _filter.SortDescending = false;
        }
        await ReloadList();
    }

    private void GoToDetail(int id) => Navigation.NavigateTo($"/customers/{id}");

    private int? GetAdjacentCustomerId(int offset)
    {
        if (_customers.Count == 0 || _detail is null) return null;
        var idx = _customers.FindIndex(c => c.Id == _detail.Id);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < _customers.Count ? _customers[target].Id : null;
    }
    private void GoToPrevCustomer() { var id = GetAdjacentCustomerId(-1); if (id.HasValue) GoToDetail(id.Value); }
    private void GoToNextCustomer() { var id = GetAdjacentCustomerId(1); if (id.HasValue) GoToDetail(id.Value); }

    private int? GetAdjacentCustomerEditId(int offset)
    {
        if (_customers.Count == 0 || !Id.HasValue) return null;
        var idx = _customers.FindIndex(c => c.Id == Id.Value);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < _customers.Count ? _customers[target].Id : null;
    }
    private void GoToPrevCustomerEdit() { var id = GetAdjacentCustomerEditId(-1); if (id.HasValue) Navigation.NavigateTo($"/customers/{id.Value}/edit"); }
    private void GoToNextCustomerEdit() { var id = GetAdjacentCustomerEditId(1); if (id.HasValue) Navigation.NavigateTo($"/customers/{id.Value}/edit"); }

    private void GoToSite(int id) => Navigation.NavigateTo($"/sites/{id}");
    private void GoToAsset(int id) => Navigation.NavigateTo($"/assets/{id}");
    private void GoToJob(int id) => Navigation.NavigateTo($"/jobs/{id}");
    private void GoToInvoice(int id) => Navigation.NavigateTo($"/financials/invoices/{id}");
    private void GoToAgreement(int id) => Navigation.NavigateTo($"/serviceagreements/{id}");

    private void GoBack()
    {
        if (Id.HasValue)
            Navigation.NavigateTo($"/customers/{Id.Value}");
        else
            Navigation.NavigateTo("/customers");
    }

    private async Task SaveCustomer()
    {
        _formError = null;
        _saving = true;
        _savedMsg = null;

        try
        {
            if (Id.HasValue)
            {
                await CustomerService.UpdateCustomerAsync(Id.Value, _editModel);
                if (_closeAfterSave) Navigation.NavigateTo($"/customers/{Id.Value}");
                else _savedMsg = "Saved!";
            }
            else
            {
                var created = await CustomerService.CreateCustomerAsync(_editModel);
                if (_closeAfterSave) Navigation.NavigateTo($"/customers/{created.Id}");
                else Navigation.NavigateTo($"/customers/{created.Id}/edit");
            }
        }
        catch (Exception ex)
        {
            _formError = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task ArchiveCustomer()
    {
        if (_detail is not null)
        {
            await CustomerService.ArchiveCustomerAsync(_detail.Id);
            Navigation.NavigateTo("/customers");
        }
    }

    // Helper methods
    private static string TypeBadgeClass(CustomerType type) => type switch
    {
        CustomerType.Individual => "bg-info",
        CustomerType.Company => "bg-primary",
        CustomerType.Landlord => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    private static string AssetStatusBadge(AssetStatus status) => status switch
    {
        AssetStatus.Active => "bg-success",
        AssetStatus.MaintenanceNeeded => "bg-warning text-dark",
        AssetStatus.Retired => "bg-secondary",
        AssetStatus.Decommissioned => "bg-dark",
        _ => "bg-secondary"
    };

    private static string JobStatusBadge(JobStatus status) => status switch
    {
        JobStatus.Completed => "bg-success",
        JobStatus.Cancelled => "bg-danger",
        JobStatus.InProgress or JobStatus.OnSite => "bg-primary",
        JobStatus.Scheduled or JobStatus.EnRoute => "bg-info",
        _ => "bg-secondary"
    };

    private static string InvoiceStatusBadge(InvoiceStatus status) => status switch
    {
        InvoiceStatus.Overdue => "bg-danger",
        InvoiceStatus.Sent or InvoiceStatus.Invoiced => "bg-warning text-dark",
        InvoiceStatus.Draft => "bg-secondary",
        _ => "bg-secondary"
    };

    private static string FormatAddress(CustomerDetail d)
    {
        var parts = new[] { d.Address, d.City, d.State, d.Zip }.Where(p => !string.IsNullOrWhiteSpace(p));
        return string.Join(", ", parts);
    }

    private static string FormatSiteAddress(SiteSummary s)
    {
        var parts = new[] { s.Address, s.City, s.State }.Where(p => !string.IsNullOrWhiteSpace(p));
        return string.Join(", ", parts);
    }

    private RenderFragment SortIcon(string column) => builder =>
    {
        var icon = _filter.SortBy == column
            ? (_filter.SortDescending ? "bi-sort-down" : "bi-sort-up")
            : "bi-arrow-down-up";
        var css = _filter.SortBy == column ? "text-primary" : "text-muted";
        builder.OpenElement(0, "i");
        builder.AddAttribute(1, "class", $"bi {icon} {css} small");
        builder.CloseElement();
    };

    private async Task LoadFormDropdowns()
    {
        var customerTypes = await DropdownSvc.GetOptionsAsync("CustomerType");
        if (customerTypes.Count > 0) _customerTypeOptions = customerTypes.Where(o => o.IsActive).Select(o => o.Value).ToList();
        var contacts = await DropdownSvc.GetOptionsAsync("PreferredContact");
        if (contacts.Count > 0) _preferredContactOptions = contacts.Where(o => o.IsActive).Select(o => o.Value).ToList();
        var referrals = await DropdownSvc.GetOptionsAsync("ReferralSource");
        if (referrals.Count > 0) _referralSourceOptions = referrals.Where(o => o.IsActive).Select(o => o.Value).ToList();
    }

    private void OnCustomerTypeChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<CustomerType>(e.Value?.ToString(), out var parsed))
            _editModel.Type = parsed;
    }

    private static string? FormatPhone(string? raw)
    {
        if (string.IsNullOrEmpty(raw)) return raw;
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        return digits.Length switch
        {
            >= 10 => $"({digits[..3]}) {digits[3..6]}-{digits[6..Math.Min(10, digits.Length)]}",
            >= 7 => $"{digits[..3]}-{digits[3..Math.Min(7, digits.Length)]}",
            _ => digits
        };
    }

    private async Task EmailCustomer()
    {
        if (_detail is null || string.IsNullOrEmpty(_detail.PrimaryEmail)) return;
        var subject = Uri.EscapeDataString($"OneManVanFSM — {_detail.Name}");
        await JS.InvokeVoidAsync("eval", $"window.location.href='mailto:{_detail.PrimaryEmail}?subject={subject}'");
    }

    // ---- Multi-select & Bulk Actions ----
    private void ToggleRowSelection(int id) { if (!_selectedIds.Remove(id)) _selectedIds.Add(id); _confirmBulkDelete = false; }
    private void ToggleSelectAll() { if (_allSelected) _selectedIds.Clear(); else foreach (var c in _customers) _selectedIds.Add(c.Id); _confirmBulkDelete = false; }
    private void ClearSelection() { _selectedIds.Clear(); _confirmBulkDelete = false; _bulkMsg = null; }
    private async Task ToggleShowArchived(ChangeEventArgs e) { _filter.ShowArchived = (bool)(e.Value ?? false); ClearSelection(); await ReloadList(); }
    private async Task BulkArchive() { if (_selectedIds.Count == 0) return; try { var n = await CustomerService.BulkArchiveCustomersAsync(_selectedIds.ToList()); _bulkMsg = $"{n} customer(s) archived."; _bulkMsgIsError = false; ClearSelection(); await ReloadList(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
    private async Task BulkRestore() { if (_selectedIds.Count == 0) return; try { var n = await CustomerService.BulkRestoreCustomersAsync(_selectedIds.ToList()); _bulkMsg = $"{n} customer(s) restored."; _bulkMsgIsError = false; ClearSelection(); await ReloadList(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
    private async Task BulkDeletePermanently() { if (_selectedIds.Count == 0) return; try { var n = await CustomerService.BulkDeleteCustomersPermanentlyAsync(_selectedIds.ToList()); _bulkMsg = $"{n} customer(s) permanently deleted."; _bulkMsgIsError = false; ClearSelection(); await ReloadList(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
}
