@page "/employees"
@page "/employees/new"
@page "/employees/{Id:int}"
@page "/employees/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject IEmployeeService EmployeeSvc
@inject IJobService JobSvc
@inject IDropdownService DropdownSvc
@inject IShiftService ShiftSvc
@inject NavigationManager Nav

<PageTitle>Employees - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        @if (editId.HasValue)
        {
            <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToPrevEmployeeEdit" disabled="@(GetAdjacentEmployeeEditId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToNextEmployeeEdit" disabled="@(GetAdjacentEmployeeEditId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        }
        <h4 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i>@(editId.HasValue ? "Edit" : "New") Employee</h4>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveEmployee">
                <DataAnnotationsValidator />
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <InputText @bind-Value="form.FirstName" class="form-control" placeholder="First name" />
                        <ValidationMessage For="() => form.FirstName" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Last Name</label>
                        <InputText @bind-Value="form.LastName" class="form-control" placeholder="Last name" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Role</label>
                        <InputSelect @bind-Value="form.Role" class="form-select">
                            @foreach (var r in _employeeRoles) { <option value="@r">@r</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in _employeeStatuses) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" value="@form.Phone"
                               @oninput="e => form.Phone = FormatPhone(e.Value?.ToString())" placeholder="(555) 123-4567" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <InputText @bind-Value="form.Email" class="form-control" />
                        <ValidationMessage For="() => form.Email" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Hourly Rate</label>
                        <InputNumber @bind-Value="form.HourlyRate" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Address</label>
                        <InputText @bind-Value="form.Address" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Territory</label>
                        <InputText @bind-Value="form.Territory" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hire Date</label>
                        <InputDate @bind-Value="form.HireDate" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Certifications (JSON)</label>
                        <InputText @bind-Value="form.Certifications" class="form-control" placeholder='e.g. ["EPA 608","NATE"]' />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>

                    <div class="col-12"><hr class="my-2" /></div>

                    <div class="col-md-4">
                        <label class="form-label">License Number</label>
                        <InputText @bind-Value="form.LicenseNumber" class="form-control" placeholder="EPA 608, State HVAC, etc." />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">License Expiry</label>
                        <InputDate @bind-Value="form.LicenseExpiry" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Vehicle Assigned</label>
                        <InputText @bind-Value="form.VehicleAssigned" class="form-control" placeholder="Truck #, plate, etc." />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Overtime Rate</label>
                        <InputNumber @bind-Value="form.OvertimeRate" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Emergency Contact Name</label>
                        <InputText @bind-Value="form.EmergencyContactName" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Emergency Contact Phone</label>
                        <input type="tel" class="form-control" value="@form.EmergencyContactPhone"
                               @oninput="e => form.EmergencyContactPhone = FormatPhone(e.Value?.ToString())" placeholder="(555) 123-4567" />
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2 align-items-center">
                    @if (!string.IsNullOrEmpty(_savedMsg)) { <span class="text-success small"><i class="bi bi-check-circle me-1"></i>@_savedMsg</span> }
                    <button type="submit" class="btn btn-outline-primary" @onclick="() => _closeAfterSave = false"><i class="bi bi-floppy me-1"></i>Save</button>
                    <button type="submit" class="btn btn-primary" @onclick="() => _closeAfterSave = true"><i class="bi bi-check-circle me-1"></i>Save & Close</button>
                    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="GoToList">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && detail is not null)
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToList" title="Back to list"><i class="bi bi-arrow-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToPrevEmployee" disabled="@(GetAdjacentEmployeeId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToNextEmployee" disabled="@(GetAdjacentEmployeeId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        <h4 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i>@detail.Name</h4>
        <span class="badge ms-2 @(detail.Status == EmployeeStatus.Active ? "bg-success" : "bg-secondary")">@detail.Status</span>
        <span class="badge bg-info ms-1">@detail.Role</span>
        <div class="ms-auto dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-gear me-1"></i>Actions</button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item" @onclick="EditDetail"><i class="bi bi-pencil me-1"></i>Edit</button></li>
                <li><hr class="dropdown-divider" /></li>
                @if (_confirmArchive)
                {
                    <li><button class="dropdown-item text-danger fw-semibold" @onclick="ArchiveDetail"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Archive</button></li>
                    <li><button class="dropdown-item" @onclick="() => _confirmArchive = false"><i class="bi bi-x-lg me-1"></i>Cancel</button></li>
                }
                else
                {
                    <li><button class="dropdown-item text-danger" @onclick="() => _confirmArchive = true"><i class="bi bi-archive me-1"></i>Archive</button></li>
                }
            </ul>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Contact Info</h6>
                    <p class="mb-1"><i class="bi bi-telephone me-1"></i>@(detail.Phone ?? "—")</p>
                    <p class="mb-1"><i class="bi bi-envelope me-1"></i>@(detail.Email ?? "—")</p>
                    <p class="mb-1"><i class="bi bi-geo-alt me-1"></i>@(detail.Address ?? "—")</p>
                    <hr class="my-2" />
                    <p class="mb-1"><strong>Rate:</strong> @detail.HourlyRate.ToString("C")/hr</p>
                    @if (detail.OvertimeRate.HasValue)
                    {
                        <p class="mb-1"><strong>OT Rate:</strong> @detail.OvertimeRate.Value.ToString("C")/hr</p>
                    }
                    <p class="mb-1"><strong>Territory:</strong> @(detail.Territory ?? "—")</p>
                    <p class="mb-1"><strong>Hired:</strong> @detail.HireDate.ToString("MMM dd, yyyy")</p>
                    @if (!string.IsNullOrWhiteSpace(detail.Certifications))
                    {
                        <hr class="my-2" />
                        <p class="mb-0"><strong>Certs:</strong> @detail.Certifications</p>
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.LicenseNumber) || detail.LicenseExpiry.HasValue)
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted mb-2"><i class="bi bi-card-text me-1"></i>License</h6>
                        @if (!string.IsNullOrWhiteSpace(detail.LicenseNumber))
                        {
                            <p class="mb-1"><strong>License #:</strong> @detail.LicenseNumber</p>
                        }
                        @if (detail.LicenseExpiry.HasValue)
                        {
                            var licExpired = detail.LicenseExpiry.Value < DateTime.UtcNow;
                            <p class="mb-1">
                                <strong>Expires:</strong>
                                <span class="@(licExpired ? "text-danger fw-semibold" : "")">@detail.LicenseExpiry.Value.ToString("MMM dd, yyyy")</span>
                                @if (licExpired) { <span class="badge bg-danger ms-1">Expired</span> }
                            </p>
                        }
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.VehicleAssigned))
                    {
                        <hr class="my-2" />
                        <p class="mb-1"><i class="bi bi-truck me-1 text-muted"></i><strong>Vehicle:</strong> @detail.VehicleAssigned</p>
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.EmergencyContactName) || !string.IsNullOrWhiteSpace(detail.EmergencyContactPhone))
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted mb-2"><i class="bi bi-exclamation-triangle me-1"></i>Emergency Contact</h6>
                        @if (!string.IsNullOrWhiteSpace(detail.EmergencyContactName))
                        {
                            <p class="mb-1"><strong>Name:</strong> @detail.EmergencyContactName</p>
                        }
                        @if (!string.IsNullOrWhiteSpace(detail.EmergencyContactPhone))
                        {
                            <p class="mb-1"><i class="bi bi-telephone me-1"></i>@detail.EmergencyContactPhone</p>
                        }
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.Notes))
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted mb-2"><i class="bi bi-sticky me-1"></i>Notes</h6>
                        <p class="mb-0 small bg-light rounded p-2">@detail.Notes</p>
                    }
                    <hr class="my-2" />
                    <div class="d-flex gap-3 text-muted small">
                        <span><strong>Created:</strong> @detail.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                        <span><strong>Updated:</strong> @detail.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                    </div>
                </div>
            </div>

            @* Time Clock Panel *@
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-clock me-1"></i>Time Clock</h6>
                    @if (activeClock is not null)
                    {
                        <div class="alert alert-success py-2 mb-2">
                            <i class="bi bi-record-circle text-danger me-1"></i>
                            <strong>Clocked In</strong> since @activeClock.StartTime.ToLocalTime().ToString("h:mm tt")
                            @if (!string.IsNullOrEmpty(activeClock.JobTitle)) { <br /><small>Job: @activeClock.JobTitle</small> }
                        </div>
                        <button class="btn btn-danger w-100" @onclick="ClockOut" disabled="@isClocking">
                            @if (isClocking) { <span class="spinner-border spinner-border-sm me-1"></span> }
                            <i class="bi bi-stop-circle me-1"></i>Clock Out
                        </button>
                    }
                    else
                    {
                        <div class="mb-2">
                            <label class="form-label small">Job (optional)</label>
                            <select class="form-select form-select-sm" @bind="clockInJobId">
                                <option value="">— No Job —</option>
                                @foreach (var j in jobOptions)
                                {
                                    <option value="@j.Id">@j.Display</option>
                                }
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">Notes (optional)</label>
                            <input type="text" class="form-control form-control-sm" @bind="clockInNotes" placeholder="e.g., On-site work" />
                        </div>
                        <button class="btn btn-success w-100" @onclick="ClockIn" disabled="@isClocking">
                            @if (isClocking) { <span class="spinner-border spinner-border-sm me-1"></span> }
                            <i class="bi bi-play-circle me-1"></i>Clock In
                        </button>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            @* Detail Sub-Tabs *@
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item"><button class="nav-link @(detailTab == "jobs" ? "active" : "")" @onclick='() => detailTab = "jobs"'>Jobs</button></li>
                <li class="nav-item"><button class="nav-link @(detailTab == "timesheet" ? "active" : "")" @onclick="LoadTimesheet">Timesheet</button></li>
                <li class="nav-item"><button class="nav-link @(detailTab == "pay" ? "active" : "")" @onclick="LoadPaySummary">Pay Summary</button></li>
                <li class="nav-item"><button class="nav-link @(detailTab == "manual" ? "active" : "")" @onclick='() => detailTab = "manual"'>Manual Entry</button></li>
            </ul>

            @if (detailTab == "jobs")
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-transparent"><h6 class="mb-0">Assigned Jobs (@detail.RecentJobs.Count)</h6></div>
                    @if (detail.RecentJobs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-light"><tr><th>Job #</th><th>Title</th><th>Status</th><th>Scheduled</th></tr></thead>
                                <tbody>
                                    @foreach (var j in detail.RecentJobs)
                                    {
                                        <tr style="cursor:pointer" @onclick="() => GoToJob(j.Id)">
                                            <td>@j.JobNumber</td><td>@(j.Title ?? "—")</td>
                                            <td><span class="badge @JobStatusBadge(j.Status)">@j.Status</span></td>
                                            <td>@(j.ScheduledDate?.ToString("MMM dd") ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else { <div class="card-body text-muted">No assigned jobs.</div> }
                </div>
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent"><h6 class="mb-0">Recent Time Entries (@detail.RecentTimeEntries.Count)</h6></div>
                    @if (detail.RecentTimeEntries.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-light"><tr><th>Date</th><th>Hours</th><th>Job</th><th>Billable</th></tr></thead>
                                <tbody>
                                    @foreach (var t in detail.RecentTimeEntries)
                                    {
                                        <tr>
                                            <td>@t.StartTime.ToString("MMM dd")</td>
                                            <td>@t.Hours.ToString("F1")h</td>
                                            <td>@(t.JobTitle ?? "—")</td>
                                            <td>@(t.IsBillable ? "Yes" : "No")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else { <div class="card-body text-muted">No time entries.</div> }
                </div>
            }
            else if (detailTab == "timesheet")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Weekly Timesheet</h6>
                        <div class="d-flex gap-2 align-items-center">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="PrevWeek"><i class="bi bi-chevron-left"></i></button>
                            <span class="small">@timesheetWeekStart.ToString("MMM dd") — @timesheetWeekStart.AddDays(6).ToString("MMM dd, yyyy")</span>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="NextWeek"><i class="bi bi-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (timesheetDays is not null)
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Day</th>
                                            <th class="text-end">Regular</th>
                                            <th class="text-end">OT</th>
                                            <th class="text-end">Total</th>
                                            <th>Entries</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var day in timesheetDays)
                                        {
                                            <tr class="@(day.Date.DayOfWeek == DayOfWeek.Sunday || day.Date.DayOfWeek == DayOfWeek.Saturday ? "table-light" : "")">
                                                <td><strong>@day.Date.ToString("ddd MMM dd")</strong></td>
                                                <td class="text-end">@((day.TotalHours - day.OvertimeHours).ToString("F1"))h</td>
                                                <td class="text-end text-danger">@(day.OvertimeHours > 0 ? $"{day.OvertimeHours:F1}h" : "—")</td>
                                                <td class="text-end fw-bold">@day.TotalHours.ToString("F1")h</td>
                                                <td>
                                                    @foreach (var e in day.Entries)
                                                    {
                                                        <small class="d-block">@e.StartTime.ToLocalTime().ToString("h:mm tt") - @(e.EndTime?.ToLocalTime().ToString("h:mm tt") ?? "Active") @(e.JobTitle != null ? $"({e.JobTitle})" : "")</small>
                                                    }
                                                    @if (!day.Entries.Any()) { <small class="text-muted">No entries</small> }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot>
                                        <tr class="fw-bold">
                                            <td>Total</td>
                                            <td class="text-end">@timesheetDays.Sum(d => d.TotalHours - d.OvertimeHours).ToString("F1")h</td>
                                            <td class="text-end text-danger">@timesheetDays.Sum(d => d.OvertimeHours).ToString("F1")h</td>
                                            <td class="text-end">@timesheetDays.Sum(d => d.TotalHours).ToString("F1")h</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>
                        }
                    </div>
                </div>
            }
            else if (detailTab == "pay")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Pay Summary</h6>
                        <div class="d-flex gap-2 align-items-center">
                            <label class="small me-1">From:</label>
                            <input type="date" class="form-control form-control-sm" style="width:150px;" @bind="payPeriodStart" />
                            <label class="small me-1">To:</label>
                            <input type="date" class="form-control form-control-sm" style="width:150px;" @bind="payPeriodEnd" />
                            <button class="btn btn-outline-primary btn-sm" @onclick="LoadPaySummary"><i class="bi bi-search"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (paySummary is not null)
                        {
                            <div class="row g-3 mb-3">
                                <div class="col-sm-3">
                                    <div class="card bg-light border-0 text-center py-2">
                                        <div class="fs-5 fw-bold">@paySummary.TotalRegularHours.ToString("F1")h</div>
                                        <small class="text-muted">Regular Hours</small>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="card bg-light border-0 text-center py-2">
                                        <div class="fs-5 fw-bold text-danger">@paySummary.TotalOvertimeHours.ToString("F1")h</div>
                                        <small class="text-muted">Overtime Hours</small>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="card bg-light border-0 text-center py-2">
                                        <div class="fs-5 fw-bold text-success">@paySummary.RegularPay.ToString("C")</div>
                                        <small class="text-muted">Regular Pay</small>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="card bg-light border-0 text-center py-2">
                                        <div class="fs-5 fw-bold text-primary">@paySummary.TotalPay.ToString("C")</div>
                                        <small class="text-muted">Total Pay</small>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light"><tr><th>Rate</th><th>OT Pay (1.5x)</th><th>Flat Rate Jobs</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td>@paySummary.HourlyRate.ToString("C")/hr</td>
                                            <td>@paySummary.OvertimePay.ToString("C")</td>
                                            <td>@paySummary.FlatRateTotal.ToString("C")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            @if (paySummary.Jobs.Any())
                            {
                                <h6 class="mt-3">Job Breakdown</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead class="table-light"><tr><th>Job #</th><th>Title</th><th>Hours</th><th>Pay Type</th><th class="text-end">Amount</th></tr></thead>
                                        <tbody>
                                            @foreach (var j in paySummary.Jobs)
                                            {
                                                <tr>
                                                    <td>@j.JobNumber</td>
                                                    <td>@(j.Title ?? "—")</td>
                                                    <td>@j.Hours.ToString("F1")h</td>
                                                    <td><span class="badge @(j.PayType == "FlatRate" ? "bg-warning text-dark" : "bg-info")">@j.PayType</span></td>
                                                    <td class="text-end">@j.Amount.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-3 text-muted">Select a date range and click search.</div>
                        }
                    </div>
                </div>
            }
            else if (detailTab == "manual")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent"><h6 class="mb-0">Add Manual Time Entry</h6></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Job (optional)</label>
                                <select class="form-select form-select-sm" @bind="manualJobId">
                                    <option value="">— No Job —</option>
                                    @foreach (var j in jobOptions)
                                    {
                                        <option value="@j.Id">@j.Display</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Start Time</label>
                                <input type="datetime-local" class="form-control form-control-sm" @bind="manualStart" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">End Time</label>
                                <input type="datetime-local" class="form-control form-control-sm" @bind="manualEnd" />
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" @bind="manualBillable" id="manualBillable" />
                                    <label class="form-check-label" for="manualBillable">Billable</label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-control form-control-sm" @bind="manualNotes" />
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" @onclick="AddManualEntry" disabled="@isClocking">
                                <i class="bi bi-plus-lg me-1"></i>Add Entry
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(manualMsg))
                        {
                            <div class="alert alert-success mt-2 py-2 mb-0">@manualMsg</div>
                        }
                        @if (!string.IsNullOrEmpty(manualError))
                        {
                            <div class="alert alert-danger mt-2 py-2 mb-0">@manualError</div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-person-badge-fill me-2"></i>Employees</h4>
        <div class="d-flex gap-2 align-items-center">
            @if (listTab == "roster")
            {
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="showArchivedEmployees" checked="@filter.ShowArchived" @onchange="ToggleShowArchived" />
                    <label class="form-check-label small" for="showArchivedEmployees"><i class="bi bi-archive me-1"></i>Show Archived</label>
                </div>
                @if (!filter.ShowArchived) { <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New Employee</button> }
            }
            @if (listTab == "teamboard")
            {
                <button class="btn btn-outline-primary btn-sm" @onclick="LoadTeamBoard" disabled="@_teamBoardLoading">
                    @if (_teamBoardLoading) { <span class="spinner-border spinner-border-sm me-1"></span> }
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
            }
        </div>
    </div>

    <ul class="nav nav-tabs mb-3">
        <li class="nav-item"><button class="nav-link @(listTab == "roster" ? "active" : "")" @onclick='() => SwitchListTab("roster")'><i class="bi bi-list-ul me-1"></i>Roster</button></li>
        <li class="nav-item"><button class="nav-link @(listTab == "teamboard" ? "active" : "")" @onclick='() => SwitchListTab("teamboard")'><i class="bi bi-people-fill me-1"></i>Team Board</button></li>
    </ul>
    @if (listTab == "teamboard")
    {
        @* ===== TEAM BOARD VIEW ===== *@
        @if (_teamBoardLoading)
        {
            <div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Loading team board...</div>
        }
        else if (_teamBoard is not null)
        {
            @* Quick Stats Row *@
            <div class="row g-3 mb-3">
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-2">
                        <div class="fs-4 fw-bold text-success">@_teamBoard.Count(t => t.IsOnShift)</div>
                        <small class="text-muted">On Shift</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-2">
                        <div class="fs-4 fw-bold text-secondary">@_teamBoard.Count(t => !t.IsOnShift)</div>
                        <small class="text-muted">Off Shift</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-2">
                        <div class="fs-4 fw-bold text-primary">@_teamBoard.Count(t => t.CurrentJobId.HasValue)</div>
                        <small class="text-muted">On Jobs</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-2">
                        <div class="fs-4 fw-bold text-info">@_teamBoard.Sum(t => t.HoursToday).ToString("F1")h</div>
                        <small class="text-muted">Total Hours Today</small>
                    </div>
                </div>
            </div>

            @* Employee Cards *@
            <div class="row g-3">
                @foreach (var emp in _teamBoard)
                {
                    <div class="col-12 col-md-6 col-xl-4">
                        <div class="card border-0 shadow-sm h-100 @(emp.IsOnShift ? "border-start border-success border-3" : "")">
                            <div class="card-body pb-2">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-0 cursor-pointer" @onclick="() => GoToDetail(emp.EmployeeId)">@emp.Name</h6>
                                        <small class="text-muted">@emp.Role @(emp.Territory is not null ? $"· {emp.Territory}" : "")</small>
                                    </div>
                                    <div>
                                        @if (emp.IsOnShift)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-record-circle me-1"></i>On Shift</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Off</span>
                                        }
                                    </div>
                                </div>

                                @if (emp.IsOnShift)
                                {
                                    <div class="small text-muted mb-2">
                                        <i class="bi bi-clock me-1"></i>Since @emp.ShiftStartTime?.ToLocalTime().ToString("h:mm tt")
                                        @if (emp.ShiftDuration.HasValue) { <span class="ms-2">(@emp.ShiftDuration.Value.Hours)h @(emp.ShiftDuration.Value.Minutes)m)</span> }
                                        <span class="ms-2 fw-semibold">@emp.HoursToday.ToString("F1")h today</span>
                                    </div>
                                }

                                @if (emp.CurrentJobId.HasValue)
                                {
                                    <div class="alert alert-primary py-1 px-2 mb-2 small">
                                        <i class="bi bi-briefcase-fill me-1"></i>
                                        <strong class="cursor-pointer" @onclick="() => GoToJob(emp.CurrentJobId.Value)">@emp.CurrentJobNumber</strong>
                                        @if (!string.IsNullOrEmpty(emp.CurrentJobTitle)) { <span> — @emp.CurrentJobTitle</span> }
                                        @if (!string.IsNullOrEmpty(emp.CurrentCustomerName)) { <br /><small class="text-muted">@emp.CurrentCustomerName</small> }
                                        @if (emp.CurrentJobPriority == JobPriority.Emergency) { <span class="badge bg-danger ms-1">Emergency</span> }
                                        else if (emp.CurrentJobPriority == JobPriority.High) { <span class="badge bg-warning text-dark ms-1">High</span> }
                                    </div>
                                }

                                @* Action Buttons *@
                                <div class="d-flex gap-1 flex-wrap">
                                    @if (!emp.IsOnShift)
                                    {
                                        <button class="btn btn-success btn-sm" @onclick="() => TeamClockIn(emp.EmployeeId)" disabled="@_teamActionInProgress">
                                            <i class="bi bi-play-fill me-1"></i>Clock In
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-danger btn-sm" @onclick="() => TeamClockOut(emp.EmployeeId)" disabled="@_teamActionInProgress">
                                            <i class="bi bi-stop-fill me-1"></i>Clock Out
                                        </button>
                                    }

                                    @if (emp.IsOnShift && !emp.CurrentJobId.HasValue)
                                    {
                                        <div class="dropdown">
                                            <button class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" disabled="@_teamActionInProgress">
                                                <i class="bi bi-briefcase me-1"></i>Assign Job
                                            </button>
                                            <ul class="dropdown-menu" style="max-height:300px;overflow-y:auto;">
                                                @if (_assignableJobs is not null)
                                                {
                                                    @foreach (var j in _assignableJobs)
                                                    {
                                                        <li>
                                                            <button class="dropdown-item small" @onclick="() => TeamAssignJob(emp.EmployeeId, j.Id)">
                                                                <span class="badge @GetPriorityBadgeClass(j.Priority) me-1">@j.Priority</span>
                                                                @j.Display
                                                                @if (!string.IsNullOrEmpty(j.CustomerName)) { <br /><small class="text-muted">@j.CustomerName</small> }
                                                            </button>
                                                        </li>
                                                    }
                                                    @if (!_assignableJobs.Any())
                                                    {
                                                        <li><span class="dropdown-item text-muted small">No assignable jobs</span></li>
                                                    }
                                                }
                                            </ul>
                                        </div>
                                    }
                                    else if (emp.CurrentJobId.HasValue)
                                    {
                                        <button class="btn btn-outline-secondary btn-sm" @onclick="() => TeamUnassignJob(emp.EmployeeId)" disabled="@_teamActionInProgress">
                                            <i class="bi bi-x-circle me-1"></i>Unassign
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(_teamMsg))
            {
                <div class="alert @(_teamMsgIsError ? "alert-danger" : "alert-success") mt-3 py-2 mb-0">
                    <i class="bi @(_teamMsgIsError ? "bi-x-circle" : "bi-check-circle") me-1"></i>@_teamMsg
                </div>
            }
        }
    }
    else
    {
    @* ===== ROSTER VIEW ===== *@
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm" placeholder="Search employees..." @bind="filter.Search" @bind:event="oninput" @bind:after="LoadEmployees" />
                </div>
                <div class="col-md-4">
                    <select class="form-select form-select-sm" @bind="filterRole" @bind:after="LoadEmployees">
                        <option value="">All Roles</option>
                        @foreach (var r in _employeeRoles) { <option value="@r">@r</option> }
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterStatusStr" @bind:after="LoadEmployees">
                        <option value="">All Statuses</option>
                        @foreach (var s in _employeeStatuses) { <option value="@s">@s</option> }
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (_selectedIds.Count > 0)
    {
        <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
            <span><strong>@_selectedIds.Count</strong> employee(s) selected</span>
            <div class="d-flex gap-2">
                @if (filter.ShowArchived)
                {
                    <button class="btn btn-success btn-sm" @onclick="BulkRestore"><i class="bi bi-arrow-counterclockwise me-1"></i>Restore</button>
                    @if (!_confirmBulkDelete) { <button class="btn btn-danger btn-sm" @onclick="() => _confirmBulkDelete = true"><i class="bi bi-trash3 me-1"></i>Delete Permanently</button> }
                    else { <button class="btn btn-danger btn-sm fw-semibold" @onclick="BulkDeletePermanently"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete Forever</button> <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmBulkDelete = false">Cancel</button> }
                }
                else
                {
                    <button class="btn btn-warning btn-sm" @onclick="BulkArchive"><i class="bi bi-archive me-1"></i>Archive</button>
                    @if (!_confirmBulkDelete) { <button class="btn btn-danger btn-sm" @onclick="() => _confirmBulkDelete = true"><i class="bi bi-trash3 me-1"></i>Delete Permanently</button> }
                    else { <button class="btn btn-danger btn-sm fw-semibold" @onclick="BulkDeletePermanently"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete Forever</button> <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmBulkDelete = false">Cancel</button> }
                }
                <button class="btn btn-outline-secondary btn-sm" @onclick="ClearSelection"><i class="bi bi-x-lg me-1"></i>Clear</button>
            </div>
        </div>
    }

    <div class="card border-0 shadow-sm">
        @if (employees is null)
        {
            <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div> Loading...</div>
        }
        else if (!employees.Any())
        {
            <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-person-badge" style="font-size: 3rem;"></i>
                @if (filter.ShowArchived)
                {
                    <p class="mt-2">No archived employees to show.</p>
                }
                else
                {
                    <p class="mt-2">No employees found. <a href="javascript:void(0)" @onclick="GoToNew">Add one</a>.</p>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light"><tr>
                        <th style="width:40px;"><input type="checkbox" class="form-check-input" checked="@_allSelected" @onchange="ToggleSelectAll" title="Select all" /></th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Name")'>Name @SortIcon("Name")</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Role")'>Role @SortIcon("Role")</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Status")'>Status @SortIcon("Status")</th>
                        <th>Phone</th><th>Territory</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Rate")'>Rate @SortIcon("Rate")</th>
                        <th>Active Jobs</th>
                    </tr></thead>
                    <tbody>
                        @foreach (var e in employees)
                        {
                            <tr class="@(_selectedIds.Contains(e.Id) ? "table-active" : "")">
                                <td @onclick:stopPropagation="true"><input type="checkbox" class="form-check-input" checked="@_selectedIds.Contains(e.Id)" @onchange="() => ToggleRowSelection(e.Id)" /></td>
                                <td style="cursor:pointer" @onclick="() => GoToDetail(e.Id)"><strong>@e.Name</strong></td>
                                <td><span class="badge bg-info">@e.Role</span></td>
                                <td><span class="badge @(e.Status == EmployeeStatus.Active ? "bg-success" : "bg-secondary")">@e.Status</span></td>
                                <td>@(e.Phone ?? "—")</td>
                                <td>@(e.Territory ?? "—")</td>
                                <td>@e.HourlyRate.ToString("C")/hr</td>
                                <td>@e.ActiveJobCount</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
    @if (!string.IsNullOrEmpty(_bulkMsg))
    {
        <div class="alert @(_bulkMsgIsError ? "alert-danger" : "alert-success") mt-2 mb-0 py-2"><i class="bi @(_bulkMsgIsError ? "bi-x-circle" : "bi-check-circle") me-1"></i>@_bulkMsg</div>
    }
    } @* end roster view *@
}

@code {
    [Parameter] public int? Id { get; set; }

    private string mode = "list";
    private string listTab = "roster";
    private string detailTab = "jobs";
    private List<EmployeeListItem>? employees;
    private EmployeeFilter filter = new();
    private string filterRole = "";
    private string filterStatusStr = "";
    private EmployeeDetail? detail;
    private EmployeeEditModel form = new();
    private int? editId;
    private string? errorMsg;
    private bool _confirmArchive;

    // Save/Close state
    private bool _closeAfterSave = true;
    private string? _savedMsg;

    // Multi-select & bulk action state
    private HashSet<int> _selectedIds = [];
    private bool _confirmBulkDelete;
    private string? _bulkMsg;
    private bool _bulkMsgIsError;
    private bool _allSelected => employees is not null && employees.Count > 0 && employees.All(e => _selectedIds.Contains(e.Id));

    private List<string> _employeeRoles = Enum.GetValues<EmployeeRole>().Select(r => r.ToString()).ToList();
    private List<string> _employeeStatuses = Enum.GetValues<EmployeeStatus>().Select(s => s.ToString()).ToList();

    // Time clock state
    private EmployeeTimeEntry? activeClock;
    private List<JobOption> jobOptions = [];
    private string clockInJobId = "";
    private string clockInNotes = "";
    private bool isClocking;

    // Timesheet state
    private DateTime timesheetWeekStart;
    private List<TimesheetDay>? timesheetDays;

    // Pay summary state
    private DateTime payPeriodStart;
    private DateTime payPeriodEnd;
    private PayPeriodSummary? paySummary;

    // Manual entry state
    private string manualJobId = "";
    private DateTime manualStart = DateTime.Now.Date.AddHours(8);
    private DateTime manualEnd = DateTime.Now.Date.AddHours(17);
    private bool manualBillable = true;
    private string manualNotes = "";
    private string? manualMsg;
    private string? manualError;

    // Team Board state
    private List<EmployeeShiftStatus>? _teamBoard;
    private List<ShiftJobOption>? _assignableJobs;
    private bool _teamBoardLoading;
    private bool _teamActionInProgress;
    private string? _teamMsg;
    private bool _teamMsgIsError;

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
        var today = DateTime.UtcNow.Date;
        var dow = (int)today.DayOfWeek;
        timesheetWeekStart = today.AddDays(-dow);
        payPeriodStart = today.AddDays(-13);
        payPeriodEnd = today;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadFormDropdowns();
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await DetermineView();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DetermineView()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.AbsolutePath.Contains("/employees/new", StringComparison.OrdinalIgnoreCase))
        {
            mode = "form"; editId = null; form = new();
        }
        else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
            await LoadForEdit(Id.Value);
        else if (Id.HasValue)
            await LoadDetail(Id.Value);
        else { mode = "list"; await LoadEmployees(); }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadEmployees()
    {
        filter.Role = string.IsNullOrWhiteSpace(filterRole) ? null : Enum.Parse<EmployeeRole>(filterRole);
        filter.Status = string.IsNullOrWhiteSpace(filterStatusStr) ? null : Enum.Parse<EmployeeStatus>(filterStatusStr);
        employees = await EmployeeSvc.GetEmployeesAsync(filter);
    }

    private async Task LoadFormDropdowns()
    {
        var roles = await DropdownSvc.GetOptionsAsync("EmployeeRole");
        if (roles.Count > 0)
        {
            // Only include values that are valid EmployeeRole enum members
            var validRoles = roles
                .Where(o => o.IsActive && Enum.TryParse<EmployeeRole>(o.Value, ignoreCase: true, out _))
                .Select(o => o.Value)
                .ToList();
            if (validRoles.Count > 0) _employeeRoles = validRoles;
        }
        var statuses = await DropdownSvc.GetOptionsAsync("EmployeeStatus");
        if (statuses.Count > 0)
        {
            var validStatuses = statuses
                .Where(o => o.IsActive && Enum.TryParse<EmployeeStatus>(o.Value, ignoreCase: true, out _))
                .Select(o => o.Value)
                .ToList();
            if (validStatuses.Count > 0) _employeeStatuses = validStatuses;
        }
    }

    private async Task LoadDetail(int id)
    {
        detail = await EmployeeSvc.GetEmployeeAsync(id);
        mode = detail is not null ? "detail" : "list";
        if (mode == "list") { await LoadEmployees(); return; }
        detailTab = "jobs";
        jobOptions = await JobSvc.GetJobOptionsAsync();
        var clock = await EmployeeSvc.GetActiveClockAsync(id);
        activeClock = clock is not null ? new EmployeeTimeEntry
        {
            Id = clock.Id,
            StartTime = clock.StartTime,
            EndTime = clock.EndTime,
            Hours = clock.Hours,
            JobTitle = clock.Job?.Title,
            IsBillable = clock.IsBillable
        } : null;
    }

    private async Task LoadForEdit(int id)
    {
        var d = await EmployeeSvc.GetEmployeeAsync(id);
        if (d is null) { mode = "list"; await LoadEmployees(); return; }
        editId = id;
        form = new EmployeeEditModel
        {
            Name = d.Name, FirstName = d.FirstName ?? d.Name, LastName = d.LastName,
            Role = d.Role, Phone = d.Phone, Email = d.Email,
            Address = d.Address, HourlyRate = d.HourlyRate, HireDate = d.HireDate,
            Status = d.Status, Territory = d.Territory,
            Certifications = d.Certifications,
            LicenseNumber = d.LicenseNumber, LicenseExpiry = d.LicenseExpiry,
            VehicleAssigned = d.VehicleAssigned,
            EmergencyContactName = d.EmergencyContactName,
            EmergencyContactPhone = d.EmergencyContactPhone,
            OvertimeRate = d.OvertimeRate,
            Notes = d.Notes
        };
        mode = "form";
    }

    private async Task SaveEmployee()
    {
        try
        {
            errorMsg = null;
            _savedMsg = null;
            if (editId.HasValue)
            {
                await EmployeeSvc.UpdateEmployeeAsync(editId.Value, form);
                if (_closeAfterSave) Nav.NavigateTo("/employees");
                else _savedMsg = "Saved!";
            }
            else
            {
                var created = await EmployeeSvc.CreateEmployeeAsync(form);
                if (_closeAfterSave) Nav.NavigateTo("/employees");
                else Nav.NavigateTo($"/employees/{created.Id}/edit");
            }
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task ArchiveDetail()
    {
        if (detail is not null) { await EmployeeSvc.ArchiveEmployeeAsync(detail.Id); _confirmArchive = false; Nav.NavigateTo("/employees"); }
    }

    // Time Clock
    private async Task ClockIn()
    {
        if (detail is null) return;
        isClocking = true;
        try
        {
            int? jobId = int.TryParse(clockInJobId, out var jid) ? jid : null;
            var entry = await EmployeeSvc.ClockInAsync(detail.Id, jobId, string.IsNullOrWhiteSpace(clockInNotes) ? null : clockInNotes);
            activeClock = new EmployeeTimeEntry { Id = entry.Id, StartTime = entry.StartTime, Hours = 0, IsBillable = entry.IsBillable };
            clockInJobId = ""; clockInNotes = "";
        }
        catch (Exception ex) { errorMsg = ex.Message; }
        finally { isClocking = false; }
    }

    private async Task ClockOut()
    {
        if (detail is null) return;
        isClocking = true;
        try
        {
            await EmployeeSvc.ClockOutAsync(detail.Id);
            activeClock = null;
            detail = await EmployeeSvc.GetEmployeeAsync(detail.Id);
        }
        catch (Exception ex) { errorMsg = ex.Message; }
        finally { isClocking = false; }
    }

    // Timesheet
    private async Task LoadTimesheet()
    {
        detailTab = "timesheet";
        if (detail is null) return;
        timesheetDays = await EmployeeSvc.GetWeeklyTimesheetAsync(detail.Id, timesheetWeekStart);
    }

    private async Task PrevWeek() { timesheetWeekStart = timesheetWeekStart.AddDays(-7); await LoadTimesheet(); }
    private async Task NextWeek() { timesheetWeekStart = timesheetWeekStart.AddDays(7); await LoadTimesheet(); }

    // Pay Summary
    private async Task LoadPaySummary()
    {
        detailTab = "pay";
        if (detail is null) return;
        paySummary = await EmployeeSvc.GetPaySummaryAsync(detail.Id, payPeriodStart, payPeriodEnd);
    }

    // Manual Entry
    private async Task AddManualEntry()
    {
        if (detail is null) return;
        manualMsg = null; manualError = null;
        isClocking = true;
        try
        {
            int? jobId = int.TryParse(manualJobId, out var jid) ? jid : null;
            await EmployeeSvc.AddManualTimeEntryAsync(detail.Id, jobId, manualStart.ToUniversalTime(), manualEnd.ToUniversalTime(), manualBillable, string.IsNullOrWhiteSpace(manualNotes) ? null : manualNotes);
            manualMsg = "Time entry added successfully.";
            detail = await EmployeeSvc.GetEmployeeAsync(detail.Id);
        }
        catch (Exception ex) { manualError = ex.Message; }
        finally { isClocking = false; }
    }

    private void GoToList() => Nav.NavigateTo("/employees");
    private void GoToNew() => Nav.NavigateTo("/employees/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/employees/{id}");

    private int? GetAdjacentEmployeeId(int offset)
    {
        if (employees is null || employees.Count == 0 || detail is null) return null;
        var idx = employees.FindIndex(e => e.Id == detail.Id);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < employees.Count ? employees[target].Id : null;
    }
    private void GoToPrevEmployee() { var id = GetAdjacentEmployeeId(-1); if (id.HasValue) GoToDetail(id.Value); }
    private void GoToNextEmployee() { var id = GetAdjacentEmployeeId(1); if (id.HasValue) GoToDetail(id.Value); }

    private int? GetAdjacentEmployeeEditId(int offset)
    {
        if (employees is null || employees.Count == 0 || !editId.HasValue) return null;
        var idx = employees.FindIndex(e => e.Id == editId.Value);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < employees.Count ? employees[target].Id : null;
    }
    private void GoToPrevEmployeeEdit() { var id = GetAdjacentEmployeeEditId(-1); if (id.HasValue) Nav.NavigateTo($"/employees/{id.Value}/edit"); }
    private void GoToNextEmployeeEdit() { var id = GetAdjacentEmployeeEditId(1); if (id.HasValue) Nav.NavigateTo($"/employees/{id.Value}/edit"); }
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");
    private void EditDetail() { if (detail is not null) Nav.NavigateTo($"/employees/{detail.Id}/edit"); }

    private async Task ToggleSort(string column)
    {
        if (filter.SortBy == column) filter.SortDescending = !filter.SortDescending;
        else { filter.SortBy = column; filter.SortDescending = false; }
        await LoadEmployees();
    }

    private RenderFragment SortIcon(string column) => builder =>
    {
        var css = filter.SortBy == column
            ? (filter.SortDescending ? "bi-sort-down" : "bi-sort-up")
            : "bi-arrow-down-up opacity-25";
        builder.OpenElement(0, "i");
        builder.AddAttribute(1, "class", $"bi {css} ms-1{(filter.SortBy == column ? " text-primary" : "")}");
        builder.CloseElement();
    };

    private static string JobStatusBadge(JobStatus status) => status switch
    {
        JobStatus.Completed => "bg-success",
        JobStatus.Cancelled => "bg-danger",
        JobStatus.InProgress or JobStatus.OnSite => "bg-primary",
        JobStatus.Scheduled or JobStatus.EnRoute => "bg-info",
        _ => "bg-secondary"
    };

    private static string? FormatPhone(string? raw)
    {
        if (string.IsNullOrEmpty(raw)) return raw;
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        return digits.Length switch
        {
            >= 10 => $"({digits[..3]}) {digits[3..6]}-{digits[6..Math.Min(10, digits.Length)]}",
            >= 7 => $"{digits[..3]}-{digits[3..Math.Min(7, digits.Length)]}",
            _ => digits
            };
            }

            // ---- Multi-select & Bulk Actions ----
            private void ToggleRowSelection(int id) { if (!_selectedIds.Remove(id)) _selectedIds.Add(id); _confirmBulkDelete = false; }
            private void ToggleSelectAll() { if (employees is null) return; if (_allSelected) _selectedIds.Clear(); else foreach (var e in employees) _selectedIds.Add(e.Id); _confirmBulkDelete = false; }
            private void ClearSelection() { _selectedIds.Clear(); _confirmBulkDelete = false; _bulkMsg = null; }
            private async Task ToggleShowArchived(ChangeEventArgs e) { filter.ShowArchived = (bool)(e.Value ?? false); ClearSelection(); await LoadEmployees(); }
            private async Task BulkArchive() { if (_selectedIds.Count == 0) return; try { var n = await EmployeeSvc.BulkArchiveEmployeesAsync(_selectedIds.ToList()); _bulkMsg = $"{n} employee(s) archived."; _bulkMsgIsError = false; ClearSelection(); await LoadEmployees(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
            private async Task BulkRestore() { if (_selectedIds.Count == 0) return; try { var n = await EmployeeSvc.BulkRestoreEmployeesAsync(_selectedIds.ToList()); _bulkMsg = $"{n} employee(s) restored."; _bulkMsgIsError = false; ClearSelection(); await LoadEmployees(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
            private async Task BulkDeletePermanently() { if (_selectedIds.Count == 0) return; try { var n = await EmployeeSvc.BulkDeleteEmployeesPermanentlyAsync(_selectedIds.ToList()); _bulkMsg = $"{n} employee(s) permanently deleted."; _bulkMsgIsError = false; ClearSelection(); await LoadEmployees(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }

    // ---- Team Board ----
    private async Task SwitchListTab(string tab)
    {
        listTab = tab;
        if (tab == "teamboard")
            await LoadTeamBoard();
    }

    private async Task LoadTeamBoard()
    {
        _teamBoardLoading = true;
        _teamMsg = null;
        StateHasChanged();
        try
        {
            _teamBoard = await ShiftSvc.GetTeamBoardAsync();
            _assignableJobs = await ShiftSvc.GetAssignableJobsAsync();
        }
        catch (Exception ex)
        {
            _teamMsg = ex.Message;
            _teamMsgIsError = true;
        }
        _teamBoardLoading = false;
    }

    private async Task TeamClockIn(int employeeId)
    {
        _teamActionInProgress = true;
        _teamMsg = null;
        try
        {
            await ShiftSvc.ClockInEmployeeAsync(employeeId);
            await LoadTeamBoard();
        }
        catch (Exception ex) { _teamMsg = ex.Message; _teamMsgIsError = true; }
        finally { _teamActionInProgress = false; }
    }

    private async Task TeamClockOut(int employeeId)
    {
        _teamActionInProgress = true;
        _teamMsg = null;
        try
        {
            await ShiftSvc.ClockOutEmployeeAsync(employeeId);
            await LoadTeamBoard();
        }
        catch (Exception ex) { _teamMsg = ex.Message; _teamMsgIsError = true; }
        finally { _teamActionInProgress = false; }
    }

    private async Task TeamAssignJob(int employeeId, int jobId)
    {
        _teamActionInProgress = true;
        _teamMsg = null;
        try
        {
            await ShiftSvc.AssignEmployeeToJobAsync(employeeId, jobId);
            _teamMsg = "Employee assigned to job.";
            _teamMsgIsError = false;
            await LoadTeamBoard();
        }
        catch (Exception ex) { _teamMsg = ex.Message; _teamMsgIsError = true; }
        finally { _teamActionInProgress = false; }
    }

    private async Task TeamUnassignJob(int employeeId)
    {
        _teamActionInProgress = true;
        _teamMsg = null;
        try
        {
            await ShiftSvc.UnassignEmployeeFromJobAsync(employeeId);
            _teamMsg = "Employee unassigned from job.";
            _teamMsgIsError = false;
            await LoadTeamBoard();
        }
        catch (Exception ex) { _teamMsg = ex.Message; _teamMsgIsError = true; }
        finally { _teamActionInProgress = false; }
    }

    private static string GetPriorityBadgeClass(JobPriority priority) => priority switch
    {
        JobPriority.Emergency => "bg-danger",
        JobPriority.High => "bg-warning text-dark",
        JobPriority.Standard => "bg-info",
        JobPriority.Low => "bg-secondary",
        _ => "bg-secondary"
    };
        }
