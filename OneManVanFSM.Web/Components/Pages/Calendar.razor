@page "/calendar"
@page "/calendar/new"
@page "/calendar/{Id:int}"
@page "/calendar/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject ICalendarService CalSvc
@inject IJobService JobSvc
@inject IEmployeeService EmployeeSvc
@inject IServiceAgreementService AgreementSvc
@inject NavigationManager Nav

<PageTitle>Calendar - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>@(editId.HasValue ? "Edit" : "New") Event</h4>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveEvent">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Title</label>
                        <InputText @bind-Value="form.Title" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in Enum.GetValues<CalendarEventStatus>()) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Event Type</label>
                        <InputSelect @bind-Value="form.EventType" class="form-select">
                            <option value="">—</option>
                            <option value="Job">Job</option>
                            <option value="Personal">Personal</option>
                            <option value="Meeting">Meeting</option>
                            <option value="Reminder">Reminder</option>
                            <option value="Block-Off">Block-Off</option>
                            <option value="Training">Training</option>
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Start</label>
                        <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="form.StartDateTime" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">End</label>
                        <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="form.EndDateTime" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Duration (hrs)</label>
                        <InputNumber @bind-Value="form.Duration" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Color</label>
                        <InputText @bind-Value="form.Color" class="form-control" placeholder="#ff0000" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Job</label>
                        <InputSelect @bind-Value="form.JobId" class="form-select">
                            <option value="">— Select Job —</option>
                            @foreach (var j in _jobs)
                            {
                                <option value="@j.Id">@j.JobNumber — @(j.Title ?? "")</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Technician</label>
                        <InputSelect @bind-Value="form.EmployeeId" class="form-select">
                            <option value="">— Select Tech —</option>
                            @foreach (var e in _employees)
                            {
                                <option value="@e.Id">@e.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Service Agreement</label>
                        <InputSelect @bind-Value="form.ServiceAgreementId" class="form-select">
                            <option value="">— Select Agreement —</option>
                            @foreach (var a in _agreements)
                            {
                                <option value="@a.Id">@a.AgreementNumber — @(a.Title ?? "")</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <InputCheckbox @bind-Value="form.IsRecurring" class="form-check-input" id="isRecurring" />
                            <label class="form-check-label" for="isRecurring">Recurring</label>
                        </div>
                    </div>
                    @if (form.IsRecurring)
                    {
                        <div class="col-md-9">
                            <label class="form-label">Recurrence Rule</label>
                            <InputText @bind-Value="form.RecurrenceRule" class="form-control" placeholder="RRULE:FREQ=WEEKLY;BYDAY=MO" />
                        </div>
                    }
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Checklist</label>
                        <InputTextArea @bind-Value="form.Checklist" class="form-control" rows="2" />
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save</button>
                    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="GoToList">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && selected is not null)
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>@(selected.Title ?? "Event")</h4>
        <span class="badge ms-2 @GetStatusBadge(selected.Status)">@selected.Status</span>
        @if (!string.IsNullOrWhiteSpace(selected.EventType)) { <span class="badge bg-info text-dark ms-1">@selected.EventType</span> }
        @if (selected.IsRecurring) { <span class="badge bg-primary ms-1"><i class="bi bi-arrow-repeat me-1"></i>Recurring</span> }
        <div class="ms-auto">
            <button class="btn btn-outline-primary btn-sm me-1" @onclick="EditDetail"><i class="bi bi-pencil me-1"></i>Edit</button>
            <button class="btn btn-outline-danger btn-sm" @onclick="DeleteDetail"><i class="bi bi-trash me-1"></i>Delete</button>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6><i class="bi bi-clock me-1"></i>Schedule</h6>
                    <div class="row g-2 mt-2">
                        <div class="col-sm-6"><small class="text-muted d-block">Start</small><span>@selected.StartDateTime.ToString("MMM dd, yyyy h:mm tt")</span></div>
                        <div class="col-sm-6"><small class="text-muted d-block">End</small><span>@selected.EndDateTime.ToString("MMM dd, yyyy h:mm tt")</span></div>
                        <div class="col-sm-4"><small class="text-muted d-block">Duration</small><span>@(selected.Duration?.ToString("0.0") ?? "—") hrs</span></div>
                        <div class="col-sm-4"><small class="text-muted d-block">Event Type</small><span>@(selected.EventType ?? "—")</span></div>
                        @if (!string.IsNullOrWhiteSpace(selected.Color))
                        {
                            <div class="col-sm-4"><small class="text-muted d-block">Color</small><span class="d-inline-block rounded-circle me-1" style="width:14px;height:14px;background:@selected.Color;vertical-align:middle;"></span>@selected.Color</div>
                        }
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white"><strong><i class="bi bi-link-45deg me-1"></i>Connections</strong></div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Job</small>
                            @if (selected.JobId.HasValue && selected.JobNumber is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToJob(selected.JobId.Value)">@selected.JobNumber</a> }
                            else { <span>—</span> }
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Technician</small>
                            @if (selected.EmployeeId.HasValue && selected.EmployeeName is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToEmployee(selected.EmployeeId.Value)">@selected.EmployeeName</a> }
                            else { <span>—</span> }
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Agreement</small>
                            @if (selected.ServiceAgreementId.HasValue && selected.AgreementNumber is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToAgreement(selected.ServiceAgreementId.Value)">@selected.AgreementNumber</a> }
                            else { <span>—</span> }
                        </div>
                        @if (selected.CustomerName is not null) { <div class="col-md-4"><small class="text-muted d-block">Customer</small><span>@selected.CustomerName</span></div> }
                        @if (selected.SiteName is not null) { <div class="col-md-4"><small class="text-muted d-block">Site</small><span>@selected.SiteName</span></div> }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(selected.Checklist))
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white"><strong><i class="bi bi-list-check me-1"></i>Checklist</strong></div>
                    <div class="card-body"><pre class="bg-light p-3 rounded small mb-0">@selected.Checklist</pre></div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(selected.Notes))
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white"><strong><i class="bi bi-journal-text me-1"></i>Notes</strong></div>
                    <div class="card-body"><p class="text-muted small mb-0">@selected.Notes</p></div>
                </div>
            }
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-3"><i class="bi bi-lightning me-1"></i>Quick Status</h6>
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var s in Enum.GetValues<CalendarEventStatus>())
                        {
                            <button class="btn btn-sm @(s == selected.Status ? "btn-primary" : "btn-outline-secondary")" @onclick="() => UpdateStatus(s)">@s</button>
                        }
                    </div>
                </div>
            </div>
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted"><i class="bi bi-info-circle me-1"></i>Record Info</h6>
                    <p class="mb-1 small"><strong>Created:</strong> @selected.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</p>
                    <p class="mb-0 small"><strong>Updated:</strong> @selected.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Calendar / Scheduling</h4>
        <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New Event</button>
    </div>

    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-0">From</label>
                    <input type="date" class="form-control form-control-sm" @bind="filterStart" />
                </div>
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-0">To</label>
                    <input type="date" class="form-control form-control-sm" @bind="filterEnd" />
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-0">Technician</label>
                    <select class="form-select form-select-sm" @bind="filterEmployee">
                        <option value="">All Techs</option>
                        @foreach (var e in _employees)
                        {
                            <option value="@e.Id">@e.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-0">Status</label>
                    <select class="form-select form-select-sm" @bind="filterStatus">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<CalendarEventStatus>())
                        {
                            <option value="@s">@s</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary btn-sm w-100" @onclick="LoadEvents"><i class="bi bi-search me-1"></i>Filter</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Total Events</small>
                <h5 class="mb-0">@(events?.Count ?? 0)</h5>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Confirmed</small>
                <h5 class="mb-0 text-success">@(events?.Count(e => e.Status == CalendarEventStatus.Confirmed) ?? 0)</h5>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Tentative</small>
                <h5 class="mb-0 text-warning">@(events?.Count(e => e.Status == CalendarEventStatus.Tentative) ?? 0)</h5>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Completed</small>
                <h5 class="mb-0 text-info">@(events?.Count(e => e.Status == CalendarEventStatus.Completed) ?? 0)</h5>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        @if (events is null)
        {
            <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
        }
        else if (!events.Any())
        {
            <div class="card-body text-center py-5 text-muted"><i class="bi bi-calendar-x" style="font-size:3rem;"></i><p class="mt-2">No events found. <a href="javascript:void(0)" @onclick="GoToNew">Create one</a>.</p></div>
        }
        else
        {
            @foreach (var group in events.GroupBy(e => e.StartDateTime.Date).OrderBy(g => g.Key))
            {
                <div class="card-header bg-light fw-semibold">
                    <i class="bi bi-calendar-day me-1"></i>@group.Key.ToString("dddd, MMMM dd, yyyy")
                </div>
                <div class="list-group list-group-flush">
                    @foreach (var ev in group.OrderBy(e => e.StartDateTime))
                    {
                        <a class="list-group-item list-group-item-action d-flex align-items-center" href="javascript:void(0)" @onclick="() => GoToDetail(ev.Id)">
                            <span class="badge @GetStatusBadge(ev.Status) me-2">@ev.Status</span>
                            <div class="flex-grow-1">
                                <strong>@(ev.Title ?? "Untitled")</strong>
                                <small class="text-muted ms-2">@ev.StartDateTime.ToString("h:mm tt") – @ev.EndDateTime.ToString("h:mm tt")</small>
                                @if (!string.IsNullOrWhiteSpace(ev.EventType)) { <small class="text-muted ms-1">· @ev.EventType</small> }
                            </div>
                            @if (ev.CustomerName is not null) { <span class="badge bg-light text-dark me-1">@ev.CustomerName</span> }
                            @if (ev.EmployeeName is not null) { <span class="badge bg-secondary me-1"><i class="bi bi-person-fill me-1"></i>@ev.EmployeeName</span> }
                            @if (ev.JobNumber is not null) { <span class="badge bg-primary"><i class="bi bi-tools me-1"></i>@ev.JobNumber</span> }
                        </a>
                    }
                </div>
            }
        }
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    private string mode = "list";
    private List<CalendarEventItem>? events;
    private CalendarEventDetail? selected;
    private CalendarEventEditModel form = new();
    private int? editId;
    private string? errorMsg;

    private DateTime? filterStart;
    private DateTime? filterEnd;
    private string filterEmployee = "";
    private string filterStatus = "";

    private List<JobListItem> _jobs = [];
    private List<EmployeeListItem> _employees = [];
    private List<AgreementListItem> _agreements = [];

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await DetermineView();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DetermineView()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.AbsolutePath.Contains("/calendar/new", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            mode = "form"; editId = null; form = new();
        }
        else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            await LoadForEdit(Id.Value);
        }
        else if (Id.HasValue)
            await LoadDetail(Id.Value);
        else
        {
            mode = "list";
            if (_employees.Count == 0) _employees = await EmployeeSvc.GetEmployeesAsync();
            await LoadEvents();
        }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadEvents()
    {
        int? empId = string.IsNullOrWhiteSpace(filterEmployee) ? null : int.Parse(filterEmployee);
        var all = await CalSvc.GetEventsAsync(filterStart, filterEnd, empId);
        if (!string.IsNullOrWhiteSpace(filterStatus) && Enum.TryParse<CalendarEventStatus>(filterStatus, out var st))
            all = all.Where(e => e.Status == st).ToList();
        events = all;
    }

    private async Task LoadDetail(int id)
    {
        selected = await CalSvc.GetEventDetailAsync(id);
        mode = selected is not null ? "detail" : "list";
        if (mode == "list") await LoadEvents();
    }

    private async Task LoadForEdit(int id)
    {
        var d = await CalSvc.GetEventDetailAsync(id);
        if (d is null) { mode = "list"; await LoadEvents(); return; }
        editId = id;
        form = new CalendarEventEditModel
        {
            Title = d.Title, StartDateTime = d.StartDateTime, EndDateTime = d.EndDateTime,
            Duration = d.Duration, Status = d.Status, EventType = d.EventType,
            IsRecurring = d.IsRecurring, RecurrenceRule = d.RecurrenceRule, Color = d.Color,
            Notes = d.Notes, Checklist = d.Checklist,
            JobId = d.JobId, EmployeeId = d.EmployeeId, ServiceAgreementId = d.ServiceAgreementId
        };
        mode = "form";
    }

    private async Task LoadDropdowns()
    {
        _jobs = await JobSvc.GetJobsAsync();
        _employees = await EmployeeSvc.GetEmployeesAsync();
        _agreements = await AgreementSvc.GetAgreementsAsync();
    }

    private async Task SaveEvent()
    {
        try
        {
            errorMsg = null;
            if (editId.HasValue) await CalSvc.UpdateEventAsync(editId.Value, form);
            else await CalSvc.CreateEventAsync(form);
            Nav.NavigateTo("/calendar");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task UpdateStatus(CalendarEventStatus status)
    {
        if (selected is not null)
        {
            await CalSvc.UpdateStatusAsync(selected.Id, status);
            await LoadDetail(selected.Id);
        }
    }

    private async Task DeleteDetail()
    {
        if (selected is not null) { await CalSvc.DeleteEventAsync(selected.Id); Nav.NavigateTo("/calendar"); }
    }

    private string GetStatusBadge(CalendarEventStatus s) => s switch
    {
        CalendarEventStatus.Tentative => "bg-warning text-dark",
        CalendarEventStatus.Confirmed => "bg-success",
        CalendarEventStatus.Completed => "bg-info",
        CalendarEventStatus.Cancelled => "bg-dark",
        _ => "bg-secondary"
    };

    private void GoToList() => Nav.NavigateTo("/calendar");
    private void GoToNew() => Nav.NavigateTo("/calendar/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/calendar/{id}");
    private void EditDetail() { if (selected is not null) Nav.NavigateTo($"/calendar/{selected.Id}/edit"); }
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");
    private void GoToEmployee(int id) => Nav.NavigateTo($"/employees/{id}");
    private void GoToAgreement(int id) => Nav.NavigateTo($"/serviceagreements/{id}");
}
