@page "/calendar"
@page "/calendar/new"
@page "/calendar/{Id:int}"
@page "/calendar/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject ICalendarService CalSvc
@inject IJobService JobSvc
@inject IEmployeeService EmployeeSvc
@inject IServiceAgreementService AgreementSvc
@inject IDropdownService DropdownSvc
@inject NavigationManager Nav

<PageTitle>Calendar - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>@(editId.HasValue ? "Edit" : "New") Event</h4>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveEvent">
                <DataAnnotationsValidator />
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Title</label>
                        <InputText @bind-Value="form.Title" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in _calendarStatuses) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Event Type</label>
                        <InputSelect @bind-Value="form.EventType" class="form-select">
                            <option value="">—</option>
                            @foreach (var t in _eventTypes) { <option value="@t">@t</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Start</label>
                        <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="form.StartDateTime" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">End</label>
                        <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="form.EndDateTime" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Duration (hrs)</label>
                        <InputNumber @bind-Value="form.Duration" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Color</label>
                        <InputText @bind-Value="form.Color" class="form-control" placeholder="#ff0000" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Job</label>
                        <InputSelect @bind-Value="form.JobId" class="form-select">
                            <option value="">— Select Job —</option>
                            @foreach (var j in _jobs)
                            {
                                <option value="@j.Id">@j.JobNumber — @(j.Title ?? "")</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Technician</label>
                        <InputSelect @bind-Value="form.EmployeeId" class="form-select">
                            <option value="">— Select Tech —</option>
                            @foreach (var e in _employees)
                            {
                                <option value="@e.Id">@e.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Service Agreement</label>
                        <InputSelect @bind-Value="form.ServiceAgreementId" class="form-select">
                            <option value="">— Select Agreement —</option>
                            @foreach (var a in _agreements)
                            {
                                <option value="@a.Id">@a.AgreementNumber — @(a.Title ?? "")</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <InputCheckbox @bind-Value="form.IsRecurring" class="form-check-input" id="isRecurring" />
                            <label class="form-check-label" for="isRecurring">Recurring</label>
                        </div>
                    </div>
                    @if (form.IsRecurring)
                    {
                        <div class="col-md-9">
                            <label class="form-label">Recurrence Rule</label>
                            <InputText @bind-Value="form.RecurrenceRule" class="form-control" placeholder="RRULE:FREQ=WEEKLY;BYDAY=MO" />
                        </div>
                    }
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Checklist</label>
                        <InputTextArea @bind-Value="form.Checklist" class="form-control" rows="2" />
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save</button>
                    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="GoToList">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && selected is not null)
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i>@(selected.Title ?? "Event")</h4>
        <span class="badge ms-2 @GetStatusBadge(selected.Status)">@selected.Status</span>
        @if (!string.IsNullOrWhiteSpace(selected.EventType)) { <span class="badge bg-info text-dark ms-1">@selected.EventType</span> }
        @if (selected.IsRecurring) { <span class="badge bg-primary ms-1"><i class="bi bi-arrow-repeat me-1"></i>Recurring</span> }
        <div class="ms-auto">
            <button class="btn btn-outline-primary btn-sm me-1" @onclick="EditDetail"><i class="bi bi-pencil me-1"></i>Edit</button>
            @if (_confirmDelete)
            {
                <button class="btn btn-danger btn-sm me-1" @onclick="async () => { _confirmDelete = false; await DeleteDetail(); }"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmDelete = false">Cancel</button>
            }
            else
            {
                <button class="btn btn-outline-danger btn-sm" @onclick="() => _confirmDelete = true"><i class="bi bi-trash me-1"></i>Delete</button>
            }
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6><i class="bi bi-clock me-1"></i>Schedule</h6>
                    <div class="row g-2 mt-2">
                        <div class="col-sm-6"><small class="text-muted d-block">Start</small><span>@selected.StartDateTime.ToString("MMM dd, yyyy h:mm tt")</span></div>
                        <div class="col-sm-6"><small class="text-muted d-block">End</small><span>@selected.EndDateTime.ToString("MMM dd, yyyy h:mm tt")</span></div>
                        <div class="col-sm-4"><small class="text-muted d-block">Duration</small><span>@(selected.Duration?.ToString("0.0") ?? "—") hrs</span></div>
                        <div class="col-sm-4"><small class="text-muted d-block">Event Type</small><span>@(selected.EventType ?? "—")</span></div>
                        @if (!string.IsNullOrWhiteSpace(selected.Color))
                        {
                            <div class="col-sm-4"><small class="text-muted d-block">Color</small><span class="d-inline-block rounded-circle me-1" style="width:14px;height:14px;background:@selected.Color;vertical-align:middle;"></span>@selected.Color</div>
                        }
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white"><strong><i class="bi bi-link-45deg me-1"></i>Connections</strong></div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Job</small>
                            @if (selected.JobId.HasValue && selected.JobNumber is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToJob(selected.JobId.Value)">@selected.JobNumber</a> }
                            else { <span>—</span> }
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Technician</small>
                            @if (selected.EmployeeId.HasValue && selected.EmployeeName is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToEmployee(selected.EmployeeId.Value)">@selected.EmployeeName</a> }
                            else { <span>—</span> }
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Agreement</small>
                            @if (selected.ServiceAgreementId.HasValue && selected.AgreementNumber is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToAgreement(selected.ServiceAgreementId.Value)">@selected.AgreementNumber</a> }
                            else { <span>—</span> }
                        </div>
                        @if (selected.CustomerName is not null) { <div class="col-md-4"><small class="text-muted d-block">Customer</small><span>@selected.CustomerName</span></div> }
                        @if (selected.SiteName is not null) { <div class="col-md-4"><small class="text-muted d-block">Site</small><span>@selected.SiteName</span></div> }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(selected.Checklist))
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white"><strong><i class="bi bi-list-check me-1"></i>Checklist</strong></div>
                    <div class="card-body"><pre class="bg-light p-3 rounded small mb-0">@selected.Checklist</pre></div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(selected.Notes))
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-white"><strong><i class="bi bi-journal-text me-1"></i>Notes</strong></div>
                    <div class="card-body"><p class="text-muted small mb-0">@selected.Notes</p></div>
                </div>
            }
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-lightning me-1"></i>Quick Status</h6>
                    <div class="d-flex flex-wrap gap-1">
                        @foreach (var s in Enum.GetValues<CalendarEventStatus>())
                        {
                            <button class="btn btn-sm @(s == selected.Status ? "btn-primary" : "btn-outline-secondary")" @onclick="() => UpdateStatus(s)">@s</button>
                        }
                    </div>
                    <div class="d-flex justify-content-between text-muted small mt-2 pt-2 border-top">
                        <span><i class="bi bi-info-circle me-1"></i>Created @selected.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                        <span>Updated @selected.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <h4 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Calendar / Scheduling</h4>
            <a href="/" class="btn btn-sm btn-outline-primary" title="Switch to Dashboard">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a>
        </div>
        <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New Event</button>
    </div>

    @* View Toggle *@
    <div class="d-flex align-items-center gap-2 mb-3">
        <div class="btn-group btn-group-sm" role="group">
            <button class="btn @(_calView == CalView.List ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetCalView(CalView.List)'><i class="bi bi-list-ul me-1"></i>List</button>
            <button class="btn @(_calView == CalView.Calendar ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetCalView(CalView.Calendar)'><i class="bi bi-calendar-month me-1"></i>Calendar</button>
            <button class="btn @(_calView == CalView.Gantt ? "btn-primary" : "btn-outline-primary")" @onclick='() => SetCalView(CalView.Gantt)'><i class="bi bi-bar-chart-steps me-1"></i>Gantt</button>
        </div>
        @if (_calView == CalView.Calendar)
        {
            <div class="d-flex align-items-center gap-1 ms-auto">
                <button class="btn btn-outline-secondary btn-sm" @onclick="PrevMonth"><i class="bi bi-chevron-left"></i></button>
                <strong class="px-2">@_calMonth.ToString("MMMM yyyy")</strong>
                <button class="btn btn-outline-secondary btn-sm" @onclick="NextMonth"><i class="bi bi-chevron-right"></i></button>
                <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="GoToToday">Today</button>
            </div>
        }
        else if (_calView == CalView.Gantt)
        {
            <div class="d-flex align-items-center gap-1 ms-auto">
                <button class="btn btn-outline-secondary btn-sm" @onclick="PrevGanttWeek"><i class="bi bi-chevron-left"></i></button>
                <strong class="px-2">@_ganttStart.ToString("MMM dd") – @_ganttStart.AddDays(13).ToString("MMM dd, yyyy")</strong>
                <button class="btn btn-outline-secondary btn-sm" @onclick="NextGanttWeek"><i class="bi bi-chevron-right"></i></button>
                <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="GoToGanttToday">Today</button>
            </div>
        }
    </div>

    @* Filters *@
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-0">From</label>
                    <input type="date" class="form-control form-control-sm" @bind="filterStart" @bind:after="LoadEvents" />
                </div>
                <div class="col-md-2">
                    <label class="form-label form-label-sm mb-0">To</label>
                    <input type="date" class="form-control form-control-sm" @bind="filterEnd" @bind:after="LoadEvents" />
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-0">Technician</label>
                    <select class="form-select form-select-sm" @bind="filterEmployee" @bind:after="LoadEvents">
                        <option value="">All Techs</option>
                        @foreach (var e in _employees)
                        {
                            <option value="@e.Id">@e.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label form-label-sm mb-0">Status</label>
                    <select class="form-select form-select-sm" @bind="filterStatus" @bind:after="LoadEvents">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<CalendarEventStatus>())
                        {
                            <option value="@s">@s</option>
                        }
                    </select>
                </div>
                <div class="col-md-2 text-end text-muted small pt-3">@(events?.Count ?? 0) event@(events?.Count != 1 ? "s" : "")</div>
            </div>
        </div>
    </div>

    @* Summary Stats *@
    <div class="row g-2 mb-3">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Total Events</small>
                <h5 class="mb-0">@(events?.Count ?? 0)</h5>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Confirmed</small>
                <h5 class="mb-0 text-success">@(events?.Count(e => e.Status == CalendarEventStatus.Confirmed) ?? 0)</h5>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Tentative</small>
                <h5 class="mb-0 text-warning">@(events?.Count(e => e.Status == CalendarEventStatus.Tentative) ?? 0)</h5>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center py-2">
                <small class="text-muted">Completed</small>
                <h5 class="mb-0 text-info">@(events?.Count(e => e.Status == CalendarEventStatus.Completed) ?? 0)</h5>
            </div>
        </div>
    </div>

    @* ========== LIST VIEW ========== *@
    @if (_calView == CalView.List)
    {
        <div class="card border-0 shadow-sm">
            @if (events is null)
            {
                <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
            }
            else if (!events.Any())
            {
                <div class="card-body text-center py-5 text-muted"><i class="bi bi-calendar-x" style="font-size:3rem;"></i><p class="mt-2">No events found. <a href="javascript:void(0)" @onclick="GoToNew">Create one</a>.</p></div>
            }
            else
            {
                @foreach (var group in events.GroupBy(e => e.StartDateTime.Date).OrderBy(g => g.Key))
                {
                    <div class="card-header bg-light fw-semibold">
                        <i class="bi bi-calendar-day me-1"></i>@group.Key.ToString("dddd, MMMM dd, yyyy")
                        @if (group.Key.Date == DateTime.Today) { <span class="badge bg-primary ms-2">Today</span> }
                    </div>
                    <div class="list-group list-group-flush">
                        @foreach (var ev in group.OrderBy(e => e.StartDateTime))
                        {
                            <a class="list-group-item list-group-item-action d-flex align-items-center" href="javascript:void(0)" @onclick="() => GoToDetail(ev.Id)">
                                @if (!string.IsNullOrWhiteSpace(ev.Color))
                                {
                                    <span class="d-inline-block rounded-circle me-2" style="width:10px;height:10px;background:@ev.Color;flex-shrink:0;"></span>
                                }
                                <span class="badge @GetStatusBadge(ev.Status) me-2">@ev.Status</span>
                                <div class="flex-grow-1">
                                    <strong>@(ev.Title ?? "Untitled")</strong>
                                    <small class="text-muted ms-2">@ev.StartDateTime.ToString("h:mm tt") – @ev.EndDateTime.ToString("h:mm tt")</small>
                                    @if (!string.IsNullOrWhiteSpace(ev.EventType)) { <small class="text-muted ms-1">· @ev.EventType</small> }
                                </div>
                                @if (ev.CustomerName is not null) { <span class="badge bg-light text-dark me-1">@ev.CustomerName</span> }
                                @if (ev.EmployeeName is not null) { <span class="badge bg-secondary me-1"><i class="bi bi-person-fill me-1"></i>@ev.EmployeeName</span> }
                                @if (ev.JobNumber is not null) { <span class="badge bg-primary"><i class="bi bi-tools me-1"></i>@ev.JobNumber</span> }
                            </a>
                        }
                    </div>
                }
            }
        </div>
    }

    @* ========== CALENDAR GRID VIEW ========== *@
    else if (_calView == CalView.Calendar)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                @{
                    var firstOfMonth = new DateTime(_calMonth.Year, _calMonth.Month, 1);
                    var daysInMonth = DateTime.DaysInMonth(_calMonth.Year, _calMonth.Month);
                    var startDow = (int)firstOfMonth.DayOfWeek;
                    var totalCells = startDow + daysInMonth;
                    var rows = (int)Math.Ceiling(totalCells / 7.0);
                    var eventsLookup = (events ?? [])
                        .Where(e => e.StartDateTime.Month == _calMonth.Month && e.StartDateTime.Year == _calMonth.Year)
                        .GroupBy(e => e.StartDateTime.Day)
                        .ToDictionary(g => g.Key, g => g.OrderBy(x => x.StartDateTime).ToList());
                }
                <div style="display:grid;grid-template-columns:repeat(7,1fr);border-bottom:1px solid #dee2e6;">
                    @foreach (var dayName in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                    {
                        <div class="text-center fw-semibold text-muted small py-2" style="border-right:1px solid #dee2e6;background:#f8f9fa;">@dayName</div>
                    }
                </div>
                @for (int row = 0; row < rows; row++)
                {
                    <div style="display:grid;grid-template-columns:repeat(7,1fr);min-height:100px;">
                        @for (int col = 0; col < 7; col++)
                        {
                            var cellIndex = row * 7 + col;
                            var dayNum = cellIndex - startDow + 1;
                            var isValidDay = dayNum >= 1 && dayNum <= daysInMonth;
                            var isToday = isValidDay && _calMonth.Year == DateTime.Today.Year && _calMonth.Month == DateTime.Today.Month && dayNum == DateTime.Today.Day;
                            var dayEvents = isValidDay && eventsLookup.TryGetValue(dayNum, out var de) ? de : null;

                            <div class="p-1 @(isToday ? "bg-primary bg-opacity-10" : isValidDay ? "" : "bg-light")" style="border-right:1px solid #eee;border-bottom:1px solid #eee;min-height:100px;overflow:hidden;">
                                @if (isValidDay)
                                {
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="fw-semibold @(isToday ? "text-primary" : "text-muted")">@dayNum</small>
                                        @if (dayEvents is not null)
                                        {
                                            <span class="badge bg-secondary rounded-pill" style="font-size:0.65rem;">@dayEvents.Count</span>
                                        }
                                    </div>
                                    @if (dayEvents is not null)
                                    {
                                        @foreach (var ev in dayEvents.Take(3))
                                        {
                                            var bgColor = !string.IsNullOrWhiteSpace(ev.Color) ? ev.Color : GetEventColor(ev.Status);
                                            <div class="rounded px-1 mb-1 text-truncate" style="font-size:0.7rem;background:@(bgColor);color:#fff;cursor:pointer;line-height:1.4;" @onclick="() => GoToDetail(ev.Id)" title="@ev.Title @ev.StartDateTime.ToString("h:mm tt")">
                                                @ev.StartDateTime.ToString("h:mm") @(ev.Title ?? "Event")
                                            </div>
                                        }
                                        @if (dayEvents.Count > 3)
                                        {
                                            <small class="text-muted" style="font-size:0.65rem;">+@(dayEvents.Count - 3) more</small>
                                        }
                                    }
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }

    @* ========== GANTT VIEW ========== *@
    else if (_calView == CalView.Gantt)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                @{
                    var ganttDays = 14;
                    var ganttDates = Enumerable.Range(0, ganttDays).Select(i => _ganttStart.AddDays(i)).ToList();
                    var ganttEvents = (events ?? []).Where(e => e.StartDateTime.Date <= _ganttStart.AddDays(ganttDays - 1) && e.EndDateTime.Date >= _ganttStart).ToList();
                    var techGroups = ganttEvents
                        .GroupBy(e => e.EmployeeName ?? "Unassigned")
                        .OrderBy(g => g.Key)
                        .ToList();
                    if (techGroups.Count == 0)
                    {
                        techGroups = _employees.Take(5).Select(emp =>
                            ganttEvents.Where(e => e.EmployeeName == emp.Name).GroupBy(_ => emp.Name).FirstOrDefault()
                        ).Where(g => g is not null).ToList()!;
                    }
                }
                <div style="overflow-x:auto;">
                    <div style="display:grid;grid-template-columns:160px repeat(@ganttDays, minmax(70px, 1fr));min-width:@(160 + ganttDays * 70)px;">
                        @* Header row *@
                        <div class="fw-semibold small p-2 text-muted" style="background:#f8f9fa;border-right:2px solid #dee2e6;border-bottom:2px solid #dee2e6;">Technician</div>
                        @foreach (var d in ganttDates)
                        {
                            var isWeekend = d.DayOfWeek == DayOfWeek.Saturday || d.DayOfWeek == DayOfWeek.Sunday;
                            var isTodayG = d.Date == DateTime.Today;
                            <div class="text-center small py-2 @(isTodayG ? "bg-primary bg-opacity-10 fw-bold" : isWeekend ? "bg-light" : "")" style="border-right:1px solid #eee;border-bottom:2px solid #dee2e6;">
                                <div class="@(isTodayG ? "text-primary" : "text-muted")">@d.ToString("ddd")</div>
                                <div class="fw-semibold">@d.Day</div>
                            </div>
                        }

                        @* Tech rows *@
                        @if (techGroups.Count == 0)
                        {
                            <div class="p-3 text-muted small" style="grid-column: 1 / -1;text-align:center;">No events in this date range. Adjust filters or date range.</div>
                        }
                        else
                        {
                            @foreach (var group in techGroups)
                            {
                                var techName = group.Key;
                                var techEvents = group.OrderBy(e => e.StartDateTime).ToList();

                                @* Tech name cell *@
                                <div class="d-flex align-items-center px-2 py-1 small fw-semibold" style="border-right:2px solid #dee2e6;border-bottom:1px solid #eee;background:#fafafa;">
                                    <i class="bi bi-person-fill text-muted me-1"></i>@techName
                                </div>

                                @* Day cells for this tech *@
                                @foreach (var d in ganttDates)
                                {
                                    var dayEvts = techEvents.Where(e => e.StartDateTime.Date <= d.Date && e.EndDateTime.Date >= d.Date).ToList();
                                    var isWeekend = d.DayOfWeek == DayOfWeek.Saturday || d.DayOfWeek == DayOfWeek.Sunday;
                                    var isTodayG = d.Date == DateTime.Today;
                                    <div class="p-1 @(isTodayG ? "bg-primary bg-opacity-10" : isWeekend ? "bg-light bg-opacity-50" : "")" style="border-right:1px solid #eee;border-bottom:1px solid #eee;min-height:40px;">
                                        @foreach (var ev in dayEvts.Take(2))
                                        {
                                            var bgColor = !string.IsNullOrWhiteSpace(ev.Color) ? ev.Color : GetEventColor(ev.Status);
                                            <div class="rounded px-1 mb-1 text-truncate" style="font-size:0.65rem;background:@(bgColor);color:#fff;cursor:pointer;line-height:1.3;" @onclick="() => GoToDetail(ev.Id)" title="@ev.Title @ev.StartDateTime.ToString("h:mm tt")–@ev.EndDateTime.ToString("h:mm tt")">
                                                @(ev.Title ?? "Event")
                                            </div>
                                        }
                                        @if (dayEvts.Count > 2)
                                        {
                                            <small class="text-muted" style="font-size:0.6rem;">+@(dayEvts.Count - 2)</small>
                                        }
                                    </div>
                                }
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    [Parameter]
    public int? Id { get; set; }
    private bool _confirmDelete;

    private string mode = "list";
    private List<CalendarEventItem>? events;
    private CalendarEventDetail? selected;
    private CalendarEventEditModel form = new();
    private int? editId;
    private string? errorMsg;

    private DateTime? filterStart;
    private DateTime? filterEnd;
    private string filterEmployee = "";
    private string filterStatus = "";

    private enum CalView { List, Calendar, Gantt }
    private CalView _calView = CalView.Calendar;
    private DateTime _calMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime _ganttStart = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);

    private List<JobListItem> _jobs = [];
    private List<EmployeeListItem> _employees = [];
    private List<AgreementListItem> _agreements = [];
    private List<string> _eventTypes = ["Job", "Personal", "Meeting", "Reminder", "Block-Off", "Training"];
    private List<string> _calendarStatuses = Enum.GetValues<CalendarEventStatus>().Select(s => s.ToString()).ToList();

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await Task.Run(async () => 
        {
            await DetermineView();
            await InvokeAsync(StateHasChanged);
        });
    }

    private async Task DetermineView()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.AbsolutePath.Contains("/calendar/new", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            mode = "form"; editId = null; form = new();
        }
        else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            await LoadForEdit(Id.Value);
        }
        else if (Id.HasValue)
            await LoadDetail(Id.Value);
        else
        {
            mode = "list";
            if (_employees.Count == 0) _employees = await EmployeeSvc.GetEmployeesAsync();
            await LoadEvents();
        }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadEvents()
    {
        int? empId = string.IsNullOrWhiteSpace(filterEmployee) ? null : int.Parse(filterEmployee);
        var all = await CalSvc.GetEventsAsync(filterStart, filterEnd, empId);
        if (!string.IsNullOrWhiteSpace(filterStatus) && Enum.TryParse<CalendarEventStatus>(filterStatus, out var st))
            all = all.Where(e => e.Status == st).ToList();
        events = all;
    }

    private async Task LoadDetail(int id)
    {
        selected = await CalSvc.GetEventDetailAsync(id);
        mode = selected is not null ? "detail" : "list";
        if (mode == "list") await LoadEvents();
    }

    private async Task LoadForEdit(int id)
    {
        var d = await CalSvc.GetEventDetailAsync(id);
        if (d is null) { mode = "list"; await LoadEvents(); return; }
        editId = id;
        form = new CalendarEventEditModel
        {
            Title = d.Title, StartDateTime = d.StartDateTime, EndDateTime = d.EndDateTime,
            Duration = d.Duration, Status = d.Status, EventType = d.EventType,
            IsRecurring = d.IsRecurring, RecurrenceRule = d.RecurrenceRule, Color = d.Color,
            Notes = d.Notes, Checklist = d.Checklist,
            JobId = d.JobId, EmployeeId = d.EmployeeId, ServiceAgreementId = d.ServiceAgreementId
        };
        mode = "form";
    }

    private async Task LoadDropdowns()
    {
        _jobs = await JobSvc.GetJobsAsync();
        _employees = await EmployeeSvc.GetEmployeesAsync();
        _agreements = await AgreementSvc.GetAgreementsAsync();
        var types = await DropdownSvc.GetOptionsAsync("EventType");
        if (types.Count > 0) _eventTypes = types.Where(o => o.IsActive).Select(o => o.Value).ToList();
        var statuses = await DropdownSvc.GetOptionsAsync("CalendarEventStatus");
        if (statuses.Count > 0) _calendarStatuses = statuses.Where(o => o.IsActive).Select(o => o.Value).ToList();
    }

    private async Task SaveEvent()
    {
        try
        {
            errorMsg = null;
            if (editId.HasValue) await CalSvc.UpdateEventAsync(editId.Value, form);
            else await CalSvc.CreateEventAsync(form);
            Nav.NavigateTo("/calendar");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task UpdateStatus(CalendarEventStatus status)
    {
        if (selected is not null)
        {
            await CalSvc.UpdateStatusAsync(selected.Id, status);
            await LoadDetail(selected.Id);
        }
    }

    private async Task DeleteDetail()
    {
        if (selected is not null) { await CalSvc.DeleteEventAsync(selected.Id); Nav.NavigateTo("/calendar"); }
    }

    private string GetStatusBadge(CalendarEventStatus s) => s switch
    {
        CalendarEventStatus.Tentative => "bg-warning text-dark",
        CalendarEventStatus.Confirmed => "bg-success",
        CalendarEventStatus.Completed => "bg-info",
        CalendarEventStatus.Cancelled => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetEventColor(CalendarEventStatus s) => s switch
    {
        CalendarEventStatus.Tentative => "#ffc107",
        CalendarEventStatus.Confirmed => "#198754",
        CalendarEventStatus.Completed => "#0dcaf0",
        CalendarEventStatus.Cancelled => "#6c757d",
        _ => "#6c757d"
    };

    private void SetCalView(CalView v) => _calView = v;
    private void PrevMonth() => _calMonth = _calMonth.AddMonths(-1);
    private void NextMonth() => _calMonth = _calMonth.AddMonths(1);
    private void GoToToday() => _calMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private void PrevGanttWeek() => _ganttStart = _ganttStart.AddDays(-7);
    private void NextGanttWeek() => _ganttStart = _ganttStart.AddDays(7);
    private void GoToGanttToday() => _ganttStart = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);

    private void GoToList() => Nav.NavigateTo("/calendar");
    private void GoToNew() => Nav.NavigateTo("/calendar/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/calendar/{id}");
    private void EditDetail() { if (selected is not null) Nav.NavigateTo($"/calendar/{selected.Id}/edit"); }
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");
    private void GoToEmployee(int id) => Nav.NavigateTo($"/employees/{id}");
    private void GoToAgreement(int id) => Nav.NavigateTo($"/serviceagreements/{id}");
}

