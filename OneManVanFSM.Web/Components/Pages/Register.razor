@page "/login/register"
@layout EmptyLayout
@inject IAuthService AuthService

<PageTitle>Register - OneManVanFSM</PageTitle>

<div class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="card border-0 shadow" style="max-width: 460px; width: 100%;">
        <div class="card-body p-4 text-center">
            <i class="bi bi-person-plus text-primary" style="font-size: 2.5rem;"></i>
            <h4 class="mt-2 mb-1">Create Account</h4>
            <p class="text-muted small mb-3">Registration requires admin approval before access is granted.</p>

            @if (_submitted)
            {
                <div class="alert alert-success py-2 small">
                    Your registration has been submitted. An administrator will review and activate your account.
                </div>
                <a href="/login" class="btn btn-outline-primary w-100">Back to Login</a>
            }
            else
            {
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger py-2 small">@_errorMessage</div>
                }

                <EditForm Model="_model" OnValidSubmit="HandleRegister" FormName="registerForm">
                    <DataAnnotationsValidator />

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Full Name</label>
                        <InputText @bind-Value="_model.Name" class="form-control" placeholder="Enter your full name" disabled="@_isLoading" />
                        <ValidationMessage For="() => _model.Name" />
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Email</label>
                        <InputText @bind-Value="_model.Email" class="form-control" placeholder="Enter your email" disabled="@_isLoading" />
                        <ValidationMessage For="() => _model.Email" />
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Username</label>
                        <InputText @bind-Value="_model.Username" class="form-control" placeholder="Choose a username" disabled="@_isLoading" />
                        <ValidationMessage For="() => _model.Username" />
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Requested Role</label>
                        <InputSelect @bind-Value="_model.RequestedRole" class="form-select" disabled="@_isLoading">
                            <option value="@UserRole.Tech">Technician</option>
                            <option value="@UserRole.Dispatcher">Dispatcher</option>
                            <option value="@UserRole.Manager">Manager</option>
                        </InputSelect>
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Password</label>
                        <InputText @bind-Value="_model.Password" type="password" class="form-control" placeholder="Min. 6 characters" disabled="@_isLoading" />
                        <ValidationMessage For="() => _model.Password" />
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Confirm Password</label>
                        <InputText @bind-Value="_model.ConfirmPassword" type="password" class="form-control" placeholder="Re-enter password" disabled="@_isLoading" />
                        <ValidationMessage For="() => _model.ConfirmPassword" />
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>Submitting...</span>
                        }
                        else
                        {
                            <span>Register</span>
                        }
                    </button>
                </EditForm>

                <a href="/login" class="small text-decoration-none">Already have an account? Sign In</a>
            }
        </div>
    </div>
</div>

@code {
[SupplyParameterFromForm]
private RegisterModel _model { get; set; } = new();
private string? _errorMessage;
private bool _submitted;
private bool _isLoading;

    private async Task HandleRegister()
    {
        _errorMessage = null;

        if (_model.Password != _model.ConfirmPassword)
        {
            _errorMessage = "Passwords do not match.";
            return;
        }

        _isLoading = true;

        try
        {
            var request = new RegisterRequest
            {
                Name = _model.Name,
                Email = _model.Email,
                Username = _model.Username,
                Password = _model.Password,
                ConfirmPassword = _model.ConfirmPassword,
                RequestedRole = _model.RequestedRole
            };

            var result = await AuthService.RegisterAsync(request);

            if (result.Succeeded)
            {
                _submitted = true;
            }
            else
            {
                _errorMessage = result.ErrorMessage ?? "Registration failed.";
            }
        }
        catch
        {
            _errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private sealed class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Name is required.")]
        public string Name { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required.")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Enter a valid email.")]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Username is required.")]
        [System.ComponentModel.DataAnnotations.MinLength(3, ErrorMessage = "Username must be at least 3 characters.")]
        public string Username { get; set; } = string.Empty;

        public UserRole RequestedRole { get; set; } = UserRole.Tech;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required.")]
        [System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Password must be at least 6 characters.")]
        public string Password { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Please confirm your password.")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
