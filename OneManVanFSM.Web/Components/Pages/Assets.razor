@page "/assets"
@page "/assets/new"
@page "/assets/{Id:int}"
@page "/assets/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject IAssetService AssetSvc
@inject ICustomerService CustomerSvc
@inject ISiteService SiteSvc
@inject IProductService ProductSvc
@inject IDropdownService DropdownSvc
@inject IJobService JobSvc
@inject IEmployeeService EmployeeSvc
@inject NavigationManager Nav

<PageTitle>Assets - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        @if (editId.HasValue)
        {
            <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToPrevAssetEdit" disabled="@(GetAdjacentAssetEditId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToNextAssetEdit" disabled="@(GetAdjacentAssetEditId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        }
        <h4 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>@(editId.HasValue ? "Edit" : "New") Asset</h4>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveAsset">
                <DataAnnotationsValidator />

                <!-- Populate from Product -->
                <h6 class="text-info mb-2"><i class="bi bi-pencil-square me-1"></i>Populate from Product</h6>
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <select class="form-select border-info" @onchange="OnProductSelected">
                            <option value="">Select a product to auto-fill...</option>
                            @foreach (var p in _products)
                            {
                                <option value="@p.Id" selected="@(form.ProductId == p.Id)">@p.Name @(!string.IsNullOrWhiteSpace(p.Brand) ? $"({p.Brand})" : "")</option>
                            }
                        </select>
                        <small class="text-muted">Auto-fills brand, model, equipment type, fuel type, tonnage, SEER, AFUE, refrigerant, voltage, and warranty info</small>
                    </div>
                </div>

                <!-- Equipment Information -->
                <h6 class="text-muted mb-2"><i class="bi bi-tag me-1"></i>Equipment Information</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Customer</label>
                        <InputSelect @bind-Value="form.CustomerId" @bind-Value:after="OnAssetCustomerChanged" class="form-select">
                            <option value="">— Select Customer —</option>
                            @foreach (var c in _customers) { <option value="@c.Id">@c.Name</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Site</label>
                        <InputSelect @bind-Value="form.SiteId" @bind-Value:after="OnAssetSiteChanged" class="form-select">
                            <option value="">— Select Site —</option>
                            @foreach (var s in FilteredAssetSites) { <option value="@s.Id">@s.Name</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-4"></div>
                    <div class="col-md-4">
                        <label class="form-label">Asset Name</label>
                        <InputText @bind-Value="form.Name" class="form-control" placeholder="Optional friendly name" />
                        <ValidationMessage For="() => form.Name" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Serial Number <span class="text-danger">*</span></label>
                        <InputText @bind-Value="form.SerialNumber" class="form-control" />
                    </div>
                    <div class="col-md-4"></div>
                    <div class="col-md-3">
                        <label class="form-label">Asset Tag</label>
                        <InputText @bind-Value="form.AssetTag" class="form-control" placeholder="Barcode/QR code" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Brand</label>
                        <select class="form-select" @bind="_brandValue" @bind:after="OnBrandChanged">
                            <option value="">— Select —</option>
                            @foreach (var o in _brandOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Model</label>
                        <InputText @bind-Value="form.Model" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nickname</label>
                        <InputText @bind-Value="form.Nickname" class="form-control" placeholder="e.g., Upstairs Unit" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Location</label>
                        <select class="form-select" @bind="_locationValue" @bind:after="OnLocationChanged">
                            <option value="">— Select —</option>
                            @foreach (var o in _locationOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Equipment Type -->
                <h6 class="text-muted mb-2"><i class="bi bi-gear me-1"></i>Equipment Type</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Equipment Type</label>
                        <select class="form-select" @bind="_assetTypeValue" @bind:after="OnAssetTypeChanged">
                            <option value="">Unknown</option>
                            @foreach (var o in _assetTypeOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fuel Type</label>
                        <select class="form-select" @bind="_fuelTypeValue" @bind:after="OnFuelTypeChanged">
                            <option value="">Unknown</option>
                            @foreach (var o in _fuelTypeOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in Enum.GetValues<AssetStatus>()) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unit Config</label>
                        <select class="form-select" @bind="_unitConfigValue" @bind:after="OnUnitConfigChanged">
                            <option value="">Unknown</option>
                            @foreach (var o in _unitConfigOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Capacity & Efficiency -->
                <h6 class="text-muted mb-2"><i class="bi bi-thermometer-half me-1"></i>Capacity & Efficiency</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Tonnage (BTU)</label>
                        <select class="form-select" @bind="_tonnageValue" @bind:after="OnTonnageChanged">
                            <option value="">— Select —</option>
                            <option value="6000">6,000 BTU (0.5 Ton)</option>
                            <option value="9000">9,000 BTU (0.75 Ton)</option>
                            <option value="12000">12,000 BTU (1 Ton)</option>
                            <option value="18000">18,000 BTU (1.5 Ton)</option>
                            <option value="24000">24,000 BTU (2 Ton)</option>
                            <option value="30000">30,000 BTU (2.5 Ton)</option>
                            <option value="36000">36,000 BTU (3 Ton)</option>
                            <option value="42000">42,000 BTU (3.5 Ton)</option>
                            <option value="48000">48,000 BTU (4 Ton)</option>
                            <option value="60000">60,000 BTU (5 Ton)</option>
                            <option value="Other">Other</option>
                        </select>
                        @if (_tonnageValue == "Other")
                        {
                            <input type="number" class="form-control mt-1" step="1" placeholder="Enter BTU value" @bind="form.Tonnage" />
                        }
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">BTU Rating</label>
                        <InputNumber @bind-Value="form.BTURating" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">SEER</label>
                        <InputNumber @bind-Value="form.SEER" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">SEER2</label>
                        <InputNumber @bind-Value="form.SEER2" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">AFUE %</label>
                        <InputNumber @bind-Value="form.AFUE" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">HSPF</label>
                        <InputNumber @bind-Value="form.HSPF" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">HSPF2</label>
                        <InputNumber @bind-Value="form.HSPF2" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">EER</label>
                        <InputNumber @bind-Value="form.EER" class="form-control" />
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Refrigerant & Electrical -->
                <h6 class="text-muted mb-2"><i class="bi bi-snow me-1"></i>Refrigerant & Electrical</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Refrigerant Type</label>
                        <select class="form-select" @bind="_refrigerantValue" @bind:after="OnRefrigerantChanged">
                            <option value="">Unknown</option>
                            @foreach (var o in _refrigerantOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Charge (oz)</label>
                        <InputNumber @bind-Value="form.RefrigerantQuantity" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Voltage</label>
                        <select class="form-select" @bind="_voltageValue" @bind:after="OnVoltageChanged">
                            <option value="">— Select —</option>
                            @foreach (var o in _voltageOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Phase Type</label>
                        <select class="form-select" @bind="_phaseValue" @bind:after="OnPhaseChanged">
                            <option value="">— Select —</option>
                            @foreach (var o in _phaseOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Filter Information -->
                <h6 class="text-muted mb-2"><i class="bi bi-funnel me-1"></i>Filter Information</h6>
                <div class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label">Filter Size</label>
                        <select class="form-select" @bind="_filterSizeValue" @bind:after="OnFilterSizeChanged">
                            <option value="">— Select —</option>
                            @foreach (var o in _filterSizeOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Filter Type</label>
                        <select class="form-select" @bind="_filterTypeValue" @bind:after="OnFilterTypeChanged">
                            <option value="">Unknown</option>
                            @foreach (var o in _filterTypeOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Change Interval</label>
                        <InputNumber @bind-Value="form.FilterChangeIntervalMonths" class="form-control" />
                        <small class="text-muted">months</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Last Changed</label>
                        <InputDate @bind-Value="form.FilterLastChanged" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Next Due</label>
                        <InputDate @bind-Value="form.FilterNextDue" class="form-control" />
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Thermostat -->
                <h6 class="text-muted mb-2"><i class="bi bi-thermometer me-1"></i>Thermostat</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Thermostat Brand</label>
                        <InputText @bind-Value="form.ThermostatBrand" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Thermostat Model</label>
                        <InputText @bind-Value="form.ThermostatModel" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Thermostat Type</label>
                        <select class="form-select" @bind="_thermostatTypeValue" @bind:after="OnThermostatTypeChanged">
                            <option value="">Unknown</option>
                            @foreach (var o in _thermostatTypeOptions) { <option value="@o">@o</option> }
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div class="form-check">
                            <InputCheckbox @bind-Value="form.ThermostatWiFiEnabled" class="form-check-input" id="chkWifi" />
                            <label class="form-check-label" for="chkWifi">WiFi Enabled</label>
                        </div>
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Installation & Warranty -->
                <h6 class="text-muted mb-2"><i class="bi bi-shield-check me-1"></i>Installation & Warranty</h6>
                <div class="row g-2 mb-2">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" id="chkNoWarranty"
                                   checked="@form.NoWarranty" @onchange="OnNoWarrantyToggled" />
                            <label class="form-check-label fw-semibold @(form.NoWarranty ? "text-danger" : "text-muted")" for="chkNoWarranty">
                                <i class="bi @(form.NoWarranty ? "bi-shield-x" : "bi-shield-check") me-1"></i>
                                @(form.NoWarranty ? "Warranty Disabled — unit is not under warranty" : "Warranty Active")
                            </label>
                        </div>
                    </div>
                </div>
                @if (form.NoWarranty)
                {
                    <div class="alert alert-warning py-2 px-3 mb-3">
                        <i class="bi bi-exclamation-triangle me-1"></i>All warranty fields are disabled. This unit will show as <strong>No Warranty</strong> in listings and detail views.
                    </div>
                }
                <div class="row g-2" style="@(form.NoWarranty ? "opacity:0.5;pointer-events:none;" : "")">
                    <div class="col-md-3">
                        <label class="form-label">Install Date</label>
                        <InputDate @bind-Value="form.InstallDate" @bind-Value:after="OnInstallDateChanged" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Warranty Start</label>
                        <InputDate @bind-Value="form.WarrantyStartDate" @bind-Value:after="RecalculateWarrantyExpiries" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Warranty Expiration</label>
                        <InputDate @bind-Value="form.WarrantyExpiry" class="form-control" disabled />
                    </div>
                    <div class="col-md-3"></div>
                    <div class="col-md-3">
                        <label class="form-label">Installed By</label>
                        <InputSelect @bind-Value="form.InstalledBy" class="form-select">
                            <option value="">— Select Employee —</option>
                            @foreach (var emp in _employees)
                            {
                                <option value="@emp.Name">@emp.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <div class="form-check">
                            <InputCheckbox @bind-Value="form.WarrantedByCompany" class="form-check-input" id="chkWarrantedByCompany" />
                            <label class="form-check-label" for="chkWarrantedByCompany">Warranted by SE HVAC</label>
                        </div>
                    </div>
                    <div class="col-md-3"></div>
                </div>

                <!-- Warranty Terms Breakdown -->
                <div class="row g-2 mt-2" style="@(form.NoWarranty ? "opacity:0.5;pointer-events:none;" : "")">
                    <div class="col-12"><small class="text-muted fw-bold">Warranty Terms (years) — expiry dates auto-calculate from Warranty Start</small></div>
                    <div class="col-md-3">
                        <label class="form-label">Labor (years)</label>
                        <InputNumber @bind-Value="form.LaborWarrantyTermYears" @bind-Value:after="RecalculateWarrantyExpiries" class="form-control" />
                        @if (_laborExpiry.HasValue)
                        {
                            <small class="@GetWarrantyTermCss(_laborExpiry.Value)">Expires: @_laborExpiry.Value.ToString("MMM dd, yyyy")</small>
                        }
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Parts (years)</label>
                        <InputNumber @bind-Value="form.PartsWarrantyTermYears" @bind-Value:after="RecalculateWarrantyExpiries" class="form-control" />
                        @if (_partsExpiry.HasValue)
                        {
                            <small class="@GetWarrantyTermCss(_partsExpiry.Value)">Expires: @_partsExpiry.Value.ToString("MMM dd, yyyy")</small>
                        }
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Compressor (years)</label>
                        <InputNumber @bind-Value="form.CompressorWarrantyTermYears" @bind-Value:after="RecalculateWarrantyExpiries" class="form-control" />
                        @if (_compressorExpiry.HasValue)
                        {
                            <small class="@GetWarrantyTermCss(_compressorExpiry.Value)">Expires: @_compressorExpiry.Value.ToString("MMM dd, yyyy")</small>
                        }
                    </div>
                    <div class="col-md-3"></div>
                </div>

                <!-- Registration & Service -->
                <div class="row g-2 mt-2" style="@(form.NoWarranty ? "opacity:0.5;pointer-events:none;" : "")">
                    <div class="col-md-3">
                        <label class="form-label">Next Service Due</label>
                        <InputDate @bind-Value="form.NextServiceDue" class="form-control" />
                        <small class="text-muted">Defaults to 1yr from install</small>
                    </div>
                    <div class="col-md-3 d-flex align-items-center pt-4">
                        <div class="form-check">
                            <InputCheckbox @bind-Value="form.RegisteredOnline" class="form-check-input" id="chkRegistered" />
                            <label class="form-check-label" for="chkRegistered">Registered Online</label>
                        </div>
                    </div>
                    @if (!form.RegisteredOnline)
                    {
                        <div class="col-md-6 pt-4">
                            <div class="alert alert-warning py-1 px-2 mb-0 small">
                                <i class="bi bi-exclamation-triangle me-1"></i>Remember to register this equipment online to honor the full manufacturer warranty.
                            </div>
                        </div>
                    }
                </div>

                <hr class="my-3" />
                <!-- Linked Jobs -->
                <h6 class="fw-semibold mb-2"><i class="bi bi-briefcase me-1"></i>Linked Jobs</h6>
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <div class="border rounded p-2" style="max-height:200px;overflow-y:auto;">
                            @if (!form.CustomerId.HasValue && !form.SiteId.HasValue)
                            {
                                <small class="text-muted">Select a customer or site to see matching jobs.</small>
                            }
                            else if (FilteredJobOptions.Count == 0)
                            {
                                <small class="text-muted">No jobs found for the selected customer/site.</small>
                            }
                            else
                            {
                                @foreach (var j in FilteredJobOptions)
                                {
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="chkJob_@j.Id"
                                               checked="@(_selectedJobIds.Contains(j.Id))"
                                               @onchange="() => ToggleJob(j.Id)" />
                                        <label class="form-check-label" for="chkJob_@j.Id">@j.Display</label>
                                    </div>
                                }
                            }
                        </div>
                        <small class="text-muted">@_selectedJobIds.Count job(s) selected</small>
                    </div>
                </div>

                <hr class="my-3" />
                <!-- Notes -->
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Asset Value ($)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <InputNumber @bind-Value="form.Value" class="form-control" placeholder="0.00" />
                        </div>
                        <small class="text-muted">Original cost or current value</small>
                    </div>
                    <div class="col-md-9">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>
                </div>

                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-outline-secondary" @onclick="GoToList">Cancel</button>
                    <div class="d-flex gap-2 align-items-center">
                        @if (!string.IsNullOrEmpty(_savedMsg)) { <span class="text-success small"><i class="bi bi-check-circle me-1"></i>@_savedMsg</span> }
                        <button type="submit" class="btn btn-outline-primary" @onclick="() => _closeAfterSave = false"><i class="bi bi-floppy me-1"></i>Save</button>
                        <button type="submit" class="btn btn-primary" @onclick="() => _closeAfterSave = true"><i class="bi bi-check-circle me-1"></i>Save & Close</button>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && detail is not null)
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToList" title="Back to list"><i class="bi bi-arrow-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToPrevAsset" disabled="@(GetAdjacentAssetId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToNextAsset" disabled="@(GetAdjacentAssetId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        <h4 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>@detail.Name</h4>
        <span class="badge ms-2 @GetAssetBadge(detail.Status)">@detail.Status</span>
        @{ var warrantyState = GetWarrantyState(detail); }
        @if (detail.NoWarranty)
        {
            <span class="badge bg-dark ms-1"><i class="bi bi-shield-x me-1"></i>No Warranty</span>
        }
        else if (warrantyState == "active")
        {
            <span class="badge bg-success ms-1"><i class="bi bi-shield-check me-1"></i>Warranty Active</span>
        }
        else if (warrantyState == "expiring")
        {
            <span class="badge bg-warning text-dark ms-1"><i class="bi bi-shield-exclamation me-1"></i>Warranty Expiring</span>
        }
        else if (warrantyState == "expired")
        {
            <span class="badge bg-danger ms-1"><i class="bi bi-shield-x me-1"></i>Warranty Expired</span>
        }
        <div class="ms-auto dropdown">
            <button class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-plus-lg me-1"></i>Actions</button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item" @onclick="EditDetail"><i class="bi bi-pencil me-2"></i>Edit Asset</button></li>
                <li><a class="dropdown-item" href="jobs/new?assetId=@detail.Id"><i class="bi bi-wrench me-2"></i>New Job</a></li>
                <li><hr class="dropdown-divider" /></li>
                @if (!_confirmArchive)
                {
                    <li><button class="dropdown-item text-danger" @onclick="() => _confirmArchive = true"><i class="bi bi-archive me-2"></i>Archive</button></li>
                }
                else
                {
                    <li><button class="dropdown-item text-danger fw-semibold" @onclick="ArchiveDetail"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Archive?</button></li>
                    <li><button class="dropdown-item" @onclick="() => _confirmArchive = false"><i class="bi bi-x-lg me-2"></i>Cancel</button></li>
                }
            </ul>
        </div>
    </div>
    <div class="row g-3">
        <!-- Main Content Column -->
        <div class="col-md-8">
            <!-- Equipment Details -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-gear me-1"></i>Equipment Details</h6>
                    <div class="row g-2">
                        <div class="col-sm-4"><strong>Type:</strong> @(detail.AssetType ?? "—")</div>
                        <div class="col-sm-4"><strong>Brand:</strong> @(detail.Brand ?? "—")</div>
                        <div class="col-sm-4"><strong>Model:</strong> @(detail.Model ?? "—")</div>
                        <div class="col-sm-4"><strong>Serial:</strong> @(detail.SerialNumber ?? "—")</div>
                        @if (detail.Nickname is not null) { <div class="col-sm-4"><strong>Nickname:</strong> @detail.Nickname</div> }
                        @if (detail.AssetTag is not null) { <div class="col-sm-4"><strong>Asset Tag:</strong> @detail.AssetTag</div> }
                        @if (detail.UnitConfiguration is not null) { <div class="col-sm-4"><strong>Config:</strong> @detail.UnitConfiguration</div> }
                        @if (detail.FuelType is not null) { <div class="col-sm-4"><strong>Fuel:</strong> @detail.FuelType</div> }
                        @if (detail.LocationOnSite is not null) { <div class="col-sm-4"><strong>Location:</strong> @detail.LocationOnSite</div> }
                        <div class="col-sm-4"><strong>Value:</strong> @(detail.Value?.ToString("C") ?? "—")</div>
                        @if (detail.InstalledBy is not null) { <div class="col-sm-4"><strong>Installed By:</strong> @detail.InstalledBy</div> }
                    </div>
                </div>
            </div>

            <!-- HVAC Specs -->
            @if (detail.Tonnage.HasValue || detail.SEER.HasValue || detail.AFUE.HasValue || detail.HSPF.HasValue
                || detail.BTURating.HasValue || detail.FilterSize is not null || detail.FuelType is not null
                || detail.RefrigerantType is not null)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-thermometer-half me-1"></i>Capacity & Efficiency</h6>
                        <div class="row g-2">
                            @if (detail.Tonnage.HasValue) { <div class="col-sm-3"><strong>Tonnage:</strong> @detail.Tonnage.Value.ToString("N0") BTU</div> }
                            @if (detail.BTURating.HasValue) { <div class="col-sm-3"><strong>BTU:</strong> @detail.BTURating.Value.ToString("N0")</div> }
                            @if (detail.SEER.HasValue) { <div class="col-sm-3"><strong>SEER:</strong> @detail.SEER</div> }
                            @if (detail.SEER2.HasValue) { <div class="col-sm-3"><strong>SEER2:</strong> @detail.SEER2</div> }
                            @if (detail.AFUE.HasValue) { <div class="col-sm-3"><strong>AFUE:</strong> @detail.AFUE%</div> }
                            @if (detail.HSPF.HasValue) { <div class="col-sm-3"><strong>HSPF:</strong> @detail.HSPF</div> }
                            @if (detail.HSPF2.HasValue) { <div class="col-sm-3"><strong>HSPF2:</strong> @detail.HSPF2</div> }
                            @if (detail.EER.HasValue) { <div class="col-sm-3"><strong>EER:</strong> @detail.EER</div> }
                        </div>
                        @if (detail.RefrigerantType is not null)
                        {
                            <hr />
                            <h6 class="text-muted mb-2"><i class="bi bi-snow me-1"></i>Refrigerant & Electrical</h6>
                            <div class="row g-2">
                                <div class="col-sm-3"><strong>Refrigerant:</strong> @detail.RefrigerantType</div>
                                <div class="col-sm-3"><strong>Charge:</strong> @(detail.RefrigerantQuantity?.ToString() ?? "—") oz</div>
                                @if (detail.Voltage is not null) { <div class="col-sm-3"><strong>Voltage:</strong> @detail.Voltage</div> }
                                @if (detail.Phase is not null) { <div class="col-sm-3"><strong>Phase:</strong> @detail.Phase</div> }
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Filter Information -->
            @if (detail.FilterSize is not null || detail.FilterType is not null || detail.FilterChangeIntervalMonths.HasValue)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-funnel me-1"></i>Filter Information</h6>
                        <div class="row g-2">
                            @if (detail.FilterSize is not null) { <div class="col-sm-3"><strong>Size:</strong> @detail.FilterSize</div> }
                            @if (detail.FilterType is not null) { <div class="col-sm-3"><strong>Type:</strong> @detail.FilterType</div> }
                            @if (detail.FilterChangeIntervalMonths.HasValue) { <div class="col-sm-3"><strong>Interval:</strong> @detail.FilterChangeIntervalMonths months</div> }
                            @if (detail.FilterLastChanged.HasValue) { <div class="col-sm-3"><strong>Last Changed:</strong> @detail.FilterLastChanged.Value.ToString("MMM dd, yyyy")</div> }
                            @if (detail.FilterNextDue.HasValue)
                            {
                                var filterOverdue = detail.FilterNextDue.Value < DateTime.UtcNow;
                                <div class="col-sm-3">
                                    <strong>Next Due:</strong>
                                    <span class="@(filterOverdue ? "text-danger fw-bold" : "")">@detail.FilterNextDue.Value.ToString("MMM dd, yyyy") @(filterOverdue ? "(Overdue)" : "")</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Thermostat -->
            @if (detail.ThermostatBrand is not null || detail.ThermostatModel is not null || detail.ThermostatType is not null)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-thermometer me-1"></i>Thermostat</h6>
                        <div class="row g-2">
                            @if (detail.ThermostatBrand is not null) { <div class="col-sm-3"><strong>Brand:</strong> @detail.ThermostatBrand</div> }
                            @if (detail.ThermostatModel is not null) { <div class="col-sm-3"><strong>Model:</strong> @detail.ThermostatModel</div> }
                            @if (detail.ThermostatType is not null) { <div class="col-sm-3"><strong>Type:</strong> @detail.ThermostatType</div> }
                            <div class="col-sm-3"><strong>WiFi:</strong> @(detail.ThermostatWiFiEnabled ? "Yes" : "No")</div>
                        </div>
                    </div>
                </div>
            }

            <!-- Plumbing Specs -->
            @if (detail.PipeMaterial is not null || detail.GallonCapacity.HasValue)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-droplet me-1"></i>Plumbing</h6>
                        <div class="row g-2">
                            @if (detail.PipeMaterial is not null) { <div class="col-sm-6"><strong>Pipe Material:</strong> @detail.PipeMaterial</div> }
                            @if (detail.GallonCapacity.HasValue) { <div class="col-sm-6"><strong>Capacity:</strong> @detail.GallonCapacity gal</div> }
                        </div>
                    </div>
                </div>
            }

            <!-- Key Dates & Warranty -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-calendar3 me-1"></i>Key Dates & Warranty</h6>
                    @if (detail.NoWarranty)
                    {
                        <div class="alert alert-secondary py-2 px-3 mb-2">
                            <i class="bi bi-shield-x me-1"></i><strong>Warranty Disabled</strong> — This unit is not under warranty.
                        </div>
                    }
                    <div class="row g-2">
                        <div class="col-sm-4"><strong>Installed:</strong> @(detail.InstallDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4"><strong>Last Service:</strong> @(detail.LastServiceDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4">
                            <strong>Next Service:</strong>
                            @if (detail.NextServiceDue.HasValue)
                            {
                                var overdue = detail.NextServiceDue.Value < DateTime.UtcNow;
                                <span class="@(overdue ? "text-danger fw-bold" : "")">
                                    @detail.NextServiceDue.Value.ToString("MMM dd, yyyy") @(overdue ? " (Overdue)" : "")
                                </span>
                            }
                            else { <span>—</span> }
                        </div>
                        <div class="col-sm-4"><strong>Warranty Start:</strong> @(detail.WarrantyStartDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4">
                            <strong>Warranty Expiry:</strong>
                            @if (detail.WarrantyExpiry.HasValue)
                            {
                                var ws = GetWarrantyState(detail);
                                <span class="@(ws == "expired" ? "text-danger" : ws == "expiring" ? "text-warning" : "text-success")">
                                    @detail.WarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                    @if (detail.WarrantyTermYears.HasValue) { <small>(@(detail.WarrantyTermYears)yr term)</small> }
                                </span>
                            }
                            else { <span>—</span> }
                        </div>
                    </div>
                    @if (detail.LaborWarrantyExpiry.HasValue || detail.PartsWarrantyExpiry.HasValue || detail.CompressorWarrantyExpiry.HasValue)
                    {
                        <hr />
                        <h6 class="text-muted mb-2"><i class="bi bi-shield-check me-1"></i>Warranty Breakdown</h6>
                        <div class="row g-2">
                            @if (detail.LaborWarrantyExpiry.HasValue)
                            {
                                var laborDays = (int)(detail.LaborWarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
                                <div class="col-sm-4">
                                    <strong>Labor@(detail.LaborWarrantyTermYears.HasValue ? $" ({detail.LaborWarrantyTermYears}yr)" : ""):</strong>
                                    <span class="@(laborDays < 0 ? "text-danger" : laborDays < 90 ? "text-warning" : "text-success")">
                                        @detail.LaborWarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                        @if (laborDays < 0) { <small>(Expired)</small> }
                                        else { <small>(@laborDays days)</small> }
                                    </span>
                                </div>
                            }
                            @if (detail.PartsWarrantyExpiry.HasValue)
                            {
                                var partsDays = (int)(detail.PartsWarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
                                <div class="col-sm-4">
                                    <strong>Parts@(detail.PartsWarrantyTermYears.HasValue ? $" ({detail.PartsWarrantyTermYears}yr)" : ""):</strong>
                                    <span class="@(partsDays < 0 ? "text-danger" : partsDays < 90 ? "text-warning" : "text-success")">
                                        @detail.PartsWarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                        @if (partsDays < 0) { <small>(Expired)</small> }
                                        else { <small>(@partsDays days)</small> }
                                    </span>
                                </div>
                            }
                            @if (detail.CompressorWarrantyExpiry.HasValue)
                            {
                                var compDays = (int)(detail.CompressorWarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
                                <div class="col-sm-4">
                                    <strong>Compressor@(detail.CompressorWarrantyTermYears.HasValue ? $" ({detail.CompressorWarrantyTermYears}yr)" : ""):</strong>
                                    <span class="@(compDays < 0 ? "text-danger" : compDays < 90 ? "text-warning" : "text-success")">
                                        @detail.CompressorWarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                        @if (compDays < 0) { <small>(Expired)</small> }
                                        else { <small>(@compDays days)</small> }
                                    </span>
                                </div>
                            }
                        </div>
                    }
                    <hr />
                    <div class="row g-2">
                        <div class="col-sm-4">
                            <strong>Registered Online:</strong>
                            @if (detail.RegisteredOnline)
                            {
                                <span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Yes</span>
                            }
                            else
                            {
                                <span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>No — register to honor full warranty</span>
                            }
                        </div>
                        @if (detail.WarrantedByCompany) { <div class="col-sm-4"><span class="badge bg-primary"><i class="bi bi-award me-1"></i>Warranted by SE HVAC</span></div> }
                    </div>
                </div>
            </div>

            <!-- Service History -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-clock-history me-1"></i>Service History (@detail.ServiceHistory.Count)</h6>
                    @if (detail.ServiceHistory.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr><th>Date</th><th>Service</th><th>Performed By</th><th>Cost</th><th>Refrigerant</th><th>Notes</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var sl in detail.ServiceHistory)
                                    {
                                        <tr>
                                            <td>@sl.ServiceDate.ToString("MMM dd, yyyy")</td>
                                            <td><span class="badge bg-info text-dark">@(sl.ServiceType ?? "General")</span></td>
                                            <td>@(sl.PerformedBy ?? "—")</td>
                                            <td>@(sl.Cost?.ToString("C") ?? "—")</td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(sl.RefrigerantType))
                                                {
                                                    <small>@sl.RefrigerantType @(sl.RefrigerantAmountAdded.HasValue ? $"+{sl.RefrigerantAmountAdded:N1} lbs" : "")</small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                            <td class="text-muted small">@(sl.Notes ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No service records yet.</p>
                    }
                </div>
            </div>

            <!-- Linked Jobs -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-wrench-adjustable me-1"></i>Linked Jobs (@detail.LinkedJobs.Count)</h6>
                    @if (detail.LinkedJobs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr><th>Job #</th><th>Title</th><th>Status</th><th>Date</th><th>Role</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var j in detail.LinkedJobs)
                                    {
                                        <tr style="cursor:pointer" @onclick="() => GoToJob(j.Id)">
                                            <td><strong>@j.JobNumber</strong></td>
                                            <td>@(j.Title ?? "—")</td>
                                            <td><span class="badge @GetJobBadge(j.Status)">@j.Status</span></td>
                                            <td>@(j.ScheduledDate?.ToString("MMM dd, yyyy") ?? "—")</td>
                                            <td class="text-muted">@(j.Role ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No linked jobs yet.</p>
                    }
                </div>
            </div>

            <!-- Unified Service Timeline -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-timeline me-1"></i>Unified Service Timeline (@detail.UnifiedTimeline.Count)</h6>
                    @if (detail.UnifiedTimeline.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr><th>Date</th><th>Source</th><th>Title</th><th>Status</th><th>Performed By</th><th>Cost</th><th>Details</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var entry in detail.UnifiedTimeline)
                                    {
                                        <tr @onclick="() => NavigateTimelineEntry(entry)" style="@(entry.Source == "Job" ? "cursor:pointer" : "")">
                                            <td>@entry.Date.ToString("MMM dd, yyyy")</td>
                                            <td><span class="badge @(entry.Badge ?? "bg-secondary")">@entry.Source</span></td>
                                            <td><strong>@entry.Title</strong></td>
                                            <td><small>@(entry.Status ?? "—")</small></td>
                                            <td>@(entry.PerformedBy ?? "—")</td>
                                            <td>@(entry.Cost?.ToString("C") ?? "—")</td>
                                            <td class="text-muted small" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">@(entry.Description ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No timeline entries yet. Complete a job with linked assets to see entries here automatically.</p>
                    }
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(detail.Notes))
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-sticky me-1"></i>Notes</h6>
                        <p class="mb-0" style="white-space:pre-wrap;">@detail.Notes</p>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Connected Equipment (Asset Links) -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-diagram-3 me-1"></i>Connected Equipment (@detail.LinkedAssets.Count)</h6>
                    @if (detail.LinkedAssets.Any())
                    {
                        @foreach (var la in detail.LinkedAssets)
                        {
                            <div class="d-flex align-items-start justify-content-between border-bottom py-2">
                                <div>
                                    <a href="assets/@la.Id" class="fw-semibold text-decoration-none">@la.Name</a>
                                    @if (la.AssetType is not null) { <br /><small class="text-muted">@la.AssetType</small> }
                                    @if (la.Brand is not null || la.Model is not null) { <br /><small class="text-muted">@la.Brand @la.Model</small> }
                                    @if (la.LocationOnSite is not null) { <br /><small class="text-muted"><i class="bi bi-geo-alt me-1"></i>@la.LocationOnSite</small> }
                                    @if (la.LinkType is not null) { <span class="badge bg-info text-dark ms-1" style="font-size:0.7em;">@la.LinkType</span> }
                                </div>
                                <button class="btn btn-outline-danger btn-sm ms-2" title="Unlink" @onclick="() => UnlinkAsset(la.Id)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted small mb-2">No connected equipment.</p>
                    }
                    @if (!_showLinkForm)
                    {
                        <button class="btn btn-outline-primary btn-sm mt-2 w-100" @onclick="() => ShowLinkForm()">
                            <i class="bi bi-plus-lg me-1"></i>Link Equipment
                        </button>
                    }
                    else
                    {
                        <div class="mt-2 border rounded p-2 bg-light">
                            <label class="form-label small fw-semibold mb-1">Link to Asset</label>
                            <select class="form-select form-select-sm mb-1" @bind="_linkTargetAssetId">
                                <option value="0">— Select Asset —</option>
                                @foreach (var opt in _linkableAssets.Where(a => a.Id != detail.Id && !detail.LinkedAssets.Any(la => la.Id == a.Id)))
                                {
                                    <option value="@opt.Id">@opt.Display</option>
                                }
                            </select>
                            <label class="form-label small mb-1">System Type</label>
                            <select class="form-select form-select-sm mb-2" @bind="_linkType">
                                <option value="">— Optional —</option>
                                <option value="Split System">Split System</option>
                                <option value="Packaged Unit">Packaged Unit</option>
                                <option value="Mini-Split System">Mini-Split System</option>
                                <option value="Heat Pump System">Heat Pump System</option>
                                <option value="Zoned System">Zoned System</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="d-flex gap-1">
                                <button class="btn btn-primary btn-sm flex-grow-1" @onclick="LinkSelectedAsset" disabled="@(_linkTargetAssetId == 0)">
                                    <i class="bi bi-link-45deg me-1"></i>Link
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" @onclick="() => _showLinkForm = false">Cancel</button>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-link-45deg me-1"></i>Connections</h6>
                    @if (detail.CustomerName is not null)
                    {
                        <p class="mb-1"><i class="bi bi-person me-1"></i><a href="customers/@detail.CustomerId">@detail.CustomerName</a></p>
                    }
                    @if (detail.SiteName is not null)
                    {
                        <p class="mb-1"><i class="bi bi-geo-alt me-1"></i><a href="sites/@detail.SiteId">@detail.SiteName</a></p>
                        @if (detail.SiteAddress is not null)
                        {
                            <p class="mb-1 ms-4 text-muted small">@detail.SiteAddress</p>
                        }
                    }
                    @if (detail.ProductName is not null)
                    {
                        <p class="mb-1"><i class="bi bi-box-seam me-1"></i><a href="products/@detail.ProductId">@detail.ProductName</a></p>
                    }
                    <hr class="my-2" />
                    <div class="d-flex gap-3 text-muted small">
                        <span><i class="bi bi-clock me-1"></i>Created @detail.CreatedAt.ToString("MMM dd, yyyy")</span>
                        <span><i class="bi bi-pencil-square me-1"></i>Updated @detail.UpdatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>Assets</h4>
        <div class="d-flex gap-2 align-items-center">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="showArchivedAssets" checked="@filter.ShowArchived" @onchange="ToggleShowArchived" />
                <label class="form-check-label small" for="showArchivedAssets"><i class="bi bi-archive me-1"></i>Show Archived</label>
            </div>
            @if (!filter.ShowArchived) { <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New Asset</button> }
        </div>
    </div>
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm" placeholder="Search assets..." @bind="filter.Search" @bind:event="oninput" @bind:after="LoadAssets" />
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterStatus" @bind:after="OnStatusFilterChanged">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<AssetStatus>()) { <option value="@s">@s</option> }
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Type..." @bind="filter.AssetType" @bind:event="oninput" @bind:after="LoadAssets" />
                </div>
                <div class="col-md-2 text-end text-muted small">@(assets?.Count ?? 0) asset@(assets?.Count != 1 ? "s" : "")</div>
            </div>
        </div>
    </div>

    @if (_selectedIds.Count > 0)
    {
        <div class="alert alert-info d-flex justify-content-between align-items-center py-2 mb-3">
            <span><strong>@_selectedIds.Count</strong> asset(s) selected</span>
            <div class="d-flex gap-2">
                @if (filter.ShowArchived)
                {
                    <button class="btn btn-success btn-sm" @onclick="BulkRestore"><i class="bi bi-arrow-counterclockwise me-1"></i>Restore</button>
                    @if (!_confirmBulkDelete) { <button class="btn btn-danger btn-sm" @onclick="() => _confirmBulkDelete = true"><i class="bi bi-trash3 me-1"></i>Delete Permanently</button> }
                    else { <button class="btn btn-danger btn-sm fw-semibold" @onclick="BulkDeletePermanently"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete Forever</button> <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmBulkDelete = false">Cancel</button> }
                }
                else
                {
                    <button class="btn btn-warning btn-sm" @onclick="BulkArchive"><i class="bi bi-archive me-1"></i>Archive</button>
                    @if (!_confirmBulkDelete) { <button class="btn btn-danger btn-sm" @onclick="() => _confirmBulkDelete = true"><i class="bi bi-trash3 me-1"></i>Delete Permanently</button> }
                    else { <button class="btn btn-danger btn-sm fw-semibold" @onclick="BulkDeletePermanently"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Delete Forever</button> <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmBulkDelete = false">Cancel</button> }
                }
                <button class="btn btn-outline-secondary btn-sm" @onclick="ClearSelection"><i class="bi bi-x-lg me-1"></i>Clear</button>
            </div>
        </div>
    }

    <div class="card border-0 shadow-sm">
        @if (assets is null)
        {
            <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div> Loading...</div>
        }
        else if (!assets.Any())
        {
            <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-cpu" style="font-size: 3rem;"></i>
                @if (filter.ShowArchived)
                {
                    <p class="mt-2">No archived assets to show.</p>
                }
                else
                {
                    <p class="mt-2">No assets found. <a href="javascript:void(0)" @onclick="GoToNew">Create one</a>.</p>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:40px;"><input type="checkbox" class="form-check-input" checked="@_allSelected" @onchange="ToggleSelectAll" title="Select all" /></th>
                            <th role="button" @onclick='() => ToggleSort("Name")'>Name @SortIcon("Name")</th>
                            <th role="button" @onclick='() => ToggleSort("Type")'>Type @SortIcon("Type")</th>
                            <th role="button" @onclick='() => ToggleSort("Model")'>Model @SortIcon("Model")</th>
                            <th role="button" @onclick='() => ToggleSort("Status")'>Status @SortIcon("Status")</th>
                            <th role="button" @onclick='() => ToggleSort("Customer")'>Customer @SortIcon("Customer")</th>
                            <th role="button" @onclick='() => ToggleSort("Site")'>Site @SortIcon("Site")</th>
                            <th role="button" @onclick='() => ToggleSort("Warranty")'>Warranty @SortIcon("Warranty")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in assets)
                        {
                            <tr class="@(_selectedIds.Contains(a.Id) ? "table-active" : "")">
                                <td @onclick:stopPropagation="true"><input type="checkbox" class="form-check-input" checked="@_selectedIds.Contains(a.Id)" @onchange="() => ToggleRowSelection(a.Id)" /></td>
                                <td style="cursor:pointer" @onclick="() => GoToDetail(a.Id)"><strong>@a.Name</strong></td>
                                <td>@(a.AssetType ?? "—")</td>
                                <td>@(a.Model ?? "—")</td>
                                <td><span class="badge @GetAssetBadge(a.Status)">@a.Status</span></td>
                                <td>@(a.CustomerName ?? "—")</td>
                                <td>@(a.SiteName ?? "—")</td>
                                <td>
                                    @if (a.NoWarranty) { <span class="text-dark"><i class="bi bi-shield-x"></i> None</span> }
                                    else if (a.WarrantyActive) { <span class="text-success"><i class="bi bi-shield-check"></i></span> }
                                    else { <span class="text-muted">—</span> }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
    @if (!string.IsNullOrEmpty(_bulkMsg))
    {
        <div class="alert @(_bulkMsgIsError ? "alert-danger" : "alert-success") mt-2 mb-0 py-2"><i class="bi @(_bulkMsgIsError ? "bi-x-circle" : "bi-check-circle") me-1"></i>@_bulkMsg</div>
    }
}

@code {
[Parameter] public int? Id { get; set; }

private string mode = "list";
private List<AssetListItem>? assets;
private AssetFilter filter = new();
private string filterStatus = "";
private AssetDetail? detail;
private AssetEditModel form = new();
private int? editId;
private string? errorMsg;
private bool _confirmArchive;

// Save/Close state
private bool _closeAfterSave = true;
private string? _savedMsg;

// Multi-select & bulk action state
private HashSet<int> _selectedIds = [];
private bool _confirmBulkDelete;
private string? _bulkMsg;
private bool _bulkMsgIsError;
private bool _allSelected => assets is not null && assets.Count > 0 && assets.All(a => _selectedIds.Contains(a.Id));

private List<CustomerListItem> _customers = [];
private List<SiteListItem> _sites = [];
private List<EmployeeListItem> _employees = [];

// Asset linking state
private bool _showLinkForm;
private List<AssetOption> _linkableAssets = [];
private int _linkTargetAssetId;
private string _linkType = "";

    private List<SiteListItem> FilteredAssetSites => form.CustomerId.HasValue
        ? _sites.Where(s => s.CustomerId == form.CustomerId.Value).ToList()
        : _sites;
private List<ProductListItem> _products = [];
private List<JobOption> _jobOptions = [];
private HashSet<int> _selectedJobIds = [];

    private List<JobOption> FilteredJobOptions => form.SiteId.HasValue || form.CustomerId.HasValue
        ? _jobOptions
        : [];

// Dropdown options loaded from DropdownService
private List<string> _brandOptions = [];
private List<string> _assetTypeOptions = [];
private List<string> _fuelTypeOptions = [];
private List<string> _unitConfigOptions = [];
private List<string> _voltageOptions = [];
private List<string> _phaseOptions = [];
private List<string> _refrigerantOptions = [];
private List<string> _filterSizeOptions = [];
private List<string> _filterTypeOptions = [];
private List<string> _thermostatTypeOptions = [];
private List<string> _locationOptions = [];

// Bound select values for dropdown ? form sync
private string _brandValue = "";
private string _assetTypeValue = "";
private string _fuelTypeValue = "";
private string _unitConfigValue = "";
private string _voltageValue = "";
private string _phaseValue = "";
private string _refrigerantValue = "";
private string _filterSizeValue = "";
private string _filterTypeValue = "";
private string _thermostatTypeValue = "";
private string _locationValue = "";
private string _tonnageValue = "";

// Computed warranty expiries for live display in form
private DateTime? _laborExpiry;
private DateTime? _partsExpiry;
private DateTime? _compressorExpiry;

protected override void OnInitialized()
{
    Nav.LocationChanged += OnLocationChanged;
}

protected override async Task OnParametersSetAsync()
{
    await DetermineView();
}

private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
{
    await DetermineView();
    await InvokeAsync(StateHasChanged);
}

private async Task DetermineView()
{
    var uri = Nav.ToAbsoluteUri(Nav.Uri);
    if (uri.AbsolutePath.Contains("/assets/new", StringComparison.OrdinalIgnoreCase))
    {
        mode = "form"; editId = null;
        form = new AssetEditModel
        {
            InstallDate = DateTime.UtcNow.Date,
            WarrantyStartDate = DateTime.UtcNow.Date,
            NextServiceDue = DateTime.UtcNow.Date.AddYears(1)
        };
        _selectedJobIds = [];
        await LoadFormDependencies();

        // Prepopulate from query string (e.g., navigating from Site page)
        var qs = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (int.TryParse(qs["siteId"], out var qsSiteId))
        {
            form.SiteId = qsSiteId;
            var site = _sites.FirstOrDefault(s => s.Id == qsSiteId);
            if (site?.CustomerId.HasValue == true)
                form.CustomerId = site.CustomerId;
        }
        if (int.TryParse(qs["customerId"], out var qsCustId))
            form.CustomerId = qsCustId;
    }
    else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
    {
        await LoadFormDependencies();
        await LoadForEdit(Id.Value);
    }
    else if (Id.HasValue)
        await LoadDetail(Id.Value);
    else { mode = "list"; await LoadAssets(); }
}

private async Task LoadFormDependencies()
{
    _customers = await CustomerSvc.GetCustomersAsync();
    _sites = await SiteSvc.GetSitesAsync();
    _products = await ProductSvc.GetProductsAsync();
    _employees = await EmployeeSvc.GetEmployeesAsync();
    _jobOptions = await JobSvc.GetJobOptionsAsync(form.CustomerId, form.SiteId);
    await LoadDropdownOptions();
}

private async Task LoadDropdownOptions()
{
    _brandOptions = (await DropdownSvc.GetOptionsAsync("Brand")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _assetTypeOptions = (await DropdownSvc.GetOptionsAsync("EquipmentCategory")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _fuelTypeOptions = (await DropdownSvc.GetOptionsAsync("FuelType")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _unitConfigOptions = (await DropdownSvc.GetOptionsAsync("UnitConfiguration")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _voltageOptions = (await DropdownSvc.GetOptionsAsync("Voltage")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _phaseOptions = (await DropdownSvc.GetOptionsAsync("Phase")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _refrigerantOptions = (await DropdownSvc.GetOptionsAsync("RefrigerantType")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _filterSizeOptions = (await DropdownSvc.GetOptionsAsync("FilterSize")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _filterTypeOptions = (await DropdownSvc.GetOptionsAsync("FilterType")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _thermostatTypeOptions = (await DropdownSvc.GetOptionsAsync("ThermostatType")).Where(o => o.IsActive).Select(o => o.Value).ToList();
    _locationOptions = (await DropdownSvc.GetOptionsAsync("AssetLocation")).Where(o => o.IsActive).Select(o => o.Value).ToList();
}

private void SyncDropdownSelects()
{
    _brandValue = form.Brand ?? "";
    _assetTypeValue = form.AssetType ?? "";
    _fuelTypeValue = form.FuelType ?? "";
    _unitConfigValue = form.UnitConfiguration ?? "";
    _voltageValue = form.Voltage ?? "";
    _phaseValue = form.Phase ?? "";
    _refrigerantValue = form.RefrigerantType ?? "";
    _filterSizeValue = form.FilterSize ?? "";
    _filterTypeValue = form.FilterType ?? "";
    _thermostatTypeValue = form.ThermostatType ?? "";
    _locationValue = form.LocationOnSite ?? "";
    // Sync tonnage dropdown
    if (form.Tonnage.HasValue)
    {
        var knownBtus = new[] { 6000m, 9000m, 12000m, 18000m, 24000m, 30000m, 36000m, 42000m, 48000m, 60000m };
        _tonnageValue = knownBtus.Contains(form.Tonnage.Value) ? form.Tonnage.Value.ToString("0") : "Other";
    }
    else
    {
        _tonnageValue = "";
    }
    RecalculateWarrantyExpiries();
}

// Dropdown change handlers
private void OnTonnageChanged()
{
    if (string.IsNullOrEmpty(_tonnageValue))
        form.Tonnage = null;
    else if (_tonnageValue != "Other" && decimal.TryParse(_tonnageValue, out var btu))
        form.Tonnage = btu;
    // When "Other" is selected, form.Tonnage is bound directly via the input
}
private void OnBrandChanged() => form.Brand = string.IsNullOrEmpty(_brandValue) ? null : _brandValue;
private void OnAssetTypeChanged() => form.AssetType = string.IsNullOrEmpty(_assetTypeValue) ? null : _assetTypeValue;
private void OnFuelTypeChanged()
{
    form.FuelType = string.IsNullOrEmpty(_fuelTypeValue) ? null : _fuelTypeValue;

    // Default voltage and phase based on fuel type
    if (!string.IsNullOrEmpty(_fuelTypeValue))
    {
        if (_fuelTypeValue.Equals("Electric", StringComparison.OrdinalIgnoreCase))
        {
            form.Voltage = "240V";
            _voltageValue = "240V";
            form.Phase = "Single Phase";
            _phaseValue = "Single Phase";
        }
        else if (_fuelTypeValue.Equals("Natural Gas", StringComparison.OrdinalIgnoreCase)
              || _fuelTypeValue.Equals("Propane", StringComparison.OrdinalIgnoreCase))
        {
            form.Voltage = "120V";
            _voltageValue = "120V";
            form.Phase = "Single Phase";
            _phaseValue = "Single Phase";
        }
    }
}
private void OnUnitConfigChanged() => form.UnitConfiguration = string.IsNullOrEmpty(_unitConfigValue) ? null : _unitConfigValue;
private void OnVoltageChanged() => form.Voltage = string.IsNullOrEmpty(_voltageValue) ? null : _voltageValue;
private void OnPhaseChanged() => form.Phase = string.IsNullOrEmpty(_phaseValue) ? null : _phaseValue;
private void OnRefrigerantChanged() => form.RefrigerantType = string.IsNullOrEmpty(_refrigerantValue) ? null : _refrigerantValue;
private void OnFilterSizeChanged() => form.FilterSize = string.IsNullOrEmpty(_filterSizeValue) ? null : _filterSizeValue;
private void OnFilterTypeChanged() => form.FilterType = string.IsNullOrEmpty(_filterTypeValue) ? null : _filterTypeValue;
private void OnThermostatTypeChanged() => form.ThermostatType = string.IsNullOrEmpty(_thermostatTypeValue) ? null : _thermostatTypeValue;
private void OnLocationChanged() => form.LocationOnSite = string.IsNullOrEmpty(_locationValue) ? null : _locationValue;

private async Task OnAssetCustomerChanged()
{
    // Reset site if it no longer belongs to the selected customer
    if (form.SiteId.HasValue && form.CustomerId.HasValue)
    {
        var site = _sites.FirstOrDefault(s => s.Id == form.SiteId.Value);
        if (site is not null && site.CustomerId.HasValue && site.CustomerId != form.CustomerId)
            form.SiteId = null;
    }
    // Reload job options for the new customer/site
    _jobOptions = await JobSvc.GetJobOptionsAsync(form.CustomerId, form.SiteId);
    // Remove any selected jobs that are no longer in the filtered list
    var validIds = _jobOptions.Select(j => j.Id).ToHashSet();
    _selectedJobIds.IntersectWith(validIds);
}

private async Task OnAssetSiteChanged()
{
    // Reload job options for the new site (or fall back to customer)
    _jobOptions = await JobSvc.GetJobOptionsAsync(form.CustomerId, form.SiteId);
    var validIds = _jobOptions.Select(j => j.Id).ToHashSet();
    _selectedJobIds.IntersectWith(validIds);
}

private async Task OnProductSelected(ChangeEventArgs e)
{
    if (!int.TryParse(e.Value?.ToString(), out var productId)) { form.ProductId = null; return; }
    form.ProductId = productId;
    var product = await ProductSvc.GetProductAsync(productId);
    if (product is null) return;

    // Auto-fill fields from product
    form.Name = string.IsNullOrWhiteSpace(form.Name) ? product.Name : form.Name;
    form.Brand = product.Brand;
    form.Model = product.ModelNumber;
    form.AssetType = product.EquipmentType;
    form.FuelType = product.FuelType;
    form.RefrigerantType = product.RefrigerantType;
    form.Voltage = product.Voltage;

    // Parse tonnage: Product stores "2.5 Ton" or "3 Ton" ? Asset stores BTU as decimal
    if (!string.IsNullOrWhiteSpace(product.Tonnage))
    {
        var tonStr = product.Tonnage.Replace("Ton", "", StringComparison.OrdinalIgnoreCase).Trim();
        if (decimal.TryParse(tonStr, out var tons))
            form.Tonnage = tons * 12000m; // Convert tons to BTU
    }

    // Parse SEER rating: Product stores as string ? Asset as decimal
    if (!string.IsNullOrWhiteSpace(product.SEERRating) && decimal.TryParse(product.SEERRating, out var seer))
        form.SEER = seer;

    // Parse AFUE rating: Product stores as string ? Asset as decimal
    if (!string.IsNullOrWhiteSpace(product.AFUERating) && decimal.TryParse(product.AFUERating, out var afue))
        form.AFUE = afue;

    // Warranty
    form.LaborWarrantyTermYears = product.LaborWarrantyYears;
    form.PartsWarrantyTermYears = product.PartsWarrantyYears;
    form.CompressorWarrantyTermYears = product.CompressorWarrantyYears;

    // Inject product values into dropdown options if not already present
    EnsureDropdownOption(_brandOptions, form.Brand);
    EnsureDropdownOption(_assetTypeOptions, form.AssetType);
    EnsureDropdownOption(_fuelTypeOptions, form.FuelType);
    EnsureDropdownOption(_refrigerantOptions, form.RefrigerantType);
    EnsureDropdownOption(_voltageOptions, form.Voltage);

    // Sync all dropdown selects to match the filled values
    SyncDropdownSelects();
}

private static void EnsureDropdownOption(List<string> options, string? value)
{
    if (!string.IsNullOrWhiteSpace(value) && !options.Contains(value, StringComparer.OrdinalIgnoreCase))
        options.Add(value);
}

private void OnInstallDateChanged()
{
    // Warranty start defaults to install date
    if (form.InstallDate.HasValue)
    {
        form.WarrantyStartDate = form.InstallDate.Value;
        RecalculateWarrantyExpiries();
    }
    // Auto-set NextServiceDue to 1 year from install date
    if (form.InstallDate.HasValue)
        form.NextServiceDue = form.InstallDate.Value.AddYears(1);
}

private void OnNoWarrantyToggled(ChangeEventArgs e)
{
    form.NoWarranty = e.Value is true;
    if (form.NoWarranty)
    {
        // Clear all warranty fields when disabling warranty
        form.WarrantyStartDate = null;
        form.WarrantyExpiry = null;
        form.WarrantyTermYears = null;
        form.LaborWarrantyTermYears = null;
        form.PartsWarrantyTermYears = null;
        form.CompressorWarrantyTermYears = null;
        form.RegisteredOnline = false;
        form.WarrantedByCompany = false;
        _laborExpiry = null;
        _partsExpiry = null;
        _compressorExpiry = null;
    }
}

private void RecalculateWarrantyExpiries()
{
    var start = form.WarrantyStartDate ?? form.InstallDate;
    _laborExpiry = start.HasValue && form.LaborWarrantyTermYears.HasValue && form.LaborWarrantyTermYears > 0
        ? start.Value.AddYears(form.LaborWarrantyTermYears.Value) : null;
    _partsExpiry = start.HasValue && form.PartsWarrantyTermYears.HasValue && form.PartsWarrantyTermYears > 0
        ? start.Value.AddYears(form.PartsWarrantyTermYears.Value) : null;
    _compressorExpiry = start.HasValue && form.CompressorWarrantyTermYears.HasValue && form.CompressorWarrantyTermYears > 0
        ? start.Value.AddYears(form.CompressorWarrantyTermYears.Value) : null;

    // Set overall expiry to latest
    var all = new[] { _laborExpiry, _partsExpiry, _compressorExpiry }.Where(d => d.HasValue).Select(d => d!.Value).ToArray();
    form.WarrantyExpiry = all.Length > 0 ? all.Max() : null;
}

private string GetWarrantyTermCss(DateTime expiry)
{
    var days = (expiry - DateTime.UtcNow).TotalDays;
    if (days < 0) return "text-danger";
    if (days < 90) return "text-warning";
    return "text-success";
}

private async Task ShowLinkForm()
{
    if (detail is not null)
        _linkableAssets = await AssetSvc.GetAssetOptionsAsync(detail.CustomerId, detail.SiteId);
    _linkTargetAssetId = 0;
    _linkType = "";
    _showLinkForm = true;
}

private async Task LinkSelectedAsset()
{
    if (detail is null || _linkTargetAssetId == 0) return;
    await AssetSvc.LinkAssetsAsync(detail.Id, _linkTargetAssetId, string.IsNullOrEmpty(_linkType) ? null : _linkType);
    _showLinkForm = false;
    await LoadDetail(detail.Id);
}

private async Task UnlinkAsset(int linkedAssetId)
{
    if (detail is null) return;
    await AssetSvc.UnlinkAssetAsync(detail.Id, linkedAssetId);
    await LoadDetail(detail.Id);
}

public void Dispose()
{
    Nav.LocationChanged -= OnLocationChanged;
}

private async Task LoadAssets()
{
    filter.Status = string.IsNullOrWhiteSpace(filterStatus) ? null : Enum.Parse<AssetStatus>(filterStatus);
    assets = await AssetSvc.GetAssetsAsync(filter);
}

private async Task LoadDetail(int id)
{
    detail = await AssetSvc.GetAssetAsync(id);
    mode = detail is not null ? "detail" : "list";
    if (mode == "list") await LoadAssets();
}

private async Task LoadForEdit(int id)
{
    var d = await AssetSvc.GetAssetAsync(id);
    if (d is null) { mode = "list"; await LoadAssets(); return; }
    editId = id;
    form = new AssetEditModel
    {
        Name = d.Name, Model = d.Model, SerialNumber = d.SerialNumber,
        AssetType = d.AssetType, Brand = d.Brand, FuelType = d.FuelType,
        UnitConfiguration = d.UnitConfiguration, BTURating = d.BTURating,
        FilterSize = d.FilterSize, Tonnage = d.Tonnage, SEER = d.SEER,
        SEER2 = d.SEER2, AFUE = d.AFUE, HSPF = d.HSPF, HSPF2 = d.HSPF2,
        EER = d.EER, AssetTag = d.AssetTag, Nickname = d.Nickname,
        Voltage = d.Voltage, Phase = d.Phase,
        LocationOnSite = d.LocationOnSite,
        AmpRating = d.AmpRating, PanelType = d.PanelType,
        PipeMaterial = d.PipeMaterial, GallonCapacity = d.GallonCapacity,
        RefrigerantType = d.RefrigerantType, RefrigerantQuantity = d.RefrigerantQuantity,
        FilterType = d.FilterType, FilterChangeIntervalMonths = d.FilterChangeIntervalMonths,
        FilterLastChanged = d.FilterLastChanged, FilterNextDue = d.FilterNextDue,
        ThermostatBrand = d.ThermostatBrand, ThermostatModel = d.ThermostatModel,
        ThermostatType = d.ThermostatType, ThermostatWiFiEnabled = d.ThermostatWiFiEnabled,
        InstallDate = d.InstallDate, LastServiceDate = d.LastServiceDate,
        NextServiceDue = d.NextServiceDue, WarrantyStartDate = d.WarrantyStartDate,
        WarrantyTermYears = d.WarrantyTermYears, WarrantyExpiry = d.WarrantyExpiry,
        LaborWarrantyTermYears = d.LaborWarrantyTermYears,
        PartsWarrantyTermYears = d.PartsWarrantyTermYears,
        CompressorWarrantyTermYears = d.CompressorWarrantyTermYears,
        RegisteredOnline = d.RegisteredOnline, InstalledBy = d.InstalledBy,
        WarrantedByCompany = d.WarrantedByCompany, NoWarranty = d.NoWarranty,
        Status = d.Status, Value = d.Value, Notes = d.Notes,
        ProductId = d.ProductId, CustomerId = d.CustomerId, SiteId = d.SiteId
    };
    _selectedJobIds = d.LinkedJobs.Select(j => j.Id).ToHashSet();
    SyncDropdownSelects();
    mode = "form";
}

    private async Task SaveAsset()
    {
        try
        {
            errorMsg = null;
            _savedMsg = null;
            form.JobIds = _selectedJobIds.ToList();
            if (editId.HasValue)
            {
                await AssetSvc.UpdateAssetAsync(editId.Value, form);
                if (_closeAfterSave) Nav.NavigateTo("/assets");
                else _savedMsg = "Saved!";
            }
            else
            {
                var created = await AssetSvc.CreateAssetAsync(form);
                if (_closeAfterSave) Nav.NavigateTo("/assets");
                else Nav.NavigateTo($"/assets/{created.Id}/edit");
            }
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task ArchiveDetail()
    {
        if (detail is not null) { await AssetSvc.ArchiveAssetAsync(detail.Id); Nav.NavigateTo("/assets"); }
    }

    private string GetAssetBadge(AssetStatus s) => s switch
    {
        AssetStatus.Active => "bg-success",
        AssetStatus.MaintenanceNeeded => "bg-warning text-dark",
        AssetStatus.Retired => "bg-secondary",
        AssetStatus.Decommissioned => "bg-danger",
        _ => "bg-secondary"
    };

    private void GoToList() => Nav.NavigateTo("/assets");
    private void GoToNew() => Nav.NavigateTo("/assets/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/assets/{id}");

    private int? GetAdjacentAssetId(int offset)
    {
        if (assets is null || assets.Count == 0 || detail is null) return null;
        var idx = assets.FindIndex(a => a.Id == detail.Id);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < assets.Count ? assets[target].Id : null;
    }
    private void GoToPrevAsset() { var id = GetAdjacentAssetId(-1); if (id.HasValue) GoToDetail(id.Value); }
    private void GoToNextAsset() { var id = GetAdjacentAssetId(1); if (id.HasValue) GoToDetail(id.Value); }

    private int? GetAdjacentAssetEditId(int offset)
    {
        if (assets is null || assets.Count == 0 || !editId.HasValue) return null;
        var idx = assets.FindIndex(a => a.Id == editId.Value);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < assets.Count ? assets[target].Id : null;
    }
    private void GoToPrevAssetEdit() { var id = GetAdjacentAssetEditId(-1); if (id.HasValue) Nav.NavigateTo($"/assets/{id.Value}/edit"); }
    private void GoToNextAssetEdit() { var id = GetAdjacentAssetEditId(1); if (id.HasValue) Nav.NavigateTo($"/assets/{id.Value}/edit"); }
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");
    private void EditDetail() { if (detail is not null) Nav.NavigateTo($"/assets/{detail.Id}/edit"); }

    private async Task OnStatusFilterChanged()
    {
        filter.Status = string.IsNullOrWhiteSpace(filterStatus) ? null : Enum.Parse<AssetStatus>(filterStatus);
        await LoadAssets();
    }

    private async Task ToggleSort(string column)
    {
        if (filter.SortBy == column) filter.SortDescending = !filter.SortDescending;
        else { filter.SortBy = column; filter.SortDescending = false; }
        await LoadAssets();
    }

    private RenderFragment SortIcon(string column) => builder =>
    {
        var icon = filter.SortBy == column
            ? (filter.SortDescending ? "bi-sort-down" : "bi-sort-up")
            : "bi-arrow-down-up";
        var css = filter.SortBy == column ? "text-primary" : "text-muted";
        builder.OpenElement(0, "i");
        builder.AddAttribute(1, "class", $"bi {icon} {css} small");
        builder.CloseElement();
    };

    private string GetWarrantyState(AssetDetail d)
    {
        if (d.NoWarranty) return "none";
        if (!d.WarrantyExpiry.HasValue) return "none";
        var daysLeft = (d.WarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
        if (daysLeft < 0) return "expired";
        if (daysLeft < 90) return "expiring";
        return "active";
    }

    private string GetJobBadge(JobStatus s) => s switch
    {
        JobStatus.Lead => "bg-info text-dark",
        JobStatus.Quoted => "bg-primary",
        JobStatus.Approved => "bg-primary",
        JobStatus.Scheduled => "bg-primary",
        JobStatus.EnRoute => "bg-warning text-dark",
        JobStatus.OnSite => "bg-warning text-dark",
        JobStatus.InProgress => "bg-warning text-dark",
        JobStatus.Paused => "bg-secondary",
        JobStatus.Completed => "bg-success",
        JobStatus.Closed => "bg-success",
        JobStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };

    private void NavigateTimelineEntry(AssetTimelineEntry entry)
    {
        if (entry.Source == "Job" && entry.SourceId.HasValue)
            Nav.NavigateTo($"/jobs/{entry.SourceId.Value}");
        else if (entry.Source == "ServiceHistory")
            Nav.NavigateTo("/servicehistory");
    }

    private void ToggleJob(int jobId)
    {
        if (!_selectedJobIds.Remove(jobId))
            _selectedJobIds.Add(jobId);
    }

    // ---- Multi-select & Bulk Actions ----
    private void ToggleRowSelection(int id) { if (!_selectedIds.Remove(id)) _selectedIds.Add(id); _confirmBulkDelete = false; }
    private void ToggleSelectAll() { if (assets is null) return; if (_allSelected) _selectedIds.Clear(); else foreach (var a in assets) _selectedIds.Add(a.Id); _confirmBulkDelete = false; }
    private void ClearSelection() { _selectedIds.Clear(); _confirmBulkDelete = false; _bulkMsg = null; }
    private async Task ToggleShowArchived(ChangeEventArgs e) { filter.ShowArchived = (bool)(e.Value ?? false); ClearSelection(); await LoadAssets(); }
    private async Task BulkArchive() { if (_selectedIds.Count == 0) return; try { var n = await AssetSvc.BulkArchiveAssetsAsync(_selectedIds.ToList()); _bulkMsg = $"{n} asset(s) archived."; _bulkMsgIsError = false; ClearSelection(); await LoadAssets(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
    private async Task BulkRestore() { if (_selectedIds.Count == 0) return; try { var n = await AssetSvc.BulkRestoreAssetsAsync(_selectedIds.ToList()); _bulkMsg = $"{n} asset(s) restored."; _bulkMsgIsError = false; ClearSelection(); await LoadAssets(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
    private async Task BulkDeletePermanently() { if (_selectedIds.Count == 0) return; try { var n = await AssetSvc.BulkDeleteAssetsPermanentlyAsync(_selectedIds.ToList()); _bulkMsg = $"{n} asset(s) permanently deleted."; _bulkMsgIsError = false; ClearSelection(); await LoadAssets(); } catch (Exception ex) { _bulkMsg = ex.Message; _bulkMsgIsError = true; } }
}
