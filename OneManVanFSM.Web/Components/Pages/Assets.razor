@page "/assets"
@page "/assets/new"
@page "/assets/{Id:int}"
@page "/assets/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject IAssetService AssetSvc
@inject ICustomerService CustomerSvc
@inject ISiteService SiteSvc
@inject NavigationManager Nav

<PageTitle>Assets - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>@(editId.HasValue ? "Edit" : "New") Asset</h4>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveAsset">
                <DataAnnotationsValidator />
                <!-- Core Identity -->
                <h6 class="text-muted mb-2"><i class="bi bi-tag me-1"></i>Identity</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <InputText @bind-Value="form.Name" class="form-control" />
                        <ValidationMessage For="() => form.Name" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Asset Type</label>
                        <InputText @bind-Value="form.AssetType" class="form-control" placeholder="e.g. Furnace, AC Unit" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Brand</label>
                        <InputText @bind-Value="form.Brand" class="form-control" placeholder="e.g. Carrier, Lennox" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in Enum.GetValues<AssetStatus>()) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Model</label>
                        <InputText @bind-Value="form.Model" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Serial Number</label>
                        <InputText @bind-Value="form.SerialNumber" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unit Configuration</label>
                        <InputText @bind-Value="form.UnitConfiguration" class="form-control" placeholder="Split, Packaged, etc." />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Location on Site</label>
                        <InputText @bind-Value="form.LocationOnSite" class="form-control" placeholder="Basement, Attic, Roof" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Value</label>
                        <InputNumber @bind-Value="form.Value" class="form-control" />
                    </div>
                </div>

                <hr class="my-2" />
                <h6 class="text-muted mb-2"><i class="bi bi-thermometer-half me-1"></i>HVAC Specs</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Tonnage</label>
                        <InputNumber @bind-Value="form.Tonnage" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">BTU Rating</label>
                        <InputNumber @bind-Value="form.BTURating" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">SEER</label>
                        <InputNumber @bind-Value="form.SEER" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">AFUE (%)</label>
                        <InputNumber @bind-Value="form.AFUE" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">HSPF</label>
                        <InputNumber @bind-Value="form.HSPF" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fuel Type</label>
                        <InputText @bind-Value="form.FuelType" class="form-control" placeholder="Natural Gas, Electric" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filter Size</label>
                        <InputText @bind-Value="form.FilterSize" class="form-control" placeholder="16x25x1" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Refrigerant</label>
                        <InputText @bind-Value="form.RefrigerantType" class="form-control" placeholder="R-410A" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ref. Quantity (lbs)</label>
                        <InputNumber @bind-Value="form.RefrigerantQuantity" class="form-control" />
                    </div>
                </div>

                <hr class="my-2" />
                <h6 class="text-muted mb-2"><i class="bi bi-lightning-charge me-1"></i>Electrical / <i class="bi bi-droplet me-1"></i>Plumbing</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Voltage</label>
                        <InputText @bind-Value="form.Voltage" class="form-control" placeholder="120V, 240V" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Phase</label>
                        <InputText @bind-Value="form.Phase" class="form-control" placeholder="Single Phase" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Amp Rating</label>
                        <InputNumber @bind-Value="form.AmpRating" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Panel Type</label>
                        <InputText @bind-Value="form.PanelType" class="form-control" placeholder="Main Breaker" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Pipe Material</label>
                        <InputText @bind-Value="form.PipeMaterial" class="form-control" placeholder="Copper, PEX" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Gallon Capacity</label>
                        <InputNumber @bind-Value="form.GallonCapacity" class="form-control" />
                    </div>
                </div>

                <hr class="my-2" />
                <h6 class="text-muted mb-2"><i class="bi bi-calendar3 me-1"></i>Dates & Warranty</h6>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Install Date</label>
                        <InputDate @bind-Value="form.InstallDate" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Manufacture Date</label>
                        <InputDate @bind-Value="form.ManufactureDate" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Last Service Date</label>
                        <InputDate @bind-Value="form.LastServiceDate" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Next Service Due</label>
                        <InputDate @bind-Value="form.NextServiceDue" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Warranty Start</label>
                        <InputDate @bind-Value="form.WarrantyStartDate" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Warranty Term (years)</label>
                        <InputNumber @bind-Value="form.WarrantyTermYears" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Warranty Expiry</label>
                        <InputDate @bind-Value="form.WarrantyExpiry" class="form-control" />
                    </div>
                </div>

                <hr class="my-2" />
                <h6 class="text-muted mb-2"><i class="bi bi-link-45deg me-1"></i>Connections</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Customer</label>
                        <InputSelect @bind-Value="form.CustomerId" class="form-select">
                            <option value="">— Select Customer —</option>
                            @foreach (var c in _customers)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Site</label>
                        <InputSelect @bind-Value="form.SiteId" class="form-select">
                            <option value="">— Select Site —</option>
                            @foreach (var s in _sites)
                            {
                                <option value="@s.Id">@s.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save</button>
                    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="GoToList">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && detail is not null)
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>@detail.Name</h4>
        <span class="badge ms-2 @GetAssetBadge(detail.Status)">@detail.Status</span>
        @{ var warrantyState = GetWarrantyState(detail); }
        @if (warrantyState == "active")
        {
            <span class="badge bg-success ms-1"><i class="bi bi-shield-check me-1"></i>Warranty Active</span>
        }
        else if (warrantyState == "expiring")
        {
            <span class="badge bg-warning text-dark ms-1"><i class="bi bi-shield-exclamation me-1"></i>Warranty Expiring</span>
        }
        else if (warrantyState == "expired")
        {
            <span class="badge bg-danger ms-1"><i class="bi bi-shield-x me-1"></i>Warranty Expired</span>
        }
        <div class="ms-auto dropdown">
            <button class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-plus-lg me-1"></i>Actions</button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><button class="dropdown-item" @onclick="EditDetail"><i class="bi bi-pencil me-2"></i>Edit Asset</button></li>
                <li><a class="dropdown-item" href="jobs/new?assetId=@detail.Id"><i class="bi bi-wrench me-2"></i>New Job</a></li>
                <li><hr class="dropdown-divider" /></li>
                @if (!_confirmArchive)
                {
                    <li><button class="dropdown-item text-danger" @onclick="() => _confirmArchive = true"><i class="bi bi-archive me-2"></i>Archive</button></li>
                }
                else
                {
                    <li><button class="dropdown-item text-danger fw-semibold" @onclick="ArchiveDetail"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Archive?</button></li>
                    <li><button class="dropdown-item" @onclick="() => _confirmArchive = false"><i class="bi bi-x-lg me-2"></i>Cancel</button></li>
                }
            </ul>
        </div>
    </div>
    <div class="row g-3">
        <!-- Main Content Column -->
        <div class="col-md-8">
            <!-- Equipment Details -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-gear me-1"></i>Equipment Details</h6>
                    <div class="row g-2">
                        <div class="col-sm-4"><strong>Type:</strong> @(detail.AssetType ?? "—")</div>
                        <div class="col-sm-4"><strong>Brand:</strong> @(detail.Brand ?? "—")</div>
                        <div class="col-sm-4"><strong>Model:</strong> @(detail.Model ?? "—")</div>
                        <div class="col-sm-4"><strong>Serial:</strong> @(detail.SerialNumber ?? "—")</div>
                        @if (detail.UnitConfiguration is not null) { <div class="col-sm-4"><strong>Config:</strong> @detail.UnitConfiguration</div> }
                        @if (detail.LocationOnSite is not null) { <div class="col-sm-4"><strong>Location:</strong> @detail.LocationOnSite</div> }
                        <div class="col-sm-4"><strong>Value:</strong> @(detail.Value?.ToString("C") ?? "—")</div>
                    </div>
                </div>
            </div>

            <!-- HVAC Specs -->
            @if (detail.Tonnage.HasValue || detail.SEER.HasValue || detail.AFUE.HasValue || detail.HSPF.HasValue
                || detail.BTURating.HasValue || detail.FilterSize is not null || detail.FuelType is not null
                || detail.RefrigerantType is not null)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-thermometer-half me-1"></i>HVAC Specifications</h6>
                        <div class="row g-2">
                            @if (detail.Tonnage.HasValue) { <div class="col-sm-3"><strong>Tonnage:</strong> @detail.Tonnage</div> }
                            @if (detail.BTURating.HasValue) { <div class="col-sm-3"><strong>BTU:</strong> @detail.BTURating.Value.ToString("N0")</div> }
                            @if (detail.SEER.HasValue) { <div class="col-sm-3"><strong>SEER:</strong> @detail.SEER</div> }
                            @if (detail.AFUE.HasValue) { <div class="col-sm-3"><strong>AFUE:</strong> @detail.AFUE%</div> }
                            @if (detail.HSPF.HasValue) { <div class="col-sm-3"><strong>HSPF:</strong> @detail.HSPF</div> }
                            @if (detail.FuelType is not null) { <div class="col-sm-3"><strong>Fuel:</strong> @detail.FuelType</div> }
                            @if (detail.FilterSize is not null) { <div class="col-sm-3"><strong>Filter:</strong> @detail.FilterSize</div> }
                        </div>
                        @if (detail.RefrigerantType is not null)
                        {
                            <hr />
                            <div class="row g-2">
                                <div class="col-sm-6"><strong>Refrigerant:</strong> @detail.RefrigerantType</div>
                                <div class="col-sm-6"><strong>Quantity:</strong> @(detail.RefrigerantQuantity?.ToString() ?? "—") lbs</div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Electrical Specs -->
            @if (detail.Voltage is not null || detail.Phase is not null || detail.AmpRating.HasValue || detail.PanelType is not null)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-lightning-charge me-1"></i>Electrical</h6>
                        <div class="row g-2">
                            @if (detail.Voltage is not null) { <div class="col-sm-3"><strong>Voltage:</strong> @detail.Voltage</div> }
                            @if (detail.Phase is not null) { <div class="col-sm-3"><strong>Phase:</strong> @detail.Phase</div> }
                            @if (detail.AmpRating.HasValue) { <div class="col-sm-3"><strong>Amps:</strong> @detail.AmpRating A</div> }
                            @if (detail.PanelType is not null) { <div class="col-sm-3"><strong>Panel:</strong> @detail.PanelType</div> }
                        </div>
                    </div>
                </div>
            }

            <!-- Plumbing Specs -->
            @if (detail.PipeMaterial is not null || detail.GallonCapacity.HasValue)
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-droplet me-1"></i>Plumbing</h6>
                        <div class="row g-2">
                            @if (detail.PipeMaterial is not null) { <div class="col-sm-6"><strong>Pipe Material:</strong> @detail.PipeMaterial</div> }
                            @if (detail.GallonCapacity.HasValue) { <div class="col-sm-6"><strong>Capacity:</strong> @detail.GallonCapacity gal</div> }
                        </div>
                    </div>
                </div>
            }

            <!-- Key Dates & Warranty -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-calendar3 me-1"></i>Key Dates & Warranty</h6>
                    <div class="row g-2">
                        <div class="col-sm-4"><strong>Installed:</strong> @(detail.InstallDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4"><strong>Manufactured:</strong> @(detail.ManufactureDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4"><strong>Last Service:</strong> @(detail.LastServiceDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4">
                            <strong>Next Service:</strong>
                            @if (detail.NextServiceDue.HasValue)
                            {
                                var overdue = detail.NextServiceDue.Value < DateTime.UtcNow;
                                <span class="@(overdue ? "text-danger fw-bold" : "")">
                                    @detail.NextServiceDue.Value.ToString("MMM dd, yyyy") @(overdue ? " (Overdue)" : "")
                                </span>
                            }
                            else { <span>—</span> }
                        </div>
                        <div class="col-sm-4"><strong>Warranty Start:</strong> @(detail.WarrantyStartDate?.ToString("MMM dd, yyyy") ?? "—")</div>
                        <div class="col-sm-4">
                            <strong>Warranty Expiry:</strong>
                            @if (detail.WarrantyExpiry.HasValue)
                            {
                                var ws = GetWarrantyState(detail);
                                <span class="@(ws == "expired" ? "text-danger" : ws == "expiring" ? "text-warning" : "text-success")">
                                    @detail.WarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                    @if (detail.WarrantyTermYears.HasValue) { <small>(@(detail.WarrantyTermYears)yr term)</small> }
                                </span>
                            }
                            else { <span>—</span> }
                        </div>
                    </div>
                    @if (detail.LaborWarrantyExpiry.HasValue || detail.PartsWarrantyExpiry.HasValue || detail.CompressorWarrantyExpiry.HasValue)
                    {
                        <hr />
                        <h6 class="text-muted mb-2"><i class="bi bi-shield-check me-1"></i>Warranty Breakdown</h6>
                        <div class="row g-2">
                            @if (detail.LaborWarrantyExpiry.HasValue)
                            {
                                var laborDays = (int)(detail.LaborWarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
                                <div class="col-sm-4">
                                    <strong>Labor:</strong>
                                    <span class="@(laborDays < 0 ? "text-danger" : laborDays < 90 ? "text-warning" : "text-success")">
                                        @detail.LaborWarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                        @if (laborDays < 0) { <small>(Expired)</small> }
                                        else { <small>(@laborDays days)</small> }
                                    </span>
                                </div>
                            }
                            @if (detail.PartsWarrantyExpiry.HasValue)
                            {
                                var partsDays = (int)(detail.PartsWarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
                                <div class="col-sm-4">
                                    <strong>Parts:</strong>
                                    <span class="@(partsDays < 0 ? "text-danger" : partsDays < 90 ? "text-warning" : "text-success")">
                                        @detail.PartsWarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                        @if (partsDays < 0) { <small>(Expired)</small> }
                                        else { <small>(@partsDays days)</small> }
                                    </span>
                                </div>
                            }
                            @if (detail.CompressorWarrantyExpiry.HasValue)
                            {
                                var compDays = (int)(detail.CompressorWarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
                                <div class="col-sm-4">
                                    <strong>Compressor:</strong>
                                    <span class="@(compDays < 0 ? "text-danger" : compDays < 90 ? "text-warning" : "text-success")">
                                        @detail.CompressorWarrantyExpiry.Value.ToString("MMM dd, yyyy")
                                        @if (compDays < 0) { <small>(Expired)</small> }
                                        else { <small>(@compDays days)</small> }
                                    </span>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Service History -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-clock-history me-1"></i>Service History (@detail.ServiceHistory.Count)</h6>
                    @if (detail.ServiceHistory.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr><th>Date</th><th>Service</th><th>Performed By</th><th>Cost</th><th>Refrigerant</th><th>Notes</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var sl in detail.ServiceHistory)
                                    {
                                        <tr>
                                            <td>@sl.ServiceDate.ToString("MMM dd, yyyy")</td>
                                            <td><span class="badge bg-info text-dark">@(sl.ServiceType ?? "General")</span></td>
                                            <td>@(sl.PerformedBy ?? "—")</td>
                                            <td>@(sl.Cost?.ToString("C") ?? "—")</td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(sl.RefrigerantType))
                                                {
                                                    <small>@sl.RefrigerantType @(sl.RefrigerantAmountAdded.HasValue ? $"+{sl.RefrigerantAmountAdded:N1} lbs" : "")</small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                            <td class="text-muted small">@(sl.Notes ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No service records yet.</p>
                    }
                </div>
            </div>

            <!-- Linked Jobs -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-wrench-adjustable me-1"></i>Linked Jobs (@detail.LinkedJobs.Count)</h6>
                    @if (detail.LinkedJobs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr><th>Job #</th><th>Title</th><th>Status</th><th>Date</th><th>Role</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var j in detail.LinkedJobs)
                                    {
                                        <tr style="cursor:pointer" @onclick="() => GoToJob(j.Id)">
                                            <td><strong>@j.JobNumber</strong></td>
                                            <td>@(j.Title ?? "—")</td>
                                            <td><span class="badge @GetJobBadge(j.Status)">@j.Status</span></td>
                                            <td>@(j.ScheduledDate?.ToString("MMM dd, yyyy") ?? "—")</td>
                                            <td class="text-muted">@(j.Role ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No linked jobs yet.</p>
                    }
                </div>
            </div>

            <!-- Unified Service Timeline -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-timeline me-1"></i>Unified Service Timeline (@detail.UnifiedTimeline.Count)</h6>
                    @if (detail.UnifiedTimeline.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr><th>Date</th><th>Source</th><th>Title</th><th>Status</th><th>Performed By</th><th>Cost</th><th>Details</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var entry in detail.UnifiedTimeline)
                                    {
                                        <tr @onclick="() => NavigateTimelineEntry(entry)" style="@(entry.Source == "Job" ? "cursor:pointer" : "")">
                                            <td>@entry.Date.ToString("MMM dd, yyyy")</td>
                                            <td><span class="badge @(entry.Badge ?? "bg-secondary")">@entry.Source</span></td>
                                            <td><strong>@entry.Title</strong></td>
                                            <td><small>@(entry.Status ?? "—")</small></td>
                                            <td>@(entry.PerformedBy ?? "—")</td>
                                            <td>@(entry.Cost?.ToString("C") ?? "—")</td>
                                            <td class="text-muted small" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">@(entry.Description ?? "—")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No timeline entries yet. Complete a job with linked assets to see entries here automatically.</p>
                    }
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(detail.Notes))
            {
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-2"><i class="bi bi-sticky me-1"></i>Notes</h6>
                        <p class="mb-0" style="white-space:pre-wrap;">@detail.Notes</p>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <h6 class="text-muted mb-2"><i class="bi bi-link-45deg me-1"></i>Connections</h6>
                    @if (detail.CustomerName is not null)
                    {
                        <p class="mb-1"><i class="bi bi-person me-1"></i><a href="customers/@detail.CustomerId">@detail.CustomerName</a></p>
                    }
                    @if (detail.SiteName is not null)
                    {
                        <p class="mb-1"><i class="bi bi-geo-alt me-1"></i><a href="sites/@detail.SiteId">@detail.SiteName</a></p>
                        @if (detail.SiteAddress is not null)
                        {
                            <p class="mb-1 ms-4 text-muted small">@detail.SiteAddress</p>
                        }
                    }
                    @if (detail.ProductName is not null)
                    {
                        <p class="mb-1"><i class="bi bi-box-seam me-1"></i><a href="products/@detail.ProductId">@detail.ProductName</a></p>
                    }
                    <hr class="my-2" />
                    <div class="d-flex gap-3 text-muted small">
                        <span><i class="bi bi-clock me-1"></i>Created @detail.CreatedAt.ToString("MMM dd, yyyy")</span>
                        <span><i class="bi bi-pencil-square me-1"></i>Updated @detail.UpdatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>Assets</h4>
        <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New Asset</button>
    </div>
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm" placeholder="Search assets..." @bind="filter.Search" @bind:event="oninput" @bind:after="LoadAssets" />
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterStatus" @bind:after="OnStatusFilterChanged">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<AssetStatus>()) { <option value="@s">@s</option> }
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" placeholder="Type..." @bind="filter.AssetType" @bind:event="oninput" @bind:after="LoadAssets" />
                </div>
                <div class="col-md-2 text-end text-muted small">@(assets?.Count ?? 0) asset@(assets?.Count != 1 ? "s" : "")</div>
            </div>
        </div>
    </div>
    <div class="card border-0 shadow-sm">
        @if (assets is null)
        {
            <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div> Loading...</div>
        }
        else if (!assets.Any())
        {
            <div class="card-body text-center py-5 text-muted">
                <i class="bi bi-cpu" style="font-size: 3rem;"></i>
                <p class="mt-2">No assets found. <a href="javascript:void(0)" @onclick="GoToNew">Create one</a>.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th role="button" @onclick='() => ToggleSort("Name")'>Name @SortIcon("Name")</th>
                            <th role="button" @onclick='() => ToggleSort("Type")'>Type @SortIcon("Type")</th>
                            <th>Model</th>
                            <th role="button" @onclick='() => ToggleSort("Status")'>Status @SortIcon("Status")</th>
                            <th>Customer</th>
                            <th>Site</th>
                            <th>Warranty</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var a in assets)
                        {
                            <tr style="cursor:pointer" @onclick="() => GoToDetail(a.Id)">
                                <td><strong>@a.Name</strong></td>
                                <td>@(a.AssetType ?? "—")</td>
                                <td>@(a.Model ?? "—")</td>
                                <td><span class="badge @GetAssetBadge(a.Status)">@a.Status</span></td>
                                <td>@(a.CustomerName ?? "—")</td>
                                <td>@(a.SiteName ?? "—")</td>
                                <td>
                                    @if (a.WarrantyActive) { <span class="text-success"><i class="bi bi-shield-check"></i></span> }
                                    else { <span class="text-muted">—</span> }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    private string mode = "list";
    private List<AssetListItem>? assets;
    private AssetFilter filter = new();
    private string filterStatus = "";
    private AssetDetail? detail;
    private AssetEditModel form = new();
    private int? editId;
    private string? errorMsg;
    private bool _confirmArchive;
    private List<CustomerListItem> _customers = [];
    private List<SiteListItem> _sites = [];

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await DetermineView();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DetermineView()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.AbsolutePath.Contains("/assets/new", StringComparison.OrdinalIgnoreCase))
        {
            mode = "form"; editId = null; form = new();
            _customers = await CustomerSvc.GetCustomersAsync();
            _sites = await SiteSvc.GetSitesAsync();
        }
        else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
        {
            _customers = await CustomerSvc.GetCustomersAsync();
            _sites = await SiteSvc.GetSitesAsync();
            await LoadForEdit(Id.Value);
        }
        else if (Id.HasValue)
            await LoadDetail(Id.Value);
        else { mode = "list"; await LoadAssets(); }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadAssets()
    {
        filter.Status = string.IsNullOrWhiteSpace(filterStatus) ? null : Enum.Parse<AssetStatus>(filterStatus);
        assets = await AssetSvc.GetAssetsAsync(filter);
    }

    private async Task LoadDetail(int id)
    {
        detail = await AssetSvc.GetAssetAsync(id);
        mode = detail is not null ? "detail" : "list";
        if (mode == "list") await LoadAssets();
    }

    private async Task LoadForEdit(int id)
    {
        var d = await AssetSvc.GetAssetAsync(id);
        if (d is null) { mode = "list"; await LoadAssets(); return; }
        editId = id;
        form = new AssetEditModel
        {
            Name = d.Name, Model = d.Model, SerialNumber = d.SerialNumber,
            AssetType = d.AssetType, Brand = d.Brand, FuelType = d.FuelType,
            UnitConfiguration = d.UnitConfiguration, BTURating = d.BTURating,
            FilterSize = d.FilterSize, Tonnage = d.Tonnage, SEER = d.SEER,
            AFUE = d.AFUE, HSPF = d.HSPF, Voltage = d.Voltage, Phase = d.Phase,
            LocationOnSite = d.LocationOnSite, ManufactureDate = d.ManufactureDate,
            AmpRating = d.AmpRating, PanelType = d.PanelType,
            PipeMaterial = d.PipeMaterial, GallonCapacity = d.GallonCapacity,
            RefrigerantType = d.RefrigerantType, RefrigerantQuantity = d.RefrigerantQuantity,
            InstallDate = d.InstallDate, LastServiceDate = d.LastServiceDate,
            NextServiceDue = d.NextServiceDue, WarrantyStartDate = d.WarrantyStartDate,
            WarrantyTermYears = d.WarrantyTermYears, WarrantyExpiry = d.WarrantyExpiry,
            Status = d.Status, Value = d.Value, Notes = d.Notes,
            ProductId = d.ProductId, CustomerId = d.CustomerId, SiteId = d.SiteId
        };
        mode = "form";
    }

    private async Task SaveAsset()
    {
        try
        {
            errorMsg = null;
            if (editId.HasValue) await AssetSvc.UpdateAssetAsync(editId.Value, form);
            else await AssetSvc.CreateAssetAsync(form);
            Nav.NavigateTo("/assets");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task ArchiveDetail()
    {
        if (detail is not null) { await AssetSvc.ArchiveAssetAsync(detail.Id); Nav.NavigateTo("/assets"); }
    }

    private string GetAssetBadge(AssetStatus s) => s switch
    {
        AssetStatus.Active => "bg-success",
        AssetStatus.MaintenanceNeeded => "bg-warning text-dark",
        AssetStatus.Retired => "bg-secondary",
        AssetStatus.Decommissioned => "bg-danger",
        _ => "bg-secondary"
    };

    private void GoToList() => Nav.NavigateTo("/assets");
    private void GoToNew() => Nav.NavigateTo("/assets/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/assets/{id}");
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");
    private void EditDetail() { if (detail is not null) Nav.NavigateTo($"/assets/{detail.Id}/edit"); }

    private async Task OnStatusFilterChanged()
    {
        filter.Status = string.IsNullOrWhiteSpace(filterStatus) ? null : Enum.Parse<AssetStatus>(filterStatus);
        await LoadAssets();
    }

    private async Task ToggleSort(string column)
    {
        if (filter.SortBy == column) filter.SortDescending = !filter.SortDescending;
        else { filter.SortBy = column; filter.SortDescending = false; }
        await LoadAssets();
    }

    private RenderFragment SortIcon(string column) => builder =>
    {
        var icon = filter.SortBy == column
            ? (filter.SortDescending ? "bi-sort-down" : "bi-sort-up")
            : "bi-arrow-down-up";
        var css = filter.SortBy == column ? "text-primary" : "text-muted";
        builder.OpenElement(0, "i");
        builder.AddAttribute(1, "class", $"bi {icon} {css} small");
        builder.CloseElement();
    };

    private string GetWarrantyState(AssetDetail d)
    {
        if (!d.WarrantyExpiry.HasValue) return "none";
        var daysLeft = (d.WarrantyExpiry.Value - DateTime.UtcNow).TotalDays;
        if (daysLeft < 0) return "expired";
        if (daysLeft < 90) return "expiring";
        return "active";
    }

    private string GetJobBadge(JobStatus s) => s switch
    {
        JobStatus.Lead => "bg-info text-dark",
        JobStatus.Quoted => "bg-primary",
        JobStatus.Approved => "bg-primary",
        JobStatus.Scheduled => "bg-primary",
        JobStatus.EnRoute => "bg-warning text-dark",
        JobStatus.OnSite => "bg-warning text-dark",
        JobStatus.InProgress => "bg-warning text-dark",
        JobStatus.Paused => "bg-secondary",
        JobStatus.Completed => "bg-success",
        JobStatus.Closed => "bg-success",
        JobStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };

    private void NavigateTimelineEntry(AssetTimelineEntry entry)
    {
        if (entry.Source == "Job" && entry.SourceId.HasValue)
            Nav.NavigateTo($"/jobs/{entry.SourceId.Value}");
        else if (entry.Source == "ServiceHistory" && entry.SourceId.HasValue)
            Nav.NavigateTo($"/service-history/{entry.SourceId.Value}");
    }
}
