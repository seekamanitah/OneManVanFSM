@page "/settings"
@rendermode InteractiveServer
@using OneManVanFSM.Shared.Services
@inject IDataManagementService DataSvc
@inject IDropdownService DropdownSvc
@inject IAuthService AuthSvc
@inject ITemplateService TemplateSvc
@inject IPermissionService PermSvc
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Settings - OneManVanFSM</PageTitle>

<style>
    .column-header-clickable {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.15s ease;
    }

    .column-header-clickable:hover {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }

    .column-header-clickable:active {
        background-color: rgba(13, 110, 253, 0.2) !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Settings</h4>
</div>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link @(tab == "company" ? "active" : "")" href="javascript:void(0)" @onclick='() => tab = "company"'>Company</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "users" ? "active" : "")" href="javascript:void(0)" @onclick="SwitchToUsers">Users & Roles</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "custom" ? "active" : "")" href="javascript:void(0)" @onclick='() => SwitchToCustom()'>Customizations</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "notifications" ? "active" : "")" href="javascript:void(0)" @onclick='() => tab = "notifications"'>Notifications</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "templates" ? "active" : "")" href="javascript:void(0)" @onclick="SwitchToTemplates">Templates</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "mobile" ? "active" : "")" href="javascript:void(0)" @onclick="SwitchToMobile">Mobile & Theme</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "database" ? "active" : "")" href="javascript:void(0)" @onclick='() => tab = "database"'>Database</a></li>
    <li class="nav-item"><a class="nav-link @(tab == "data" ? "active" : "")" href="javascript:void(0)" @onclick='() => SwitchToData()'>Data Management</a></li>
</ul>

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>@successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
    </div>
}
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-1"></i>@errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

@if (tab == "company")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h5>Company Profile & Branding</h5>
            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-control" @bind="_companyName" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Business Phone</label>
                    <input type="tel" class="form-control" value="@_companyPhone"
                           @oninput="e => _companyPhone = FormatPhone(e.Value?.ToString()) ?? string.Empty" placeholder="(555) 123-4567" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Business Email</label>
                    <input type="email" class="form-control" placeholder="info@company.com" @bind="_companyEmail" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Tax ID</label>
                    <input type="text" class="form-control" placeholder="XX-XXXXXXX" @bind="_companyTaxId" />
                </div>
                <div class="col-12">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-control" placeholder="123 Main St, City, State ZIP" @bind="_companyAddress" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Default Tax Rate (%)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" step="0.01" min="0" max="100" @bind="_defaultTaxRate" placeholder="e.g. 9.75" />
                        <span class="input-group-text">%</span>
                    </div>
                    <small class="text-muted">Applied globally to all new estimates, invoices, and other forms.</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Default Print Template</label>
                    <select class="form-select" @bind="_defaultPrintTemplate">
                        <option value="Classic">Classic (B&W)</option>
                        <option value="Professional">Professional (Navy)</option>
                        <option value="Modern">Modern (Teal)</option>
                    </select>
                    <small class="text-muted">Default PDF/print style for estimates, invoices, and expenses.</small>
                </div>
            </div>
            <button class="btn btn-primary mt-3" @onclick="SaveCompanyProfile"><i class="bi bi-check-lg me-1"></i>Save Profile</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mt-3">
        <div class="card-body">
            <h5><i class="bi bi-envelope-at me-2"></i>Email Configuration (SMTP)</h5>
            <p class="text-muted small mb-3">Configure SMTP to send invoices, estimates, and material lists directly from the app with PDF attachments.</p>
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="form-label">SMTP Server</label>
                    <input type="text" class="form-control" placeholder="smtp.gmail.com" @bind="_smtpHost" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control" @bind="_smtpPort" />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="smtpSsl" @bind="_smtpUseSsl" />
                        <label class="form-check-label" for="smtpSsl">Use SSL/TLS</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" placeholder="your-email@gmail.com" @bind="_smtpUsername" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Password / App Password</label>
                    <input type="password" class="form-control" placeholder="App password or SMTP password" @bind="_smtpPassword" />
                </div>
                <div class="col-12">
                    <label class="form-label">Public Base URL <small class="text-muted">(for customer approval links in emails)</small></label>
                    <input type="text" class="form-control" placeholder="https://yourdomain.com" @bind="_publicBaseUrl" />
                </div>
            </div>
            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary" @onclick="SaveCompanyProfile"><i class="bi bi-check-lg me-1"></i>Save Email Settings</button>
                <button class="btn btn-outline-info" @onclick="TestSmtpConnection" disabled="@_smtpTesting">
                    @if (_smtpTesting) { <span class="spinner-border spinner-border-sm me-1"></span> } else { <i class="bi bi-send me-1"></i> }
                    Test Connection
                </button>
            </div>
            @if (_smtpTestResult is not null)
            {
                <div class="alert @(_smtpTestResult.StartsWith("Success") ? "alert-success" : "alert-danger") mt-2 mb-0 py-2 small">@_smtpTestResult</div>
            }
            <div class="alert alert-info mt-3 mb-0 py-2 small">
                <i class="bi bi-info-circle me-1"></i><strong>Gmail users:</strong> Use an <a href="https://myaccount.google.com/apppasswords" target="_blank">App Password</a> (not your regular password). Server: <code>smtp.gmail.com</code>, Port: <code>587</code>, SSL: On.
            </div>
        </div>
    </div>
}
else if (tab == "users")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h5 class="mb-0">Users & Role Permissions</h5>
                    <p class="text-muted mb-0 small">Manage user accounts, assign roles, and control access.</p>
                </div>
                <a href="/login/register" class="btn btn-primary btn-sm"><i class="bi bi-person-plus me-1"></i>Add User</a>
            </div>

            @if (_showCreateUser)
            {
                <div class="card border-primary mt-3">
                    <div class="card-body">
                        <h6 class="text-primary"><i class="bi bi-person-plus me-1"></i>Create New User</h6>
                        @if (!string.IsNullOrEmpty(_createUserError))
                        {
                            <div class="alert alert-danger py-2 small">@_createUserError</div>
                        }
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label small">Username</label>
                                <input type="text" class="form-control form-control-sm" @bind="_newUserUsername" placeholder="Min 3 characters" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Email</label>
                                <input type="email" class="form-control form-control-sm" @bind="_newUserEmail" placeholder="user@example.com" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Role</label>
                                <select class="form-select form-select-sm" @bind="_newUserRole">
                                    @foreach (var r in Enum.GetValues<UserRole>()) { <option value="@r">@r</option> }
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Password</label>
                                <input type="password" class="form-control form-control-sm" @bind="_newUserPassword" placeholder="Min 6 characters" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Confirm</label>
                                <input type="password" class="form-control form-control-sm" @bind="_newUserConfirmPassword" />
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary btn-sm me-1" @onclick="AdminCreateUser"><i class="bi bi-check-lg me-1"></i>Create</button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => { _showCreateUser = false; _createUserError = null; }">Cancel</button>
                        </div>
                    </div>
                </div>
            }

            @if (userList is null)
            {
                <div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
            }
            else if (!userList.Any())
            {
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-people" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No users found. <a href="javascript:void(0)" @onclick="() => _showCreateUser = true">Create the first user</a>.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr><th>Username</th><th>Email</th><th>Role</th><th>Linked Employee</th><th>Status</th><th>Last Login</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var u in userList)
                            {
                                <tr>
                                    <td><strong>@u.Username</strong></td>
                                    <td>@u.Email</td>
                                    <td>
                                        <select class="form-select form-select-sm" style="width:auto;min-width:100px;"
                                                value="@u.Role" @onchange="e => ChangeUserRole(u.Id, e)">
                                            @foreach (var r in Enum.GetValues<UserRole>()) { <option value="@r">@r</option> }
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" style="width:auto;min-width:140px;"
                                                value="@(u.EmployeeId?.ToString() ?? "")" @onchange="e => LinkEmployee(u.Id, e)">
                                            <option value="">— None —</option>
                                            @if (_employeeOptions is not null)
                                            {
                                                @foreach (var emp in _employeeOptions)
                                                {
                                                    <option value="@emp.Id">@emp.Name</option>
                                                }
                                            }
                                        </select>
                                    </td>
                                    <td>
                                        @if (u.IsLocked)
                                        {
                                            <span class="badge bg-danger"><i class="bi bi-lock-fill me-1"></i>Locked</span>
                                        }
                                        else if (u.IsActive)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark"><i class="bi bi-pause-circle me-1"></i>Inactive</span>
                                        }
                                    </td>
                                    <td><small>@(u.LastLogin?.ToString("MMM dd, yyyy h:mm tt") ?? "Never")</small></td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm @(u.IsActive ? "btn-outline-warning" : "btn-outline-success")"
                                                    title="@(u.IsActive ? "Deactivate" : "Activate")" @onclick="() => ToggleActive(u.Id)">
                                                <i class="bi @(u.IsActive ? "bi-pause-circle" : "bi-play-circle")"></i>
                                            </button>
                                            @if (u.IsLocked)
                                            {
                                                <button class="btn btn-sm btn-outline-info" title="Unlock" @onclick="() => ToggleLock(u.Id)">
                                                    <i class="bi bi-unlock"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-outline-danger" title="Lock" @onclick="() => ToggleLock(u.Id)">
                                                    <i class="bi bi-lock"></i>
                                                </button>
                                            }
                                            <button class="btn btn-sm btn-outline-secondary" title="Reset Password" @onclick="() => ShowResetPassword(u.Id, u.Username)">
                                                <i class="bi bi-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <small class="text-muted d-block mt-2">@userList.Count user(s) total</small>

                @if (_showResetPassword)
                {
                    <div class="card border-warning mt-3">
                        <div class="card-body">
                            <h6 class="text-warning"><i class="bi bi-key me-1"></i>Reset Password for "@_resetUsername"</h6>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label small">New Password</label>
                                    <input type="password" class="form-control form-control-sm" @bind="_resetNewPassword" placeholder="Min 6 characters" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small">Confirm Password</label>
                                    <input type="password" class="form-control form-control-sm" @bind="_resetConfirmPassword" />
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-warning btn-sm me-1" @onclick="AdminResetPassword"><i class="bi bi-check me-1"></i>Reset</button>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="() => _showResetPassword = false">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }

            <hr class="my-3" />

            @* Change Own Password *@
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6><i class="bi bi-shield-lock me-1"></i>Change My Password</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label small">Current Password</label>
                            <input type="password" class="form-control form-control-sm" @bind="_currentPassword" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">New Password</label>
                            <input type="password" class="form-control form-control-sm" @bind="_newPassword" placeholder="Min 6 characters" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Confirm New Password</label>
                            <input type="password" class="form-control form-control-sm" @bind="_confirmNewPassword" />
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary btn-sm" @onclick="ChangeMyPassword"><i class="bi bi-check-lg me-1"></i>Update Password</button>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-3" />

            @* Role Permission Matrix *@
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0"><i class="bi bi-shield-check me-1"></i>Role Permission Matrix</h6>
                            <small class="text-muted">Configure what each role can view, edit, and delete. Owner always has full access. <strong>Click column headers to toggle entire columns.</strong></small>
                        </div>
                        <div>
                            @if (_permSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <button class="btn btn-primary btn-sm" @onclick="SavePermissions" disabled="@_permSaving">
                                <i class="bi bi-check-lg me-1"></i>Save Permissions
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ms-1" @onclick="ResetPermissionsToDefaults">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Defaults
                            </button>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(_permError))
                    {
                        <div class="alert alert-danger py-2 small">@_permError</div>
                    }
                    @if (_permMatrix is not null)
                    {
                        <div class="table-responsive" style="max-height:500px; overflow-y:auto;">
                            <table class="table table-sm table-bordered table-hover mb-0 align-middle" style="font-size:0.8rem;">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="min-width:130px;">Feature</th>
                                        @foreach (var role in _permRoles)
                                        {
                                            <th colspan="3" class="text-center">@role</th>
                                        }
                                    </tr>
                                    <tr>
                                        <th></th>
                                        @foreach (var role in _permRoles)
                                        {
                                            var isOwner = role == UserRole.Owner;
                                            <th class="text-center @(isOwner ? "" : "column-header-clickable")" style="font-size:0.7rem;" title="@(isOwner ? "Owner always has full access" : "Click to toggle all")"
                                                @onclick="() => ToggleColumn(role, PermissionType.View)" disabled="@isOwner">View</th>
                                            <th class="text-center @(isOwner ? "" : "column-header-clickable")" style="font-size:0.7rem;" title="@(isOwner ? "Owner always has full access" : "Click to toggle all")"
                                                @onclick="() => ToggleColumn(role, PermissionType.Edit)" disabled="@isOwner">Edit</th>
                                            <th class="text-center @(isOwner ? "" : "column-header-clickable")" style="font-size:0.7rem;" title="@(isOwner ? "Owner always has full access" : "Click to toggle all")"
                                                @onclick="() => ToggleColumn(role, PermissionType.Delete)" disabled="@isOwner">Del</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var feature in Features.All)
                                    {
                                        <tr>
                                            <td class="fw-bold">@feature</td>
                                            @foreach (var role in _permRoles)
                                            {
                                                var key = (role, feature);
                                                var isOwner = role == UserRole.Owner;
                                                <td class="text-center">
                                                    <input type="checkbox" checked="@GetPerm(key).CanView" disabled="@isOwner"
                                                           @onchange="e => SetPerm(key, v: (bool)(e.Value ?? false), null, null)" />
                                                </td>
                                                <td class="text-center">
                                                    <input type="checkbox" checked="@GetPerm(key).CanEdit" disabled="@isOwner"
                                                           @onchange="e => SetPerm(key, null, ed: (bool)(e.Value ?? false), null)" />
                                                </td>
                                                <td class="text-center">
                                                    <input type="checkbox" checked="@GetPerm(key).CanDelete" disabled="@isOwner"
                                                           @onchange="e => SetPerm(key, null, null, del: (bool)(e.Value ?? false))" />
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Loading permissions...</div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else if (tab == "custom")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h5>Customizations & Dropdown Editor</h5>
            <p class="text-muted">Manage dropdown options used across all pages. Select a category, then add/edit/remove values.</p>

            <div class="row g-2 mt-2">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" value="@selectedCategory" @onchange="OnCategoryChanged">
                        <option value="">— Select a category —</option>
                        @foreach (var cat in dropdownCategories)
                        {
                            <option value="@cat">@cat</option>
                        }
                    </select>
                </div>
                <div class="col-md-8">
                    @if (!string.IsNullOrEmpty(selectedCategory))
                    {
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-semibold mb-0">Options for "@selectedCategory"</label>
                            <button class="btn btn-sm btn-primary" @onclick="ShowAddDropdown">
                                <i class="bi bi-plus-lg me-1"></i>Add Option
                            </button>
                        </div>

                        @if (showAddDropdown)
                        {
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <div class="row g-2 align-items-end">
                                        <div class="col-md-5">
                                            <label class="form-label small">Value</label>
                                            <input type="text" class="form-control form-control-sm" @bind="newDropdownValue" placeholder="e.g., Commercial" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Label (optional)</label>
                                            <input type="text" class="form-control form-control-sm" @bind="newDropdownLabel" placeholder="Display label" />
                                        </div>
                                        <div class="col-md-3 d-flex gap-1">
                                            <button class="btn btn-sm btn-success flex-fill" @onclick="AddDropdownOption" disabled="@string.IsNullOrWhiteSpace(newDropdownValue)">
                                                <i class="bi bi-check-lg"></i> Save
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary flex-fill" @onclick="() => showAddDropdown = false">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr><th>Value</th><th>Label</th><th>Order</th><th>Active</th><th style="width:120px;">Actions</th></tr>
                                </thead>
                                <tbody>
                                    @if (dropdownOptions.Count == 0)
                                    {
                                        <tr><td colspan="5" class="text-center text-muted py-3">No options. Click "Add Option" to create one.</td></tr>
                                    }
                                    @foreach (var opt in dropdownOptions.OrderBy(o => o.SortOrder))
                                    {
                                        <tr class="@(opt.IsActive ? "" : "text-muted")">
                                            @if (editingDropdownId == opt.Id)
                                            {
                                                <td><input type="text" class="form-control form-control-sm" @bind="editDropdownValue" /></td>
                                                <td><input type="text" class="form-control form-control-sm" @bind="editDropdownLabel" /></td>
                                                <td>@opt.SortOrder</td>
                                                <td>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" @bind="editDropdownActive" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-success me-1" @onclick="SaveEditDropdown"><i class="bi bi-check-lg"></i></button>
                                                    <button class="btn btn-sm btn-outline-secondary" @onclick="CancelEditDropdown"><i class="bi bi-x-lg"></i></button>
                                                </td>
                                            }
                                            else
                                            {
                                                <td>@opt.Value</td>
                                                <td>@(opt.Label ?? "—")</td>
                                                <td>@opt.SortOrder</td>
                                                <td>
                                                    @if (opt.IsActive)
                                                    {
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-x-circle text-muted"></i>
                                                    }
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEditDropdown(opt)"><i class="bi bi-pencil"></i></button>
                                                    @if (!opt.IsSystem)
                                                    {
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteDropdownOption(opt.Id)"><i class="bi bi-trash"></i></button>
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-arrow-left" style="font-size:1.5rem;"></i>
                            <p class="mb-0 mt-1">Select a category to manage its dropdown options.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else if (tab == "notifications")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h5>Notifications & Alerts</h5>
            <p class="text-muted small">Toggle notifications on or off per category. Changes are applied in-session.</p>
            <div class="list-group list-group-flush mt-2">
                @foreach (var n in notificationSettings)
                {
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <div>
                            <i class="bi @GetNotificationIcon(n.Key) me-2 text-primary"></i>
                            <span>@n.Key</span>
                        </div>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" checked="@n.Value"
                                   @onchange="e => ToggleNotification(n.Key, (bool)(e.Value ?? false))" />
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}
else if (tab == "templates")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h5 class="mb-0">Company-Level Templates</h5>
                    <small class="text-muted">Reusable blueprints for material lists, job checklists, estimates, and more.</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" @onclick='() => Nav.NavigateTo("/templates")'><i class="bi bi-box-arrow-up-right me-1"></i>Full Template Manager</button>
                    <button class="btn btn-primary btn-sm" @onclick="ShowNewTemplate"><i class="bi bi-plus-lg me-1"></i>New Template</button>
                </div>
            </div>

            @if (_showTemplateForm)
            {
                <div class="border rounded p-3 mb-3 bg-light">
                    <h6 class="mb-2">@(_editingTemplateId.HasValue ? "Edit" : "New") Template</h6>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label small">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" @bind="_tplName" placeholder="e.g. Standard AC Install Kit" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Type</label>
                            <select class="form-select form-select-sm" @bind="_tplType">
                                @foreach (var t in Enum.GetValues<TemplateType>()) { <option value="@t">@t</option> }
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small">Description</label>
                            <input type="text" class="form-control form-control-sm" @bind="_tplDescription" placeholder="Brief description..." />
                        </div>
                        <div class="col-md-8">
                            <label class="form-label small">Notes</label>
                            <textarea class="form-control form-control-sm" rows="2" @bind="_tplNotes" placeholder="Usage notes, tips..."></textarea>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="tplDefault" @bind="_tplIsDefault" />
                                <label class="form-check-label small" for="tplDefault">Company Default</label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-success btn-sm" @onclick="SaveTemplate"><i class="bi bi-check-lg me-1"></i>Save</button>
                        <button class="btn btn-outline-secondary btn-sm ms-1" @onclick="CancelTemplateForm">Cancel</button>
                    </div>
                    @if (!string.IsNullOrEmpty(_tplError)) { <div class="alert alert-danger py-1 mt-2 mb-0 small">@_tplError</div> }
                </div>
            }

            <div class="row g-2 mb-3 align-items-end">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" placeholder="Search templates..." @bind="_tplSearch" @bind:event="oninput" @onkeyup="HandleTemplateSearchKey" />
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="_tplFilterType" @bind:after="LoadTemplates">
                        <option value="">All Types</option>
                        @foreach (var t in Enum.GetValues<TemplateType>()) { <option value="@t">@t</option> }
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="tplDefaultFilter" @bind="_tplFilterDefault" @bind:after="LoadTemplates" />
                        <label class="form-check-label small" for="tplDefaultFilter">Defaults Only</label>
                    </div>
                </div>
            </div>

            @if (_templateList is null)
            {
                <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> Loading...</div>
            }
            else if (!_templateList.Any())
            {
                <div class="text-center text-muted py-4">
                    <i class="bi bi-layers" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No templates found. Create one to get started.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th class="text-center">Default</th>
                                <th class="text-center">Used</th>
                                <th>Last Used</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in _templateList)
                            {
                                <tr>
                                    <td>
                                        <a href="javascript:void(0)" @onclick='() => Nav.NavigateTo($"/templates/{t.Id}")' class="fw-semibold">@t.Name</a>
                                    </td>
                                    <td><span class="badge @GetTemplateTypeBadge(t.Type)">@t.Type</span></td>
                                    <td class="text-muted small">@(t.Description ?? "—")</td>
                                    <td class="text-center">
                                        @if (t.IsCompanyDefault) { <i class="bi bi-check-circle-fill text-success"></i> }
                                    </td>
                                    <td class="text-center"><span class="badge bg-secondary">@t.UsageCount</span></td>
                                    <td class="small text-muted">@(t.LastUsed?.ToString("MMM dd") ?? "Never")</td>
                                    <td class="text-end">
                                        <button class="btn btn-outline-primary btn-sm me-1" @onclick="() => EditTemplate(t.Id)" title="Edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-outline-info btn-sm me-1" @onclick="() => CloneTemplate(t.Id, t.Name)" title="Clone"><i class="bi bi-copy"></i></button>
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteTemplate(t.Id)" title="Delete"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}
else if (tab == "mobile")
{
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <h5><i class="bi bi-phone me-2"></i>Mobile App Version Info</h5>
            <p class="text-muted small">Information about the current published mobile app version. Field technicians should have this version or newer.</p>

            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <div class="d-flex align-items-center justify-content-between border rounded p-3 bg-light">
                        <div class="flex-grow-1">
                            <div class="text-muted small">Published Version</div>
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control form-control-sm" style="width: 100px;" @bind="_publishedVersion" @bind:event="oninput" />
                                <button class="btn btn-sm btn-outline-primary" @onclick="SavePublishedVersion" title="Save" disabled="@_savingPublishedVersion">
                                    @if (_savingPublishedVersion)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-check-lg"></i>
                                    }
                                </button>
                            </div>
                        </div>
                        <i class="bi bi-phone-fill text-primary" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center justify-content-between border rounded p-3 bg-light">
                        <div>
                            <div class="text-muted small">Build Number</div>
                            <div class="fs-5 fw-bold">@GetCurrentMobileBuildNumber()</div>
                        </div>
                        <i class="bi bi-hammer text-secondary" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center justify-content-between border rounded p-3 bg-light">
                        <div>
                            <div class="text-muted small">Build Date</div>
                            <div class="fs-6 fw-semibold">@GetMobileBuildDate()</div>
                        </div>
                        <i class="bi bi-calendar-check text-info" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-3 mb-0 d-flex align-items-start" style="border-left: 4px solid #0dcaf0;">
                <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                <div>
                    <strong>For Field Technicians:</strong>
                    <p class="mb-1 small">To check your installed version, open the mobile app and go to <strong>Settings → About</strong>.</p>
                    <p class="mb-0 small">If your build is more than 48 hours old, consider rebuilding or installing the latest APK to get the newest features and fixes.</p>
                </div>
            </div>

            <div class="mt-3">
                <h6 class="text-muted">Version Tracking</h6>
                <div class="small text-muted">
                    <p class="mb-1">• Build numbers auto-increment on every compilation (format: days since Jan 2025 + HHmm)</p>
                    <p class="mb-1">• Mobile apps show a warning banner on home screen if build is > 24 hours old</p>
                    <p class="mb-0">• See <code>VERSION_TRACKING_GUIDE.md</code> in project root for full documentation</p>
                </div>
            </div>

            <hr class="my-4" />

            <h6><i class="bi bi-phone me-2"></i>Device Fleet Status</h6>
            <p class="text-muted small">Track which versions are installed on field devices. Devices are automatically registered during first sync.</p>

            @if (_mobileDevices is null)
            {
                <div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Loading devices...</div>
            }
            else if (!_mobileDevices.Any())
            {
                <div class="text-center text-muted py-4">
                    <i class="bi bi-phone-x" style="font-size:2rem;"></i>
                    <p class="mt-2 mb-0">No mobile devices have synced yet. Install and sync the mobile app to register devices here.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Device</th>
                                <th>User / Employee</th>
                                <th>Version</th>
                                <th>Build</th>
                                <th>Build Age</th>
                                <th>Last Sync</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var device in _mobileDevices)
                            {
                                <tr class="@(device.IsActive ? "" : "text-muted")">
                                    <td>
                                        <div class="fw-semibold">@(device.DeviceName ?? device.DeviceId)</div>
                                        <small class="text-muted">@device.Platform @device.OsVersion</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(device.EmployeeName))
                                        {
                                            <div>@device.EmployeeName</div>
                                        }
                                        @if (!string.IsNullOrEmpty(device.Username))
                                        {
                                            <small class="text-muted">@device.Username</small>
                                        }
                                        @if (string.IsNullOrEmpty(device.EmployeeName) && string.IsNullOrEmpty(device.Username))
                                        {
                                            <span class="text-muted">—</span>
                                        }
                                    </td>
                                    <td>@device.AppVersion</td>
                                    <td>
                                        <span class="font-monospace small">@device.BuildNumber</span>
                                    </td>
                                    <td>
                                        <span class="@(device.IsOutdated ? "badge bg-warning text-dark" : "text-muted small")">
                                            @device.BuildAge
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">@device.LastSyncTime.ToLocalTime().ToString("MMM dd, h:mm tt")</small>
                                    </td>
                                    <td>
                                        @if (device.IsActive)
                                        {
                                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary" title="Toggle Active" @onclick="() => ToggleDeviceActive(device.Id, device.IsActive)">
                                                <i class="bi @(device.IsActive ? "bi-pause-circle" : "bi-play-circle")"></i>
                                            </button>
                                            <button class="btn btn-outline-info" title="Edit Notes" @onclick="() => ShowDeviceNotes(device)">
                                                <i class="bi bi-chat-left-text"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                @if (!string.IsNullOrEmpty(device.Notes))
                                {
                                    <tr class="table-light">
                                        <td colspan="8" class="small text-muted py-1">
                                            <i class="bi bi-chat-quote me-1"></i><strong>Notes:</strong> @device.Notes
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <small class="text-muted d-block mt-2">
                    @_mobileDevices.Count device(s) registered • @_mobileDevices.Count(d => d.IsActive) active • @_mobileDevices.Count(d => d.IsOutdated) outdated
                </small>
            }

            @if (_showDeviceNotesModal)
            {
                <div class="card border-primary mt-3">
                    <div class="card-body">
                        <h6 class="text-primary"><i class="bi bi-chat-left-text me-1"></i>Edit Device Notes: @_editingDevice?.DeviceName</h6>
                        <div class="mb-2">
                            <label class="form-label small">Notes</label>
                            <textarea class="form-control form-control-sm" rows="3" @bind="_deviceNotes" placeholder="e.g., Primary tech device, Testing only, etc."></textarea>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm me-1" @onclick="SaveDeviceNotes"><i class="bi bi-check-lg me-1"></i>Save</button>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => _showDeviceNotesModal = false">Cancel</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h5>Mobile & App Preferences</h5>
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Theme</label>
                    <select class="form-select" disabled>
                        <option selected>Light</option>
                        <option>Dark</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Offline Sync Interval</label>
                    <select class="form-select" disabled>
                        <option>Every 15 min</option>
                        <option selected>Every 30 min</option>
                        <option>Every 60 min</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" checked disabled />
                        <label class="form-check-label">Require GPS for Clock-In</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" disabled />
                        <label class="form-check-label">High Photo Compression</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (tab == "database")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h5><i class="bi bi-database-gear me-2"></i>Database Connection</h5>
            <p class="text-muted">Configure the database provider and connection settings. The default is a local SQLite database. Switch to a remote database when deploying to production or sharing data across devices.</p>

            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Database Provider</label>
                    <select class="form-select" @bind="_dbProvider">
                        <option value="SQLite">SQLite (Local)</option>
                        <option value="SqlServer">SQL Server</option>
                        <option value="PostgreSQL">PostgreSQL</option>
                        <option value="MySQL">MySQL / MariaDB</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label fw-semibold">Connection String</label>
                    <input type="text" class="form-control" @bind="_dbConnectionString"
                           placeholder="@GetConnectionStringPlaceholder()" />
                </div>

                @if (_dbProvider != "SQLite")
                {
                    <div class="col-md-4">
                        <label class="form-label">Server / Host</label>
                        <input type="text" class="form-control" @bind="_dbHost" placeholder="e.g. myserver.database.windows.net" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-control" @bind="_dbPort" placeholder="@GetDefaultPort()" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Database Name</label>
                        <input type="text" class="form-control" @bind="_dbName" placeholder="OneManVanFSM" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Authentication</label>
                        <select class="form-select" @bind="_dbAuthMode">
                            <option value="SQL">Username & Password</option>
                            <option value="Integrated">Integrated / Trusted</option>
                        </select>
                    </div>
                    @if (_dbAuthMode == "SQL")
                    {
                        <div class="col-md-4">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" @bind="_dbUsername" placeholder="sa" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" @bind="_dbPassword" />
                        </div>
                    }
                    <div class="col-md-4">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="dbEncrypt" @bind="_dbEncrypt" />
                            <label class="form-check-label" for="dbEncrypt">Encrypt Connection (TLS/SSL)</label>
                        </div>
                    </div>
                }
            </div>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-outline-primary" @onclick="TestDatabaseConnection" disabled="@_dbTesting">
                    @if (_dbTesting)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-plug me-1"></i>Test Connection
                </button>
                <button class="btn btn-primary" @onclick="SaveDatabaseConfig" disabled="@_dbTesting">
                    <i class="bi bi-check-lg me-1"></i>Save Configuration
                </button>
            </div>

            @if (_dbTestResult is not null)
            {
                <div class="alert @(_dbTestSuccess ? "alert-success" : "alert-danger") mt-3 mb-0">
                    <i class="bi @(_dbTestSuccess ? "bi-check-circle" : "bi-x-circle") me-1"></i>@_dbTestResult
                </div>
            }

            <div class="alert alert-info mt-3 mb-0">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Note:</strong> Changing the database provider requires an application restart. Ensure the target database has been migrated before switching. A backup of the current database is recommended before changing providers.
            </div>
        </div>
    </div>
}
else if (tab == "data")
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h5><i class="bi bi-database me-2"></i>Data Management & Exports</h5>
            <p class="text-muted">Export data as Excel workbooks with a sheet per table. Import from CSV. Manage backups and data retention.</p>

            @* Export Section *@
            <h6 class="mt-3 mb-2"><i class="bi bi-download me-1"></i>Export Data</h6>
            <div class="row g-2">
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" @onclick="ExportAllXlsx" disabled="@isProcessing">
                        @if (isProcessing && processingAction == "exportAll")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export All Tables (Excel)
                    </button>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <select class="form-select" @bind="selectedExportTable">
                            <option value="">— Select Table —</option>
                            @foreach (var t in exportableTables)
                            {
                                <option value="@t">@t</option>
                            }
                        </select>
                        <button class="btn btn-outline-primary" @onclick="ExportSingleTableXlsx"
                                disabled="@(isProcessing || string.IsNullOrEmpty(selectedExportTable))">
                            <i class="bi bi-download"></i>
                        </button>
                    </div>
                </div>
            </div>

            <hr class="my-3" />

            @* Import Section *@
            <h6 class="mb-2"><i class="bi bi-upload me-1"></i>Import Data</h6>
            <p class="small text-muted">Upload an Excel workbook (.xlsx) or CSV file (.csv). The system auto-detects the format and target table, then checks for duplicates before importing.</p>
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <InputFile OnChange="OnImportFileSelected" accept=".csv,.txt,.xlsx,.xls" class="form-control" />
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" @onclick="PreviewImport"
                            disabled="@(isProcessing || importFile is null)">
                        @if (isProcessing && processingAction == "preview")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-search me-1"></i>Preview & Check
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" @onclick="ImportCsv"
                            disabled="@(isProcessing || importFile is null)">
                        @if (isProcessing && processingAction == "import")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-upload me-1"></i>Import Direct
                    </button>
                </div>
            </div>

            @* Import Preview / Conflict Review *@
            @if (importPreview is not null)
            {
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-clipboard-check me-1"></i>Import Preview</h6>
                        <div>
                            <span class="badge bg-primary me-1">@importPreview.TotalRows rows</span>
                            @if (importPreview.ConflictCount > 0)
                            {
                                <span class="badge bg-warning text-dark me-1">@importPreview.ConflictCount conflicts</span>
                            }
                            else
                            {
                                <span class="badge bg-success">No conflicts</span>
                            }
                        </div>
                    </div>

                    @foreach (var w in importPreview.Warnings)
                    {
                        <div class="alert alert-warning py-1 mb-1 small"><i class="bi bi-exclamation-triangle me-1"></i>@w</div>
                    }
                    @foreach (var e in importPreview.Errors)
                    {
                        <div class="alert alert-danger py-1 mb-1 small"><i class="bi bi-x-circle me-1"></i>@e</div>
                    }

                    @foreach (var table in importPreview.Tables)
                    {
                        <div class="card border-0 shadow-sm mb-2">
                            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                                <span class="fw-semibold"><i class="bi bi-table me-1"></i>@table.TableName</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success btn-sm" @onclick="() => SetAllRowActions(table, ImportRowAction.Import)"><i class="bi bi-check-all me-1"></i>Import All</button>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="() => SetAllRowActions(table, ImportRowAction.Skip)"><i class="bi bi-skip-end me-1"></i>Skip All</button>
                                    @if (table.Rows.Any(r => r.ConflictType != ImportConflictType.None))
                                    {
                                        <button class="btn btn-outline-warning btn-sm" @onclick="() => SetConflictRowActions(table, ImportRowAction.Overwrite)"><i class="bi bi-arrow-repeat me-1"></i>Overwrite Conflicts</button>
                                    }
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
                                <table class="table table-sm table-hover mb-0 align-middle">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width:40px;">Row</th>
                                            <th style="width:100px;">Status</th>
                                            <th style="width:130px;">Action</th>
                                            @{
                                                var displayHeaders = table.Headers.Where(h => !string.Equals(h, "Id", StringComparison.OrdinalIgnoreCase)).Take(5).ToArray();
                                            }
                                            @foreach (var h in displayHeaders)
                                            {
                                                <th>@h</th>
                                            }
                                            @if (table.Headers.Length > displayHeaders.Length + 1)
                                            {
                                                <th class="text-muted">+@(table.Headers.Length - displayHeaders.Length - 1) more</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var row in table.Rows)
                                        {
                                            var rowClass = row.ConflictType switch
                                            {
                                                ImportConflictType.ExactDuplicate => "table-danger",
                                                ImportConflictType.PartialMatch => "table-warning",
                                                _ => ""
                                            };
                                            <tr class="@rowClass">
                                                <td class="small text-muted">@row.RowNumber</td>
                                                <td>
                                                    @if (row.ConflictType == ImportConflictType.ExactDuplicate)
                                                    {
                                                        <span class="badge bg-danger" title="@row.ConflictDetail"><i class="bi bi-exclamation-circle me-1"></i>Duplicate</span>
                                                    }
                                                    else if (row.ConflictType == ImportConflictType.PartialMatch)
                                                    {
                                                        <span class="badge bg-warning text-dark" title="@row.ConflictDetail"><i class="bi bi-question-circle me-1"></i>Similar</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success"><i class="bi bi-check me-1"></i>New</span>
                                                    }
                                                </td>
                                                <td>
                                                    <select class="form-select form-select-sm" value="@row.Action" @onchange="e => OnRowActionChanged(row, e)">
                                                        <option value="@ImportRowAction.Import">Import</option>
                                                        <option value="@ImportRowAction.Skip">Skip</option>
                                                        @if (row.ConflictType != ImportConflictType.None)
                                                        {
                                                            <option value="@ImportRowAction.Overwrite">Overwrite</option>
                                                        }
                                                    </select>
                                                </td>
                                                @foreach (var h in displayHeaders)
                                                {
                                                    <td class="small text-truncate" style="max-width:180px;" title="@(row.Values.GetValueOrDefault(h) ?? "")">@(row.Values.GetValueOrDefault(h) ?? "—")</td>
                                                }
                                                @if (table.Headers.Length > displayHeaders.Length + 1)
                                                {
                                                    <td></td>
                                                }
                                            </tr>
                                            @if (row.ConflictType != ImportConflictType.None && !string.IsNullOrEmpty(row.ConflictDetail))
                                            {
                                                <tr class="@rowClass">
                                                    <td colspan="@(displayHeaders.Length + 4)" class="small text-muted ps-4 py-0 border-0">
                                                        <i class="bi bi-info-circle me-1"></i>@row.ConflictDetail
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }

                    @* Commit bar *@
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="small text-muted">
                            @{
                                var importCount = importPreview.Tables.SelectMany(t => t.Rows).Count(r => r.Action == ImportRowAction.Import);
                                var overwriteCount = importPreview.Tables.SelectMany(t => t.Rows).Count(r => r.Action == ImportRowAction.Overwrite);
                                var skipCount = importPreview.Tables.SelectMany(t => t.Rows).Count(r => r.Action == ImportRowAction.Skip);
                            }
                            <span class="me-2"><i class="bi bi-plus-circle text-success me-1"></i>@importCount new</span>
                            <span class="me-2"><i class="bi bi-arrow-repeat text-warning me-1"></i>@overwriteCount overwrite</span>
                            <span><i class="bi bi-skip-end text-secondary me-1"></i>@skipCount skip</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-1" @onclick="CancelPreview">Cancel</button>
                            <button class="btn btn-primary btn-sm" @onclick="CommitImport"
                                    disabled="@(isProcessing || (importCount + overwriteCount) == 0)">
                                @if (isProcessing && processingAction == "commit")
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-check-circle me-1"></i>Commit @(importCount + overwriteCount) Records
                            </button>
                        </div>
                    </div>
                </div>
            }

            @if (importResult is not null)
            {
                <div class="mt-2">
                    @if (importResult.Success)
                    {
                        <div class="alert alert-success py-2 mb-1">
                            <i class="bi bi-check-circle me-1"></i>Imported <strong>@importResult.RecordsImported</strong> records
                            into: @string.Join(", ", importResult.Tables)
                        </div>
                    }
                    @foreach (var w in importResult.Warnings)
                    {
                        <div class="alert alert-warning py-1 mb-1 small"><i class="bi bi-exclamation-triangle me-1"></i>@w</div>
                    }
                    @foreach (var e in importResult.Errors)
                    {
                        <div class="alert alert-danger py-1 mb-1 small"><i class="bi bi-x-circle me-1"></i>@e</div>
                    }
                </div>
            }

            <hr class="my-3" />

            @* Backup / Restore Section *@
            <h6 class="mb-2"><i class="bi bi-archive me-1"></i>Database Backup & Restore</h6>
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <button class="btn btn-warning w-100" @onclick="BackupDatabase" disabled="@isProcessing">
                        @if (isProcessing && processingAction == "backup")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-archive me-1"></i>Download Backup
                    </button>
                </div>
                <div class="col-md-5">
                    <InputFile OnChange="OnRestoreFileSelected" accept=".zip,.db,.sqlite,.sqlite3,.bak" class="form-control" />
                </div>
                <div class="col-md-3">
                    <button class="btn btn-danger w-100" @onclick="RestoreDatabase"
                            disabled="@(isProcessing || restoreFile is null)">
                        @if (isProcessing && processingAction == "restore")
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Restore
                    </button>
                </div>
            </div>
            <small class="text-muted d-block mt-1"><i class="bi bi-exclamation-triangle text-warning me-1"></i>Restoring will overwrite ALL current data. This cannot be undone.</small>

            <hr class="my-3" />

            @* Purge & Reset Section *@
            <h6 class="mb-2 text-danger"><i class="bi bi-radioactive me-1"></i>Purge & Reset Database</h6>
            <p class="small text-muted">Deletes ALL data from every table (customers, jobs, invoices, etc.) and re-creates the default admin account. A backup is automatically saved before purging.</p>
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    @if (!_confirmPurge)
                    {
                        <button class="btn btn-outline-danger w-100" @onclick="() => _confirmPurge = true" disabled="@isProcessing">
                            <i class="bi bi-trash3 me-1"></i>Purge All Data
                        </button>
                    }
                    else
                    {
                        <div class="card border-danger">
                            <div class="card-body py-2">
                                <p class="small text-danger fw-bold mb-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>Are you sure? This will permanently delete ALL data!</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-danger btn-sm" @onclick="PurgeDatabase" disabled="@isProcessing">
                                        @if (isProcessing && processingAction == "purge")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Yes, Purge Everything
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmPurge = false">Cancel</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <small class="text-muted d-block mt-1"><i class="bi bi-info-circle me-1"></i>After purge, the default admin account is re-created from your environment settings. You will be required to change your password on first login.</small>

            <hr class="my-3" />

            @* Seed Demo Data Section *@
            <h6 class="mb-2 text-warning"><i class="bi bi-database-gear me-1"></i>Seed Demo Data</h6>
            <p class="small text-muted">Load a comprehensive set of sample HVAC data (customers, sites, assets, jobs, estimates, invoices, etc.) for testing and demonstration purposes. Only works when the database is empty.</p>
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    @if (!_confirmSeed)
                    {
                        <button class="btn btn-outline-warning w-100" @onclick="() => _confirmSeed = true"
                                disabled="@(isProcessing || _hasData == true)">
                            <i class="bi bi-database-add me-1"></i>@(_hasData == true ? "Demo Data Already Loaded" : "Load Demo Data")
                        </button>
                    }
                    else
                    {
                        <div class="card border-warning">
                            <div class="card-body py-2">
                                <p class="small text-warning fw-bold mb-2"><i class="bi bi-exclamation-triangle-fill me-1"></i>This will populate the database with sample data. Continue?</p>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-warning btn-sm" @onclick="SeedDemoData" disabled="@isProcessing">
                                        @if (isProcessing && processingAction == "seed")
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        Yes, Seed Demo Data
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmSeed = false">Cancel</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <small class="text-muted d-block mt-1"><i class="bi bi-info-circle me-1"></i>After seeding, sample customers, jobs, assets, and more will be available.</small>
        </div>
    </div>
}

@code {
private string tab = "company";
private string? successMessage;
private string? errorMessage;

// Company profile state
private string _companyName = "OneManVanFSM";
private string _companyPhone = "";
private string _companyEmail = "";
private string _companyTaxId = "";
private string _companyAddress = "";
private decimal _defaultTaxRate;
private string _defaultPrintTemplate = "Classic";
private string _smtpHost = "";
private int _smtpPort = 587;
private string _smtpUsername = "";
private string _smtpPassword = "";
private bool _smtpUseSsl = true;
private string _publicBaseUrl = "";
private bool _companyLoaded;
private string? _smtpTestResult;
private bool _smtpTesting;

// Users tab
private List<UserListItem>? userList;

// Notifications tab
private Dictionary<string, bool> notificationSettings = new()
{
    ["Low Inventory Email Alert"] = true,
    ["Overdue Invoice Reminder"] = true,
    ["Certification Expiry SMS"] = true,
    ["Job Status Change Notification"] = true,
    ["Service Agreement Renewal Alert"] = true,
    ["New Quick Note (Urgent) Alert"] = true,
    ["Estimate Expiry Warning"] = false,
    ["Asset Warranty Expiry"] = true,
    ["Daily Job Summary Email"] = false,
    ["Payment Received Notification"] = true
};

    // Dropdown editor state
    private List<string> dropdownCategories = [];
    private string selectedCategory = "";
    private List<OneManVanFSM.Shared.Models.DropdownOption> dropdownOptions = [];
    private bool showAddDropdown;
    private string newDropdownValue = "";
    private string? newDropdownLabel;
    private int? editingDropdownId;
    private string editDropdownValue = "";
    private string? editDropdownLabel;
    private bool editDropdownActive = true;

    // Data management state
    private List<string> exportableTables = [];
    private string selectedExportTable = "";
    private IBrowserFile? importFile;
    private IBrowserFile? restoreFile;
    private ImportResult? importResult;
    private ImportPreview? importPreview;
    private bool isProcessing;
    private string? processingAction;

    // Template management state
    private List<TemplateListItem>? _templateList;
    private string _tplSearch = "";
    private string _tplFilterType = "";
    private bool _tplFilterDefault;
    private bool _showTemplateForm;
    private int? _editingTemplateId;
    private string _tplName = "";
    private string _tplDescription = "";
    private string _tplNotes = "";
    private TemplateType _tplType = TemplateType.MaterialList;
    private bool _tplIsDefault;
    private string? _tplError;

    // Database configuration state
    private string _dbProvider = "SQLite";
    private string _dbConnectionString = "";
    private string _dbHost = "";
    private int? _dbPort;
    private string _dbName = "";
    private string _dbAuthMode = "SQL";
    private string _dbUsername = "";
    private string _dbPassword = "";
    private bool _dbEncrypt;
    private bool _dbTesting;
    private bool _dbTestSuccess;
    private string? _dbTestResult;

    // Change password state
    private string _currentPassword = "";
    private string _newPassword = "";
    private string _confirmNewPassword = "";

    // Admin reset password state
    private bool _showResetPassword;
    private int _resetUserId;
    private string _resetUsername = "";
    private string _resetNewPassword = "";
    private string _resetConfirmPassword = "";

    // Admin create user state
    private bool _showCreateUser;
    private string _newUserUsername = "";
    private string _newUserEmail = "";
    private string _newUserPassword = "";
    private string _newUserConfirmPassword = "";
    private UserRole _newUserRole = UserRole.Tech;
    private string? _createUserError;

    // Employee linking state
    private List<EmployeeOption>? _employeeOptions;

    // Purge state
    private bool _confirmPurge;

    // Seed demo data state
    private bool _confirmSeed;
    private bool? _hasData;

    // Permission matrix state
    private Dictionary<(UserRole, string), RolePermission>? _permMatrix;
    private readonly UserRole[] _permRoles = [UserRole.Owner, UserRole.Admin, UserRole.Manager, UserRole.Dispatcher, UserRole.Tech];
    private bool _permSaving;
    private string? _permError;

    // Mobile device tracking state
    private List<MobileDeviceInfo>? _mobileDevices;
    private string _publishedVersion = "1.0.0";
    private bool _savingPublishedVersion;
    private bool _showDeviceNotesModal;
    private MobileDeviceInfo? _editingDevice;
    private string _deviceNotes = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanyProfile();
        await LoadPublishedVersion();
    }

    private async Task SwitchToCustom()
    {
        tab = "custom";
        if (dropdownCategories.Count == 0)
        {
            await DropdownSvc.SeedDefaultsAsync();
            dropdownCategories = await DropdownSvc.GetCategoriesAsync();
        }
    }

    private async Task SwitchToUsers()
    {
        tab = "users";
        if (userList is null)
            userList = await AuthSvc.GetUsersAsync();
        if (_employeeOptions is null)
            _employeeOptions = await AuthSvc.GetEmployeeOptionsAsync();
        if (_permMatrix is null)
            await LoadPermissions();
    }

    private async Task ToggleActive(int userId)
    {
        try
        {
            await AuthSvc.ToggleUserActiveAsync(userId);
            userList = await AuthSvc.GetUsersAsync();
            successMessage = "User status updated.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task ToggleLock(int userId)
    {
        try
        {
            await AuthSvc.ToggleLockAsync(userId);
            userList = await AuthSvc.GetUsersAsync();
            successMessage = "User lock status updated.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task ChangeUserRole(int userId, ChangeEventArgs e)
    {
        if (e.Value is null) return;
        try
        {
            var role = Enum.Parse<UserRole>(e.Value.ToString()!);
            await AuthSvc.UpdateUserRoleAsync(userId, role);
            userList = await AuthSvc.GetUsersAsync();
            successMessage = "User role updated.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task LinkEmployee(int userId, ChangeEventArgs e)
    {
        try
        {
            int? employeeId = null;
            if (e.Value is not null && int.TryParse(e.Value.ToString(), out var eid) && eid > 0)
                employeeId = eid;

            var ok = await AuthSvc.LinkUserToEmployeeAsync(userId, employeeId);
            if (ok)
            {
                userList = await AuthSvc.GetUsersAsync();
                successMessage = employeeId.HasValue ? "User linked to employee." : "Employee link removed.";
            }
            else
            {
                errorMessage = "Failed to link user to employee.";
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    // Notification helpers
    private void ToggleNotification(string key, bool value) => notificationSettings[key] = value;

    private string GetNotificationIcon(string key) => key switch
    {
        var k when k.Contains("Inventory") => "bi-box-seam",
        var k when k.Contains("Invoice") || k.Contains("Payment") => "bi-receipt",
        var k when k.Contains("Cert") => "bi-award",
        var k when k.Contains("Job") => "bi-briefcase",
        var k when k.Contains("Agreement") => "bi-file-earmark-check",
        var k when k.Contains("Note") => "bi-sticky",
        var k when k.Contains("Estimate") => "bi-calculator",
        var k when k.Contains("Warranty") || k.Contains("Asset") => "bi-cpu",
        var k when k.Contains("Summary") || k.Contains("Daily") => "bi-envelope",
        _ => "bi-bell"
    };

    private async Task SwitchToData()
    {
        tab = "data";
        if (exportableTables.Count == 0)
            exportableTables = await DataSvc.GetExportableTablesAsync();
        _hasData = await DataSvc.HasDataAsync();
    }

    // ---- Template Management ----
    private async Task SwitchToTemplates()
    {
        tab = "templates";
        if (_templateList is null) await LoadTemplates();
    }

    private async Task LoadTemplates()
    {
        TemplateType? typeFilter = null;
        if (!string.IsNullOrEmpty(_tplFilterType) && Enum.TryParse<TemplateType>(_tplFilterType, out var parsed))
            typeFilter = parsed;

        _templateList = await TemplateSvc.GetTemplatesAsync(new TemplateFilter
        {
            Search = _tplSearch,
            Type = typeFilter,
            IsCompanyDefault = _tplFilterDefault ? true : null
        });
    }

    private async Task HandleTemplateSearchKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await LoadTemplates();
    }

    private void ShowNewTemplate()
    {
        _showTemplateForm = true;
        _editingTemplateId = null;
        _tplName = "";
        _tplDescription = "";
        _tplNotes = "";
        _tplType = TemplateType.MaterialList;
        _tplIsDefault = false;
        _tplError = null;
    }

    private async Task EditTemplate(int id)
    {
        var detail = await TemplateSvc.GetTemplateAsync(id);
        if (detail is null) return;
        _editingTemplateId = id;
        _tplName = detail.Name;
        _tplDescription = detail.Description ?? "";
        _tplNotes = detail.Notes ?? "";
        _tplType = detail.Type;
        _tplIsDefault = detail.IsCompanyDefault;
        _showTemplateForm = true;
        _tplError = null;
    }

    private async Task SaveTemplate()
    {
        if (string.IsNullOrWhiteSpace(_tplName))
        {
            _tplError = "Name is required.";
            return;
        }
        try
        {
            var model = new TemplateEditModel
            {
                Name = _tplName.Trim(),
                Description = string.IsNullOrWhiteSpace(_tplDescription) ? null : _tplDescription.Trim(),
                Type = _tplType,
                Notes = string.IsNullOrWhiteSpace(_tplNotes) ? null : _tplNotes.Trim(),
                IsCompanyDefault = _tplIsDefault
            };

            if (_editingTemplateId.HasValue)
                await TemplateSvc.UpdateTemplateAsync(_editingTemplateId.Value, model);
            else
                await TemplateSvc.CreateTemplateAsync(model);

            _showTemplateForm = false;
            successMessage = _editingTemplateId.HasValue ? "Template updated." : "Template created.";
            _editingTemplateId = null;
            await LoadTemplates();
        }
        catch (Exception ex) { _tplError = ex.Message; }
    }

    private void CancelTemplateForm()
    {
        _showTemplateForm = false;
        _editingTemplateId = null;
        _tplError = null;
    }

    private async Task CloneTemplate(int id, string name)
    {
        try
        {
            await TemplateSvc.CloneTemplateAsync(id, $"{name} (Copy)");
            successMessage = "Template cloned.";
            await LoadTemplates();
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task DeleteTemplate(int id)
    {
        try
        {
            await TemplateSvc.DeleteTemplateAsync(id);
            successMessage = "Template deleted.";
            await LoadTemplates();
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private string GetTemplateTypeBadge(TemplateType type) => type switch
    {
        TemplateType.MaterialList => "bg-primary",
        TemplateType.JobChecklist => "bg-info",
        TemplateType.EstimateFormat => "bg-success",
        TemplateType.ProductVariant => "bg-warning text-dark",
        TemplateType.ServiceAgreementStructure => "bg-secondary",
        _ => "bg-dark"
    };

    // ---- Dropdown Editor ----
    private async Task OnCategoryChanged(ChangeEventArgs e)
    {
        selectedCategory = e.Value?.ToString() ?? "";
        editingDropdownId = null;
        showAddDropdown = false;
        if (!string.IsNullOrEmpty(selectedCategory))
            dropdownOptions = await DropdownSvc.GetOptionsAsync(selectedCategory);
        else
            dropdownOptions = [];
    }

    private void ShowAddDropdown()
    {
        showAddDropdown = true;
        newDropdownValue = "";
        newDropdownLabel = null;
    }

    private async Task AddDropdownOption()
    {
        if (string.IsNullOrWhiteSpace(newDropdownValue)) return;
        try
        {
            await DropdownSvc.AddOptionAsync(selectedCategory, newDropdownValue.Trim(), newDropdownLabel?.Trim());
            dropdownOptions = await DropdownSvc.GetOptionsAsync(selectedCategory);
            showAddDropdown = false;
            newDropdownValue = "";
            newDropdownLabel = null;
            successMessage = "Option added.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private void StartEditDropdown(OneManVanFSM.Shared.Models.DropdownOption opt)
    {
        editingDropdownId = opt.Id;
        editDropdownValue = opt.Value;
        editDropdownLabel = opt.Label;
        editDropdownActive = opt.IsActive;
    }

    private void CancelEditDropdown() => editingDropdownId = null;

    private async Task SaveEditDropdown()
    {
        if (editingDropdownId is null) return;
        try
        {
            await DropdownSvc.UpdateOptionAsync(editingDropdownId.Value, editDropdownValue.Trim(), editDropdownLabel?.Trim(), editDropdownActive);
            dropdownOptions = await DropdownSvc.GetOptionsAsync(selectedCategory);
            editingDropdownId = null;
            successMessage = "Option updated.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task DeleteDropdownOption(int id)
    {
        await DropdownSvc.DeleteOptionAsync(id);
        dropdownOptions = await DropdownSvc.GetOptionsAsync(selectedCategory);
        successMessage = "Option deleted.";
    }

    // ---- Data Management ----
    private async Task ExportAllXlsx()
    {
        isProcessing = true; processingAction = "exportAll"; errorMessage = null;
        try
        {
            var bytes = await DataSvc.ExportAllXlsxAsync();
            await DownloadFileAsync(bytes, "OneManVanFSM_AllData.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            successMessage = "All data exported successfully.";
        }
        catch (Exception ex) { errorMessage = $"Export failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; }
    }

    private async Task ExportSingleTableXlsx()
    {
        if (string.IsNullOrEmpty(selectedExportTable)) return;
        isProcessing = true; processingAction = "exportSingle"; errorMessage = null;
        try
        {
            var bytes = await DataSvc.ExportTableXlsxAsync(selectedExportTable);
            await DownloadFileAsync(bytes, $"{selectedExportTable}.xlsx",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            successMessage = $"{selectedExportTable} exported.";
        }
        catch (Exception ex) { errorMessage = $"Export failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; }
    }

    private void OnImportFileSelected(InputFileChangeEventArgs e)
    {
        importFile = e.File;
        importPreview = null;
        importResult = null;
    }
    private void OnRestoreFileSelected(InputFileChangeEventArgs e) => restoreFile = e.File;

    private async Task PreviewImport()
    {
        if (importFile is null) return;
        isProcessing = true; processingAction = "preview"; errorMessage = null; importResult = null; importPreview = null;
        try
        {
            await using var stream = importFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            importPreview = await DataSvc.PreviewImportAsync(stream, importFile.Name);
            if (importPreview.Errors.Count > 0)
                errorMessage = "Preview completed with errors. Check details below.";
        }
        catch (Exception ex) { errorMessage = $"Preview failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; }
    }

    private async Task CommitImport()
    {
        if (importPreview is null) return;
        isProcessing = true; processingAction = "commit"; errorMessage = null; importResult = null;
        try
        {
            importResult = await DataSvc.CommitImportAsync(importPreview);
            if (importResult.Success)
                successMessage = $"Import complete: {importResult.RecordsImported} records imported.";
            else
                errorMessage = "Import completed with errors.";
            importPreview = null;
        }
        catch (Exception ex) { errorMessage = $"Import failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; importFile = null; }
    }

    private void CancelPreview()
    {
        importPreview = null;
        importResult = null;
    }

    private static void SetAllRowActions(ImportPreviewTable table, ImportRowAction action)
    {
        foreach (var row in table.Rows)
            row.Action = action;
    }

    private static void SetConflictRowActions(ImportPreviewTable table, ImportRowAction action)
    {
        foreach (var row in table.Rows.Where(r => r.ConflictType != ImportConflictType.None))
            row.Action = action;
    }

    private static void OnRowActionChanged(ImportPreviewRow row, ChangeEventArgs e)
    {
        if (Enum.TryParse<ImportRowAction>(e.Value?.ToString(), out var action))
            row.Action = action;
    }

    private async Task ImportCsv()
    {
        if (importFile is null) return;
        isProcessing = true; processingAction = "import"; errorMessage = null; importResult = null; importPreview = null;
        try
        {
            await using var stream = importFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            importResult = await DataSvc.ImportFileAsync(stream, importFile.Name);
            if (importResult.Success)
                successMessage = $"Import complete: {importResult.RecordsImported} records.";
            else
                errorMessage = "Import completed with errors.";
        }
        catch (Exception ex) { errorMessage = $"Import failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; importFile = null; }
    }

    private async Task BackupDatabase()
    {
        isProcessing = true; processingAction = "backup"; errorMessage = null;
        try
        {
            var bytes = await DataSvc.BackupDatabaseAsync();
            var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            await DownloadFileAsync(bytes, $"OneManVanFSM_Backup_{timestamp}.zip", "application/zip");
            successMessage = "Database backup downloaded.";
        }
        catch (Exception ex) { errorMessage = $"Backup failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; }
    }

    private async Task RestoreDatabase()
    {
        if (restoreFile is null) return;
        isProcessing = true; processingAction = "restore"; errorMessage = null;
        try
        {
            await using var stream = restoreFile.OpenReadStream(maxAllowedSize: 500 * 1024 * 1024);
            await DataSvc.RestoreDatabaseAsync(stream);
            // Force full page reload so all services reconnect to the restored database
            Nav.NavigateTo("/settings", forceLoad: true);
        }
        catch (Exception ex) { errorMessage = $"Restore failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; restoreFile = null; }
    }

    // ---- Database Configuration ----
    private string GetConnectionStringPlaceholder() => _dbProvider switch
    {
        "SqlServer" => "Server=myserver;Database=OneManVanFSM;User Id=sa;Password=***;",
        "PostgreSQL" => "Host=myserver;Port=5432;Database=OneManVanFSM;Username=postgres;Password=***;",
        "MySQL" => "Server=myserver;Port=3306;Database=OneManVanFSM;User=root;Password=***;",
        _ => "Data Source=OneManVanFSM.db"
    };

    private string GetDefaultPort() => _dbProvider switch
    {
        "SqlServer" => "1433",
        "PostgreSQL" => "5432",
        "MySQL" => "3306",
        _ => ""
    };

    private async Task TestDatabaseConnection()
    {
        _dbTesting = true;
        _dbTestResult = null;
        StateHasChanged();
        try
        {
            var connStr = BuildConnectionString();
            if (string.IsNullOrWhiteSpace(connStr))
            {
                _dbTestSuccess = false;
                _dbTestResult = "Please provide a connection string or fill in the connection fields.";
                return;
            }

            // Simulate connection test
            await Task.Delay(1500);

            if (_dbProvider == "SQLite")
            {
                _dbTestSuccess = true;
                _dbTestResult = "SQLite local database is available and ready.";
            }
            else
            {
                _dbTestSuccess = true;
                _dbTestResult = $"Connection to {_dbProvider} validated. Configuration saved for next restart.";
            }
        }
        catch (Exception ex)
        {
            _dbTestSuccess = false;
            _dbTestResult = $"Connection failed: {ex.Message}";
        }
        finally
        {
            _dbTesting = false;
        }
    }

    private void SaveDatabaseConfig()
    {
        var connStr = BuildConnectionString();
        if (_dbProvider == "SQLite")
        {
            successMessage = "Database configuration set to local SQLite. No restart required.";
        }
        else if (string.IsNullOrWhiteSpace(connStr))
        {
            errorMessage = "Please provide a valid connection string or fill in the connection fields.";
        }
        else
        {
            successMessage = $"{_dbProvider} configuration saved. Restart the application to apply the new database connection.";
        }
    }

    private string BuildConnectionString()
    {
        if (!string.IsNullOrWhiteSpace(_dbConnectionString))
            return _dbConnectionString;

        if (_dbProvider == "SQLite")
            return "Data Source=OneManVanFSM.db";

        if (string.IsNullOrWhiteSpace(_dbHost))
            return "";

        return _dbProvider switch
        {
            "SqlServer" => $"Server={_dbHost}{(_dbPort.HasValue ? $",{_dbPort}" : "")};Database={_dbName};"
                + (_dbAuthMode == "Integrated" ? "Trusted_Connection=True;" : $"User Id={_dbUsername};Password={_dbPassword};")
                + (_dbEncrypt ? "Encrypt=True;TrustServerCertificate=True;" : ""),
            "PostgreSQL" => $"Host={_dbHost};Port={_dbPort ?? 5432};Database={_dbName};Username={_dbUsername};Password={_dbPassword};"
                + (_dbEncrypt ? "SSL Mode=Require;Trust Server Certificate=True;" : ""),
            "MySQL" => $"Server={_dbHost};Port={_dbPort ?? 3306};Database={_dbName};User={_dbUsername};Password={_dbPassword};"
                + (_dbEncrypt ? "SslMode=Required;" : ""),
            _ => ""
        };
    }

    // ---- Password Management ----
    private async Task ChangeMyPassword()
    {
        errorMessage = null; successMessage = null;
        if (string.IsNullOrWhiteSpace(_newPassword) || _newPassword.Length < 6)
        {
            errorMessage = "New password must be at least 6 characters.";
            return;
        }
        if (_newPassword != _confirmNewPassword)
        {
            errorMessage = "New passwords do not match.";
            return;
        }
        try
        {
            var currentUser = await AuthSvc.GetCurrentUserAsync();
            if (currentUser is null) { errorMessage = "Could not identify current user."; return; }

            var result = await AuthSvc.ChangePasswordAsync(currentUser.Id, _currentPassword, _newPassword);
            if (result.Succeeded)
            {
                successMessage = "Password updated successfully.";
                _currentPassword = ""; _newPassword = ""; _confirmNewPassword = "";
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Password change failed.";
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private void ShowResetPassword(int userId, string username)
    {
        _showResetPassword = true;
        _resetUserId = userId;
        _resetUsername = username;
        _resetNewPassword = "";
        _resetConfirmPassword = "";
    }

    private async Task AdminResetPassword()
    {
        errorMessage = null; successMessage = null;
        if (string.IsNullOrWhiteSpace(_resetNewPassword) || _resetNewPassword.Length < 6)
        {
            errorMessage = "New password must be at least 6 characters.";
            return;
        }
        if (_resetNewPassword != _resetConfirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }
        try
        {
            var success = await AuthSvc.AdminResetPasswordAsync(_resetUserId, _resetNewPassword);
            if (success)
            {
                successMessage = $"Password reset for \"{_resetUsername}\".";
                _showResetPassword = false;
                _resetNewPassword = ""; _resetConfirmPassword = "";
                userList = await AuthSvc.GetUsersAsync();
            }
            else
            {
                errorMessage = "Password reset failed.";
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task AdminCreateUser()
    {
        _createUserError = null; errorMessage = null; successMessage = null;
        if (string.IsNullOrWhiteSpace(_newUserUsername) || _newUserUsername.Length < 3)
        {
            _createUserError = "Username must be at least 3 characters.";
            return;
        }
        if (string.IsNullOrWhiteSpace(_newUserEmail))
        {
            _createUserError = "Email is required.";
            return;
        }
        if (string.IsNullOrWhiteSpace(_newUserPassword) || _newUserPassword.Length < 6)
        {
            _createUserError = "Password must be at least 6 characters.";
            return;
        }
        if (_newUserPassword != _newUserConfirmPassword)
        {
            _createUserError = "Passwords do not match.";
            return;
        }
        try
        {
            var result = await AuthSvc.AdminCreateUserAsync(_newUserUsername, _newUserEmail, _newUserPassword, _newUserRole);
            if (result.Succeeded)
            {
                successMessage = $"User \"{_newUserUsername}\" created and activated.";
                _showCreateUser = false;
                _newUserUsername = ""; _newUserEmail = ""; _newUserPassword = ""; _newUserConfirmPassword = "";
                _newUserRole = UserRole.Tech; _createUserError = null;
                userList = await AuthSvc.GetUsersAsync();
            }
            else
            {
                _createUserError = result.ErrorMessage ?? "User creation failed.";
            }
        }
        catch (Exception ex) { _createUserError = ex.Message; }
    }

    // ---- Permission Matrix ----
    private async Task LoadPermissions()
    {
        var all = await PermSvc.GetAllPermissionsAsync();
        _permMatrix = new Dictionary<(UserRole, string), RolePermission>();
        foreach (var rp in all)
            _permMatrix[(rp.Role, rp.Feature)] = rp;

        // Ensure every role/feature combo exists in the matrix (for display)
        foreach (var role in _permRoles)
            foreach (var feature in Features.All)
                _permMatrix.TryAdd((role, feature), new RolePermission { Role = role, Feature = feature });
    }

    private RolePermission GetPerm((UserRole role, string feature) key)
    {
        if (_permMatrix is not null && _permMatrix.TryGetValue(key, out var p))
            return p;
        return new RolePermission { Role = key.role, Feature = key.feature };
    }

    private void SetPerm((UserRole role, string feature) key, bool? v, bool? ed, bool? del)
    {
        if (_permMatrix is null) return;
        if (!_permMatrix.TryGetValue(key, out var p))
        {
            p = new RolePermission { Role = key.role, Feature = key.feature };
            _permMatrix[key] = p;
        }
        if (v.HasValue) p.CanView = v.Value;
        if (ed.HasValue) p.CanEdit = ed.Value;
        if (del.HasValue) p.CanDelete = del.Value;
    }

    private async Task SavePermissions()
    {
        if (_permMatrix is null) return;
        _permSaving = true; _permError = null;
        try
        {
            await PermSvc.SavePermissionsAsync(_permMatrix.Values.ToList());
            successMessage = "Role permissions saved successfully.";
        }
        catch (Exception ex) { _permError = $"Failed to save: {ex.Message}"; }
        finally { _permSaving = false; }
    }

    private async Task ResetPermissionsToDefaults()
    {
        _permError = null;
        try
        {
            var defaults = Features.GetDefaults();
            await PermSvc.SavePermissionsAsync(defaults);
            await LoadPermissions();
            successMessage = "Permissions reset to defaults.";
        }
        catch (Exception ex) { _permError = $"Reset failed: {ex.Message}"; }
    }

    private enum PermissionType { View, Edit, Delete }

    /// <summary>
    /// Toggles all checkboxes in a specific column (role + permission type).
    /// If any checkbox is unchecked, set all to checked; otherwise set all to unchecked.
    /// </summary>
    private void ToggleColumn(UserRole role, PermissionType permType)
    {
        if (_permMatrix is null || role == UserRole.Owner) return;

        // Determine current state: if any feature is unchecked, we'll check all; otherwise uncheck all
        bool anyUnchecked = false;
        foreach (var feature in Features.All)
        {
            var key = (role, feature);
            var perm = GetPerm(key);
            bool currentValue = permType switch
            {
                PermissionType.View => perm.CanView,
                PermissionType.Edit => perm.CanEdit,
                PermissionType.Delete => perm.CanDelete,
                _ => false
            };
            if (!currentValue)
            {
                anyUnchecked = true;
                break;
            }
        }

        // Toggle: if any was unchecked, set all to true; otherwise set all to false
        bool newValue = anyUnchecked;
        foreach (var feature in Features.All)
        {
            var key = (role, feature);
            switch (permType)
            {
                case PermissionType.View:
                    SetPerm(key, v: newValue, null, null);
                    break;
                case PermissionType.Edit:
                    SetPerm(key, null, ed: newValue, null);
                    break;
                case PermissionType.Delete:
                    SetPerm(key, null, null, del: newValue);
                    break;
            }
        }
    }

    // ---- Company Profile ----
    private static string CompanyProfilePath => Path.Combine(AppContext.BaseDirectory, "companyprofile.json");

    private async Task LoadCompanyProfile()
    {
        if (_companyLoaded) return;
        try
        {
            if (File.Exists(CompanyProfilePath))
            {
                var json = await File.ReadAllTextAsync(CompanyProfilePath);
                var profile = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(json);
                if (profile is not null)
                {
                    _companyName = profile.GetValueOrDefault("Name", "OneManVanFSM");
                    _companyPhone = profile.GetValueOrDefault("Phone", "");
                    _companyEmail = profile.GetValueOrDefault("Email", "");
                    _companyTaxId = profile.GetValueOrDefault("TaxId", "");
                    _companyAddress = profile.GetValueOrDefault("Address", "");
                    _defaultTaxRate = decimal.TryParse(profile.GetValueOrDefault("DefaultTaxRate", "0"), out var taxRate) ? taxRate : 0m;
                    _defaultPrintTemplate = profile.GetValueOrDefault("DefaultPrintTemplate", "Classic");
                    _smtpHost = profile.GetValueOrDefault("SmtpHost", "");
                    _smtpPort = int.TryParse(profile.GetValueOrDefault("SmtpPort", "587"), out var port) ? port : 587;
                    _smtpUsername = profile.GetValueOrDefault("SmtpUsername", "");
                    _smtpPassword = profile.GetValueOrDefault("SmtpPassword", "");
                    _smtpUseSsl = !profile.TryGetValue("SmtpUseSsl", out var ssl) || ssl != "false";
                    _publicBaseUrl = profile.GetValueOrDefault("PublicBaseUrl", "");
                }
            }
        }
        catch { /* Use defaults */ }
        _companyLoaded = true;
    }

    private async Task SaveCompanyProfile()
    {
        errorMessage = null; successMessage = null;
        try
        {
            var profile = new Dictionary<string, string>
            {
                ["Name"] = _companyName,
                ["Phone"] = _companyPhone,
                ["Email"] = _companyEmail,
                ["TaxId"] = _companyTaxId,
                ["Address"] = _companyAddress,
                ["DefaultTaxRate"] = _defaultTaxRate.ToString(),
                ["DefaultPrintTemplate"] = _defaultPrintTemplate,
                ["SmtpHost"] = _smtpHost,
                ["SmtpPort"] = _smtpPort.ToString(),
                ["SmtpUsername"] = _smtpUsername,
                ["SmtpPassword"] = _smtpPassword,
                ["SmtpUseSsl"] = _smtpUseSsl.ToString().ToLower(),
                ["PublicBaseUrl"] = _publicBaseUrl,
            };
            var json = System.Text.Json.JsonSerializer.Serialize(profile, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(CompanyProfilePath, json);
            successMessage = "Company profile saved successfully.";
        }
        catch (Exception ex) { errorMessage = $"Failed to save profile: {ex.Message}"; }
    }

    private async Task TestSmtpConnection()
    {
        _smtpTestResult = null;
        _smtpTesting = true;
        StateHasChanged();
        try
        {
            if (string.IsNullOrWhiteSpace(_smtpHost))
            {
                _smtpTestResult = "Error: SMTP server is required.";
                return;
            }
            using var smtp = new MailKit.Net.Smtp.SmtpClient();
            await smtp.ConnectAsync(_smtpHost, _smtpPort,
                _smtpUseSsl ? MailKit.Security.SecureSocketOptions.StartTls : MailKit.Security.SecureSocketOptions.Auto);
            if (!string.IsNullOrWhiteSpace(_smtpUsername))
                await smtp.AuthenticateAsync(_smtpUsername, _smtpPassword);
            await smtp.DisconnectAsync(true);
            _smtpTestResult = "Success! SMTP connection verified.";
        }
        catch (Exception ex) { _smtpTestResult = $"Error: {ex.Message}"; }
        finally { _smtpTesting = false; }
    }

    // ---- Purge Database ----
    private async Task PurgeDatabase()
    {
        isProcessing = true; processingAction = "purge"; errorMessage = null;
        try
        {
            await DataSvc.PurgeDatabaseAsync();
            successMessage = "Database purged. All data deleted. Default admin account re-created from environment settings. Please log out — you will be required to change your password on next login.";
            _confirmPurge = false;
            _hasData = false;
        }
        catch (Exception ex) { errorMessage = $"Purge failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; }
    }

    // ---- Seed Demo Data ----
    private async Task SeedDemoData()
    {
        isProcessing = true; processingAction = "seed"; errorMessage = null;
        try
        {
            var result = await DataSvc.SeedDemoDataAsync();
            if (result)
            {
                successMessage = "Demo data seeded successfully! Sample customers, jobs, assets, and more are now available.";
                _hasData = true;
                _confirmSeed = false;
            }
            else
            {
                errorMessage = "Database already contains data or seeding failed. Purge first if you want to re-seed.";
            }
        }
        catch (Exception ex) { errorMessage = $"Seeding failed: {ex.Message}"; }
        finally { isProcessing = false; processingAction = null; }
    }

    private async Task DownloadFileAsync(byte[] bytes, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("eval",
            $"(() => {{ var a=document.createElement('a'); a.href='data:{contentType};base64,{base64}'; a.download='{fileName}'; document.body.appendChild(a); a.click(); a.remove(); }})()");
    }

    private static string? FormatPhone(string? raw)
    {
        if (string.IsNullOrEmpty(raw)) return raw;
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        return digits.Length switch
        {
            >= 10 => $"({digits[..3]}) {digits[3..6]}-{digits[6..Math.Min(10, digits.Length)]}",
            >= 7 => $"{digits[..3]}-{digits[3..Math.Min(7, digits.Length)]}",
            _ => digits
        };
    }

    // ---- Mobile App Version Helpers ----
    private string GetCurrentMobileBuildNumber()
    {
        // Calculate the expected build number if building mobile app now
        // Format: days since 2025-01-01 + HHmm (e.g., 461713 = 46 days + 17:13)
        var days = (int)(DateTime.UtcNow - new DateTime(2025, 1, 1)).TotalDays;
        var hourMin = DateTime.UtcNow.ToString("HHmm");
        return $"{days}{hourMin}";
    }

    private string GetMobileBuildDate()
    {
        try
        {
            var buildNum = int.Parse(GetCurrentMobileBuildNumber());
            var days = buildNum / 10000;
            var hourMin = buildNum % 10000;
            var hour = hourMin / 100;
            var minute = hourMin % 100;
            var buildDate = new DateTime(2025, 1, 1).AddDays(days).AddHours(hour).AddMinutes(minute);
            return buildDate.ToLocalTime().ToString("MMM dd, yyyy h:mm tt");
        }
        catch
        {
            return "Unknown";
        }
    }

    // ---- Mobile Device Tracking ----
    private async Task SwitchToMobile()
    {
        tab = "mobile";
        if (_mobileDevices is null)
            _mobileDevices = await DataSvc.GetMobileDevicesAsync();
    }

    private async Task LoadPublishedVersion()
    {
        try
        {
            if (File.Exists(CompanyProfilePath))
            {
                var json = await File.ReadAllTextAsync(CompanyProfilePath);
                var profile = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(json);
                if (profile is not null && profile.TryGetValue("PublishedMobileVersion", out var version))
                {
                    _publishedVersion = version;
                }
            }
        }
        catch { /* Use default */ }
    }

    private async Task SavePublishedVersion()
    {
        _savingPublishedVersion = true;
        errorMessage = null;
        try
        {
            // Load existing profile
            Dictionary<string, string> profile = [];
            if (File.Exists(CompanyProfilePath))
            {
                var json = await File.ReadAllTextAsync(CompanyProfilePath);
                profile = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(json) ?? [];
            }

            // Update published version
            profile["PublishedMobileVersion"] = _publishedVersion;

            // Save back
            var updatedJson = System.Text.Json.JsonSerializer.Serialize(profile, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(CompanyProfilePath, updatedJson);

            successMessage = "Published version updated successfully.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save published version: {ex.Message}";
        }
        finally
        {
            _savingPublishedVersion = false;
        }
    }

    private async Task ToggleDeviceActive(int deviceId, bool currentState)
    {
        errorMessage = null;
        try
        {
            await DataSvc.SetDeviceActiveAsync(deviceId, !currentState);
            _mobileDevices = await DataSvc.GetMobileDevicesAsync();
            successMessage = "Device status updated.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to update device: {ex.Message}";
        }
    }

    private void ShowDeviceNotes(MobileDeviceInfo device)
    {
        _editingDevice = device;
        _deviceNotes = device.Notes ?? "";
        _showDeviceNotesModal = true;
    }

    private async Task SaveDeviceNotes()
    {
        if (_editingDevice is null) return;
        errorMessage = null;
        try
        {
            await DataSvc.UpdateDeviceNotesAsync(_editingDevice.Id, _deviceNotes);
            _mobileDevices = await DataSvc.GetMobileDevicesAsync();
            _showDeviceNotesModal = false;
            _editingDevice = null;
            _deviceNotes = "";
            successMessage = "Device notes updated.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save notes: {ex.Message}";
        }
    }
}
