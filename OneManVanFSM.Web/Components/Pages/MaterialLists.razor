@page "/materiallists"
@page "/materiallists/new"
@page "/materiallists/{Id:int}"
@page "/materiallists/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject IMaterialListService ListSvc
@inject ICustomerService CustomerSvc
@inject ISiteService SiteSvc
@inject IJobService JobSvc
@inject IInventoryService InvSvc
@inject ICompanyProfileService CompanyProfileSvc
@inject IEmailService EmailSvc
@inject IPdfService PdfSvc
@inject NavigationManager Nav

@inject IJSRuntime JS

<PageTitle>Material Lists - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        @if (editId.HasValue)
        {
            <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToPrevListEdit" disabled="@(GetAdjacentListEditId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
            <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToNextListEdit" disabled="@(GetAdjacentListEditId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        }
        <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>@(editId.HasValue ? "Edit" : "New") Material List</h4>
    </div>

    @* Template selector — only on new list *@
    @if (!editId.HasValue && _templates.Any())
    {
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label small fw-semibold"><i class="bi bi-clipboard-check me-1"></i>Start from Template</label>
                        <select class="form-select form-select-sm" @onchange="OnTemplateSelected">
                            <option value="">— Blank List —</option>
                            @foreach (var t in _templates)
                            {
                                <option value="@t.Id">@t.Name (@t.ItemCount items)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 text-muted small pt-2">
                        <i class="bi bi-info-circle me-1"></i>Selecting a template will clone its sections and items into this new list.
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveList">
                <DataAnnotationsValidator />
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <InputText @bind-Value="form.Name" class="form-control" />
                        <ValidationMessage For="() => form.Name" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Pricing Method</label>
                        <InputSelect @bind-Value="form.PricingMethod" class="form-select">
                            @foreach (var p in Enum.GetValues<PricingMethod>()) { <option value="@p">@p</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in Enum.GetValues<MaterialListStatus>()) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Trade Type</label>
                        <InputText @bind-Value="form.TradeType" class="form-control" placeholder="HVAC" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Template</label>
                        <div class="form-check mt-2">
                            <InputCheckbox @bind-Value="form.IsTemplate" class="form-check-input" />
                            <label class="form-check-label">Is Template</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">PO Number</label>
                        <InputText @bind-Value="form.PONumber" class="form-control" placeholder="Supply house PO / reference" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Job</label>
                        <InputSelect @bind-Value="form.JobId" class="form-select">
                            <option value="">— No Job —</option>
                            @foreach (var j in _jobs)
                            {
                                <option value="@j.Id">@j.Display</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer</label>
                        <InputSelect @bind-Value="form.CustomerId" @bind-Value:after="OnMaterialCustomerChanged" class="form-select">
                            <option value="">— Select Customer —</option>
                            @foreach (var c in _customers)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Site</label>
                        <InputSelect @bind-Value="form.SiteId" class="form-select">
                            <option value="">— Select Site —</option>
                            @foreach (var s in _sites)
                            {
                                <option value="@s.Id">@s.Name @(s.CustomerName is not null ? $"[{s.CustomerName}]" : "")</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Internal Notes <small class="text-muted">(not shown on customer printouts)</small></label>
                        <InputTextArea @bind-Value="form.InternalNotes" class="form-control" rows="2" placeholder="Internal reference, supplier contacts, etc." />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">External Notes <small class="text-muted">(included on customer/supply house printouts)</small></label>
                        <InputTextArea @bind-Value="form.ExternalNotes" class="form-control" rows="2" placeholder="Delivery instructions, special requirements, etc." />
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2 align-items-center">
                    @if (!string.IsNullOrEmpty(_savedMsg)) { <span class="text-success small"><i class="bi bi-check-circle me-1"></i>@_savedMsg</span> }
                    <button type="submit" class="btn btn-outline-primary" @onclick="() => _closeAfterSave = false"><i class="bi bi-floppy me-1"></i>Save</button>
                    <button type="submit" class="btn btn-primary" @onclick="() => _closeAfterSave = true"><i class="bi bi-check-circle me-1"></i>Save & Close</button>
                    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="GoToList">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && detail is not null)
{
    <div class="d-flex align-items-center mb-3 no-print">
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToList" title="Back to list"><i class="bi bi-arrow-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm me-1" @onclick="GoToPrevList" disabled="@(GetAdjacentListId(-1) is null)" title="Previous"><i class="bi bi-chevron-left"></i></button>
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToNextList" disabled="@(GetAdjacentListId(1) is null)" title="Next"><i class="bi bi-chevron-right"></i></button>
        <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>@detail.Name</h4>
        @if (detail.IsTemplate) { <span class="badge bg-info ms-2">Template</span> }
        <span class="badge ms-1 @StatusBadgeClass(detail.Status)">@detail.Status</span>
        <span class="badge bg-secondary ms-1">@detail.PricingMethod</span>
        @if (!string.IsNullOrEmpty(detail.TradeType)) { <span class="badge bg-dark ms-1">@detail.TradeType</span> }
        <div class="ms-auto d-flex gap-1">
            @* Status workflow buttons *@
            @if (detail.Status == MaterialListStatus.Draft)
            {
                <button class="btn btn-success btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Approved)" title="Approve this list"><i class="bi bi-check-circle me-1"></i>Approve</button>
            }
            else if (detail.Status == MaterialListStatus.Approved)
            {
                <button class="btn btn-primary btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Ordered)" title="Mark as ordered"><i class="bi bi-truck me-1"></i>Mark Ordered</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Draft)" title="Return to draft"><i class="bi bi-arrow-counterclockwise me-1"></i>Back to Draft</button>
            }
            else if (detail.Status == MaterialListStatus.Ordered)
            {
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Approved)" title="Return to approved"><i class="bi bi-arrow-counterclockwise me-1"></i>Back to Approved</button>
            }
            @if (detail.Status != MaterialListStatus.Draft && !detail.JobId.HasValue)
            {
                <button class="btn btn-outline-primary btn-sm" @onclick="CreateJobFromList" title="Create a job from this material list"><i class="bi bi-wrench me-1"></i>Create Job</button>
            }
            <div class="form-check form-switch d-inline-flex align-items-center ms-1">
                <input class="form-check-input" type="checkbox" id="chkPrices" @bind="_includePricesOnPdf" />
                <label class="form-check-label small ms-1" for="chkPrices">Prices</label>
            </div>
            <button class="btn btn-outline-success btn-sm" @onclick="() => PrintList(false)" title="Print for Customer"><i class="bi bi-printer me-1"></i>Customer PDF</button>
            <button class="btn btn-outline-warning btn-sm" @onclick="() => PrintList(true)" title="Print for Supply House (no prices)"><i class="bi bi-box-seam me-1"></i>Supply PDF</button>
            @if (!string.IsNullOrEmpty(detail.CustomerName))
            {
                <button class="btn btn-outline-info btn-sm" @onclick="EmailList" title="Email material list"><i class="bi bi-envelope me-1"></i>Email</button>
            }
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-gear me-1"></i>Actions</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item" @onclick="EditDetail"><i class="bi bi-pencil me-1"></i>Edit</button></li>
                    <li><button class="dropdown-item" @onclick="ConvertToEstimate"><i class="bi bi-calculator me-1"></i>Convert to Estimate</button></li>
                    <li><button class="dropdown-item" @onclick="CheckStock"><i class="bi bi-box-seam me-1"></i>Check Inventory Stock</button></li>
                    <li><hr class="dropdown-divider" /></li>
                    @if (_confirmArchive)
                    {
                        <li><button class="dropdown-item text-danger fw-semibold" @onclick="ArchiveDetail"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Archive</button></li>
                        <li><button class="dropdown-item" @onclick="() => _confirmArchive = false"><i class="bi bi-x-lg me-1"></i>Cancel</button></li>
                    }
                    else
                    {
                        <li><button class="dropdown-item text-danger" @onclick="() => _confirmArchive = true"><i class="bi bi-archive me-1"></i>Archive</button></li>
                    }
                </ul>
            </div>
        </div>
    </div>

    @* Stock check results *@
    @if (_stockChecks is not null && _stockChecks.Any(s => s.IsLow))
    {
        <div class="alert alert-warning mb-3 no-print">
            <strong><i class="bi bi-exclamation-triangle me-1"></i>Low Stock Warning:</strong>
            @foreach (var s in _stockChecks.Where(s => s.IsLow))
            {
                <span class="d-block small">@s.ItemName — Need @s.RequestedQty, only @s.AvailableQty available</span>
            }
        </div>
    }

    @* Print options — visible only on screen *@
    <div class="card border-0 shadow-sm mb-3 no-print">
        <div class="card-body py-2">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <strong class="small"><i class="bi bi-sliders me-1"></i>Print Options:</strong>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="printExtNotes" @bind="_printExternalNotes" />
                    <label class="form-check-label small" for="printExtNotes">Include External Notes</label>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="printIntNotes" @bind="_printInternalNotes" />
                    <label class="form-check-label small" for="printIntNotes">Include Internal Notes</label>
                </div>
            </div>
        </div>
    </div>

    @* Print-only professional document *@
    <div class="print-doc d-none">
        <div class="print-doc-banner">
            <div class="print-doc-banner-left">
                <p class="print-doc-type">Material List</p>
                <p class="print-doc-number-line"><strong>@detail.Name</strong>@(!string.IsNullOrEmpty(detail.PONumber) ? $" — PO# {detail.PONumber}" : "")</p>
            </div>
            <div class="print-doc-banner-right">
                @if (_companyProfile is not null)
                {
                    <p class="print-company-name">@_companyProfile.Name</p>
                    @if (!string.IsNullOrWhiteSpace(_companyProfile.Address)) { <p class="print-company-detail">@_companyProfile.Address</p> }
                    @if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) { <p class="print-company-detail">@_companyProfile.Phone</p> }
                    @if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) { <p class="print-company-detail">@_companyProfile.Email</p> }
                }
            </div>
        </div>
        <div class="print-doc-info-bar">
            <div class="print-info-item"><span class="print-info-label">Status</span><span class="print-info-value">@detail.Status</span></div>
            <div class="print-info-item"><span class="print-info-label">Date</span><span class="print-info-value">@detail.CreatedAt.ToString("MMM dd, yyyy")</span></div>
            @if (!string.IsNullOrWhiteSpace(detail.TradeType)) { <div class="print-info-item"><span class="print-info-label">Trade</span><span class="print-info-value">@detail.TradeType</span></div> }
            <div class="print-info-item"><span class="print-info-label">Pricing</span><span class="print-info-value">@detail.PricingMethod</span></div>
        </div>
        <div class="print-doc-addresses">
            @if (!string.IsNullOrEmpty(detail.CustomerName))
            {
                <div class="print-addr-block">
                    <span class="print-addr-label">Customer</span>
                    <p class="print-addr-name">@detail.CustomerName</p>
                    @if (!string.IsNullOrEmpty(detail.CustomerAddress)) { <p class="print-addr-line">@detail.CustomerAddress</p> }
                </div>
            }
            @if (!string.IsNullOrEmpty(detail.SiteName))
            {
                <div class="print-addr-block">
                    <span class="print-addr-label">Deliver To / Site</span>
                    <p class="print-addr-name">@detail.SiteName</p>
                    @if (!string.IsNullOrEmpty(detail.SiteAddress)) { <p class="print-addr-line">@detail.SiteAddress</p> }
                </div>
            }
        </div>

        @if (detail.Items.Any())
        {
            var sections = detail.Items.OrderBy(i => i.SortOrder).GroupBy(i => i.Section ?? "General");
            <table class="print-doc-table">
                <thead><tr><th>Item</th><th class="text-center">Qty</th><th>Unit</th><th class="text-end print-price-col">Cost</th><th class="text-end print-price-col">Price</th></tr></thead>
                <tbody>
                    @foreach (var grp in sections)
                    {
                        @if (sections.Count() > 1)
                        {
                            <tr class="print-section-divider"><td colspan="5">@grp.Key</td></tr>
                        }
                        @foreach (var item in grp)
                        {
                            <tr>
                                <td>@item.ItemName@(!string.IsNullOrWhiteSpace(item.Notes) ? $" — {item.Notes}" : "")</td>
                                <td class="text-center">@item.Quantity</td>
                                <td>@(item.Unit ?? "Each")</td>
                                <td class="text-end print-price-col">@item.BaseCost.ToString("C")</td>
                                <td class="text-end print-price-col">@item.FlatPrice.ToString("C")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }

        <div class="print-doc-totals">
            <div class="print-total-row print-total-subtotal"><span class="print-total-label">Material Cost</span><span class="print-total-value">@detail.TotalMaterialCost.ToString("C")</span></div>
            @if (detail.TotalLaborCost > 0) { <div class="print-total-row"><span class="print-total-label">Labor</span><span class="print-total-value">@detail.TotalLaborCost.ToString("C")</span></div> }
            @if (detail.MarkupPercent > 0) { <div class="print-total-row"><span class="print-total-label">Markup (@detail.MarkupPercent%)</span><span class="print-total-value">@((detail.TotalMaterialCost * detail.MarkupPercent / 100).ToString("C"))</span></div> }
            @if (detail.TaxPercent > 0) { <div class="print-total-row"><span class="print-total-label">Tax (@detail.TaxPercent%)</span><span class="print-total-value">@((detail.GrandTotal * detail.TaxPercent / (100 + detail.TaxPercent)).ToString("C"))</span></div> }
            <div class="print-total-row print-grand-total"><span class="print-total-label">Total</span><span class="print-total-value">@detail.GrandTotal.ToString("C")</span></div>
        </div>

        <div class="print-doc-terms">
            @if (_printExternalNotes && !string.IsNullOrWhiteSpace(detail.ExternalNotes))
            {
                <div class="print-doc-terms-block"><div class="print-terms-heading">Notes</div><p class="print-terms-text">@detail.ExternalNotes</p></div>
            }
            @if (_printInternalNotes && !string.IsNullOrWhiteSpace(detail.InternalNotes))
            {
                <div class="print-doc-terms-block"><div class="print-terms-heading">Internal Notes</div><p class="print-terms-text">@detail.InternalNotes</p></div>
            }
        </div>

        <div class="print-doc-footer">
            @if (_companyProfile is not null)
            {
                @if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) { <span class="print-footer-item"><i class="bi bi-telephone print-footer-icon"></i> @_companyProfile.Phone</span> }
                @if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) { <span class="print-footer-item"><i class="bi bi-envelope print-footer-icon"></i> @_companyProfile.Email</span> }
                @if (!string.IsNullOrWhiteSpace(_companyProfile.Address)) { <span class="print-footer-item"><i class="bi bi-geo-alt print-footer-icon"></i> @_companyProfile.Address</span> }
            }
        </div>
        <div class="print-doc-thankyou">Thank you for your business!</div>
    </div>

    <div class="print-screen-only">
    <div class="row g-3">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Items (@detail.Items.Count)</h6>
                        <div class="d-flex gap-1">
                            <button class="btn btn-outline-primary btn-sm" @onclick="ToggleHvacQuickAdd"><i class="bi bi-lightning me-1"></i>HVAC Quick-Add</button>
                            <button class="btn btn-primary btn-sm" @onclick="ShowAddItem"><i class="bi bi-plus-lg me-1"></i>Add Item</button>
                        </div>
                    </div>

                    @* HVAC Quick-Add Panel *@
                    @if (_showHvacQuickAdd)
                    {
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary bg-opacity-10 py-2 d-flex justify-content-between align-items-center">
                                <strong class="small"><i class="bi bi-lightning me-1"></i>HVAC Quick-Add</strong>
                                <button class="btn btn-sm btn-outline-secondary py-0 px-1" @onclick="ToggleHvacQuickAdd"><i class="bi bi-x-lg"></i></button>
                            </div>
                            <div class="card-body py-2">
                                @* Subcategory tabs *@
                                <ul class="nav nav-pills nav-fill mb-3">
                                    <li class="nav-item">
                                        <button type="button" class="nav-link py-1 px-2 @(_hvacQuickAddTab == "equipment" ? "active bg-primary text-white" : "text-dark")" @onclick='() => _hvacQuickAddTab = "equipment"'><i class="bi bi-cpu me-1"></i>Equipment</button>
                                    </li>
                                    <li class="nav-item">
                                        <button type="button" class="nav-link py-1 px-2 @(_hvacQuickAddTab == "ductwork" ? "active bg-primary text-white" : "text-dark")" @onclick='() => _hvacQuickAddTab = "ductwork"'><i class="bi bi-wind me-1"></i>Ductwork</button>
                                    </li>
                                    <li class="nav-item">
                                        <button type="button" class="nav-link py-1 px-2 @(_hvacQuickAddTab == "supply" ? "active bg-primary text-white" : "text-dark")" @onclick='() => _hvacQuickAddTab = "supply"'><i class="bi bi-arrow-up-right-square me-1"></i>Supply Trunk</button>
                                    </li>
                                    <li class="nav-item">
                                        <button type="button" class="nav-link py-1 px-2 @(_hvacQuickAddTab == "return" ? "active bg-primary text-white" : "text-dark")" @onclick='() => _hvacQuickAddTab = "return"'><i class="bi bi-arrow-down-left-square me-1"></i>Return Trunk</button>
                                    </li>
                                    <li class="nav-item">
                                        <button type="button" class="nav-link py-1 px-2 @(_hvacQuickAddTab == "misc" ? "active bg-primary text-white" : "text-dark")" @onclick='() => _hvacQuickAddTab = "misc"'><i class="bi bi-box me-1"></i>Misc</button>
                                    </li>
                                </ul>

                                @* ── EQUIPMENT TAB ── *@
                                @if (_hvacQuickAddTab == "equipment")
                                {
                                    <p class="text-muted small mb-2">Add equipment manually or pull from your Products catalog.</p>

                                    @* Product search row *@
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-5">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                <input type="text" class="form-control form-control-sm" placeholder="Search products to auto-fill..." @bind="_equipProductSearch" @bind:event="oninput" @bind:after="SearchEquipProducts" />
                                                @if (!string.IsNullOrEmpty(_equipProductSearch))
                                                {
                                                    <button class="btn btn-outline-secondary btn-sm" @onclick='() => { _equipProductSearch = ""; _equipProductOptions = []; }'><i class="bi bi-x"></i></button>
                                                }
                                            </div>
                                        </div>
                                        @if (_equipProductOptions.Any())
                                        {
                                            <div class="col-md-7">
                                                <div class="list-group list-group-flush border rounded" style="max-height:150px;overflow-y:auto;">
                                                    @foreach (var p in _equipProductOptions)
                                                    {
                                                        <button type="button" class="list-group-item list-group-item-action py-1 px-2 small d-flex justify-content-between align-items-center" @onclick="() => AddEquipmentFromProduct(p)">
                                                            <span><strong>@p.Name</strong> @if (!string.IsNullOrEmpty(p.Category)) { <span class="text-muted">(@p.Category)</span> }</span>
                                                            <span class="text-nowrap ms-2">@p.Cost.ToString("C") @if (p.StockQty.HasValue) { <span class="badge bg-secondary ms-1">Stock: @p.StockQty</span> }</span>
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-2 align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="min-width:120px;">Type</th>
                                                    <th style="min-width:120px;">Name / Description</th>
                                                    <th style="min-width:80px;">Brand</th>
                                                    <th style="min-width:80px;">Model</th>
                                                    <th style="width:80px;">Tons/BTU</th>
                                                    <th style="width:55px;" class="text-center">Qty</th>
                                                    <th style="min-width:90px;">Notes</th>
                                                    <th style="width:30px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _hvacEquipmentRows)
                                                {
                                                    <tr class="@(row.ProductId.HasValue ? "table-info" : "")">
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.EquipmentType">
                                                                @foreach (var t in EquipmentTypes)
                                                                {
                                                                    <option value="@t">@t</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="@(row.ProductId.HasValue ? "From product" : "Custom name")" @bind="row.CustomName" /></td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="Brand" @bind="row.Brand" /></td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="Model #" @bind="row.Model" /></td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="e.g. 3 Ton" @bind="row.TonnageBtu" /></td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:55px;margin:auto;" @bind="row.Qty" /></td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="Notes" @bind="row.Notes" /></td>
                                                        <td><button class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="() => RemoveEquipmentRow(row)" disabled="@(_hvacEquipmentRows.Count <= 1)"><i class="bi bi-x"></i></button></td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="AddEquipmentRow"><i class="bi bi-plus-lg me-1"></i>Add Custom Row</button>
                                }

                                @* ── DUCTWORK TAB ── *@
                                @if (_hvacQuickAddTab == "ductwork")
                                {
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <p class="text-muted small mb-0">Set quantities per flex size. Boot sizes default by duct diameter but can be changed.</p>
                                        <button class="btn btn-sm btn-outline-primary py-0 px-1" @onclick="() => _showHvacAccessories = !_showHvacAccessories" title="Toggle accessories">
                                            <i class="bi bi-gear me-1"></i>@(_showHvacAccessories ? "Hide" : "Show") Extras
                                        </button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-2 align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:65px;">Flex</th>
                                                    <th style="width:70px;" class="text-center">Qty</th>
                                                    <th style="width:70px;" class="text-center">Take-Off</th>
                                                    <th style="min-width:120px;">Collar Type</th>
                                                    <th style="width:70px;" class="text-center">Boot</th>
                                                    <th style="min-width:90px;">Boot Size</th>
                                                    <th style="width:70px;" class="text-center">Grill</th>
                                                    <th style="min-width:90px;">Mount</th>
                                                    @if (_showHvacAccessories)
                                                    {
                                                        <th style="width:70px;" class="text-center">Damper</th>
                                                    }
                                                    <th style="width:30px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _hvacBundleRows)
                                                {
                                                    <tr>
                                                        <td>
                                                            <select class="form-select form-select-sm" value="@row.Size" @onchange="e => OnHvacSizeChanged(row, int.Parse(e.Value?.ToString() ?? row.Size.ToString()))">
                                                                @foreach (var s in FlexSizes)
                                                                {
                                                                    <option value="@s">@s"</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:60px;margin:auto;" @bind="row.FlexQty" /></td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:60px;margin:auto;" @bind="row.TakeOffQty" /></td>
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.TakeOffStyle">
                                                                @foreach (var style in TakeOffStyles)
                                                                {
                                                                    <option value="@style">@style</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:60px;margin:auto;" @bind="row.BootQty" /></td>
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.BootSize">
                                                                @foreach (var bs in BootSizeOptions)
                                                                {
                                                                    <option value="@bs">@bs</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:60px;margin:auto;" @bind="row.GrillQty" /></td>
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.GrillMount">
                                                                @foreach (var mt in GrillMountOptions)
                                                                {
                                                                    <option value="@mt">@mt</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        @if (_showHvacAccessories)
                                                        {
                                                            <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:60px;margin:auto;" @bind="row.DamperQty" /></td>
                                                        }
                                                        <td><button class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="() => RemoveHvacSize(row)" disabled="@(_hvacBundleRows.Count <= 1)"><i class="bi bi-x"></i></button></td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="AddHvacSize" disabled="@(_hvacBundleRows.Count >= FlexSizes.Length)"><i class="bi bi-plus-lg me-1"></i>Add Size</button>
                                }

                                @* ── SUPPLY TRUNK TAB ── *@
                                @if (_hvacQuickAddTab == "supply")
                                {
                                    <p class="text-muted small mb-2">Add supply trunk sections (rectangular or round pipe), reducers, end caps, elbows, and fittings.</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-2 align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:80px;">Shape</th>
                                                    <th style="min-width:130px;">Item</th>
                                                    <th style="min-width:100px;">Size</th>
                                                    <th style="width:80px;" class="text-center">Length (ft)</th>
                                                    <th style="width:60px;" class="text-center">Qty</th>
                                                    <th style="min-width:100px;">Notes</th>
                                                    <th style="width:30px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _hvacSupplyTrunkRows)
                                                {
                                                    <tr>
                                                        <td>
                                                            <select class="form-select form-select-sm" value="@row.DuctShape" @onchange="e => OnSupplyShapeChanged(row, e.Value?.ToString())">
                                                                <option value="Rect">Rect</option>
                                                                <option value="Round">Round</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.ItemType">
                                                                <option value="Trunk Section">@(row.DuctShape == "Round" ? "Round Pipe" : "Trunk Section")</option>
                                                                @foreach (var ft in TrunkFittingTypes)
                                                                {
                                                                    <option value="@ft">@ft</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td>
                                                            @if (row.DuctShape == "Round")
                                                            {
                                                                <select class="form-select form-select-sm" @bind="row.Size">
                                                                                 @foreach (var rp in RoundPipeSizes)
                                                                                {
                                                                                    <option value="@rp">@(rp)"</option>
                                                                                }
                                                                            </select>
                                                                        }
                                                                        else
                                                                        {
                                                                            <select class="form-select form-select-sm" @bind="row.Size">
                                                                                @foreach (var sz in RectTrunkSizes)
                                                                                {
                                                                                    <option value="@sz">@sz</option>
                                                                                }
                                                                            </select>
                                                                        }
                                                                    </td>
                                                                    <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:65px;margin:auto;" @bind="row.LengthFt" /></td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:55px;margin:auto;" @bind="row.Qty" /></td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="Notes" @bind="row.Notes" /></td>
                                                        <td><button class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="() => RemoveSupplyTrunkRow(row)" disabled="@(_hvacSupplyTrunkRows.Count <= 1)"><i class="bi bi-x"></i></button></td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="AddSupplyTrunkRow"><i class="bi bi-plus-lg me-1"></i>Add Row</button>
                                }

                                @* ── RETURN TRUNK TAB ── *@
                                @if (_hvacQuickAddTab == "return")
                                {
                                    <p class="text-muted small mb-2">Add return trunk sections (rectangular or round pipe), drops, filter grilles, return boxes, and plenums.</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-2 align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width:80px;">Shape</th>
                                                    <th style="min-width:140px;">Item</th>
                                                    <th style="min-width:100px;">Size</th>
                                                    <th style="width:60px;" class="text-center">Qty</th>
                                                    <th style="min-width:100px;">Notes</th>
                                                    <th style="width:30px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _hvacReturnTrunkRows)
                                                {
                                                    <tr>
                                                        <td>
                                                            <select class="form-select form-select-sm" value="@row.DuctShape" @onchange="e => OnReturnShapeChanged(row, e.Value?.ToString())">
                                                                <option value="Rect">Rect</option>
                                                                <option value="Round">Round</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.ItemType">
                                                                @foreach (var rt in ReturnItemTypes)
                                                                {
                                                                    <option value="@rt">@rt</option>
                                                                }
                                                            </select>
                                                        </td>
                                                        <td>
                                                            @if (row.ItemType is "Filter Grille")
                                                            {
                                                                <select class="form-select form-select-sm" @bind="row.Size">
                                                                    @foreach (var fg in FilterGrilleSizes)
                                                                    {
                                                                        <option value="@fg">@fg</option>
                                                                    }
                                                                </select>
                                                            }
                                                            else if (row.DuctShape == "Round")
                                                            {
                                                                <select class="form-select form-select-sm" @bind="row.Size">
                                                                    @foreach (var rp in RoundPipeSizes)
                                                                    {
                                                                        <option value="@rp">@(rp)"</option>
                                                                    }
                                                                </select>
                                                            }
                                                            else
                                                            {
                                                                <select class="form-select form-select-sm" @bind="row.Size">
                                                                    @foreach (var sz in RectTrunkSizes)
                                                                    {
                                                                        <option value="@sz">@sz</option>
                                                                    }
                                                                </select>
                                                            }
                                                        </td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:55px;margin:auto;" @bind="row.Qty" /></td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="Notes" @bind="row.Notes" /></td>
                                                        <td><button class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="() => RemoveReturnTrunkRow(row)" disabled="@(_hvacReturnTrunkRows.Count <= 1)"><i class="bi bi-x"></i></button></td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="AddReturnTrunkRow"><i class="bi bi-plus-lg me-1"></i>Add Row</button>
                                }

                                @* ── MISC TAB ── *@
                                @if (_hvacQuickAddTab == "misc")
                                {
                                    <p class="text-muted small mb-2">Quick-add sealing, taping, supports, insulation, and any other items.</p>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered mb-2 align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="min-width:180px;">Item</th>
                                                    <th style="width:80px;">Section</th>
                                                    <th style="width:60px;" class="text-center">Qty</th>
                                                    <th style="width:70px;">Unit</th>
                                                    <th style="min-width:100px;">Notes</th>
                                                    <th style="width:30px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var row in _hvacMiscRows)
                                                {
                                                    <tr>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm" list="miscPresetList" placeholder="Type or pick preset" @bind="row.ItemName" />
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm" @bind="row.Section" /></td>
                                                        <td class="text-center"><input type="number" min="0" step="1" class="form-control form-control-sm text-center" style="width:55px;margin:auto;" @bind="row.Qty" /></td>
                                                        <td>
                                                            <select class="form-select form-select-sm" @bind="row.Unit">
                                                                <option value="ea">ea</option>
                                                                <option value="roll">roll</option>
                                                                <option value="box">box</option>
                                                                <option value="can">can</option>
                                                                <option value="tube">tube</option>
                                                                <option value="ft">ft</option>
                                                                <option value="lb">lb</option>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" class="form-control form-control-sm" placeholder="Notes" @bind="row.Notes" /></td>
                                                        <td><button class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="() => RemoveMiscRow(row)" disabled="@(_hvacMiscRows.Count <= 1)"><i class="bi bi-x"></i></button></td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    <datalist id="miscPresetList">
                                        @foreach (var p in MiscPresets)
                                        {
                                            <option value="@p" />
                                        }
                                    </datalist>
                                    <button class="btn btn-outline-primary btn-sm" @onclick="AddMiscRow"><i class="bi bi-plus-lg me-1"></i>Add Row</button>
                                }

                                @* ── Shared footer: Add All + Reset ── *@
                                <hr class="my-2" />
                                <div class="d-flex gap-2 align-items-center flex-wrap">
                                    <button class="btn btn-primary btn-sm" @onclick="AddHvacBundle" disabled="@(!HvacHasItems)">
                                        <i class="bi bi-check-lg me-1"></i>Add All to List
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="ResetHvacBundle">Reset All</button>
                                    <span class="text-muted small ms-auto">@HvacTotalItemCount items across all tabs</span>
                                </div>
                                @if (!string.IsNullOrEmpty(_hvacBundleMsg))
                                {
                                    <div class="alert alert-success py-1 px-2 small mt-2 mb-0">@_hvacBundleMsg</div>
                                }
                            </div>
                        </div>
                    }

                    @* Inline add/edit form *@
                    @if (_showItemForm)
                    {
                        <div class="card bg-light border mb-3">
                            <div class="card-body py-2">
                                <h6 class="mb-2">@(_editingItemId.HasValue ? "Edit" : "Add") Item</h6>

                                @* Source tabs *@
                                <ul class="nav nav-pills nav-fill mb-3">
                                    <li class="nav-item">
                                        <button type="button" class="nav-link @(_mlItemSource == "custom" ? "active bg-primary text-white" : "text-dark")" @onclick='() => SwitchMlItemSource("custom")'><i class="bi bi-pencil me-1"></i>Custom Item</button>
                                    </li>
                                    <li class="nav-item">
                                        <button type="button" class="nav-link @(_mlItemSource == "inventory" ? "active bg-primary text-white" : "text-dark")" @onclick='() => SwitchMlItemSource("inventory")'><i class="bi bi-box-seam me-1"></i>From Inventory</button>
                                    </li>
                                    <li class="nav-item">
                                        <button type="button" class="nav-link @(_mlItemSource == "product" ? "active bg-primary text-white" : "text-dark")" @onclick='() => SwitchMlItemSource("product")'><i class="bi bi-tag me-1"></i>From Product</button>
                                    </li>
                                </ul>

                                @if (_mlItemSource == "inventory")
                                {
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold"><i class="bi bi-search me-1"></i>Search Inventory</label>
                                            <input type="text" class="form-control form-control-sm" placeholder="Type to search inventory..." @bind="_inventorySearch" @bind:event="oninput" @bind:after="SearchInventory" />
                                        </div>
                                        @if (_filteredInventory.Any())
                                        {
                                            <div class="col-md-6">
                                                <label class="form-label small">Select Inventory Item</label>
                                                <select class="form-select form-select-sm" @onchange="OnInventorySelected">
                                                    <option value="">— Pick to auto-fill —</option>
                                                    @foreach (var inv in _filteredInventory)
                                                    {
                                                        <option value="@inv.Id">@inv.Name (@(inv.Category ?? "–")) — @inv.Cost.ToString("C") [Stock: @inv.Quantity]</option>
                                                    }
                                                </select>
                                            </div>
                                        }
                                    </div>
                                }
                                @if (_mlItemSource == "product")
                                {
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-semibold"><i class="bi bi-search me-1"></i>Search Products</label>
                                            <input type="text" class="form-control form-control-sm" placeholder="Type to search products..." @bind="_productSearch" @bind:event="oninput" @bind:after="SearchProducts" />
                                        </div>
                                        @if (_productOptions.Any())
                                        {
                                            <div class="col-md-6">
                                                <label class="form-label small">Select Product</label>
                                                <select class="form-select form-select-sm" @onchange="OnProductSelected">
                                                    <option value="">— Pick to auto-fill —</option>
                                                    @foreach (var p in _productOptions)
                                                    {
                                                        <option value="@p.Id">@p.Name (@(p.Category ?? "–")) — @p.Cost.ToString("C") @(p.StockQty.HasValue ? $"[Stock: {p.StockQty}]" : "")</option>
                                                    }
                                                </select>
                                            </div>
                                        }
                                    </div>
                                }

                                @* Pairing suggestions *@
                                @if (_pairingSuggestions.Any())
                                {
                                    <div class="alert alert-info py-1 px-2 small mb-2">
                                        <strong><i class="bi bi-link-45deg me-1"></i>Suggested Pairings:</strong>
                                        @foreach (var pair in _pairingSuggestions)
                                        {
                                            <span class="badge bg-info text-dark me-1">@pair.AssociatedItemName (@pair.Ratio:1 in @(pair.AssociatedSection ?? pair.TradeType))</span>
                                        }
                                    </div>
                                }

                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small">Item Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control form-control-sm" @bind="_itemForm.ItemName" @bind:event="oninput" @bind:after="OnItemNameChanged" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Section</label>
                                        <select class="form-select form-select-sm" @bind="_itemForm.Section">
                                            @foreach (var sec in _sectionPresets)
                                            {
                                                <option value="@sec">@sec</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Qty</label>
                                        <input type="number" step="1" min="1" class="form-control form-control-sm" @bind="_itemForm.Quantity" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Unit</label>
                                        <input type="text" class="form-control form-control-sm" @bind="_itemForm.Unit" @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Cost</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" @bind="_itemForm.BaseCost" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Labor Hrs</label>
                                        <input type="number" step="0.25" class="form-control form-control-sm" @bind="_itemForm.LaborHours" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Flat Price</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" @bind="_itemForm.FlatPrice" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Markup %</label>
                                        <input type="number" step="0.5" class="form-control form-control-sm" @bind="_itemForm.MarkupPercent" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">Notes</label>
                                        <input type="text" class="form-control form-control-sm" @bind="_itemForm.Notes" @bind:event="oninput" />
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-primary btn-sm" @onclick="SaveItem"><i class="bi bi-check-lg me-1"></i>@(_editingItemId.HasValue ? "Update" : "Add")</button>
                                    <button class="btn btn-outline-secondary btn-sm ms-1" @onclick="CancelItemForm">Cancel</button>
                                </div>
                                @if (!string.IsNullOrEmpty(_itemError)) { <div class="text-danger small mt-1">@_itemError</div> }
                            </div>
                        </div>
                    }

                    @if (!detail.Items.Any())
                    {
                        <p class="text-muted">No items yet. Click <strong>Add Item</strong> to get started.</p>
                    }
                    else
                    {
                        @foreach (var grp in detail.Items.GroupBy(i => i.Section ?? "General"))
                        {
                            var sectionTotal = grp.Sum(i => i.BaseCost * i.Quantity);
                            <h6 class="mt-3 text-primary"><i class="bi bi-folder me-1"></i>@grp.Key <small class="text-muted fw-normal ms-2">(@grp.Count() items | @sectionTotal.ToString("C"))</small></h6>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light"><tr><th>Item</th><th>Qty</th><th>Unit</th><th class="print-price-col">Cost</th><th>Labor</th><th class="print-price-col">Flat</th><th class="print-price-col">Markup</th><th style="width:80px"></th></tr></thead>
                                    <tbody>
                                        @foreach (var item in grp)
                                        {
                                            <tr>
                                                <td>
                                                    @item.ItemName
                                                    @if (item.ProductName is not null) { <small class="text-muted">(@item.ProductName)</small> }
                                                    @if (item.InventoryStockQty.HasValue && item.InventoryStockQty < item.Quantity)
                                                    {
                                                        <span class="badge bg-warning text-dark ms-1" title="Stock: @item.InventoryStockQty"><i class="bi bi-exclamation-triangle"></i> Low</span>
                                                    }
                                                </td>
                                                <td>@item.Quantity</td>
                                                <td>@(item.Unit ?? "—")</td>
                                                <td class="print-price-col">@item.BaseCost.ToString("C")</td>
                                                <td>@item.LaborHours hrs</td>
                                                <td class="print-price-col">@item.FlatPrice.ToString("C")</td>
                                                <td class="print-price-col">@item.MarkupPercent%</td>
                                                <td class="text-end no-print">
                                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" @onclick="() => DuplicateItem(item)" title="Duplicate"><i class="bi bi-copy"></i></button>
                                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1 ms-1" @onclick="() => EditItem(item)" title="Edit"><i class="bi bi-pencil"></i></button>
                                                    <button class="btn btn-sm btn-outline-danger py-0 px-1 ms-1" @onclick="() => RemoveItem(item.Id)" title="Remove"><i class="bi bi-trash"></i></button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.Notes)) { <hr class="my-2" /><p class="mb-0">@detail.Notes</p> }
                    @if (!string.IsNullOrWhiteSpace(detail.ExternalNotes))
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted small mb-1"><i class="bi bi-chat-left-text me-1"></i>External Notes</h6>
                        <p class="mb-0 small">@detail.ExternalNotes</p>
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.InternalNotes))
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted small mb-1"><i class="bi bi-lock me-1"></i>Internal Notes <span class="badge bg-secondary">Internal Only</span></h6>
                        <p class="mb-0 small text-muted">@detail.InternalNotes</p>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-4 no-print">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Financial Summary</h6>
                    <div class="d-flex justify-content-between mb-1"><span>Materials:</span><strong>@detail.TotalMaterialCost.ToString("C")</strong></div>
                    <div class="d-flex justify-content-between mb-1"><span>Labor:</span><strong>@detail.TotalLaborCost.ToString("C")</strong></div>
                    @if (detail.MarkupPercent > 0) { <div class="d-flex justify-content-between mb-1"><span>Markup:</span><strong>@detail.MarkupPercent%</strong></div> }
                    @if (detail.TaxPercent > 0) { <div class="d-flex justify-content-between mb-1"><span>Tax:</span><strong>@detail.TaxPercent%</strong></div> }
                    @if (detail.ContingencyPercent > 0) { <div class="d-flex justify-content-between mb-1"><span>Contingency:</span><strong>@detail.ContingencyPercent%</strong></div> }
                    <hr class="my-2" />
                    <div class="d-flex justify-content-between"><span class="fw-bold">Grand Total:</span><strong class="text-primary fs-5">@detail.GrandTotal.ToString("C")</strong></div>
                </div>
            </div>
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-white"><strong><i class="bi bi-link-45deg me-1"></i>Connections</strong></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Customer</small>
                            @if (detail.CustomerId.HasValue && detail.CustomerName is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToCustomer(detail.CustomerId.Value)">@detail.CustomerName</a> }
                            else { <span>—</span> }
                            @if (!string.IsNullOrEmpty(detail.CustomerAddress)) { <small class="text-muted d-block">@detail.CustomerAddress</small> }
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Site</small>
                            @if (detail.SiteId.HasValue && detail.SiteName is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToSite(detail.SiteId.Value)">@detail.SiteName</a> }
                            else { <span>—</span> }
                            @if (!string.IsNullOrEmpty(detail.SiteAddress)) { <small class="text-muted d-block">@detail.SiteAddress</small> }
                        </div>
                    </div>
                    @if (detail.JobId.HasValue && !string.IsNullOrEmpty(detail.JobNumber))
                    {
                        <hr class="my-2" />
                        <small class="text-muted d-block">Linked Job</small>
                        <a href="javascript:void(0)" @onclick="() => GoToJob(detail.JobId.Value)"><i class="bi bi-briefcase me-1"></i>@detail.JobNumber</a>
                    }
                    @if (!string.IsNullOrEmpty(detail.PONumber))
                    {
                        <hr class="my-2" />
                        <small class="text-muted d-block">PO Number</small>
                        <strong>@detail.PONumber</strong>
                    }
                    <hr class="my-2" />
                    <div class="d-flex gap-3 text-muted small flex-wrap">
                        <span><strong>Status:</strong> @detail.Status</span>
                        @if (!string.IsNullOrEmpty(detail.TradeType)) { <span><strong>Trade:</strong> @detail.TradeType</span> }
                        <span><strong>Method:</strong> @detail.PricingMethod</span>
                        <span><strong>Created:</strong> @detail.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                        <span><strong>Updated:</strong> @detail.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> @* end print-screen-only *@

    @* Email Confirmation Modal *@
    @if (_showEmailModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header py-2 bg-light">
                        <h6 class="modal-title"><i class="bi bi-envelope me-1"></i>Email Material List</h6>
                        <button type="button" class="btn-close" @onclick="CloseEmailModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">To</label>
                            <input type="email" class="form-control form-control-sm" @bind="_emailTo" placeholder="recipient@example.com" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Subject</label>
                            <input type="text" class="form-control form-control-sm" @bind="_emailSubject" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Message Body</label>
                            <textarea class="form-control form-control-sm" rows="10" @bind="_emailBody"></textarea>
                        </div>
                        @if (_emailSmtpConfigured)
                        {
                            <div class="alert alert-success py-2 small mb-0">
                                <i class="bi bi-paperclip me-1"></i><strong>PDF will be attached automatically</strong> -- the material list PDF is generated and sent with the email.
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning py-2 small mb-0">
                                <i class="bi bi-exclamation-triangle me-1"></i><strong>SMTP not configured.</strong> Go to <a href="/settings">Settings > Company</a> to set up email.
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(_emailSendResult))
                        {
                            <div class="alert @(_emailSendResult.StartsWith("Sent") ? "alert-success" : "alert-danger") py-2 small mt-2 mb-0">@_emailSendResult</div>
                        }
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CloseEmailModal">Cancel</button>
                        <button type="button" class="btn btn-outline-success btn-sm" @onclick="DownloadPdfForEmail"><i class="bi bi-download me-1"></i>Download PDF</button>
                        @if (_emailSmtpConfigured)
                        {
                            <button type="button" class="btn btn-primary btn-sm" @onclick="SendEmailWithPdf" disabled="@_emailSending">
                                @if (_emailSending) { <span class="spinner-border spinner-border-sm me-1"></span> } else { <i class="bi bi-send me-1"></i> }
                                Send with PDF
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-primary btn-sm" @onclick="SendEmailFromModal"><i class="bi bi-send me-1"></i>Open Email Client</button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>Material Lists</h4>
        <div class="d-flex align-items-center gap-2">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="chkMlArchived" @bind="filter.ShowArchived" @bind:after="LoadLists" />
                <label class="form-check-label small" for="chkMlArchived"><i class="bi bi-archive me-1"></i>Show Archived</label>
            </div>
            @if (!filter.ShowArchived)
            {
                <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New List</button>
            }
        </div>
    </div>
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" placeholder="Search lists..." @bind="filter.Search" @bind:event="oninput" @bind:after="LoadLists" />
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterTemplate" @bind:after="LoadLists">
                        <option value="">All Types</option>
                        <option value="true">Templates Only</option>
                        <option value="false">Non-Templates</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterStatus" @bind:after="LoadLists">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<MaterialListStatus>()) { <option value="@s">@s</option> }
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" @bind="filterTradeType" @bind:after="LoadLists">
                        <option value="">All Trades</option>
                        <option value="HVAC">HVAC</option>
                        <option value="Plumbing">Plumbing</option>
                        <option value="Electrical">Electrical</option>
                        <option value="General">General</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="card border-0 shadow-sm">
        @if (lists is null)
        {
            <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
        }
        else if (!lists.Any())
        {
            <div class="card-body text-center py-5 text-muted"><i class="bi bi-list-check" style="font-size:3rem;"></i>
                @if (filter.ShowArchived)
                {
                    <p class="mt-2">No archived material lists to show.</p>
                }
                else
                {
                    <p class="mt-2">No material lists. <a href="javascript:void(0)" @onclick="GoToNew">Create one</a>.</p>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light"><tr>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Name")'>Name @SortIcon("Name")</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Status")'>Status @SortIcon("Status")</th>
                        <th>Method</th><th>Customer</th><th>Job</th><th>Items</th>
                        <th>Materials</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Total")'>Total @SortIcon("Total")</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("CreatedAt")'>Created @SortIcon("CreatedAt")</th>
                    </tr></thead>
                    <tbody>
                        @foreach (var ml in lists)
                        {
                            <tr style="cursor:pointer" @onclick="() => GoToDetail(ml.Id)">
                                <td>
                                    <strong>@ml.Name</strong>
                                    @if (ml.IsTemplate) { <span class="badge bg-info ms-1">Template</span> }
                                    @if (!string.IsNullOrEmpty(ml.TradeType)) { <span class="badge bg-dark ms-1">@ml.TradeType</span> }
                                </td>
                                <td><span class="badge @StatusBadgeClass(ml.Status)">@ml.Status</span></td>
                                <td><span class="badge bg-secondary">@ml.PricingMethod</span></td>
                                <td>@(ml.CustomerName ?? "—")</td>
                                <td>@(ml.JobNumber ?? "—")</td>
                                <td>@ml.ItemCount</td>
                                <td>@ml.TotalMaterialCost.ToString("C")</td>
                                <td><strong>@ml.GrandTotal.ToString("C")</strong></td>
                                <td>@ml.CreatedAt.ToString("MMM dd, yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    private string mode = "list";
    private List<MaterialListListItem>? lists;
    private MaterialListFilter filter = new();
    private string filterTemplate = "";
    private string filterStatus = "";
    private string filterTradeType = "";
    private MaterialListDetail? detail;
    private CompanyProfile? _companyProfile;
    private MaterialListEditModel form = new();
    private int? editId;
    private string? errorMsg;
    private bool _confirmArchive;

    // Save/Close state
    private bool _closeAfterSave = true;
    private string? _savedMsg;

    private List<CustomerListItem> _customers = [];
    private List<SiteListItem> _sites = [];
    private List<MaterialJobOption> _jobs = [];
    private List<MaterialListListItem> _templates = [];

    // Item management
    private bool _showItemForm;
    private int? _editingItemId;
    private MaterialListItemEditModel _itemForm = new();
    private string? _itemError;

    // Product picker
    private string _productSearch = "";
    private List<MaterialProductOption> _productOptions = [];

    // Inventory picker
    private string _inventorySearch = "";
    private List<InventoryListItem> _allInventoryItems = [];
    private List<InventoryListItem> _filteredInventory = [];

    // Item source tab
    private string _mlItemSource = "custom";

    // HVAC pairings
    private List<ItemAssociation> _pairingSuggestions = [];

    // Stock check
    private List<MaterialStockCheck>? _stockChecks;

    // HVAC Quick-Add
    private bool _showHvacQuickAdd;
    private string? _hvacBundleMsg;
    private string _hvacQuickAddTab = "ductwork";
    private bool _showHvacAccessories;

    // --- Ductwork tab state ---
    private List<HvacBundleRow> _hvacBundleRows = InitHvacRows();

    private static readonly string[] TakeOffStyles = ["Flat Collar", "Round Collar"];
    private static readonly string[] BootSizeOptions = ["4x10", "4x12", "6x10", "6x12"];
    private static readonly string[] GrillMountOptions = ["Floor", "Ceiling"];
    private static readonly int[] FlexSizes = [5, 6, 7, 8];

    private static string GetDefaultBootSize(int flexSize) => flexSize switch
    {
        5 or 6 => "4x10",
        7 or 8 => "4x12",
        _ => "4x10"
    };

    private static List<HvacBundleRow> InitHvacRows() =>
    [
        new() { Size = 5, BootSize = "4x10" },
    ];

    private void AddHvacSize()
    {
        var usedSizes = _hvacBundleRows.Select(r => r.Size).ToHashSet();
        var nextSize = FlexSizes.FirstOrDefault(s => !usedSizes.Contains(s));
        if (nextSize > 0)
            _hvacBundleRows.Add(new HvacBundleRow { Size = nextSize, BootSize = GetDefaultBootSize(nextSize) });
    }

    private void RemoveHvacSize(HvacBundleRow row)
    {
        if (_hvacBundleRows.Count > 1) _hvacBundleRows.Remove(row);
    }

    private void OnHvacSizeChanged(HvacBundleRow row, int newSize)
    {
        row.Size = newSize;
        row.BootSize = GetDefaultBootSize(newSize);
    }

    private class HvacBundleRow
    {
        public int Size { get; set; }
        public int FlexQty { get; set; }
        public int TakeOffQty { get; set; }
        public string TakeOffStyle { get; set; } = "Flat Collar";
        public int BootQty { get; set; }
        public string BootSize { get; set; } = "";
        public int GrillQty { get; set; }
        public string GrillMount { get; set; } = "Floor";
        public int DamperQty { get; set; }
    }

    // --- Equipment tab state ---
    private List<HvacEquipmentRow> _hvacEquipmentRows = [new()];
    private string _equipProductSearch = "";
    private List<MaterialProductOption> _equipProductOptions = [];

    private static readonly string[] EquipmentTypes =
        ["Furnace", "Air Handler", "Condenser", "Heat Pump", "Mini Split", "Package Unit", "Coil", "Thermostat", "Line Set", "Disconnect", "Whip", "Pad"];

    private void AddEquipmentRow() => _hvacEquipmentRows.Add(new());
    private void RemoveEquipmentRow(HvacEquipmentRow row) { if (_hvacEquipmentRows.Count > 1) _hvacEquipmentRows.Remove(row); }

    private async Task SearchEquipProducts()
    {
        if (_equipProductSearch.Length >= 2)
            _equipProductOptions = await ListSvc.GetProductOptionsAsync(_equipProductSearch);
        else
            _equipProductOptions = [];
    }

    private void AddEquipmentFromProduct(MaterialProductOption product)
    {
        _hvacEquipmentRows.Add(new HvacEquipmentRow
        {
            EquipmentType = product.Category ?? "Equipment",
            CustomName = product.Name,
            Qty = 1,
            ProductId = product.Id,
            InventoryItemId = product.InventoryItemId,
            BaseCost = product.Cost,
        });
        _equipProductSearch = "";
        _equipProductOptions = [];
    }

    private class HvacEquipmentRow
    {
        public string EquipmentType { get; set; } = "Furnace";
        public string? CustomName { get; set; }
        public string? Brand { get; set; }
        public string? Model { get; set; }
        public string? TonnageBtu { get; set; }
        public int Qty { get; set; }
        public string? Notes { get; set; }
        public int? ProductId { get; set; }
        public int? InventoryItemId { get; set; }
        public decimal BaseCost { get; set; }
    }

    // --- Supply Trunk tab state ---
    private List<HvacSupplyTrunkRow> _hvacSupplyTrunkRows = [new()];

    private static readonly string[] RectTrunkSizes =
        ["8x8", "8x10", "8x12", "10x10", "10x12", "10x14", "12x12", "12x14", "14x14", "14x16", "16x16", "16x20", "20x20", "20x24", "24x24"];

    private static readonly int[] RoundPipeSizes = [10, 12, 14, 16, 18, 20, 22];

    private static readonly string[] TrunkFittingTypes =
        ["Reducer", "End Cap", "Tee", "Elbow", "Offset", "Starting Collar"];

    private void AddSupplyTrunkRow() => _hvacSupplyTrunkRows.Add(new());
    private void RemoveSupplyTrunkRow(HvacSupplyTrunkRow row) { if (_hvacSupplyTrunkRows.Count > 1) _hvacSupplyTrunkRows.Remove(row); }

    private void OnSupplyShapeChanged(HvacSupplyTrunkRow row, string? newShape)
    {
        row.DuctShape = newShape ?? "Rect";
        row.Size = row.DuctShape == "Round" ? "10" : "10x12";
    }

    private class HvacSupplyTrunkRow
    {
        public string DuctShape { get; set; } = "Rect";
        public string ItemType { get; set; } = "Trunk Section";
        public string Size { get; set; } = "10x12";
        public int LengthFt { get; set; }
        public int Qty { get; set; }
        public string? Notes { get; set; }
    }

    // --- Return Trunk tab state ---
    private List<HvacReturnTrunkRow> _hvacReturnTrunkRows = [new()];

    private static readonly string[] ReturnItemTypes =
        ["Return Trunk Section", "Return Drop", "Filter Grille", "Return Box", "Plenum", "Return Elbow", "Return Boot"];

    private static readonly string[] FilterGrilleSizes =
        ["14x20", "14x25", "16x20", "16x25", "20x20", "20x25", "20x30", "24x24", "24x30", "25x25"];

    private void AddReturnTrunkRow() => _hvacReturnTrunkRows.Add(new());
    private void RemoveReturnTrunkRow(HvacReturnTrunkRow row) { if (_hvacReturnTrunkRows.Count > 1) _hvacReturnTrunkRows.Remove(row); }

    private void OnReturnShapeChanged(HvacReturnTrunkRow row, string? newShape)
    {
        row.DuctShape = newShape ?? "Rect";
        row.Size = row.DuctShape == "Round" ? "10" : "20x25";
    }

    private class HvacReturnTrunkRow
    {
        public string DuctShape { get; set; } = "Rect";
        public string ItemType { get; set; } = "Return Trunk Section";
        public string? Size { get; set; } = "20x25";
        public int Qty { get; set; }
        public string? Notes { get; set; }
    }

    // --- Misc tab state ---
    private List<HvacMiscRow> _hvacMiscRows = [new()];

    private static readonly string[] MiscPresets =
        ["Mastic", "Foil Tape (UL 181A)", "Duct Sealant", "Spray Foam", "Cork Tape", "Zip Screws", "Hangers / Straps",
         "Insulation Wrap", "Fire-Rated Caulk", "Condensate Line", "Drain Pan", "Gas Line", "Flue Pipe", "Refrigerant"];

    private void AddMiscRow() => _hvacMiscRows.Add(new());
    private void RemoveMiscRow(HvacMiscRow row) { if (_hvacMiscRows.Count > 1) _hvacMiscRows.Remove(row); }

    private class HvacMiscRow
    {
        public string ItemName { get; set; } = "";
        public string? Section { get; set; } = "Misc";
        public int Qty { get; set; }
        public string? Unit { get; set; } = "ea";
        public string? Notes { get; set; }
    }

    // Print options
    private bool _printExternalNotes = true;
    private bool _printInternalNotes;
    private bool _includePricesOnPdf = true;

    // Email modal state
    private bool _showEmailModal;
    private string _emailTo = "";
    private string _emailSubject = "";
    private string _emailBody = "";
    private bool _emailSmtpConfigured;
    private bool _emailSending;
    private string? _emailSendResult;

    // HVAC section presets
    private static readonly string[] _sectionPresets =
    [
        "General", "Ductwork", "Flex Duct", "Take Offs", "Boots",
        "Returns", "Trunk Line", "Hard Pipe", "Grills/Registers",
        "Sealing & Taping", "Support & Hangers", "Insulation",
        "Fittings", "Equipment", "Accessories", "Disposal",
        "Permits", "Misc", "Labor"
    ];

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await DetermineView();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DetermineView()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.AbsolutePath.Contains("/materiallists/new", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            mode = "form"; editId = null; form = new();
        }
        else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            await LoadForEdit(Id.Value);
        }
        else if (Id.HasValue)
            await LoadDetailView(Id.Value);
        else { mode = "list"; await LoadLists(); }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadLists()
    {
        filter.IsTemplate = string.IsNullOrWhiteSpace(filterTemplate) ? null : bool.Parse(filterTemplate);
        filter.Status = string.IsNullOrWhiteSpace(filterStatus) ? null : Enum.Parse<MaterialListStatus>(filterStatus);
        filter.TradeType = string.IsNullOrWhiteSpace(filterTradeType) ? null : filterTradeType;
        lists = await ListSvc.GetListsAsync(filter);
    }

    private async Task LoadDetailView(int id)
    {
        detail = await ListSvc.GetListAsync(id);
        _stockChecks = null;
        mode = detail is not null ? "detail" : "list";
        if (mode == "detail") _companyProfile = await CompanyProfileSvc.GetProfileAsync();
        if (mode == "list") await LoadLists();
    }

    private async Task LoadForEdit(int id)
    {
        var d = await ListSvc.GetListAsync(id);
        if (d is null) { mode = "list"; await LoadLists(); return; }
        editId = id;
        form = new MaterialListEditModel
        {
            Name = d.Name, IsTemplate = d.IsTemplate,
            Status = d.Status, TradeType = d.TradeType,
            PricingMethod = d.PricingMethod, Notes = d.Notes,
            InternalNotes = d.InternalNotes, ExternalNotes = d.ExternalNotes,
            PONumber = d.PONumber,
            JobId = d.JobId, CustomerId = d.CustomerId, SiteId = d.SiteId
        };
        await RefreshMaterialSites();
        mode = "form";
    }

    private async Task OnMaterialCustomerChanged()
    {
        form.SiteId = null;
        await RefreshMaterialSites();
    }

    private async Task RefreshMaterialSites()
    {
        if (form.CustomerId.HasValue)
            _sites = await SiteSvc.GetSitesAsync(new SiteFilter { CustomerId = form.CustomerId });
        else
            _sites = await SiteSvc.GetSitesAsync();

        if (_sites.Count == 1 && !form.SiteId.HasValue)
            form.SiteId = _sites[0].Id;
    }

    private async Task SaveList()
    {
        try
        {
            errorMsg = null;
            _savedMsg = null;
            MaterialList saved;
            if (editId.HasValue)
                saved = await ListSvc.UpdateListAsync(editId.Value, form);
            else if (_selectedTemplateId.HasValue)
            {
                saved = await ListSvc.CloneFromTemplateAsync(_selectedTemplateId.Value, form.Name);
                // Apply form overrides to clone
                await ListSvc.UpdateListAsync(saved.Id, form);
            }
            else
                saved = await ListSvc.CreateListAsync(form);

            if (_closeAfterSave) Nav.NavigateTo($"/materiallists/{saved.Id}");
            else if (editId.HasValue) _savedMsg = "Saved!";
            else Nav.NavigateTo($"/materiallists/{saved.Id}/edit");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task ArchiveDetail()
    {
        if (detail is not null) { await ListSvc.ArchiveListAsync(detail.Id); _confirmArchive = false; Nav.NavigateTo("/materiallists"); }
    }

    private void GoToList() => Nav.NavigateTo("/materiallists");
    private void GoToNew() => Nav.NavigateTo("/materiallists/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/materiallists/{id}");

    private int? GetAdjacentListId(int offset)
    {
        if (lists is null || lists.Count == 0 || detail is null) return null;
        var idx = lists.FindIndex(m => m.Id == detail.Id);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < lists.Count ? lists[target].Id : null;
    }
    private void GoToPrevList() { var id = GetAdjacentListId(-1); if (id.HasValue) GoToDetail(id.Value); }
    private void GoToNextList() { var id = GetAdjacentListId(1); if (id.HasValue) GoToDetail(id.Value); }

    private int? GetAdjacentListEditId(int offset)
    {
        if (lists is null || lists.Count == 0 || !editId.HasValue) return null;
        var idx = lists.FindIndex(m => m.Id == editId.Value);
        if (idx < 0) return null;
        var target = idx + offset;
        return target >= 0 && target < lists.Count ? lists[target].Id : null;
    }
    private void GoToPrevListEdit() { var id = GetAdjacentListEditId(-1); if (id.HasValue) Nav.NavigateTo($"/materiallists/{id.Value}/edit"); }
    private void GoToNextListEdit() { var id = GetAdjacentListEditId(1); if (id.HasValue) Nav.NavigateTo($"/materiallists/{id.Value}/edit"); }
    private void EditDetail() { if (detail is not null) Nav.NavigateTo($"/materiallists/{detail.Id}/edit"); }
    private void GoToCustomer(int id) => Nav.NavigateTo($"/customers/{id}");
    private void GoToSite(int id) => Nav.NavigateTo($"/sites/{id}");
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");

    private async Task ToggleSort(string column)
    {
        if (filter.SortBy == column) filter.SortDescending = !filter.SortDescending;
        else { filter.SortBy = column; filter.SortDescending = false; }
        await LoadLists();
    }

    private RenderFragment SortIcon(string column) => builder =>
    {
        var css = filter.SortBy == column
            ? (filter.SortDescending ? "bi-sort-down" : "bi-sort-up")
            : "bi-arrow-down-up opacity-25";
        builder.OpenElement(0, "i");
        builder.AddAttribute(1, "class", $"bi {css} ms-1{(filter.SortBy == column ? " text-primary" : "")}");
        builder.CloseElement();
    };

    private async Task LoadDropdowns()
    {
        _customers = await CustomerSvc.GetCustomersAsync();
        _sites = await SiteSvc.GetSitesAsync();
        _jobs = await ListSvc.GetJobOptionsAsync();
        _templates = await ListSvc.GetListsAsync(new MaterialListFilter { IsTemplate = true });
        _allInventoryItems = await InvSvc.GetItemsAsync();
    }

    // --- Template selector ---
    private int? _selectedTemplateId;
    private void OnTemplateSelected(ChangeEventArgs e)
    {
        _selectedTemplateId = int.TryParse(e.Value?.ToString(), out var tid) ? tid : null;
    }

    // --- Status workflow ---
    private async Task ChangeStatus(MaterialListStatus newStatus)
    {
        if (detail is null) return;
        await ListSvc.UpdateStatusAsync(detail.Id, newStatus);
        await LoadDetailView(detail.Id);
    }

    private async Task CreateJobFromList()
    {
        if (detail is null) return;
        try
        {
            var jobModel = new JobEditModel
            {
                Title = detail.Name,
                TradeType = detail.TradeType,
                Status = JobStatus.Lead,
                Priority = JobPriority.Standard,
                CustomerId = detail.CustomerId,
                SiteId = detail.SiteId,
                EstimatedTotal = detail.GrandTotal > 0 ? detail.GrandTotal : null,
                Notes = $"Created from Material List: {detail.Name}"
            };
            var job = await JobSvc.CreateJobAsync(jobModel);

            // Link the job to this material list (both directions)
            job.MaterialListId = detail.Id;
            await JobSvc.UpdateJobAsync(job.Id, new JobEditModel
            {
                JobNumber = job.JobNumber,
                Title = job.Title,
                TradeType = detail.TradeType,
                Status = job.Status,
                Priority = job.Priority,
                CustomerId = detail.CustomerId,
                SiteId = detail.SiteId,
                EstimatedTotal = detail.GrandTotal > 0 ? detail.GrandTotal : null,
                Notes = job.Notes
            });

            // Link material list back to the job
            var mlForm = new MaterialListEditModel
            {
                Name = detail.Name, TradeType = detail.TradeType, PricingMethod = detail.PricingMethod,
                Notes = detail.Notes, InternalNotes = detail.InternalNotes, ExternalNotes = detail.ExternalNotes,
                PONumber = detail.PONumber,
                JobId = job.Id, CustomerId = detail.CustomerId, SiteId = detail.SiteId
            };
            await ListSvc.UpdateListAsync(detail.Id, mlForm);

            Nav.NavigateTo($"/jobs/{job.Id}");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private static string StatusBadgeClass(MaterialListStatus status) => status switch
    {
        MaterialListStatus.Draft => "bg-secondary",
        MaterialListStatus.Approved => "bg-success",
        MaterialListStatus.Ordered => "bg-primary",
        _ => "bg-secondary"
    };

    // --- Product picker ---
    private async Task SearchProducts()
    {
        if (_productSearch.Length >= 2)
            _productOptions = await ListSvc.GetProductOptionsAsync(_productSearch);
        else
            _productOptions = [];
    }

    private void OnProductSelected(ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var pid)) return;
        var product = _productOptions.FirstOrDefault(p => p.Id == pid);
        if (product is null) return;
        _itemForm.ItemName = product.Name;
        _itemForm.BaseCost = product.Cost;
        _itemForm.Unit = product.Unit ?? "ea";
        _itemForm.MarkupPercent = product.MarkupPercent;
        _itemForm.ProductId = product.Id;
        _itemForm.InventoryItemId = product.InventoryItemId;
        if (!string.IsNullOrEmpty(product.Category) && _sectionPresets.Contains(product.Category))
            _itemForm.Section = product.Category;
    }

    // --- Inventory picker ---
    private Task SearchInventory()
    {
        if (_inventorySearch.Length >= 2)
            _filteredInventory = _allInventoryItems
                .Where(i => i.Name.Contains(_inventorySearch, StringComparison.OrdinalIgnoreCase)
                    || (i.SKU ?? "").Contains(_inventorySearch, StringComparison.OrdinalIgnoreCase)
                    || (i.PartNumber ?? "").Contains(_inventorySearch, StringComparison.OrdinalIgnoreCase)
                    || (i.Category ?? "").Contains(_inventorySearch, StringComparison.OrdinalIgnoreCase))
                .Take(25).ToList();
        else
            _filteredInventory = [];
        return Task.CompletedTask;
    }

    private void OnInventorySelected(ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var invId)) return;
        var inv = _allInventoryItems.FirstOrDefault(i => i.Id == invId);
        if (inv is null) return;
        _itemForm.ItemName = inv.Name;
        _itemForm.BaseCost = inv.Cost;
        _itemForm.Unit = inv.Unit ?? "ea";
        _itemForm.InventoryItemId = inv.Id;
        if (!string.IsNullOrEmpty(inv.Category) && _sectionPresets.Contains(inv.Category))
            _itemForm.Section = inv.Category;
    }

    private void SwitchMlItemSource(string source)
    {
        _mlItemSource = source;
        _productSearch = "";
        _productOptions = [];
        _inventorySearch = "";
        _filteredInventory = [];
    }

    // --- HVAC pairing suggestions ---
    private async Task OnItemNameChanged()
    {
        if (!string.IsNullOrWhiteSpace(_itemForm.ItemName) && _itemForm.ItemName.Length >= 3)
            _pairingSuggestions = await ListSvc.GetPairingsAsync(_itemForm.ItemName, detail?.TradeType ?? "HVAC");
        else
            _pairingSuggestions = [];
    }

    // --- Stock check ---
    private async Task CheckStock()
    {
        if (detail is null) return;
        _stockChecks = await ListSvc.CheckInventoryStockAsync(detail.Id);
    }

    // --- Convert to Estimate ---
    private async Task ConvertToEstimate()
    {
        if (detail is null) return;
        try
        {
            var estimateId = await ListSvc.ConvertToEstimateAsync(detail.Id);
            Nav.NavigateTo($"/estimates/{estimateId}");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    // --- Item management ---
    private void ShowAddItem()
    {
        _editingItemId = null;
        _itemForm = new MaterialListItemEditModel();
        _showItemForm = true;
        _itemError = null;
        _mlItemSource = "custom";
        _productSearch = "";
        _productOptions = [];
        _inventorySearch = "";
        _filteredInventory = [];
        _pairingSuggestions = [];
    }

    private void EditItem(MaterialListItemDto item)
    {
        _editingItemId = item.Id;
        _itemForm = new MaterialListItemEditModel
        {
            ItemName = item.ItemName, Section = item.Section ?? "General",
            Quantity = item.Quantity, Unit = item.Unit,
            BaseCost = item.BaseCost, LaborHours = item.LaborHours,
            FlatPrice = item.FlatPrice, MarkupPercent = item.MarkupPercent,
            ProductId = item.ProductId, InventoryItemId = item.InventoryItemId,
            SortOrder = item.SortOrder, Notes = item.Notes,
        };
        _showItemForm = true;
        _itemError = null;
        _productSearch = "";
        _productOptions = [];
        _pairingSuggestions = [];
    }

    private void CancelItemForm()
    {
        _showItemForm = false;
        _editingItemId = null;
        _itemError = null;
        _mlItemSource = "custom";
        _productSearch = "";
        _productOptions = [];
        _inventorySearch = "";
        _filteredInventory = [];
        _pairingSuggestions = [];
    }

    private async Task SaveItem()
    {
        if (string.IsNullOrWhiteSpace(_itemForm.ItemName))
        {
            _itemError = "Item name is required.";
            return;
        }
        try
        {
            if (_editingItemId.HasValue)
                await ListSvc.UpdateItemAsync(detail!.Id, _editingItemId.Value, _itemForm);
            else
                await ListSvc.AddItemAsync(detail!.Id, _itemForm);

            _showItemForm = false;
            _editingItemId = null;
            _itemError = null;
            _productSearch = "";
            _productOptions = [];
            _pairingSuggestions = [];
            await LoadDetailView(detail!.Id);
        }
        catch (Exception ex) { _itemError = ex.Message; }
    }

    private async Task RemoveItem(int itemId)
    {
        if (detail is null) return;
        await ListSvc.RemoveItemAsync(detail.Id, itemId);
        await LoadDetailView(detail.Id);
    }

    private void DuplicateItem(MaterialListItemDto item)
    {
        _editingItemId = null;
        _itemForm = new MaterialListItemEditModel
        {
            ItemName = item.ItemName,
            Section = item.Section ?? "General",
            Quantity = item.Quantity,
            Unit = item.Unit,
            BaseCost = item.BaseCost,
            LaborHours = item.LaborHours,
            FlatPrice = item.FlatPrice,
            MarkupPercent = item.MarkupPercent,
            ProductId = item.ProductId,
            InventoryItemId = item.InventoryItemId,
            SortOrder = item.SortOrder,
            Notes = item.Notes,
        };
        _showItemForm = true;
        _itemError = null;
        _mlItemSource = "custom";
        _productSearch = "";
        _productOptions = [];
        _inventorySearch = "";
        _filteredInventory = [];
        _pairingSuggestions = [];
    }

    // --- HVAC Quick-Add ---
    private void ToggleHvacQuickAdd()
    {
        _showHvacQuickAdd = !_showHvacQuickAdd;
        if (_showHvacQuickAdd) _hvacBundleMsg = null;
    }

    private int HvacTotalItemCount =>
        _hvacBundleRows.Sum(r => r.FlexQty + r.TakeOffQty + r.BootQty + r.GrillQty + r.DamperQty)
        + _hvacEquipmentRows.Sum(r => r.Qty)
        + _hvacSupplyTrunkRows.Sum(r => r.Qty)
        + _hvacReturnTrunkRows.Sum(r => r.Qty)
        + _hvacMiscRows.Where(r => !string.IsNullOrWhiteSpace(r.ItemName)).Sum(r => r.Qty);

    private bool HvacHasItems => HvacTotalItemCount > 0;

    private void ResetHvacBundle()
    {
        _hvacBundleRows = InitHvacRows();
        _hvacEquipmentRows = [new()];
        _hvacSupplyTrunkRows = [new()];
        _hvacReturnTrunkRows = [new()];
        _hvacMiscRows = [new()];
        _showHvacAccessories = false;
        _equipProductSearch = "";
        _equipProductOptions = [];
        _hvacBundleMsg = null;
    }

    private async Task AddHvacBundle()
    {
        if (detail is null) return;
        var count = 0;

        // Equipment tab
        foreach (var row in _hvacEquipmentRows.Where(r => r.Qty > 0))
        {
            string name;
            if (!string.IsNullOrWhiteSpace(row.CustomName))
            {
                name = row.CustomName;
            }
            else
            {
                name = row.EquipmentType;
                if (!string.IsNullOrWhiteSpace(row.Brand)) name += $" — {row.Brand}";
                if (!string.IsNullOrWhiteSpace(row.Model)) name += $" {row.Model}";
                if (!string.IsNullOrWhiteSpace(row.TonnageBtu)) name += $" ({row.TonnageBtu})";
            }
            await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
            {
                ItemName = name,
                Section = "Equipment",
                Quantity = row.Qty,
                Unit = "ea",
                BaseCost = row.BaseCost,
                ProductId = row.ProductId,
                InventoryItemId = row.InventoryItemId,
                Notes = row.Notes,
            });
            count++;
        }

        // Ductwork tab
        foreach (var row in _hvacBundleRows)
        {
            if (row.FlexQty > 0)
            {
                await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
                {
                    ItemName = $"{row.Size}\" Flex Supply Duct",
                    Section = "Flex Duct",
                    Quantity = row.FlexQty,
                    Unit = "ea",
                });
                count++;
            }
            if (row.TakeOffQty > 0)
            {
                await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
                {
                    ItemName = $"{row.Size}\" {row.TakeOffStyle} Take-Off",
                    Section = "Take Offs",
                    Quantity = row.TakeOffQty,
                    Unit = "ea",
                });
                count++;
            }
            if (row.BootQty > 0)
            {
                await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
                {
                    ItemName = $"{row.BootSize} Floor Boot ({row.Size}\" duct)",
                    Section = "Boots",
                    Quantity = row.BootQty,
                    Unit = "ea",
                });
                count++;
            }
            if (row.GrillQty > 0)
            {
                await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
                {
                    ItemName = $"{row.BootSize} Register Grill — {row.GrillMount}",
                    Section = "Grills/Registers",
                    Quantity = row.GrillQty,
                    Unit = "ea",
                });
                count++;
            }
            if (row.DamperQty > 0)
            {
                await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
                {
                    ItemName = $"{row.Size}\" Duct Damper",
                    Section = "Accessories",
                    Quantity = row.DamperQty,
                    Unit = "ea",
                });
                count++;
            }
        }

        // Supply Trunk tab
        foreach (var row in _hvacSupplyTrunkRows.Where(r => r.Qty > 0))
        {
            string name;
            if (row.ItemType == "Trunk Section")
            {
                var label = row.DuctShape == "Round" ? "Round Supply Pipe" : "Supply Trunk";
                var sizeLabel = row.DuctShape == "Round" ? $"{row.Size}\"" : row.Size;
                name = $"{sizeLabel} {label} — {row.LengthFt} ft";
            }
            else
            {
                var shapePrefix = row.DuctShape == "Round" ? "Round " : "";
                var sizeLabel = row.DuctShape == "Round" ? $"{row.Size}\"" : row.Size;
                name = $"{sizeLabel} {shapePrefix}Supply {row.ItemType}";
            }
            await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
            {
                ItemName = name,
                Section = row.DuctShape == "Round" ? "Hard Pipe" : "Trunk Line",
                Quantity = row.Qty,
                Unit = row.ItemType == "Trunk Section" ? "pc" : "ea",
                Notes = row.Notes,
            });
            count++;
        }

        // Return Trunk tab
        foreach (var row in _hvacReturnTrunkRows.Where(r => r.Qty > 0))
        {
            string name;
            if (string.IsNullOrWhiteSpace(row.Size))
                name = row.ItemType;
            else if (row.DuctShape == "Round" && row.ItemType is "Return Trunk Section" or "Return Drop")
                name = $"{row.Size}\" Round {row.ItemType}";
            else
                name = $"{row.Size} {row.ItemType}";
            await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
            {
                ItemName = name,
                Section = row.DuctShape == "Round" ? "Hard Pipe" : "Returns",
                Quantity = row.Qty,
                Unit = "ea",
                Notes = row.Notes,
            });
            count++;
        }

        // Misc tab
        foreach (var row in _hvacMiscRows.Where(r => !string.IsNullOrWhiteSpace(r.ItemName) && r.Qty > 0))
        {
            await ListSvc.AddItemAsync(detail.Id, new MaterialListItemEditModel
            {
                ItemName = row.ItemName,
                Section = row.Section ?? "Misc",
                Quantity = row.Qty,
                Unit = row.Unit ?? "ea",
                Notes = row.Notes,
            });
            count++;
        }

        if (count > 0)
        {
            _hvacBundleMsg = $"Added {count} item(s) to the list.";
            ResetHvacBundle();
            _hvacBundleMsg = $"Added {count} item(s) to the list.";
            await LoadDetailView(detail.Id);
        }
    }

    // --- Print / PDF ---
    private async Task PrintList(bool supplyHouseMode)
    {
        // Supply house mode always hides prices; customer mode uses the toggle
        if (supplyHouseMode)
        {
            _includePricesOnPdf = false;
            await JS.InvokeVoidAsync("eval", "document.body.classList.add('print-supply-house')");
        }
        else
            await JS.InvokeVoidAsync("eval", "document.body.classList.remove('print-supply-house')");

        // Apply print-no-prices class based on toggle
        if (!_includePricesOnPdf)
            await JS.InvokeVoidAsync("eval", "document.body.classList.add('print-no-prices')");
        else
            await JS.InvokeVoidAsync("eval", "document.body.classList.remove('print-no-prices')");

        try
        {
            // Use timeout to prevent blocking; print dialog can be canceled by user
            await JS.InvokeVoidAsync("window.print").AsTask().WaitAsync(TimeSpan.FromSeconds(30));
        }
        catch (TaskCanceledException)
        {
            // User canceled print dialog or browser canceled - ignore
        }
        catch (TimeoutException)
        {
            // Print took too long - ignore
        }
    }

    // --- Email ---
    private async Task EmailList()
    {
        if (detail is null) return;
        _emailSendResult = null;
        _emailSmtpConfigured = await EmailSvc.IsConfiguredAsync();
        _emailTo = "";
        _emailSubject = $"Material List: {detail.Name}";
        var sb = new System.Text.StringBuilder();
        sb.AppendLine($"Dear {detail.CustomerName ?? "Customer"},");
        sb.AppendLine();
        sb.AppendLine($"Please find attached the material list \"{detail.Name}\".");
        sb.AppendLine();
        if (!string.IsNullOrEmpty(detail.SiteName)) sb.AppendLine($"Site: {detail.SiteName}");
        if (!string.IsNullOrEmpty(detail.JobNumber)) sb.AppendLine($"Job: {detail.JobNumber}");
        sb.AppendLine($"Total: {detail.GrandTotal:C}");
        sb.AppendLine();
        sb.AppendLine("Please don't hesitate to reach out if you have any questions.");
        sb.AppendLine();
        sb.AppendLine("Thank you!");
        if (_companyProfile is not null)
        {
            sb.AppendLine();
            sb.AppendLine(_companyProfile.Name);
            if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) sb.AppendLine(_companyProfile.Phone);
            if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) sb.AppendLine(_companyProfile.Email);
        }
        _emailBody = sb.ToString();
        _showEmailModal = true;
    }

    private void CloseEmailModal() { _showEmailModal = false; _emailSendResult = null; }

    private async Task DownloadPdfForEmail()
    {
        _showEmailModal = false;
        await Task.Delay(100);
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task SendEmailFromModal()
    {
        await JS.InvokeVoidAsync("openMailto", _emailTo, _emailSubject, _emailBody);
        _showEmailModal = false;
    }

    private async Task SendEmailWithPdf()
    {
        if (detail is null || string.IsNullOrWhiteSpace(_emailTo)) return;
        _emailSending = true;
        _emailSendResult = null;
        StateHasChanged();
        try
        {
            var pdfHtml = BuildMaterialListPdfHtml(detail, _includePricesOnPdf);
            var pdfBytes = await PdfSvc.GeneratePdfFromHtmlAsync(pdfHtml);
            var fileName = $"MaterialList_{detail.Name.Replace(" ", "_")}_{DateTime.Now:yyyyMMdd}.pdf";
            await EmailSvc.SendEmailAsync(new EmailMessage
            {
                To = _emailTo,
                Subject = _emailSubject,
                Body = _emailBody,
                Attachments = [new EmailAttachment { FileName = fileName, Content = pdfBytes }],
            });
            _emailSendResult = "Sent successfully!";
        }
        catch (Exception ex) { _emailSendResult = $"Failed: {ex.Message}"; }
        finally { _emailSending = false; }
    }

    private string BuildMaterialListPdfHtml(MaterialListDetail d, bool includePrices = true)
    {
        var sb = new System.Text.StringBuilder();
        sb.Append("<div class=\"print-doc\">");

        // Banner
        sb.Append("<div class=\"print-doc-banner\">");
        sb.Append("<div class=\"print-doc-banner-left\">");
        sb.Append("<p class=\"print-doc-type\">Material List</p>");
        sb.Append($"<p class=\"print-doc-number-line\"><strong>{Enc(d.Name)}</strong>");
        if (!string.IsNullOrEmpty(d.PONumber)) sb.Append($" &mdash; PO# {Enc(d.PONumber)}");
        sb.Append("</p></div>");
        sb.Append("<div class=\"print-doc-banner-right\">");
        if (_companyProfile is not null)
        {
            sb.Append($"<p class=\"print-company-name\">{Enc(_companyProfile.Name)}</p>");
            if (!string.IsNullOrWhiteSpace(_companyProfile.Address)) sb.Append($"<p class=\"print-company-detail\">{Enc(_companyProfile.Address)}</p>");
            if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) sb.Append($"<p class=\"print-company-detail\">{Enc(_companyProfile.Phone)}</p>");
            if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) sb.Append($"<p class=\"print-company-detail\">{Enc(_companyProfile.Email)}</p>");
        }
        sb.Append("</div></div>");

        // Info bar
        sb.Append("<div class=\"print-doc-info-bar\">");
        sb.Append($"<div class=\"print-info-item\"><span class=\"print-info-label\">Status</span><span class=\"print-info-value\">{d.Status}</span></div>");
        sb.Append($"<div class=\"print-info-item\"><span class=\"print-info-label\">Date</span><span class=\"print-info-value\">{d.CreatedAt:MMM dd, yyyy}</span></div>");
        if (!string.IsNullOrWhiteSpace(d.TradeType)) sb.Append($"<div class=\"print-info-item\"><span class=\"print-info-label\">Trade</span><span class=\"print-info-value\">{Enc(d.TradeType)}</span></div>");
        sb.Append($"<div class=\"print-info-item\"><span class=\"print-info-label\">Pricing</span><span class=\"print-info-value\">{d.PricingMethod}</span></div>");
        sb.Append("</div>");

        // Addresses
        sb.Append("<div class=\"print-doc-addresses\">");
        if (!string.IsNullOrEmpty(d.CustomerName))
        {
            sb.Append("<div class=\"print-addr-block\"><span class=\"print-addr-label\">Customer</span>");
            sb.Append($"<p class=\"print-addr-name\">{Enc(d.CustomerName)}</p>");
            if (!string.IsNullOrEmpty(d.CustomerAddress)) sb.Append($"<p class=\"print-addr-line\">{Enc(d.CustomerAddress)}</p>");
            sb.Append("</div>");
        }
        if (!string.IsNullOrEmpty(d.SiteName))
        {
            sb.Append("<div class=\"print-addr-block\"><span class=\"print-addr-label\">Deliver To / Site</span>");
            sb.Append($"<p class=\"print-addr-name\">{Enc(d.SiteName)}</p>");
            if (!string.IsNullOrEmpty(d.SiteAddress)) sb.Append($"<p class=\"print-addr-line\">{Enc(d.SiteAddress)}</p>");
            sb.Append("</div>");
        }
        sb.Append("</div>");

        // Items
        if (d.Items.Any())
        {
            var groups = d.Items.OrderBy(i => i.SortOrder).GroupBy(i => i.Section ?? "General");
            var colSpan = includePrices ? "5" : "3";
            sb.Append("<table class=\"print-doc-table\"><thead><tr>");
            sb.Append("<th>Item</th><th class=\"text-center\">Qty</th><th>Unit</th>");
            if (includePrices) sb.Append("<th class=\"text-end\">Cost</th><th class=\"text-end\">Price</th>");
            sb.Append("</tr></thead><tbody>");
            foreach (var grp in groups)
            {
                if (groups.Count() > 1) sb.Append($"<tr class=\"print-section-divider\"><td colspan=\"{colSpan}\">{Enc(grp.Key)}</td></tr>");
                foreach (var item in grp)
                {
                    sb.Append("<tr>");
                    sb.Append($"<td>{Enc(item.ItemName)}");
                    if (!string.IsNullOrWhiteSpace(item.Notes)) sb.Append($" &mdash; {Enc(item.Notes)}");
                    sb.Append("</td>");
                    sb.Append($"<td class=\"text-center\">{item.Quantity}</td>");
                    sb.Append($"<td>{Enc(item.Unit ?? "Each")}</td>");
                    if (includePrices)
                    {
                        sb.Append($"<td class=\"text-end\">{item.BaseCost:C}</td>");
                        sb.Append($"<td class=\"text-end\">{item.FlatPrice:C}</td>");
                    }
                    sb.Append("</tr>");
                }
            }
            sb.Append("</tbody></table>");
        }

        // Totals
        if (includePrices)
        {
            sb.Append("<div class=\"print-doc-totals\">");
            sb.Append($"<div class=\"print-total-row print-total-subtotal\"><span class=\"print-total-label\">Material Cost</span><span class=\"print-total-value\">{d.TotalMaterialCost:C}</span></div>");
            if (d.TotalLaborCost > 0) sb.Append($"<div class=\"print-total-row\"><span class=\"print-total-label\">Labor</span><span class=\"print-total-value\">{d.TotalLaborCost:C}</span></div>");
            if (d.MarkupPercent > 0) sb.Append($"<div class=\"print-total-row\"><span class=\"print-total-label\">Markup ({d.MarkupPercent}%)</span><span class=\"print-total-value\">{d.TotalMaterialCost * d.MarkupPercent / 100:C}</span></div>");
            sb.Append($"<div class=\"print-total-row print-grand-total\"><span class=\"print-total-label\">Total</span><span class=\"print-total-value\">{d.GrandTotal:C}</span></div>");
            sb.Append("</div>");
        }

        // Notes
        if (!string.IsNullOrWhiteSpace(d.ExternalNotes))
        {
            sb.Append("<div class=\"print-doc-terms\">");
            sb.Append($"<div class=\"print-doc-terms-block\"><div class=\"print-terms-heading\">Notes</div><p class=\"print-terms-text\">{Enc(d.ExternalNotes)}</p></div>");
            sb.Append("</div>");
        }

        // Footer
        sb.Append("<div class=\"print-doc-footer\">");
        if (_companyProfile is not null)
        {
            if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) sb.Append($"<span class=\"print-footer-item\"><i class=\"bi bi-telephone print-footer-icon\"></i> {Enc(_companyProfile.Phone)}</span>");
            if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) sb.Append($"<span class=\"print-footer-item\"><i class=\"bi bi-envelope print-footer-icon\"></i> {Enc(_companyProfile.Email)}</span>");
            if (!string.IsNullOrWhiteSpace(_companyProfile.Address)) sb.Append($"<span class=\"print-footer-item\"><i class=\"bi bi-geo-alt print-footer-icon\"></i> {Enc(_companyProfile.Address)}</span>");
        }
        sb.Append("</div>");
        sb.Append("<div class=\"print-doc-thankyou\">Thank you for your business!</div>");
        sb.Append("</div>");
        return PdfService.WrapInHtmlDocument(sb.ToString());
    }

    private static string Enc(string? value) => System.Net.WebUtility.HtmlEncode(value ?? "");
}
