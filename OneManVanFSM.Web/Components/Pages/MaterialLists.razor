@page "/materiallists"
@page "/materiallists/new"
@page "/materiallists/{Id:int}"
@page "/materiallists/{Id:int}/edit"
@rendermode InteractiveServer
@implements IDisposable
@inject IMaterialListService ListSvc
@inject ICustomerService CustomerSvc
@inject ISiteService SiteSvc
@inject ICompanyProfileService CompanyProfileSvc
@inject NavigationManager Nav

@inject IJSRuntime JS

<PageTitle>Material Lists - OneManVanFSM</PageTitle>

@if (mode == "form")
{
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>@(editId.HasValue ? "Edit" : "New") Material List</h4>
    </div>

    @* Template selector â€” only on new list *@
    @if (!editId.HasValue && _templates.Any())
    {
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label small fw-semibold"><i class="bi bi-clipboard-check me-1"></i>Start from Template</label>
                        <select class="form-select form-select-sm" @onchange="OnTemplateSelected">
                            <option value="">â€” Blank List â€”</option>
                            @foreach (var t in _templates)
                            {
                                <option value="@t.Id">@t.Name (@t.ItemCount items)</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-6 text-muted small pt-2">
                        <i class="bi bi-info-circle me-1"></i>Selecting a template will clone its sections and items into this new list.
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="form" OnValidSubmit="SaveList">
                <DataAnnotationsValidator />
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <InputText @bind-Value="form.Name" class="form-control" />
                        <ValidationMessage For="() => form.Name" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Pricing Method</label>
                        <InputSelect @bind-Value="form.PricingMethod" class="form-select">
                            @foreach (var p in Enum.GetValues<PricingMethod>()) { <option value="@p">@p</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <InputSelect @bind-Value="form.Status" class="form-select">
                            @foreach (var s in Enum.GetValues<MaterialListStatus>()) { <option value="@s">@s</option> }
                        </InputSelect>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Trade Type</label>
                        <InputText @bind-Value="form.TradeType" class="form-control" placeholder="HVAC" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Template</label>
                        <div class="form-check mt-2">
                            <InputCheckbox @bind-Value="form.IsTemplate" class="form-check-input" />
                            <label class="form-check-label">Is Template</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <InputTextArea @bind-Value="form.Notes" class="form-control" rows="2" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">PO Number</label>
                        <InputText @bind-Value="form.PONumber" class="form-control" placeholder="Supply house PO / reference" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Job</label>
                        <InputSelect @bind-Value="form.JobId" class="form-select">
                            <option value="">â€” No Job â€”</option>
                            @foreach (var j in _jobs)
                            {
                                <option value="@j.Id">@j.Display</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Customer</label>
                        <InputSelect @bind-Value="form.CustomerId" class="form-select">
                            <option value="">â€” Select Customer â€”</option>
                            @foreach (var c in _customers)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Site</label>
                        <InputSelect @bind-Value="form.SiteId" class="form-select">
                            <option value="">â€” Select Site â€”</option>
                            @foreach (var s in _sites)
                            {
                                <option value="@s.Id">@s.Name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Internal Notes <small class="text-muted">(not shown on customer printouts)</small></label>
                        <InputTextArea @bind-Value="form.InternalNotes" class="form-control" rows="2" placeholder="Internal reference, supplier contacts, etc." />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">External Notes <small class="text-muted">(included on customer/supply house printouts)</small></label>
                        <InputTextArea @bind-Value="form.ExternalNotes" class="form-control" rows="2" placeholder="Delivery instructions, special requirements, etc." />
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save</button>
                    <button type="button" class="btn btn-outline-secondary ms-2" @onclick="GoToList">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(errorMsg)) { <div class="alert alert-danger mt-2 mb-0">@errorMsg</div> }
            </EditForm>
        </div>
    </div>
}
else if (mode == "detail" && detail is not null)
{
    <div class="d-flex align-items-center mb-3 no-print">
        <button class="btn btn-outline-secondary btn-sm me-2" @onclick="GoToList"><i class="bi bi-arrow-left"></i></button>
        <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>@detail.Name</h4>
        @if (detail.IsTemplate) { <span class="badge bg-info ms-2">Template</span> }
        <span class="badge ms-1 @StatusBadgeClass(detail.Status)">@detail.Status</span>
        <span class="badge bg-secondary ms-1">@detail.PricingMethod</span>
        @if (!string.IsNullOrEmpty(detail.TradeType)) { <span class="badge bg-dark ms-1">@detail.TradeType</span> }
        <div class="ms-auto d-flex gap-1">
            @* Status workflow buttons *@
            @if (detail.Status == MaterialListStatus.Draft)
            {
                <button class="btn btn-success btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Approved)" title="Approve this list"><i class="bi bi-check-circle me-1"></i>Approve</button>
            }
            else if (detail.Status == MaterialListStatus.Approved)
            {
                <button class="btn btn-primary btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Ordered)" title="Mark as ordered"><i class="bi bi-truck me-1"></i>Mark Ordered</button>
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Draft)" title="Return to draft"><i class="bi bi-arrow-counterclockwise me-1"></i>Back to Draft</button>
            }
            else if (detail.Status == MaterialListStatus.Ordered)
            {
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => ChangeStatus(MaterialListStatus.Approved)" title="Return to approved"><i class="bi bi-arrow-counterclockwise me-1"></i>Back to Approved</button>
            }
            <button class="btn btn-outline-success btn-sm" @onclick="() => PrintList(false)" title="Print for Customer (with prices)"><i class="bi bi-printer me-1"></i>Customer PDF</button>
            <button class="btn btn-outline-warning btn-sm" @onclick="() => PrintList(true)" title="Print for Supply House (no prices)"><i class="bi bi-box-seam me-1"></i>Supply PDF</button>
            @if (!string.IsNullOrEmpty(detail.CustomerName))
            {
                <button class="btn btn-outline-info btn-sm" @onclick="EmailList" title="Email material list"><i class="bi bi-envelope me-1"></i>Email</button>
            }
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-gear me-1"></i>Actions</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><button class="dropdown-item" @onclick="EditDetail"><i class="bi bi-pencil me-1"></i>Edit</button></li>
                    <li><button class="dropdown-item" @onclick="ConvertToEstimate"><i class="bi bi-calculator me-1"></i>Convert to Estimate</button></li>
                    <li><button class="dropdown-item" @onclick="CheckStock"><i class="bi bi-box-seam me-1"></i>Check Inventory Stock</button></li>
                    <li><hr class="dropdown-divider" /></li>
                    @if (_confirmArchive)
                    {
                        <li><button class="dropdown-item text-danger fw-semibold" @onclick="ArchiveDetail"><i class="bi bi-exclamation-triangle me-1"></i>Confirm Archive</button></li>
                        <li><button class="dropdown-item" @onclick="() => _confirmArchive = false"><i class="bi bi-x-lg me-1"></i>Cancel</button></li>
                    }
                    else
                    {
                        <li><button class="dropdown-item text-danger" @onclick="() => _confirmArchive = true"><i class="bi bi-archive me-1"></i>Archive</button></li>
                    }
                </ul>
            </div>
        </div>
    </div>

    @* Stock check results *@
    @if (_stockChecks is not null && _stockChecks.Any(s => s.IsLow))
    {
        <div class="alert alert-warning mb-3 no-print">
            <strong><i class="bi bi-exclamation-triangle me-1"></i>Low Stock Warning:</strong>
            @foreach (var s in _stockChecks.Where(s => s.IsLow))
            {
                <span class="d-block small">@s.ItemName â€” Need @s.RequestedQty, only @s.AvailableQty available</span>
            }
        </div>
    }

    @* Print options â€” visible only on screen *@
    <div class="card border-0 shadow-sm mb-3 no-print">
        <div class="card-body py-2">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <strong class="small"><i class="bi bi-sliders me-1"></i>Print Options:</strong>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="printExtNotes" @bind="_printExternalNotes" />
                    <label class="form-check-label small" for="printExtNotes">Include External Notes</label>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="printIntNotes" @bind="_printInternalNotes" />
                    <label class="form-check-label small" for="printIntNotes">Include Internal Notes</label>
                </div>
            </div>
        </div>
    </div>

    @* Print-only professional document *@
    <div class="print-doc d-none">
        <div class="print-doc-banner">
            <div class="print-doc-banner-left">
                <p class="print-doc-type">Material List</p>
                <p class="print-doc-number-line"><strong>@detail.Name</strong>@(!string.IsNullOrEmpty(detail.PONumber) ? $" â€” PO# {detail.PONumber}" : "")</p>
            </div>
            <div class="print-doc-banner-right">
                @if (_companyProfile is not null)
                {
                    <p class="print-company-name">@_companyProfile.Name</p>
                    @if (!string.IsNullOrWhiteSpace(_companyProfile.Address)) { <p class="print-company-detail">@_companyProfile.Address</p> }
                    @if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) { <p class="print-company-detail">@_companyProfile.Phone</p> }
                    @if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) { <p class="print-company-detail">@_companyProfile.Email</p> }
                }
            </div>
        </div>
        <div class="print-doc-info-bar">
            <div class="print-info-item"><span class="print-info-label">Status</span><span class="print-info-value">@detail.Status</span></div>
            <div class="print-info-item"><span class="print-info-label">Date</span><span class="print-info-value">@detail.CreatedAt.ToString("MMM dd, yyyy")</span></div>
            @if (!string.IsNullOrWhiteSpace(detail.TradeType)) { <div class="print-info-item"><span class="print-info-label">Trade</span><span class="print-info-value">@detail.TradeType</span></div> }
            <div class="print-info-item"><span class="print-info-label">Pricing</span><span class="print-info-value">@detail.PricingMethod</span></div>
        </div>
        <div class="print-doc-addresses">
            @if (!string.IsNullOrEmpty(detail.CustomerName))
            {
                <div class="print-addr-block">
                    <span class="print-addr-label">Customer</span>
                    <p class="print-addr-name">@detail.CustomerName</p>
                    @if (!string.IsNullOrEmpty(detail.CustomerAddress)) { <p class="print-addr-line">@detail.CustomerAddress</p> }
                </div>
            }
            @if (!string.IsNullOrEmpty(detail.SiteName))
            {
                <div class="print-addr-block">
                    <span class="print-addr-label">Deliver To / Site</span>
                    <p class="print-addr-name">@detail.SiteName</p>
                    @if (!string.IsNullOrEmpty(detail.SiteAddress)) { <p class="print-addr-line">@detail.SiteAddress</p> }
                </div>
            }
        </div>

        @if (detail.Items.Any())
        {
            var sections = detail.Items.OrderBy(i => i.SortOrder).GroupBy(i => i.Section ?? "General");
            <table class="print-doc-table">
                <thead><tr><th>Item</th><th class="text-center">Qty</th><th>Unit</th><th class="text-end print-price-col">Cost</th><th class="text-end print-price-col">Price</th></tr></thead>
                <tbody>
                    @foreach (var grp in sections)
                    {
                        @if (sections.Count() > 1)
                        {
                            <tr class="print-section-divider"><td colspan="5">@grp.Key</td></tr>
                        }
                        @foreach (var item in grp)
                        {
                            <tr>
                                <td>@item.ItemName@(!string.IsNullOrWhiteSpace(item.Notes) ? $" â€” {item.Notes}" : "")</td>
                                <td class="text-center">@item.Quantity</td>
                                <td>@(item.Unit ?? "Each")</td>
                                <td class="text-end print-price-col">@item.BaseCost.ToString("C")</td>
                                <td class="text-end print-price-col">@item.FlatPrice.ToString("C")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }

        <div class="print-doc-totals">
            <div class="print-total-row print-total-subtotal"><span class="print-total-label">Material Cost</span><span class="print-total-value">@detail.TotalMaterialCost.ToString("C")</span></div>
            @if (detail.TotalLaborCost > 0) { <div class="print-total-row"><span class="print-total-label">Labor</span><span class="print-total-value">@detail.TotalLaborCost.ToString("C")</span></div> }
            @if (detail.MarkupPercent > 0) { <div class="print-total-row"><span class="print-total-label">Markup (@detail.MarkupPercent%)</span><span class="print-total-value">@((detail.TotalMaterialCost * detail.MarkupPercent / 100).ToString("C"))</span></div> }
            @if (detail.TaxPercent > 0) { <div class="print-total-row"><span class="print-total-label">Tax (@detail.TaxPercent%)</span><span class="print-total-value">@((detail.GrandTotal * detail.TaxPercent / (100 + detail.TaxPercent)).ToString("C"))</span></div> }
            <div class="print-total-row print-grand-total"><span class="print-total-label">Total</span><span class="print-total-value">@detail.GrandTotal.ToString("C")</span></div>
        </div>

        <div class="print-doc-terms">
            @if (_printExternalNotes && !string.IsNullOrWhiteSpace(detail.ExternalNotes))
            {
                <div class="print-doc-terms-block"><div class="print-terms-heading">Notes</div><p class="print-terms-text">@detail.ExternalNotes</p></div>
            }
            @if (_printInternalNotes && !string.IsNullOrWhiteSpace(detail.InternalNotes))
            {
                <div class="print-doc-terms-block"><div class="print-terms-heading">Internal Notes</div><p class="print-terms-text">@detail.InternalNotes</p></div>
            }
        </div>

        <div class="print-doc-footer">
            @if (_companyProfile is not null)
            {
                @if (!string.IsNullOrWhiteSpace(_companyProfile.Phone)) { <span class="print-footer-item"><i class="bi bi-telephone print-footer-icon"></i> @_companyProfile.Phone</span> }
                @if (!string.IsNullOrWhiteSpace(_companyProfile.Email)) { <span class="print-footer-item"><i class="bi bi-envelope print-footer-icon"></i> @_companyProfile.Email</span> }
                @if (!string.IsNullOrWhiteSpace(_companyProfile.Address)) { <span class="print-footer-item"><i class="bi bi-geo-alt print-footer-icon"></i> @_companyProfile.Address</span> }
            }
        </div>
        <div class="print-doc-thankyou">Thank you for your business!</div>
    </div>

    <div class="print-screen-only">
    <div class="row g-3">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Items (@detail.Items.Count)</h6>
                        <button class="btn btn-primary btn-sm" @onclick="ShowAddItem"><i class="bi bi-plus-lg me-1"></i>Add Item</button>
                    </div>

                    @* Inline add/edit form *@
                    @if (_showItemForm)
                    {
                        <div class="card bg-light border mb-3">
                            <div class="card-body py-2">
                                <h6 class="mb-2">@(_editingItemId.HasValue ? "Edit" : "Add") Item</h6>

                                @* Product picker *@
                                <div class="row g-2 mb-2">
                                    <div class="col-md-6">
                                        <label class="form-label small fw-semibold"><i class="bi bi-search me-1"></i>Search Products</label>
                                        <input type="text" class="form-control form-control-sm" placeholder="Type to search products..." @bind="_productSearch" @bind:event="oninput" @bind:after="SearchProducts" />
                                    </div>
                                    @if (_productOptions.Any())
                                    {
                                        <div class="col-md-6">
                                            <label class="form-label small">Select Product</label>
                                            <select class="form-select form-select-sm" @onchange="OnProductSelected">
                                                <option value="">â€” Pick to auto-fill â€”</option>
                                                @foreach (var p in _productOptions)
                                                {
                                                    <option value="@p.Id">@p.Name (@(p.Category ?? "â€“")) â€” @p.Cost.ToString("C") @(p.StockQty.HasValue ? $"[Stock: {p.StockQty}]" : "")</option>
                                                }
                                            </select>
                                        </div>
                                    }
                                </div>

                                @* Pairing suggestions *@
                                @if (_pairingSuggestions.Any())
                                {
                                    <div class="alert alert-info py-1 px-2 small mb-2">
                                        <strong><i class="bi bi-link-45deg me-1"></i>Suggested Pairings:</strong>
                                        @foreach (var pair in _pairingSuggestions)
                                        {
                                            <span class="badge bg-info text-dark me-1">@pair.AssociatedItemName (@pair.Ratio:1 in @(pair.AssociatedSection ?? pair.TradeType))</span>
                                        }
                                    </div>
                                }

                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small">Item Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control form-control-sm" @bind="_itemForm.ItemName" @bind:event="oninput" @bind:after="OnItemNameChanged" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Section</label>
                                        <select class="form-select form-select-sm" @bind="_itemForm.Section">
                                            @foreach (var sec in _sectionPresets)
                                            {
                                                <option value="@sec">@sec</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Qty</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" @bind="_itemForm.Quantity" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Unit</label>
                                        <input type="text" class="form-control form-control-sm" @bind="_itemForm.Unit" @bind:event="oninput" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Cost</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" @bind="_itemForm.BaseCost" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Labor Hrs</label>
                                        <input type="number" step="0.25" class="form-control form-control-sm" @bind="_itemForm.LaborHours" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Flat Price</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" @bind="_itemForm.FlatPrice" />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">Markup %</label>
                                        <input type="number" step="0.5" class="form-control form-control-sm" @bind="_itemForm.MarkupPercent" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">Notes</label>
                                        <input type="text" class="form-control form-control-sm" @bind="_itemForm.Notes" @bind:event="oninput" />
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-primary btn-sm" @onclick="SaveItem"><i class="bi bi-check-lg me-1"></i>@(_editingItemId.HasValue ? "Update" : "Add")</button>
                                    <button class="btn btn-outline-secondary btn-sm ms-1" @onclick="CancelItemForm">Cancel</button>
                                </div>
                                @if (!string.IsNullOrEmpty(_itemError)) { <div class="text-danger small mt-1">@_itemError</div> }
                            </div>
                        </div>
                    }

                    @if (!detail.Items.Any())
                    {
                        <p class="text-muted">No items yet. Click <strong>Add Item</strong> to get started.</p>
                    }
                    else
                    {
                        @foreach (var grp in detail.Items.GroupBy(i => i.Section ?? "General"))
                        {
                            var sectionTotal = grp.Sum(i => i.BaseCost * i.Quantity);
                            <h6 class="mt-3 text-primary"><i class="bi bi-folder me-1"></i>@grp.Key <small class="text-muted fw-normal ms-2">(@grp.Count() items · @sectionTotal.ToString("C"))</small></h6>
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <thead class="table-light"><tr><th>Item</th><th>Qty</th><th>Unit</th><th class="print-price-col">Cost</th><th>Labor</th><th class="print-price-col">Flat</th><th class="print-price-col">Markup</th><th style="width:80px"></th></tr></thead>
                                    <tbody>
                                        @foreach (var item in grp)
                                        {
                                            <tr>
                                                <td>
                                                    @item.ItemName
                                                    @if (item.ProductName is not null) { <small class="text-muted">(@item.ProductName)</small> }
                                                    @if (item.InventoryStockQty.HasValue && item.InventoryStockQty < item.Quantity)
                                                    {
                                                        <span class="badge bg-warning text-dark ms-1" title="Stock: @item.InventoryStockQty"><i class="bi bi-exclamation-triangle"></i> Low</span>
                                                    }
                                                </td>
                                                <td>@item.Quantity</td>
                                                <td>@(item.Unit ?? "â€”")</td>
                                                <td class="print-price-col">@item.BaseCost.ToString("C")</td>
                                                <td>@item.LaborHours hrs</td>
                                                <td class="print-price-col">@item.FlatPrice.ToString("C")</td>
                                                <td class="print-price-col">@item.MarkupPercent%</td>
                                                <td class="text-end no-print">
                                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" @onclick="() => EditItem(item)" title="Edit"><i class="bi bi-pencil"></i></button>
                                                    <button class="btn btn-sm btn-outline-danger py-0 px-1 ms-1" @onclick="() => RemoveItem(item.Id)" title="Remove"><i class="bi bi-trash"></i></button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.Notes)) { <hr class="my-2" /><p class="mb-0">@detail.Notes</p> }
                    @if (!string.IsNullOrWhiteSpace(detail.ExternalNotes))
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted small mb-1"><i class="bi bi-chat-left-text me-1"></i>External Notes</h6>
                        <p class="mb-0 small">@detail.ExternalNotes</p>
                    }
                    @if (!string.IsNullOrWhiteSpace(detail.InternalNotes))
                    {
                        <hr class="my-2" />
                        <h6 class="text-muted small mb-1"><i class="bi bi-lock me-1"></i>Internal Notes <span class="badge bg-secondary">Internal Only</span></h6>
                        <p class="mb-0 small text-muted">@detail.InternalNotes</p>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-4 no-print">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Financial Summary</h6>
                    <div class="d-flex justify-content-between mb-1"><span>Materials:</span><strong>@detail.TotalMaterialCost.ToString("C")</strong></div>
                    <div class="d-flex justify-content-between mb-1"><span>Labor:</span><strong>@detail.TotalLaborCost.ToString("C")</strong></div>
                    @if (detail.MarkupPercent > 0) { <div class="d-flex justify-content-between mb-1"><span>Markup:</span><strong>@detail.MarkupPercent%</strong></div> }
                    @if (detail.TaxPercent > 0) { <div class="d-flex justify-content-between mb-1"><span>Tax:</span><strong>@detail.TaxPercent%</strong></div> }
                    @if (detail.ContingencyPercent > 0) { <div class="d-flex justify-content-between mb-1"><span>Contingency:</span><strong>@detail.ContingencyPercent%</strong></div> }
                    <hr class="my-2" />
                    <div class="d-flex justify-content-between"><span class="fw-bold">Grand Total:</span><strong class="text-primary fs-5">@detail.GrandTotal.ToString("C")</strong></div>
                </div>
            </div>
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-white"><strong><i class="bi bi-link-45deg me-1"></i>Connections</strong></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Customer</small>
                            @if (detail.CustomerId.HasValue && detail.CustomerName is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToCustomer(detail.CustomerId.Value)">@detail.CustomerName</a> }
                            else { <span>â€”</span> }
                            @if (!string.IsNullOrEmpty(detail.CustomerAddress)) { <small class="text-muted d-block">@detail.CustomerAddress</small> }
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted d-block">Site</small>
                            @if (detail.SiteId.HasValue && detail.SiteName is not null)
                            { <a href="javascript:void(0)" @onclick="() => GoToSite(detail.SiteId.Value)">@detail.SiteName</a> }
                            else { <span>â€”</span> }
                            @if (!string.IsNullOrEmpty(detail.SiteAddress)) { <small class="text-muted d-block">@detail.SiteAddress</small> }
                        </div>
                    </div>
                    @if (detail.JobId.HasValue && !string.IsNullOrEmpty(detail.JobNumber))
                    {
                        <hr class="my-2" />
                        <small class="text-muted d-block">Linked Job</small>
                        <a href="javascript:void(0)" @onclick="() => GoToJob(detail.JobId.Value)"><i class="bi bi-briefcase me-1"></i>@detail.JobNumber</a>
                    }
                    @if (!string.IsNullOrEmpty(detail.PONumber))
                    {
                        <hr class="my-2" />
                        <small class="text-muted d-block">PO Number</small>
                        <strong>@detail.PONumber</strong>
                    }
                    <hr class="my-2" />
                    <div class="d-flex gap-3 text-muted small flex-wrap">
                        <span><strong>Status:</strong> @detail.Status</span>
                        @if (!string.IsNullOrEmpty(detail.TradeType)) { <span><strong>Trade:</strong> @detail.TradeType</span> }
                        <span><strong>Method:</strong> @detail.PricingMethod</span>
                        <span><strong>Created:</strong> @detail.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                        <span><strong>Updated:</strong> @detail.UpdatedAt.ToString("MMM dd, yyyy h:mm tt")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> @* end print-screen-only *@
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-list-check me-2"></i>Material Lists</h4>
        <button class="btn btn-primary btn-sm" @onclick="GoToNew"><i class="bi bi-plus-lg me-1"></i>New List</button>
    </div>
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body py-2">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" placeholder="Search lists..." @bind="filter.Search" @bind:event="oninput" @bind:after="LoadLists" />
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterTemplate" @bind:after="LoadLists">
                        <option value="">All Types</option>
                        <option value="true">Templates Only</option>
                        <option value="false">Non-Templates</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" @bind="filterStatus" @bind:after="LoadLists">
                        <option value="">All Statuses</option>
                        @foreach (var s in Enum.GetValues<MaterialListStatus>()) { <option value="@s">@s</option> }
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" @bind="filterTradeType" @bind:after="LoadLists">
                        <option value="">All Trades</option>
                        <option value="HVAC">HVAC</option>
                        <option value="Plumbing">Plumbing</option>
                        <option value="Electrical">Electrical</option>
                        <option value="General">General</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    <div class="card border-0 shadow-sm">
        @if (lists is null)
        {
            <div class="card-body text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>
        }
        else if (!lists.Any())
        {
            <div class="card-body text-center py-5 text-muted"><i class="bi bi-list-check" style="font-size:3rem;"></i><p class="mt-2">No material lists. <a href="javascript:void(0)" @onclick="GoToNew">Create one</a>.</p></div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light"><tr>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Name")'>Name @SortIcon("Name")</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Status")'>Status @SortIcon("Status")</th>
                        <th>Method</th><th>Customer</th><th>Job</th><th>Items</th>
                        <th>Materials</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("Total")'>Total @SortIcon("Total")</th>
                        <th style="cursor:pointer" @onclick='() => ToggleSort("CreatedAt")'>Created @SortIcon("CreatedAt")</th>
                    </tr></thead>
                    <tbody>
                        @foreach (var ml in lists)
                        {
                            <tr style="cursor:pointer" @onclick="() => GoToDetail(ml.Id)">
                                <td>
                                    <strong>@ml.Name</strong>
                                    @if (ml.IsTemplate) { <span class="badge bg-info ms-1">Template</span> }
                                    @if (!string.IsNullOrEmpty(ml.TradeType)) { <span class="badge bg-dark ms-1">@ml.TradeType</span> }
                                </td>
                                <td><span class="badge @StatusBadgeClass(ml.Status)">@ml.Status</span></td>
                                <td><span class="badge bg-secondary">@ml.PricingMethod</span></td>
                                <td>@(ml.CustomerName ?? "â€”")</td>
                                <td>@(ml.JobNumber ?? "â€”")</td>
                                <td>@ml.ItemCount</td>
                                <td>@ml.TotalMaterialCost.ToString("C")</td>
                                <td><strong>@ml.GrandTotal.ToString("C")</strong></td>
                                <td>@ml.CreatedAt.ToString("MMM dd, yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    private string mode = "list";
    private List<MaterialListListItem>? lists;
    private MaterialListFilter filter = new();
    private string filterTemplate = "";
    private string filterStatus = "";
    private string filterTradeType = "";
    private MaterialListDetail? detail;
    private CompanyProfile? _companyProfile;
    private MaterialListEditModel form = new();
    private int? editId;
    private string? errorMsg;
    private bool _confirmArchive;

    private List<CustomerListItem> _customers = [];
    private List<SiteListItem> _sites = [];
    private List<MaterialJobOption> _jobs = [];
    private List<MaterialListListItem> _templates = [];

    // Item management
    private bool _showItemForm;
    private int? _editingItemId;
    private MaterialListItemEditModel _itemForm = new();
    private string? _itemError;

    // Product picker
    private string _productSearch = "";
    private List<MaterialProductOption> _productOptions = [];

    // HVAC pairings
    private List<ItemAssociation> _pairingSuggestions = [];

    // Stock check
    private List<MaterialStockCheck>? _stockChecks;

    // Print options
    private bool _printExternalNotes = true;
    private bool _printInternalNotes;

    // HVAC section presets
    private static readonly string[] _sectionPresets =
    [
        "General", "Ductwork", "Flex Duct", "Take Offs", "Boots",
        "Returns", "Trunk Line", "Hard Pipe", "Grills/Registers",
        "Sealing & Taping", "Support & Hangers", "Insulation",
        "Fittings", "Equipment", "Accessories", "Disposal",
        "Permits", "Misc", "Labor"
    ];

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        await DetermineView();
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await DetermineView();
        await InvokeAsync(StateHasChanged);
    }

    private async Task DetermineView()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.AbsolutePath.Contains("/materiallists/new", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            mode = "form"; editId = null; form = new();
        }
        else if (Id.HasValue && uri.AbsolutePath.Contains("/edit", StringComparison.OrdinalIgnoreCase))
        {
            await LoadDropdowns();
            await LoadForEdit(Id.Value);
        }
        else if (Id.HasValue)
            await LoadDetailView(Id.Value);
        else { mode = "list"; await LoadLists(); }
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadLists()
    {
        filter.IsTemplate = string.IsNullOrWhiteSpace(filterTemplate) ? null : bool.Parse(filterTemplate);
        filter.Status = string.IsNullOrWhiteSpace(filterStatus) ? null : Enum.Parse<MaterialListStatus>(filterStatus);
        filter.TradeType = string.IsNullOrWhiteSpace(filterTradeType) ? null : filterTradeType;
        lists = await ListSvc.GetListsAsync(filter);
    }

    private async Task LoadDetailView(int id)
    {
        detail = await ListSvc.GetListAsync(id);
        _stockChecks = null;
        mode = detail is not null ? "detail" : "list";
        if (mode == "detail") _companyProfile = await CompanyProfileSvc.GetProfileAsync();
        if (mode == "list") await LoadLists();
    }

    private async Task LoadForEdit(int id)
    {
        var d = await ListSvc.GetListAsync(id);
        if (d is null) { mode = "list"; await LoadLists(); return; }
        editId = id;
        form = new MaterialListEditModel
        {
            Name = d.Name, IsTemplate = d.IsTemplate,
            Status = d.Status, TradeType = d.TradeType,
            PricingMethod = d.PricingMethod, Notes = d.Notes,
            InternalNotes = d.InternalNotes, ExternalNotes = d.ExternalNotes,
            PONumber = d.PONumber,
            JobId = d.JobId, CustomerId = d.CustomerId, SiteId = d.SiteId
        };
        mode = "form";
    }

    private async Task SaveList()
    {
        try
        {
            errorMsg = null;
            MaterialList saved;
            if (editId.HasValue)
                saved = await ListSvc.UpdateListAsync(editId.Value, form);
            else if (_selectedTemplateId.HasValue)
            {
                saved = await ListSvc.CloneFromTemplateAsync(_selectedTemplateId.Value, form.Name);
                // Apply form overrides to clone
                await ListSvc.UpdateListAsync(saved.Id, form);
            }
            else
                saved = await ListSvc.CreateListAsync(form);

            Nav.NavigateTo($"/materiallists/{saved.Id}");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    private async Task ArchiveDetail()
    {
        if (detail is not null) { await ListSvc.ArchiveListAsync(detail.Id); _confirmArchive = false; Nav.NavigateTo("/materiallists"); }
    }

    private void GoToList() => Nav.NavigateTo("/materiallists");
    private void GoToNew() => Nav.NavigateTo("/materiallists/new");
    private void GoToDetail(int id) => Nav.NavigateTo($"/materiallists/{id}");
    private void EditDetail() { if (detail is not null) Nav.NavigateTo($"/materiallists/{detail.Id}/edit"); }
    private void GoToCustomer(int id) => Nav.NavigateTo($"/customers/{id}");
    private void GoToSite(int id) => Nav.NavigateTo($"/sites/{id}");
    private void GoToJob(int id) => Nav.NavigateTo($"/jobs/{id}");

    private async Task ToggleSort(string column)
    {
        if (filter.SortBy == column) filter.SortDescending = !filter.SortDescending;
        else { filter.SortBy = column; filter.SortDescending = false; }
        await LoadLists();
    }

    private RenderFragment SortIcon(string column) => builder =>
    {
        var css = filter.SortBy == column
            ? (filter.SortDescending ? "bi-sort-down" : "bi-sort-up")
            : "bi-arrow-down-up opacity-25";
        builder.OpenElement(0, "i");
        builder.AddAttribute(1, "class", $"bi {css} ms-1{(filter.SortBy == column ? " text-primary" : "")}");
        builder.CloseElement();
    };

    private async Task LoadDropdowns()
    {
        _customers = await CustomerSvc.GetCustomersAsync();
        _sites = await SiteSvc.GetSitesAsync();
        _jobs = await ListSvc.GetJobOptionsAsync();
        _templates = await ListSvc.GetListsAsync(new MaterialListFilter { IsTemplate = true });
    }

    // --- Template selector ---
    private int? _selectedTemplateId;
    private void OnTemplateSelected(ChangeEventArgs e)
    {
        _selectedTemplateId = int.TryParse(e.Value?.ToString(), out var tid) ? tid : null;
    }

    // --- Status workflow ---
    private async Task ChangeStatus(MaterialListStatus newStatus)
    {
        if (detail is null) return;
        await ListSvc.UpdateStatusAsync(detail.Id, newStatus);
        await LoadDetailView(detail.Id);
    }

    private static string StatusBadgeClass(MaterialListStatus status) => status switch
    {
        MaterialListStatus.Draft => "bg-secondary",
        MaterialListStatus.Approved => "bg-success",
        MaterialListStatus.Ordered => "bg-primary",
        _ => "bg-secondary"
    };

    // --- Product picker ---
    private async Task SearchProducts()
    {
        if (_productSearch.Length >= 2)
            _productOptions = await ListSvc.GetProductOptionsAsync(_productSearch);
        else
            _productOptions = [];
    }

    private void OnProductSelected(ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out var pid)) return;
        var product = _productOptions.FirstOrDefault(p => p.Id == pid);
        if (product is null) return;
        _itemForm.ItemName = product.Name;
        _itemForm.BaseCost = product.Cost;
        _itemForm.Unit = product.Unit ?? "ea";
        _itemForm.MarkupPercent = product.MarkupPercent;
        _itemForm.ProductId = product.Id;
        _itemForm.InventoryItemId = product.InventoryItemId;
        if (!string.IsNullOrEmpty(product.Category) && _sectionPresets.Contains(product.Category))
            _itemForm.Section = product.Category;
    }

    // --- HVAC pairing suggestions ---
    private async Task OnItemNameChanged()
    {
        if (!string.IsNullOrWhiteSpace(_itemForm.ItemName) && _itemForm.ItemName.Length >= 3)
            _pairingSuggestions = await ListSvc.GetPairingsAsync(_itemForm.ItemName, detail?.TradeType ?? "HVAC");
        else
            _pairingSuggestions = [];
    }

    // --- Stock check ---
    private async Task CheckStock()
    {
        if (detail is null) return;
        _stockChecks = await ListSvc.CheckInventoryStockAsync(detail.Id);
    }

    // --- Convert to Estimate ---
    private async Task ConvertToEstimate()
    {
        if (detail is null) return;
        try
        {
            var estimateId = await ListSvc.ConvertToEstimateAsync(detail.Id);
            Nav.NavigateTo($"/estimates/{estimateId}");
        }
        catch (Exception ex) { errorMsg = ex.Message; }
    }

    // --- Item management ---
    private void ShowAddItem()
    {
        _editingItemId = null;
        _itemForm = new MaterialListItemEditModel();
        _showItemForm = true;
        _itemError = null;
        _productSearch = "";
        _productOptions = [];
        _pairingSuggestions = [];
    }

    private void EditItem(MaterialListItemDto item)
    {
        _editingItemId = item.Id;
        _itemForm = new MaterialListItemEditModel
        {
            ItemName = item.ItemName, Section = item.Section ?? "General",
            Quantity = item.Quantity, Unit = item.Unit,
            BaseCost = item.BaseCost, LaborHours = item.LaborHours,
            FlatPrice = item.FlatPrice, MarkupPercent = item.MarkupPercent,
            ProductId = item.ProductId, InventoryItemId = item.InventoryItemId,
            SortOrder = item.SortOrder, Notes = item.Notes,
        };
        _showItemForm = true;
        _itemError = null;
        _productSearch = "";
        _productOptions = [];
        _pairingSuggestions = [];
    }

    private void CancelItemForm()
    {
        _showItemForm = false;
        _editingItemId = null;
        _itemError = null;
        _productSearch = "";
        _productOptions = [];
        _pairingSuggestions = [];
    }

    private async Task SaveItem()
    {
        if (string.IsNullOrWhiteSpace(_itemForm.ItemName))
        {
            _itemError = "Item name is required.";
            return;
        }
        try
        {
            if (_editingItemId.HasValue)
                await ListSvc.UpdateItemAsync(detail!.Id, _editingItemId.Value, _itemForm);
            else
                await ListSvc.AddItemAsync(detail!.Id, _itemForm);

            _showItemForm = false;
            _editingItemId = null;
            _itemError = null;
            _productSearch = "";
            _productOptions = [];
            _pairingSuggestions = [];
            await LoadDetailView(detail!.Id);
        }
        catch (Exception ex) { _itemError = ex.Message; }
    }

    private async Task RemoveItem(int itemId)
    {
        if (detail is null) return;
        await ListSvc.RemoveItemAsync(detail.Id, itemId);
        await LoadDetailView(detail.Id);
    }

    // --- Print / PDF ---
    private async Task PrintList(bool supplyHouseMode)
    {
        if (supplyHouseMode)
            await JS.InvokeVoidAsync("eval", "document.body.classList.add('print-supply-house')");
        else
            await JS.InvokeVoidAsync("eval", "document.body.classList.remove('print-supply-house')");

        await JS.InvokeVoidAsync("window.print");
    }

    // --- Email ---
    private async Task EmailList()
    {
        if (detail is null) return;
        var subject = Uri.EscapeDataString($"Material List: {detail.Name}");
        var lines = new System.Text.StringBuilder();
        lines.AppendLine($"Material List: {detail.Name}");
        if (!string.IsNullOrEmpty(detail.CustomerName)) lines.AppendLine($"Customer: {detail.CustomerName}");
        if (!string.IsNullOrEmpty(detail.SiteName)) lines.AppendLine($"Site: {detail.SiteName}");
        if (!string.IsNullOrEmpty(detail.JobNumber)) lines.AppendLine($"Job: {detail.JobNumber}");
        lines.AppendLine();
        foreach (var grp in detail.Items.GroupBy(i => i.Section ?? "General"))
        {
            lines.AppendLine($"--- {grp.Key} ---");
            foreach (var item in grp)
                lines.AppendLine($"  {item.ItemName}  Qty: {item.Quantity} {item.Unit}  Cost: {item.BaseCost:C}");
            lines.AppendLine();
        }
        lines.AppendLine($"Total: {detail.GrandTotal:C}");
        var body = Uri.EscapeDataString(lines.ToString());
        await JS.InvokeVoidAsync("eval", $"window.location.href='mailto:?subject={subject}&body={body}'");
    }
}
