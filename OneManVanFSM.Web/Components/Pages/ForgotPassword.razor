@page "/login/forgot"
@layout EmptyLayout
@inject IAuthService AuthService

<PageTitle>Forgot Password - OneManVanFSM</PageTitle>

<div class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="card border-0 shadow" style="max-width: 420px; width: 100%;">
        <div class="card-body p-4 text-center">
            <i class="bi bi-key text-primary" style="font-size: 2.5rem;"></i>
            <h4 class="mt-2 mb-1">Forgot Password</h4>
            <p class="text-muted small mb-3">Enter your email to receive a password reset link.</p>

            @if (_submitted)
            {
                <div class="alert alert-success py-2 small">
                    If an account with that email exists, a reset link has been sent. Check your inbox.
                </div>
                <a href="/login" class="btn btn-outline-primary w-100">Back to Login</a>
            }
            else
            {
                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <div class="alert alert-danger py-2 small">@_errorMessage</div>
                }

                <EditForm Model="_model" OnValidSubmit="HandleReset" FormName="forgotForm">
                    <DataAnnotationsValidator />

                    <div class="mb-3 text-start">
                        <label class="form-label small text-muted">Email Address</label>
                        <InputText @bind-Value="_model.Email" class="form-control" placeholder="Enter your email" disabled="@_isLoading" />
                        <ValidationMessage For="() => _model.Email" />
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>Sending...</span>
                        }
                        else
                        {
                            <span>Send Reset Link</span>
                        }
                    </button>
                </EditForm>

                <a href="/login" class="small text-decoration-none">Back to Login</a>
            }
        </div>
    </div>
</div>

@code {
[SupplyParameterFromForm]
private ForgotModel _model { get; set; } = new();
private string? _errorMessage;
private bool _submitted;
private bool _isLoading;

    private async Task HandleReset()
    {
        _errorMessage = null;
        _isLoading = true;

        try
        {
            await AuthService.RequestPasswordResetAsync(_model.Email);
            _submitted = true;
        }
        catch
        {
            _errorMessage = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private sealed class ForgotModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required.")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Enter a valid email.")]
        public string Email { get; set; } = string.Empty;
    }
}
