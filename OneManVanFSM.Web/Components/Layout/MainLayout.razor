@inherits LayoutComponentBase
@implements IDisposable
@using OneManVanFSM.Shared.Services
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject IPermissionService PermSvc

<AuthorizeView>
    <Authorized>
        @{ _userName = context.User.Identity?.Name ?? "User"; _userRole = context.User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "User"; }
    </Authorized>
</AuthorizeView>

<div class="app-layout @(_darkMode ? "dark-theme" : "")">
    @* ===== SIDEBAR (Left Navigation per UI Layout guideline) ===== *@
    @* Mobile backdrop overlay *@
    <div class="sidebar-backdrop @(_mobileMenuOpen ? "visible" : "")" @onclick="CloseMobileMenu"></div>

    <aside class="app-sidebar @(SidebarCollapsed ? "collapsed" : "") @(_mobileMenuOpen ? "mobile-open" : "")">
        <div class="sidebar-brand">
            <button type="button" class="brand-button" @onclick="ShowAboutModal" title="About OneManVanFSM">
                <i class="bi bi-tools"></i>
                @if (!SidebarCollapsed)
                {
                    <span>OneManVan</span>
                }
            </button>
        </div>

        <nav class="sidebar-nav">
            @* Dashboard & Calendar — primary views (always visible) *@
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All" title="Dashboard">
                <i class="bi bi-speedometer2"></i>@if (!SidebarCollapsed) { <span>Dashboard</span> }
            </NavLink>
            @if (Can(Features.Calendar))
            {
                <NavLink class="nav-link" href="calendar" title="Calendar">
                    <i class="bi bi-calendar3"></i>@if (!SidebarCollapsed) { <span>Calendar</span> }
                </NavLink>
            }

            @* Clients *@
            @if (Can(Features.Customers) || Can(Features.Companies) || Can(Features.Sites))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Clients" : "")</div>
                @if (Can(Features.Customers))
                {
                    <NavLink class="nav-link" href="customers" title="Customers">
                        <i class="bi bi-people-fill"></i>@if (!SidebarCollapsed) { <span>Customers</span> }
                    </NavLink>
                }
                @if (Can(Features.Companies))
                {
                    <NavLink class="nav-link" href="companies" title="Companies">
                        <i class="bi bi-building"></i>@if (!SidebarCollapsed) { <span>Companies</span> }
                    </NavLink>
                }
                @if (Can(Features.Sites))
                {
                    <NavLink class="nav-link" href="sites" title="Sites">
                        <i class="bi bi-geo-alt-fill"></i>@if (!SidebarCollapsed) { <span>Sites</span> }
                    </NavLink>
                }
            }

            @* Inventory & Products *@
            @if (Can(Features.Products) || Can(Features.Inventory) || Can(Features.MaterialLists) || Can(Features.Templates) || Can(Features.Suppliers))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Inventory & Products" : "")</div>
                @if (Can(Features.Products))
                {
                    <NavLink class="nav-link" href="products" title="Products">
                        <i class="bi bi-box-seam-fill"></i>@if (!SidebarCollapsed) { <span>Products</span> }
                    </NavLink>
                }
                @if (Can(Features.Inventory))
                {
                    <NavLink class="nav-link" href="inventory" title="Inventory">
                        <i class="bi bi-boxes"></i>@if (!SidebarCollapsed) { <span>Inventory</span> }
                    </NavLink>
                }
                @if (Can(Features.MaterialLists))
                {
                    <NavLink class="nav-link" href="materiallists" title="Material Lists">
                        <i class="bi bi-list-check"></i>@if (!SidebarCollapsed) { <span>Material Lists</span> }
                    </NavLink>
                }
                @if (Can(Features.Templates))
                {
                    <NavLink class="nav-link" href="templates" title="Templates">
                        <i class="bi bi-copy"></i>@if (!SidebarCollapsed) { <span>Templates</span> }
                    </NavLink>
                }
                @if (Can(Features.Suppliers))
                {
                    <NavLink class="nav-link" href="suppliers" title="Suppliers">
                        <i class="bi bi-truck"></i>@if (!SidebarCollapsed) { <span>Suppliers</span> }
                    </NavLink>
                }
            }

            @* Bidding & Planning *@
            @if (Can(Features.Estimates))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Bidding & Planning" : "")</div>
                <NavLink class="nav-link" href="estimates" title="Estimates">
                    <i class="bi bi-calculator-fill"></i>@if (!SidebarCollapsed) { <span>Estimates</span> }
                </NavLink>
            }

            @* Operations *@
            @if (Can(Features.Jobs))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Operations" : "")</div>
                <NavLink class="nav-link" href="jobs" title="Jobs">
                    <i class="bi bi-wrench-adjustable-circle-fill"></i>@if (!SidebarCollapsed) { <span>Jobs</span> }
                </NavLink>
            }

            @* Services & History *@
            @if (Can(Features.ServiceAgreements) || Can(Features.Assets) || Can(Features.ServiceHistory))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Services" : "")</div>
                @if (Can(Features.ServiceAgreements))
                {
                    <NavLink class="nav-link" href="serviceagreements" title="Service Agreements">
                        <i class="bi bi-file-earmark-check-fill"></i>@if (!SidebarCollapsed) { <span>Agreements</span> }
                    </NavLink>
                }
                @if (Can(Features.Assets))
                {
                    <NavLink class="nav-link" href="assets" title="Assets">
                        <i class="bi bi-cpu-fill"></i>@if (!SidebarCollapsed) { <span>Assets</span> }
                    </NavLink>
                }
                @if (Can(Features.ServiceHistory))
                {
                    <NavLink class="nav-link" href="servicehistory" title="Service History">
                        <i class="bi bi-wrench-adjustable"></i>@if (!SidebarCollapsed) { <span>Service History</span> }
                    </NavLink>
                }
            }

            @* Financials *@
            @if (Can(Features.Financials) || Can(Features.Invoices) || Can(Features.Expenses))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Financials" : "")</div>
                @if (Can(Features.Financials))
                {
                    <NavLink class="nav-link" href="financials" Match="NavLinkMatch.All" title="Overview">
                        <i class="bi bi-cash-stack"></i>@if (!SidebarCollapsed) { <span>Overview</span> }
                    </NavLink>
                }
                @if (Can(Features.Invoices))
                {
                    <NavLink class="nav-link" href="financials/invoices" title="Invoices">
                        <i class="bi bi-receipt"></i>@if (!SidebarCollapsed) { <span>Invoices</span> }
                    </NavLink>
                }
                @if (Can(Features.Expenses))
                {
                    <NavLink class="nav-link" href="financials/expenses" title="Expenses">
                        <i class="bi bi-wallet2"></i>@if (!SidebarCollapsed) { <span>Expenses</span> }
                    </NavLink>
                }
            }

            @* Team & HR *@
            @if (Can(Features.Employees))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Team & HR" : "")</div>
                <NavLink class="nav-link" href="employees" title="Employees">
                    <i class="bi bi-person-badge-fill"></i>@if (!SidebarCollapsed) { <span>Employees</span> }
                </NavLink>
            }

            @* Documents & Notes *@
            @if (Can(Features.Documents) || Can(Features.QuickNotes))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Documents & Notes" : "")</div>
                @if (Can(Features.Documents))
                {
                    <NavLink class="nav-link" href="documents" title="Documents">
                        <i class="bi bi-folder-fill"></i>@if (!SidebarCollapsed) { <span>Documents</span> }
                    </NavLink>
                }
                @if (Can(Features.QuickNotes))
                {
                    <NavLink class="nav-link" href="quicknotes" title="Quick Notes">
                        <i class="bi bi-sticky-fill"></i>@if (!SidebarCollapsed) { <span>Quick Notes</span> }
                    </NavLink>
                }
            }

            @* Insights *@
            @if (Can(Features.Reports))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Insights" : "")</div>
                <NavLink class="nav-link" href="reports" title="Reports">
                    <i class="bi bi-graph-up"></i>@if (!SidebarCollapsed) { <span>Reports</span> }
                </NavLink>
            }

            @* Admin *@
            @if (Can(Features.Settings))
            {
                <div class="nav-section-header">@(!SidebarCollapsed ? "Admin" : "")</div>
                <NavLink class="nav-link" href="settings" title="Settings">
                    <i class="bi bi-gear-fill"></i>@if (!SidebarCollapsed) { <span>Settings</span> }
                </NavLink>
            }
        </nav>
    </aside>

    @* ===== MAIN AREA ===== *@
    <div class="app-main">
        @* ===== HEADER (Fixed Top Bar per UI Layout guideline) ===== *@
        <header class="app-header">
            <div class="header-left">
                <button class="btn btn-link sidebar-toggle" @onclick="ToggleSidebar" title="Toggle sidebar">
                    <i class="bi bi-list"></i>
                </button>
                <button type="button" class="header-brand d-md-none" @onclick="ShowAboutModal" title="About OneManVanFSM">OneManVan</button>
            </div>

            <div class="header-center">
                <div class="global-search">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search jobs, customers, invoices..."
                           @bind="_searchText" @bind:event="oninput"
                           @onkeydown="HandleSearchKeyDown" />
                </div>
            </div>

            <div class="header-right">
                @* Date/Period Selector *@
                <div class="dropdown d-none d-md-block">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-calendar-date"></i> @_selectedPeriodLabel
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item @(_selectedPeriod == "today" ? "active" : "")" href="javascript:void(0)" @onclick='() => SetPeriod("today", "Today")'>Today</a></li>
                        <li><a class="dropdown-item @(_selectedPeriod == "week" ? "active" : "")" href="javascript:void(0)" @onclick='() => SetPeriod("week", "This Week")'>This Week</a></li>
                        <li><a class="dropdown-item @(_selectedPeriod == "month" ? "active" : "")" href="javascript:void(0)" @onclick='() => SetPeriod("month", "This Month")'>This Month</a></li>
                    </ul>
                </div>

                @* Quick Actions *@
                <div class="dropdown">
                    <button class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-plus-lg"></i><span class="d-none d-md-inline"> New</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="jobs/new"><i class="bi bi-wrench me-2"></i>New Job</a></li>
                        <li><a class="dropdown-item" href="estimates/new"><i class="bi bi-calculator me-2"></i>New Estimate</a></li>
                        <li><a class="dropdown-item" href="customers/new"><i class="bi bi-person-plus me-2"></i>New Customer</a></li>
                        <li><a class="dropdown-item" href="quicknotes/new"><i class="bi bi-sticky me-2"></i>Quick Note</a></li>
                    </ul>
                </div>

                @* Print *@
                <button class="btn btn-link header-icon no-print" @onclick="PrintPage" title="Print this page">
                    <i class="bi bi-printer"></i>
                </button>

                @* Notifications *@
                <div class="dropdown">
                    <button class="btn btn-link header-icon position-relative dropdown-toggle" data-bs-toggle="dropdown" title="Notifications" aria-expanded="false">
                        <i class="bi bi-bell"></i>
                        @if (_notifications.Count > 0)
                        {
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                @_notifications.Count
                            </span>
                        }
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" style="min-width:320px;max-height:400px;overflow-y:auto;">
                        <li><span class="dropdown-header fw-bold"><i class="bi bi-bell me-1"></i>Notifications</span></li>
                        <li><hr class="dropdown-divider" /></li>
                        @if (_notifications.Count == 0)
                        {
                            <li><span class="dropdown-item-text text-muted small">No notifications</span></li>
                        }
                        else
                        {
                            @foreach (var n in _notifications)
                            {
                                <li>
                                    <a class="dropdown-item small d-flex align-items-start gap-2 @(n.IsRead ? "text-muted" : "")" href="@n.Url" @onclick="() => MarkNotificationRead(n)">
                                        <i class="bi @n.Icon mt-1"></i>
                                        <div>
                                            <div class="fw-semibold">@n.Title</div>
                                            <small class="text-muted">@n.Message</small>
                                            <div class="text-muted" style="font-size:0.7rem;">@n.TimeAgo</div>
                                        </div>
                                    </a>
                                </li>
                            }
                            <li><hr class="dropdown-divider" /></li>
                            <li><button class="dropdown-item text-center small text-primary" @onclick="ClearNotifications"><i class="bi bi-check-all me-1"></i>Mark all as read</button></li>
                        }
                    </ul>
                </div>

                @* User Profile *@
                <div class="dropdown">
                    <button class="btn btn-link header-icon dropdown-toggle" data-bs-toggle="dropdown" title="User menu">
                        <i class="bi bi-person-circle"></i>
                        <span class="d-none d-lg-inline small ms-1">@_userName</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><span class="dropdown-item-text fw-bold">@_userRole: @_userName</span></li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" @onclick="ToggleDarkMode"><i class="bi @(_darkMode ? "bi-sun" : "bi-moon") me-2"></i>@(_darkMode ? "Light Mode" : "Dark Mode")</a></li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="/auth/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </header>

        @* ===== CONTENT ===== *@
        <main class="app-content">
            @Body
        </main>

        @* ===== FOOTER (per UI Layout guideline) ===== *@
        <footer class="app-footer">
            <div class="footer-left">
                <small class="text-muted">OneManVanFSM v1.0.0</small>
            </div>
            <div class="footer-center">
                <small class="text-success">
                    <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Online
                </small>
            </div>
            <div class="footer-right">
                <a href="reports" class="text-muted me-3"><small>Reports</small></a>
                <a href="settings" class="text-muted me-3"><small>Settings</small></a>
                <a href="help" class="text-muted"><small><i class="bi bi-question-circle"></i> Help</small></a>
            </div>
        </footer>
    </div>
</div>

@* About Modal *@
@if (_showAboutModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="HideAboutModal">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-tools text-primary me-2"></i>About OneManVanFSM
                    </h5>
                    <button type="button" class="btn-close" @onclick="HideAboutModal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-tools" style="font-size: 4rem; color: var(--bs-primary);"></i>
                        <h4 class="mt-3">OneManVanFSM</h4>
                        <p class="text-muted">Field Service Management Solution</p>
                        <small class="text-muted">Version 1.0.0</small>
                    </div>

                    <hr />

                    <div class="mb-3">
                        <h6 class="fw-bold"><i class="bi bi-info-circle me-2"></i>About This Application</h6>
                        <p class="small text-muted">
                            OneManVanFSM is a comprehensive field service management solution designed for 
                            small to medium-sized service businesses. Manage jobs, customers, inventory, 
                            scheduling, invoicing, and more — all in one integrated platform.
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6 class="fw-bold"><i class="bi bi-person-circle me-2"></i>Created By</h6>
                        <p class="mb-1 small">
                            <strong>Christopher Eikel</strong><br />
                            <span class="text-muted">MtnManApps</span>
                        </p>
                    </div>

                    <div>
                        <h6 class="fw-bold"><i class="bi bi-globe me-2"></i>More Information</h6>
                        <p class="small mb-2">
                            <a href="https://chillwiththepenguin.com/onemanvanfsm" target="_blank" class="text-decoration-none">
                                <i class="bi bi-link-45deg"></i> chillwiththepenguin.com/onemanvanfsm
                                <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.75rem;"></i>
                            </a>
                        </p>
                        <small class="text-muted">
                            Visit our website for documentation, support, and updates.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideAboutModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">&#10006;</span>
</div>

@code {
private bool SidebarCollapsed { get; set; }
private bool _mobileMenuOpen;
private bool _darkMode;
private string _userName = "User";
private string _userRole = "User";
private string _searchText = string.Empty;
private string _selectedPeriod = "today";
private string _selectedPeriodLabel = "Today";
private List<AppNotification> _notifications = [];
private bool _showAboutModal;

// Permission state
private bool _permsLoaded;
private Dictionary<string, bool> _viewPerms = new();

private bool Can(string feature) => _viewPerms.GetValueOrDefault(feature, true);

private async Task LoadPermissions()
{
    if (_permsLoaded) return;
    _permsLoaded = true;

    try
    {
        if (Enum.TryParse<UserRole>(_userRole, out var role))
        {
            foreach (var f in Features.All)
            {
                _viewPerms[f] = await PermSvc.CanViewAsync(role, f);
            }
            await InvokeAsync(StateHasChanged);
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"[MainLayout] Failed to load permissions: {ex.Message}");
    }
}

    private class AppNotification
    {
        public string Title { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public string Icon { get; set; } = "bi-info-circle";
        public string Url { get; set; } = "#";
        public bool IsRead { get; set; }
        public string TimeAgo { get; set; } = "just now";
    }

    private void MarkNotificationRead(AppNotification n)
    {
        n.IsRead = true;
        _notifications.RemoveAll(x => x.IsRead);
    }

    private void ClearNotifications()
    {
        _notifications.Clear();
    }

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadPermissions();
        }
    }

    private async Task ToggleSidebar()
    {
        var isMobile = await JS.InvokeAsync<bool>("isMobile");
        if (isMobile)
        {
            _mobileMenuOpen = !_mobileMenuOpen;
            if (_mobileMenuOpen) SidebarCollapsed = false;
        }
        else
        {
            SidebarCollapsed = !SidebarCollapsed;
        }
    }

    private void CloseMobileMenu()
    {
        _mobileMenuOpen = false;
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        _mobileMenuOpen = false;
        try
        {
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException)
        {
            // Circuit already disposed during navigation — safe to ignore
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private void ToggleDarkMode()
    {
        _darkMode = !_darkMode;
    }

    private void SetPeriod(string period, string label)
    {
        _selectedPeriod = period;
        _selectedPeriodLabel = label;
        Navigation.NavigateTo($"/?period={period}", forceLoad: false);
    }

    private void HandleSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_searchText))
        {
            Navigation.NavigateTo($"/search?q={Uri.EscapeDataString(_searchText.Trim())}");
            _searchText = string.Empty;
        }
    }

    private async Task PrintPage()
    {
        await JS.InvokeVoidAsync("triggerPrint");
    }

    private void ShowAboutModal()
    {
        _showAboutModal = true;
    }

    private void HideAboutModal()
    {
        _showAboutModal = false;
    }
}
